# Test Design: 4.2

2026-01-28 | JW (QA)

## Overview

Total: 76 | Unit: 47 (62%) | Int: 26 (34%) | E2E: 3 (4%)
Priority: P0: 21, P1: 43, P2: 12
Blind Spot Scenarios: 31

## Scenarios by AC

### AC1: 上传声音样本

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.2-UNIT-001 | U | P0 | Generate OSS upload URL — valid request returns presigned URL, ossKey, expiry | Pure validation, no external deps |
| 4.2-UNIT-002 | U | P0 | Validate audio format — MP3 accepted | Input validation logic |
| 4.2-UNIT-003 | U | P0 | Validate audio format — WAV accepted | Input validation logic |
| 4.2-UNIT-004 | U | P0 | Validate audio format — M4A accepted | Input validation logic |
| 4.2-UNIT-005 | U | P0 | Reject invalid audio format (e.g., .txt) → 400 INVALID_AUDIO_FORMAT | Data integrity, prevent bad data |
| 4.2-UNIT-006 | U | P0 | Validate duration — minimum 5 seconds accepted (BR-1.2) | Boundary acceptance |
| 4.2-UNIT-007 | U | P0 | Validate duration — maximum 120 seconds accepted (BR-1.2) | Boundary acceptance |
| 4.2-UNIT-008 | U | P0 | Reject duration below 5 seconds → 400 AUDIO_DURATION_INVALID | Boundary rejection |
| 4.2-UNIT-009 | U | P0 | Reject duration above 120 seconds → 400 AUDIO_DURATION_INVALID | Boundary rejection |
| 4.2-UNIT-010 | U | P1 | User sample count check — allow when < 3 samples exist | Business rule verification |
| 4.2-UNIT-011 | U | P0 | Reject 4th sample when limit is 3 → 422 VOICE_SAMPLE_LIMIT_EXCEEDED (BR-1.3) | Data integrity, limit enforcement |
| 4.2-UNIT-012 | U | P1 | Create voice sample record with correct fields (ossKey, durationSeconds, status=uploading) | Correct entity persistence |
| 4.2-INT-001 | I | P0 | Create voice sample → VoiceCloneMessage published to MQ | Critical async trigger, cross-service |
| 4.2-INT-002 | I | P1 | POST /api/v1/voice/upload-url → 200 with presigned URL | API contract verification |
| 4.2-INT-003 | I | P1 | POST /api/v1/voice/samples → 201 with sample record | API contract verification |
| 4.2-INT-004 | I | P1 | POST /api/v1/voice/samples with invalid format → 400 | API error contract |
| 4.2-INT-005 | I | P1 | POST /api/v1/voice/samples with invalid duration → 400 | API error contract |
| 4.2-INT-006 | I | P1 | POST /api/v1/voice/samples when limit exceeded → 422 | API error contract |

### AC2: 声音克隆处理

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.2-UNIT-013 | U | P0 | Successful Seed-ICL call → returns clone_voice_id | Core feature logic |
| 4.2-UNIT-014 | U | P0 | Seed-ICL API failure → set status=failed, store error_message | Critical error path |
| 4.2-UNIT-015 | U | P1 | Clone consumer processes VoiceCloneMessage → invokes VoiceCloneService | Message routing logic |
| 4.2-UNIT-016 | U | P1 | Retry on transient failure — up to 2 retries with backoff | Resilience logic |
| 4.2-UNIT-017 | U | P1 | Status updated to 'processing' when clone starts | State machine correctness |
| 4.2-UNIT-018 | U | P0 | Status updated to 'completed' with clone_voice_id on success | Data integrity |
| 4.2-UNIT-019 | U | P0 | Status updated to 'failed' with error_message on failure | Data integrity |
| 4.2-INT-007 | I | P0 | MQ consumer receives VoiceCloneMessage and invokes processing | Cross-service integration |
| 4.2-INT-008 | I | P0 | Clone callback updates voice_samples record (clone_voice_id, status) in DB | Cross-service data sync |
| 4.2-INT-009 | I | P1 | DLQ routing after 3 failed retries (60s/120s/300s backoff) | Resilience architecture |

### AC3: 使用克隆声音配音 & Sample Management

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.2-UNIT-020 | U | P0 | TTS with cloned voice — resolve clone_voice_id from voice_samples (status=completed) | Core feature logic |
| 4.2-UNIT-021 | U | P0 | TTS with clone not ready (status≠completed) → 400 VOICE_CLONE_IN_PROGRESS | Prevent bad composition |
| 4.2-UNIT-022 | U | P1 | List user's voice samples — returns all with status | CRUD correctness |
| 4.2-UNIT-023 | U | P1 | Get sample by ID — returns detail with clone status | CRUD correctness |
| 4.2-UNIT-024 | U | P0 | Delete sample — cascade tasks.voice_sample_id = NULL | Data integrity |
| 4.2-UNIT-025 | U | P1 | Preview — generate short TTS preview using cloned voice | Feature logic |
| 4.2-UNIT-026 | U | P1 | Preview while clone not completed → 400 | Guard clause |
| 4.2-UNIT-027 | U | P1 | Get sample by invalid/nonexistent ID → 404 VOICE_SAMPLE_NOT_FOUND | Error response |
| 4.2-UNIT-028 | U | P1 | Delete sample not found → 404 VOICE_SAMPLE_NOT_FOUND | Error response |
| 4.2-INT-010 | I | P1 | GET /api/v1/voice/samples → 200 with list | API contract |
| 4.2-INT-011 | I | P1 | GET /api/v1/voice/samples/{id} → 200 with detail | API contract |
| 4.2-INT-012 | I | P1 | DELETE /api/v1/voice/samples/{id} → 200, tasks.voice_sample_id = NULL | API + FK cascade |
| 4.2-INT-013 | I | P2 | GET /api/v1/voice/samples/{id}/preview → 200 with audio | Secondary feature |
| 4.2-INT-014 | I | P1 | DELETE sample referenced by task → verify FK ON DELETE SET NULL | Data relationship |

### Cross-AC E2E

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.2-E2E-001 | E | P0 | Full journey: upload sample → clone processing → use cloned voice in TTS | Critical end-to-end path |
| 4.2-E2E-002 | E | P1 | Status lifecycle: uploading → processing → completed across services | State machine E2E |
| 4.2-E2E-003 | E | P1 | Upload → clone → delete → verify tasks.voice_sample_id cleared | Data cleanup journey |

## Blind Spot Scenarios [BLIND-SPOT]

### BOUNDARY

| ID | Pri | Lvl | Scenario | AC | Ref |
|----|-----|-----|----------|----|-----|
| 4.2-BLIND-BOUNDARY-001 | P1 | U | Null/empty ossKey in CreateVoiceSampleRequest | AC1 | BOUNDARY-001 |
| 4.2-BLIND-BOUNDARY-002 | P1 | U | Null/empty name in CreateVoiceSampleRequest | AC1 | BOUNDARY-001 |
| 4.2-BLIND-BOUNDARY-003 | P1 | U | Duration at exact lower boundary: 5 seconds | AC1 | BOUNDARY-002 |
| 4.2-BLIND-BOUNDARY-004 | P1 | U | Duration at exact upper boundary: 120 seconds | AC1 | BOUNDARY-003 |
| 4.2-BLIND-BOUNDARY-005 | P1 | U | Duration just below lower boundary: 4 seconds | AC1 | BOUNDARY-004 |
| 4.2-BLIND-BOUNDARY-006 | P1 | U | Duration just above upper boundary: 121 seconds | AC1 | BOUNDARY-004 |
| 4.2-BLIND-BOUNDARY-007 | P2 | U | Negative duration value | AC1 | BOUNDARY-005 |
| 4.2-BLIND-BOUNDARY-008 | P2 | U | Zero duration value | AC1 | BOUNDARY-005 |
| 4.2-BLIND-BOUNDARY-009 | P2 | U | name exceeds VARCHAR(100) limit | AC1 | BOUNDARY-003 |
| 4.2-BLIND-BOUNDARY-010 | P2 | U | ossKey exceeds VARCHAR(500) limit | AC1 | BOUNDARY-003 |
| 4.2-BLIND-BOUNDARY-011 | P2 | U | Voice sample ID = 0 or negative in path param | AC3 | BOUNDARY-005 |
| 4.2-BLIND-BOUNDARY-012 | P1 | U | Null/empty filename in VoiceUploadUrlRequest | AC1 | BOUNDARY-001 |

### ERROR

| ID | Pri | Lvl | Scenario | AC | Ref |
|----|-----|-----|----------|----|-----|
| 4.2-BLIND-ERROR-001 | P1 | U | Seed-ICL API timeout during clone processing | AC2 | ERROR-001 |
| 4.2-BLIND-ERROR-002 | P1 | U | Seed-ICL API returns 503 Service Unavailable | AC2 | ERROR-002 |
| 4.2-BLIND-ERROR-003 | P1 | U | Seed-ICL API returns malformed/unexpected response | AC2 | ERROR-003 |
| 4.2-BLIND-ERROR-004 | P1 | I | RabbitMQ unavailable when publishing VoiceCloneMessage | AC1 | ERROR-002 |
| 4.2-BLIND-ERROR-005 | P1 | U | OSS service unavailable for upload URL generation | AC1 | ERROR-002 |
| 4.2-BLIND-ERROR-006 | P2 | I | Database connection lost during sample creation | AC1 | ERROR-001 |
| 4.2-BLIND-ERROR-007 | P1 | I | Callback to user-service fails after successful Seed-ICL clone | AC2 | ERROR-004 |

### CONCURRENCY

| ID | Pri | Lvl | Scenario | AC | Ref |
|----|-----|-----|----------|----|-----|
| 4.2-BLIND-CONCURRENCY-001 | P1 | I | Concurrent upload of 3rd and 4th sample by same user (race on limit check) | AC1 | CONCURRENCY-002 |
| 4.2-BLIND-CONCURRENCY-002 | P2 | I | Concurrent clone callbacks updating same voice_samples record | AC2 | CONCURRENCY-001 |
| 4.2-BLIND-CONCURRENCY-003 | P1 | I | Delete sample while clone is still in progress | AC2/AC3 | CONCURRENCY-002 |

### DATA

| ID | Pri | Lvl | Scenario | AC | Ref |
|----|-----|-----|----------|----|-----|
| 4.2-BLIND-DATA-001 | P1 | I | Transaction rollback if MQ publish fails after DB insert (atomicity) | AC1 | DATA-001 |
| 4.2-BLIND-DATA-002 | P1 | I | Orphan voice_samples after user deletion — verify ON DELETE CASCADE | AC1 | DATA-003 |
| 4.2-BLIND-DATA-003 | P1 | I | tasks.voice_sample_id FK ON DELETE SET NULL — verify cascade | AC3 | DATA-003 |
| 4.2-BLIND-DATA-004 | P1 | I | Clone status consistency: DB status matches actual Seed-ICL outcome | AC2 | DATA-002 |

### RESOURCE

| ID | Pri | Lvl | Scenario | AC | Ref |
|----|-----|-----|----------|----|-----|
| 4.2-BLIND-RESOURCE-001 | P2 | U | DB connection release on Seed-ICL API timeout | AC2 | RESOURCE-001 |
| 4.2-BLIND-RESOURCE-002 | P2 | U | MQ channel release on consumer error/exception | AC2 | RESOURCE-001 |
| 4.2-BLIND-RESOURCE-003 | P2 | U | OSS client resource cleanup on upload URL generation failure | AC1 | RESOURCE-001 |

### FLOW

| ID | Pri | Lvl | Scenario | AC | Ref |
|----|-----|-----|----------|----|-----|
| 4.2-BLIND-FLOW-001 | P1 | I | Upload sample then immediately request preview before clone completes | AC1/AC3 | FLOW-003 |
| 4.2-BLIND-FLOW-002 | P2 | I | Delete sample while task composition is using the clone voice | AC3 | FLOW-003 |

## Risk Coverage

| Risk | Mitigated By |
|------|-------------|
| Invalid data enters DB | UNIT-002–009, UNIT-011, BLIND-BOUNDARY-001–012 |
| Clone API failure leaves inconsistent state | UNIT-014, UNIT-018–019, BLIND-ERROR-001–003, BLIND-DATA-004 |
| MQ failure loses clone request | INT-001, BLIND-ERROR-004, BLIND-DATA-001 |
| Race condition on sample limit | BLIND-CONCURRENCY-001 |
| Orphan data after deletions | UNIT-024, INT-014, BLIND-DATA-002–003 |
| Resource leaks on error paths | BLIND-RESOURCE-001–003 |
| User attempts action on incomplete clone | UNIT-021, UNIT-026, BLIND-FLOW-001 |

## Execution Order

1. P0 Unit (17 scenarios) — validate core logic fast
2. P0 Integration (3 scenarios) — confirm cross-service paths
3. P0 E2E (1 scenario) — full journey
4. P1 Unit (11 scenarios) — secondary logic
5. P1 Integration (10 scenarios) — API contracts
6. P1 E2E (2 scenarios) — additional journeys
7. P1 Blind Spot Unit (7 scenarios) — boundary/error gaps
8. P1 Blind Spot Integration (13 scenarios) — concurrency/data gaps
9. P2 (12 scenarios) — edge cases and resource cleanup
