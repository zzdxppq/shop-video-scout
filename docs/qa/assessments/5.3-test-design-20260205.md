# Test Design: Story 5.3 - å‘å¸ƒè¾…åŠ©æœåŠ¡

## Test Design Metadata

| Field | Value |
|-------|-------|
| Story ID | 5.3 |
| Story Title | å‘å¸ƒè¾…åŠ©æœåŠ¡ |
| Test Design Level | Standard |
| Complexity | Medium |
| Risk Level | MEDIUM |
| Designer | JW (QA Agent) |
| Created Date | 2026-02-05 |
| Total Test Scenarios | 132 |

## Story Summary

å®ç°å‘å¸ƒè¾…åŠ©æœåŠ¡ï¼Œä¸ºç”¨æˆ·ç”Ÿæˆçƒ­é—¨è¯é¢˜æ ‡ç­¾å’Œè§†é¢‘æ ‡é¢˜æ¨èï¼Œæå‡ç¤¾äº¤å¹³å°å‘å¸ƒæ•ˆç‡ã€‚

**Key Components:**
- publish-service å¾®æœåŠ¡ (æ–°å»º)
- DoubaoClient common æ¨¡å— (æ–°å»ºå…±äº«)
- è¯é¢˜ç”ŸæˆæœåŠ¡ (TopicGenerationService)
- æ ‡é¢˜ç”ŸæˆæœåŠ¡ (TitleGenerationService)
- è·¨æœåŠ¡è°ƒç”¨ (Feign â†’ task-service)
- Redis ç¼“å­˜ + MySQL æŒä¹…åŒ–

## Test Scope

### In Scope
- AC1: çƒ­é—¨è¯é¢˜æ¨è (7 BRs)
- AC2: æ ‡é¢˜æ¨è (7 BRs)
- AC3: é‡æ–°ç”ŸæˆåŠŸèƒ½ (4 BRs)
- DoubaoClient HTTP å®¢æˆ·ç«¯
- è·¨æœåŠ¡ Feign è°ƒç”¨
- Redis ç¼“å­˜é€»è¾‘
- æ•°æ®åº“æŒä¹…åŒ–
- é™çº§/Fallback å¤„ç†

### Out of Scope
- Doubao API å®é™…è°ƒç”¨ (ä½¿ç”¨ Mock)
- å‰ç«¯ UI ç»„ä»¶ (Story 5.4 è´Ÿè´£)
- ç«å±±å¼•æ“é…é¢ç®¡ç†

---

## Test Categories

### 1. Unit Tests (98 scenarios)

#### 1.1 DoubaoClient Tests (18 scenarios)

| ID | Scenario | Input | Expected | Priority |
|----|----------|-------|----------|----------|
| DC-U-001 | Build request with default temperature | prompt, default temp | temperature=0.7 in request | P0 |
| DC-U-002 | Build request with custom temperature | prompt, temp=0.9 | temperature=0.9 in request | P0 |
| DC-U-003 | Parse successful response | valid JSON response | extracted content string | P0 |
| DC-U-004 | Parse empty response | empty content | throws DoubaoException | P1 |
| DC-U-005 | Parse malformed JSON | invalid JSON | throws DoubaoException | P1 |
| DC-U-006 | Timeout handling | no response in 30s | throws TimeoutException | P0 |
| DC-U-007 | Retry on 500 error | API returns 500 | retry 3 times | P0 |
| DC-U-008 | Retry on 503 error | API returns 503 | retry 3 times | P0 |
| DC-U-009 | No retry on 400 error | API returns 400 | fail immediately | P1 |
| DC-U-010 | No retry on 401 error | API returns 401 | fail immediately | P1 |
| DC-U-011 | Exponential backoff timing | 500 error retry | 1s, 2s, 4s delays | P1 |
| DC-U-012 | Max retries exceeded | 500 error Ã— 4 | throws DoubaoException | P0 |
| DC-U-013 | API key in header | any request | Authorization: Bearer {key} | P0 |
| DC-U-014 | Model parameter | any request | model=doubao-pro-32k | P1 |
| DC-U-015 | Content-Type header | any request | application/json | P1 |
| DC-U-016 | Connection timeout | slow connection | timeout after config seconds | P1 |
| DC-U-017 | Response truncation | very long response | parse without error | P2 |
| DC-U-018 | Special characters in prompt | prompt with emojis/unicode | correctly encoded | P2 |

#### 1.2 PromptBuilder Tests (12 scenarios)

| ID | Scenario | Input | Expected | Priority |
|----|----------|-------|----------|----------|
| PB-U-001 | Build prompt with all fields | shop_name, shop_type, script | valid combined prompt | P0 |
| PB-U-002 | Shop name variable substitution | "æµ·åº•æ(æœ›äº¬åº—)" | {{shop_name}} replaced | P0 |
| PB-U-003 | Shop type variable substitution | "food" | {{shop_type}} replaced | P0 |
| PB-U-004 | Script summary substitution | multi-paragraph script | {{script_summary}} replaced | P0 |
| PB-U-005 | Empty script summary | null script | placeholder or empty | P1 |
| PB-U-006 | Very long script summary | 5000 char script | truncated to reasonable length | P1 |
| PB-U-007 | Special characters in shop name | "æ˜Ÿå·´å…‹/ä¸‰é‡Œå±¯:åº—" | properly escaped | P1 |
| PB-U-008 | Script with newlines | multi-line script | newlines preserved or converted | P2 |
| PB-U-009 | Prompt output format | any input | contains JSON format instruction | P0 |
| PB-U-010 | Topic count instruction | any input | "8-10ä¸ªç›¸å…³è¯é¢˜" in prompt | P1 |
| PB-U-011 | Title count instruction | any input | "4ä¸ªå¸å¼•çœ¼çƒçš„è§†é¢‘æ ‡é¢˜" in prompt | P1 |
| PB-U-012 | Platform reference | any input | mentions æŠ–éŸ³/å°çº¢ä¹¦ | P2 |

#### 1.3 TopicGenerationService Tests (22 scenarios)

| ID | Scenario | Input | Expected | Priority |
|----|----------|-------|----------|----------|
| TG-U-001 | Generate topics success | valid task | 5-10 topics returned | P0 |
| TG-U-002 | Topics start with # | AI response | all topics have # prefix | P0 |
| TG-U-003 | Auto-prepend # | topics without # | # added automatically | P0 |
| TG-U-004 | Topic max length 20 chars | valid topics | all â‰¤ 20 chars | P0 |
| TG-U-005 | Truncate long topic | 25-char topic | truncated to 20 chars | P0 |
| TG-U-006 | Remove spaces from topic | "# ç¾é£Ÿ æ¨è" | "#ç¾é£Ÿæ¨è" | P1 |
| TG-U-007 | Min 5 topics | AI returns 3 | pad with defaults to 5 | P1 |
| TG-U-008 | Max 10 topics | AI returns 15 | limited to 10 | P1 |
| TG-U-009 | Contains shop name topic | "æµ·åº•æ" | includes "#æµ·åº•æ" | P0 |
| TG-U-010 | Contains category topic | food shop | includes "#ç¾é£Ÿæ¨è" or similar | P1 |
| TG-U-011 | Contains location topic | "æœ›äº¬åº—" | includes "#æœ›äº¬ç¾é£Ÿ" or similar | P1 |
| TG-U-012 | Doubao API failure fallback | API throws exception | returns default topics | P0 |
| TG-U-013 | Doubao timeout fallback | 30s timeout | returns default topics | P0 |
| TG-U-014 | Invalid JSON response fallback | malformed JSON | returns default topics | P0 |
| TG-U-015 | Empty topics array fallback | [] from API | returns default topics | P1 |
| TG-U-016 | Default topics count | fallback scenario | 8 default topics | P1 |
| TG-U-017 | Default topics format | fallback scenario | all start with # | P1 |
| TG-U-018 | Topic sorting by priority | multiple topics | sorted by relevance | P2 |
| TG-U-019 | Duplicate topic removal | ["#ç¾é£Ÿ", "#ç¾é£Ÿ"] | unique topics only | P1 |
| TG-U-020 | Empty topic filtered | ["#", ""] | filtered out | P1 |
| TG-U-021 | Unicode in topic | "#å’–å•¡â˜•æ¢åº—" | preserved correctly | P2 |
| TG-U-022 | Extract location from shop name | "æµ·åº•æç«é”…(æœ›äº¬åº—)" | extracts "æœ›äº¬" | P1 |

#### 1.4 TitleGenerationService Tests (20 scenarios)

| ID | Scenario | Input | Expected | Priority |
|----|----------|-------|----------|----------|
| TT-U-001 | Generate titles success | valid task + script | 3-5 titles returned | P0 |
| TT-U-002 | Title length 20-50 chars | valid titles | all within range | P0 |
| TT-U-003 | Title too short filtered | 15-char title | filtered out | P0 |
| TT-U-004 | Title too long truncated | 60-char title | truncated to ~50 + "..." | P0 |
| TT-U-005 | Min 3 titles | AI returns 2 | pad with templates | P1 |
| TT-U-006 | Max 5 titles | AI returns 8 | limited to 5 | P1 |
| TT-U-007 | First title is recommended | any | titles[0] is best | P0 |
| TT-U-008 | No script fallback | empty script | template titles returned | P0 |
| TT-U-009 | Template title shop name | fallback with "æµ·åº•æ" | "{shop_name}æ¢åº—ï½œå¿…åƒæ¨è" filled | P0 |
| TT-U-010 | Doubao API failure fallback | API throws exception | returns template titles | P0 |
| TT-U-011 | Doubao timeout fallback | 30s timeout | returns template titles | P0 |
| TT-U-012 | Invalid JSON response fallback | malformed JSON | returns template titles | P0 |
| TT-U-013 | Contains click-bait elements | valid titles | has numbers/questions/exclamation | P2 |
| TT-U-014 | Platform tone check | valid titles | appropriate for æŠ–éŸ³/å°çº¢ä¹¦ | P2 |
| TT-U-015 | Sensitive word filter | title with banned word | filtered out | P1 |
| TT-U-016 | Empty title filtered | ["", "valid title"] | empty filtered | P1 |
| TT-U-017 | Title with emoji | "å¤ªç»äº†ğŸ”¥ï¼" | preserved correctly | P2 |
| TT-U-018 | Whitespace trimming | " title with spaces " | trimmed | P1 |
| TT-U-019 | Template count | fallback scenario | 3 template titles | P1 |
| TT-U-020 | Newline in title removed | "title\nwith newline" | newline removed | P1 |

#### 1.5 PublishAssistService Tests (26 scenarios)

| ID | Scenario | Input | Expected | Priority |
|----|----------|-------|----------|----------|
| PA-U-001 | Get assist - cache hit | cached data exists | return cached, no API call | P0 |
| PA-U-002 | Get assist - cache miss, DB hit | no cache, DB exists | return DB, update cache | P0 |
| PA-U-003 | Get assist - cache miss, DB miss | no cache, no DB | call AI, store both | P0 |
| PA-U-004 | Get assist - task not found | invalid taskId | throw TASK_NOT_FOUND | P0 |
| PA-U-005 | Get assist - task not done | task.status=composing | throw OUTPUT_NOT_READY | P0 |
| PA-U-006 | Get assist - shop name missing | task.shop_name=null | throw validation error | P1 |
| PA-U-007 | Regenerate success | count=0 | success, countâ†’1 | P0 |
| PA-U-008 | Regenerate count=1 | count=1 | success, countâ†’2 | P0 |
| PA-U-009 | Regenerate count=2 | count=2 | success, countâ†’3 | P0 |
| PA-U-010 | Regenerate count=3 limit | count=3 | error 1031 | P0 |
| PA-U-011 | Regenerate clears cache | regenerate call | Redis delete called | P0 |
| PA-U-012 | Regenerate temperature 0 | count=0 | temperature=0.7 | P0 |
| PA-U-013 | Regenerate temperature 1 | count=1 | temperature=0.8 | P0 |
| PA-U-014 | Regenerate temperature 2 | count=2 | temperature=0.9 | P0 |
| PA-U-015 | Regenerate temperature 3 | count=3 | temperature=1.0 | P1 |
| PA-U-016 | Regenerate updates DB | regenerate success | topics, titles, count updated | P0 |
| PA-U-017 | Regenerate updates cache | regenerate success | Redis set with new TTL | P0 |
| PA-U-018 | Response has regenerate_remaining | count=1 | remaining=2 | P0 |
| PA-U-019 | Response has regenerate_remaining=0 | count=3 | remaining=0 | P1 |
| PA-U-020 | Cache TTL is 24 hours | new cache entry | TTL=86400 seconds | P1 |
| PA-U-021 | Cache key format | taskId=123 | "publish:assist:123" | P0 |
| PA-U-022 | Task service unavailable | Feign throws | return cached if available | P1 |
| PA-U-023 | Task service unavailable, no cache | Feign throws, no cache | throw error | P1 |
| PA-U-024 | DB insert failure | DB error | return data, log error | P2 |
| PA-U-025 | Concurrent regenerate | 2 simultaneous calls | only one succeeds | P2 |
| PA-U-026 | First-time generation stores to DB | new task | insert into publish_assists | P0 |

---

### 2. Integration Tests (18 scenarios)

#### 2.1 Cross-Service Integration (8 scenarios)

| ID | Scenario | Input | Expected | Priority |
|----|----------|-------|----------|----------|
| CS-I-001 | Feign call to task-service /internal/tasks/{id} | valid taskId | returns TaskDetailDto | P0 |
| CS-I-002 | Feign call to task-service /internal/tasks/{id}/script | valid taskId | returns ScriptDto | P0 |
| CS-I-003 | Feign fallback on task-service 404 | invalid taskId | fallback triggered | P1 |
| CS-I-004 | Feign fallback on task-service 500 | service error | fallback triggered | P1 |
| CS-I-005 | Feign timeout handling | slow response | timeout after config | P1 |
| CS-I-006 | Full flow: task â†’ script â†’ AI â†’ response | done task | complete PublishAssistResponse | P0 |
| CS-I-007 | Gateway routing /api/v1/publish/** | request to gateway | routes to publish-service | P0 |
| CS-I-008 | Internal API auth bypass | internal request | no JWT required | P1 |

#### 2.2 Redis + DB Integration (6 scenarios)

| ID | Scenario | Input | Expected | Priority |
|----|----------|-------|----------|----------|
| RD-I-001 | Cache write on first generation | new task | Redis key created | P0 |
| RD-I-002 | Cache read returns valid data | cached task | correct topics/titles | P0 |
| RD-I-003 | Cache invalidation on regenerate | regenerate call | old key deleted | P0 |
| RD-I-004 | DB persistence on first generation | new task | publish_assists row created | P0 |
| RD-I-005 | DB update on regenerate | regenerate call | row updated | P0 |
| RD-I-006 | Cache-DB consistency | regenerate | both have same data | P1 |

#### 2.3 Doubao API Integration (4 scenarios)

| ID | Scenario | Input | Expected | Priority |
|----|----------|-------|----------|----------|
| DA-I-001 | Successful API call (mocked) | valid prompt | parsed topics + titles | P0 |
| DA-I-002 | API retry behavior (mocked) | 500 â†’ 500 â†’ 200 | success after retries | P1 |
| DA-I-003 | API circuit breaker | many failures | circuit opens | P2 |
| DA-I-004 | Rate limiting behavior | burst requests | throttled appropriately | P2 |

---

### 3. E2E Tests (6 scenarios)

| ID | Scenario | Steps | Expected | Priority |
|----|----------|-------|----------|----------|
| E2E-001 | Get publish assist for done task | 1. Complete task 2. GET /assist | topics + titles returned | P0 |
| E2E-002 | Regenerate publish assist | 1. GET /assist 2. POST /regenerate | new topics/titles, count++ | P0 |
| E2E-003 | Regenerate limit enforcement | 1. Regenerate Ã—3 2. Regenerate again | error 1031 on 4th | P0 |
| E2E-004 | Task not done error | 1. Task in composing 2. GET /assist | error OUTPUT_NOT_READY | P1 |
| E2E-005 | Cache behavior verification | 1. GET /assist 2. GET again immediately | second is faster (cached) | P1 |
| E2E-006 | Fallback on AI failure | 1. Mock Doubao failure 2. GET /assist | default topics/titles | P1 |

---

### 4. Blind Spot Tests (10 scenarios)

| ID | Scenario | Risk | Test Approach | Priority |
|----|----------|------|---------------|----------|
| BS-001 | Doubao API key expiration | Security | Mock 401 response handling | P0 |
| BS-002 | Very long shop name (100+ chars) | Edge case | Test prompt building | P1 |
| BS-003 | Shop name with only special chars | Edge case | Test "åº—å: @#$%" | P1 |
| BS-004 | Script with 10000+ characters | Performance | Test truncation logic | P1 |
| BS-005 | Concurrent access same task | Race condition | Parallel requests test | P1 |
| BS-006 | Redis connection failure | Resilience | Mock Redis down | P1 |
| BS-007 | DB connection failure during save | Resilience | Mock DB error | P2 |
| BS-008 | Doubao returns non-JSON | Parse error | Test graceful fallback | P1 |
| BS-009 | Doubao returns wrong structure | Parse error | Test {topics: "string"} | P1 |
| BS-010 | Task deleted during generation | Race condition | Task disappears mid-call | P2 |

---

## Test Data Requirements

### Mock Data

```yaml
tasks:
  - id: 1001
    shop_name: "æµ·åº•æç«é”…(æœ›äº¬åº—)"
    shop_type: "food"
    status: "done"

  - id: 1002
    shop_name: "æ˜Ÿå·´å…‹è‡»é€‰(ä¸‰é‡Œå±¯åº—)"
    shop_type: "food"
    status: "done"

  - id: 1003
    shop_name: "æµ‹è¯•åº—é“º"
    shop_type: "food"
    status: "composing"  # Not done

scripts:
  - task_id: 1001
    paragraphs:
      - text: "å®¶äººä»¬ï¼ä»Šå¤©ç»™ä½ ä»¬æ¢ä¸€å®¶æœ›äº¬è¶…ç«çš„æµ·åº•æ..."
      - text: "æ‹›ç‰Œæ¯›è‚šçœŸçš„å¤ªç»äº†ï¼Œä¸ƒä¸Šå…«ä¸‹ç‰¹åˆ«å«©..."
      - text: "äººå‡89çš„å›¢è´­å¤ªé¦™äº†..."

doubao_responses:
  success:
    topics: ["#æµ·åº•æ", "#ç«é”…æ¢åº—", "#æœ›äº¬ç¾é£Ÿ", "#å¿…åƒæ¦œ", "#ç¾é£Ÿæ¨è", "#åƒè´§æ—¥å¸¸", "#æ¢åº—è¾¾äºº", "#åŒ—äº¬ç¾é£Ÿ"]
    titles: ["æœ›äº¬è¿™å®¶æµ·åº•æå¤ªç»äº†ï¼æœåŠ¡å¥½åˆ°è®©ä½ æ„ŸåŠ¨æµæ³ª", "äººå‡89åƒæµ·åº•æï¼Ÿè¿™ä¸ªå›¢è´­ä¹Ÿå¤ªé¦™äº†å§ï¼", "æµ·åº•ææ¢åº—ï½œå¿…ç‚¹æ‹›ç‰Œæ¯›è‚šï¼Œä¸ƒä¸Šå…«ä¸‹å¤ªå«©äº†", "æœ‹å‹èšé¤é¦–é€‰ï¼æœ›äº¬æµ·åº•ææ°›å›´æ„Ÿæ‹‰æ»¡"]

  malformed:
    content: "è¿™ä¸æ˜¯JSONæ ¼å¼"

  wrong_structure:
    topics: "ä¸æ˜¯æ•°ç»„"
    titles: 123

default_topics:
  - "#æ¢åº—"
  - "#ç¾é£Ÿæ¢åº—"
  - "#å¿…åƒæ¦œ"
  - "#æ¢åº—vlog"
  - "#ç¾é£Ÿæ¨è"
  - "#å‘¨æœ«å»å“ªåƒ"
  - "#åƒè´§æ—¥å¸¸"
  - "#æœ¬åœ°ç¾é£Ÿ"

default_title_templates:
  - "{shop_name}æ¢åº—ï½œå¿…åƒæ¨è"
  - "å‘ç°{shop_name}çš„å®è—åƒæ³•"
  - "{shop_name}çœŸå®æµ‹è¯„ï¼Œå€¼ä¸å€¼å¾—å»ï¼Ÿ"
```

---

## Test Environment Requirements

### Services Required
- publish-service (target)
- task-service (mocked for unit, real for integration)
- Redis (real or embedded)
- MySQL (real or H2)
- Doubao API (mocked)

### Configuration
```yaml
# test application.yml
doubao:
  api-key: test-key
  endpoint: http://localhost:8089/mock/doubao
  model: doubao-pro-32k
  timeout-seconds: 5  # shorter for tests
  default-temperature: 0.7

spring:
  redis:
    host: localhost
    port: 6379
  datasource:
    url: jdbc:h2:mem:testdb
```

### Mock Server Setup
```java
// WireMock for Doubao API
stubFor(post(urlEqualTo("/v1/chat/completions"))
    .willReturn(aResponse()
        .withStatus(200)
        .withBody("""
            {
              "choices": [{
                "message": {
                  "content": "{\\"topics\\": [\\"#æµ·åº•æ\\"], \\"titles\\": [\\"æ ‡é¢˜1\\"]}"
                }
              }]
            }
            """)));
```

---

## Test Priority Matrix

| Priority | Count | Description |
|----------|-------|-------------|
| P0 | 48 | Critical path, must pass for release |
| P1 | 58 | Important functionality |
| P2 | 26 | Nice to have, edge cases |

**Total: 132 scenarios**

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Doubao API rate limit | Medium | High | Token bucket, fallback defaults |
| Cross-service call latency | Medium | Medium | Timeout config, circuit breaker |
| Redis cache inconsistency | Low | Medium | TTL, cache-aside pattern |
| Prompt injection | Low | Low | Input sanitization |
| Sensitive word bypass | Medium | High | Post-generation filter |

---

## Deliverables

### Test Files to Create

```
backend/
  common/doubao-client/
    src/test/java/com/shopvideoscout/common/doubao/
      DoubaoClientTest.java                    # DC-U-* tests

  publish-service/
    src/test/java/com/shopvideoscout/publish/
      prompt/
        PublishAssistPromptBuilderTest.java    # PB-U-* tests
      service/
        TopicGenerationServiceTest.java        # TG-U-* tests
        TitleGenerationServiceTest.java        # TT-U-* tests
        PublishAssistServiceTest.java          # PA-U-* tests
      controller/
        PublishAssistControllerTest.java       # API tests
      integration/
        PublishAssistIntegrationTest.java      # CS-I-*, RD-I-*, DA-I-* tests
        CrossServiceIntegrationTest.java       # Feign tests
```

---

## Approval

| Role | Name | Date | Status |
|------|------|------|--------|
| QA Designer | JW (QA Agent) | 2026-02-05 | âœ… Complete |
| Dev Review | - | - | â³ Pending |
| QA Lead | - | - | â³ Pending |

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2026-02-05 | JW | Initial test design created |
