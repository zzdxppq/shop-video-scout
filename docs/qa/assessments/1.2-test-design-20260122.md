# Test Design: 1.2 用户认证服务实现

2026-01-22 | JW (QA Engineer)

## Overview

| Metric | Value |
|--------|-------|
| **Total Scenarios** | 42 |
| **Unit Tests** | 18 (43%) |
| **Integration Tests** | 16 (38%) |
| **E2E Tests** | 8 (19%) |
| **Priority Distribution** | P0: 14, P1: 18, P2: 10 |
| **Blind Spot Scenarios** | 16 |
| **Test Design Level** | Comprehensive |
| **Security Sensitive** | Yes |

---

## Scenarios by AC

### AC1: 发送验证码接口

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 1.2-UNIT-001 | U | P0 | Valid phone format (13800138000) returns true | Input validation - pure logic |
| 1.2-UNIT-002 | U | P0 | Invalid phone: null input returns validation error | Boundary - null handling |
| 1.2-UNIT-003 | U | P0 | Invalid phone: empty string returns validation error | Boundary - empty input |
| 1.2-UNIT-004 | U | P1 | Invalid phone: 10 digits (too short) rejected | Boundary - minimum |
| 1.2-UNIT-005 | U | P1 | Invalid phone: 12 digits (too long) rejected | Boundary - maximum |
| 1.2-UNIT-006 | U | P1 | Invalid phone: non-numeric characters rejected | Boundary - type mismatch |
| 1.2-UNIT-007 | U | P1 | Invalid phone: doesn't start with 1 rejected | Business rule validation |
| 1.2-UNIT-008 | U | P0 | Code generation produces 6-digit numeric code | Core business logic |
| 1.2-UNIT-009 | U | P1 | Code generation randomness (no repeating patterns) | Security validation |
| 1.2-INT-001 | I | P0 | Send code success: code stored in Redis with 5-min TTL | Critical data persistence |
| 1.2-INT-002 | I | P0 | Rate limit: second request within 60s returns 429 | Business rule - rate limiting |
| 1.2-INT-003 | I | P1 | Rate limit: request after 60s succeeds | Rate limit expiry |
| 1.2-INT-004 | I | P0 | SMS service called with correct phone and code | External integration |
| 1.2-INT-005 | I | P1 | SMS service timeout: returns 503, logs error | Error handling |
| 1.2-INT-006 | I | P1 | SMS service failure: returns 503, internal error hidden | Security - error masking |
| 1.2-E2E-001 | E | P0 | Full send-code API: POST /api/v1/auth/send-code success | Critical user journey |
| 1.2-E2E-002 | E | P1 | Rate limit response includes remaining wait time | UX requirement |

### AC2: 手机号验证码登录

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 1.2-UNIT-010 | U | P0 | Correct code validation returns true | Core auth logic |
| 1.2-UNIT-011 | U | P0 | Wrong code validation returns false, increments error count | Security - brute force protection |
| 1.2-UNIT-012 | U | P0 | Expired code (>5min) validation returns false | Security - time-based validation |
| 1.2-UNIT-013 | U | P0 | Lockout check: 5+ errors returns locked status | Security - account protection |
| 1.2-UNIT-014 | U | P0 | JWT access token generation with correct claims (sub, phone, membership, exp) | Security - token structure |
| 1.2-UNIT-015 | U | P0 | JWT refresh token generation with 7-day expiry | Security - token lifecycle |
| 1.2-UNIT-016 | U | P1 | Phone masking in response (138****8000) | Privacy - data masking |
| 1.2-UNIT-017 | U | P1 | New user default membership is 'free' | Business rule |
| 1.2-UNIT-018 | U | P1 | Auto-generated nickname format (用户{last6digits}) | Business rule |
| 1.2-INT-007 | I | P0 | Login success - existing user: returns user info + tokens | Critical auth flow |
| 1.2-INT-008 | I | P0 | Login success - new user: auto-creates user record | Auto-registration |
| 1.2-INT-009 | I | P0 | Login failure - wrong code: returns 401, error count incremented | Security - failed attempt tracking |
| 1.2-INT-010 | I | P0 | Login failure - expired code: returns 401 with expiry message | Error differentiation |
| 1.2-INT-011 | I | P0 | Login failure - locked: returns 423 with remaining lock time | Account lockout |
| 1.2-INT-012 | I | P0 | Token refresh: valid refresh token returns new access token | Token lifecycle |
| 1.2-INT-013 | I | P0 | Token refresh: expired refresh token returns 401 | Security - token expiry |
| 1.2-INT-014 | I | P1 | Logout: refresh token added to blacklist | Token invalidation |
| 1.2-INT-015 | I | P1 | Logout: blacklisted token rejected on refresh | Blacklist enforcement |
| 1.2-INT-016 | I | P1 | Error count resets after successful login | UX - error recovery |
| 1.2-E2E-003 | E | P0 | Full login journey: send-code → login → access protected resource | Critical user journey |
| 1.2-E2E-004 | E | P0 | New user registration flow: send-code → login (auto-create) → verify user exists | Registration journey |
| 1.2-E2E-005 | E | P1 | Token refresh flow: access token expires → refresh → continue session | Session continuity |
| 1.2-E2E-006 | E | P1 | Logout flow: logout → verify token rejected | Session termination |
| 1.2-E2E-007 | E | P1 | Account lockout flow: 5 failed attempts → locked → wait 15min → unlocked | Lockout lifecycle |
| 1.2-E2E-008 | E | P2 | Gateway JWT validation: protected endpoint rejects invalid token | Gateway integration |

---

## Blind Spot Scenarios [BLIND-SPOT]

### BOUNDARY Category

| ID | Pri | Scenario | Applies To | Ref |
|----|-----|----------|------------|-----|
| 1.2-BLIND-BOUNDARY-001 | P1 | Null phone input to send-code API | AC1 | BOUNDARY-001 |
| 1.2-BLIND-BOUNDARY-002 | P1 | Empty string phone to send-code API | AC1 | BOUNDARY-001 |
| 1.2-BLIND-BOUNDARY-003 | P1 | Phone at min length (10 digits) | AC1 | BOUNDARY-002 |
| 1.2-BLIND-BOUNDARY-004 | P1 | Phone at max+1 length (12 digits) | AC1 | BOUNDARY-004 |
| 1.2-BLIND-BOUNDARY-005 | P1 | Null verification code to login API | AC2 | BOUNDARY-001 |
| 1.2-BLIND-BOUNDARY-006 | P1 | Code with 5 digits (min-1) | AC2 | BOUNDARY-002 |
| 1.2-BLIND-BOUNDARY-007 | P2 | Code with 7 digits (max+1) | AC2 | BOUNDARY-004 |

### ERROR Category

| ID | Pri | Scenario | Applies To | Ref |
|----|-----|----------|------------|-----|
| 1.2-BLIND-ERROR-001 | P0 | SMS service timeout (network failure) | AC1 | ERROR-001 |
| 1.2-BLIND-ERROR-002 | P0 | SMS service returns 503 (service unavailable) | AC1 | ERROR-002 |
| 1.2-BLIND-ERROR-003 | P1 | Redis unavailable during code storage | AC1 | ERROR-002 |
| 1.2-BLIND-ERROR-004 | P1 | Redis unavailable during code verification | AC2 | ERROR-002 |
| 1.2-BLIND-ERROR-005 | P1 | Database unavailable during user creation | AC2 | ERROR-002 |

### CONCURRENCY Category

| ID | Pri | Scenario | Applies To | Ref |
|----|-----|----------|------------|-----|
| 1.2-BLIND-CONCURRENCY-001 | P1 | Simultaneous login attempts with same code | AC2 | CONCURRENCY-002 |
| 1.2-BLIND-CONCURRENCY-002 | P2 | Race condition on error count increment | AC2 | CONCURRENCY-002 |

### DATA Category

| ID | Pri | Scenario | Applies To | Ref |
|----|-----|----------|------------|-----|
| 1.2-BLIND-DATA-001 | P1 | User creation rollback if JWT generation fails | AC2 | DATA-001 |

### FLOW Category

| ID | Pri | Scenario | Applies To | Ref |
|----|-----|----------|------------|-----|
| 1.2-BLIND-FLOW-001 | P2 | Double-click login button (duplicate submission) | AC2 | FLOW-002 |

---

## Risk Coverage

| Risk | Test IDs | Coverage |
|------|----------|----------|
| Brute force attack | 1.2-UNIT-011, 1.2-UNIT-013, 1.2-INT-009, 1.2-INT-011, 1.2-E2E-007 | Full |
| SMS service failure | 1.2-INT-005, 1.2-INT-006, 1.2-BLIND-ERROR-001, 1.2-BLIND-ERROR-002 | Full |
| Token theft/misuse | 1.2-INT-012, 1.2-INT-013, 1.2-INT-014, 1.2-INT-015 | Full |
| Rate limit bypass | 1.2-INT-002, 1.2-INT-003, 1.2-E2E-002 | Full |
| Data integrity (new user) | 1.2-INT-008, 1.2-BLIND-DATA-001 | Full |

---

## Execution Order

1. **P0 Unit Tests** (8 tests) - Core logic validation
2. **P0 Integration Tests** (10 tests) - Critical integrations
3. **P0 E2E Tests** (2 tests) - Critical user journeys
4. **P1 Unit Tests** (6 tests) - Secondary logic
5. **P1 Integration Tests** (6 tests) - Secondary integrations
6. **P1 E2E Tests** (4 tests) - Secondary journeys
7. **P1 Blind Spot Tests** (10 tests) - Edge cases
8. **P2 Tests** (6 tests) - Nice-to-have coverage

---

## Test Environment Requirements

| Component | Requirement |
|-----------|-------------|
| Redis | Test instance with configurable TTL |
| MySQL | Test database with users table |
| SMS Service | Mock service (do not use production) |
| Gateway | Test instance for E2E |

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 42
  by_level:
    unit: 18
    integration: 16
    e2e: 8
  by_priority:
    p0: 14
    p1: 18
    p2: 10
  blind_spot_scenarios:
    total: 16
    by_category:
      BOUNDARY: 7
      ERROR: 5
      CONCURRENCY: 2
      DATA: 1
      FLOW: 1
      RESOURCE: 0
  coverage_gaps: []
  security_coverage: complete
  story_type: backend_api
  test_design_level: comprehensive
```
