# Test Design: 4.1

2026-01-27 | JW

## Overview

Total: 44 | Unit: 28 (63.6%) | Int: 14 (31.8%) | E2E: 2 (4.5%)
Priority: P0: 11, P1: 26, P2: 7
Blind Spot Scenarios: 23

## Story Context

**Story**: 4.1 - TTS配音服务实现
**Type**: Backend API (MQ consumer, external TTS service, Redis, OSS)
**Complexity**: High (5 indicators)
**Test Design Level**: Comprehensive

**Architecture Summary**:
- task-service: REST API endpoints (compose trigger, voice-type update, progress query)
- media-service: MQ consumer, TTS orchestration via Volcano Seed-TTS, OSS upload
- Cross-service communication via RabbitMQ (compose.queue)
- Progress tracking via Redis Hash (task:progress:{taskId}, TTL 1h)

## Scenarios by AC

### AC1: 标准音色配音 (Standard Voice TTS)

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.1-UNIT-001 | U | P0 | VolcanoTtsClient: successful single paragraph TTS conversion → audio bytes + duration | Core TTS integration logic, pure client call with mocked HTTP |
| 4.1-UNIT-002 | U | P0 | VolcanoTtsClient: handle 504 timeout with exponential backoff retry (3x max) | Critical error handling, must verify retry count and backoff timing |
| 4.1-UNIT-003 | U | P0 | VolcanoTtsClient: text >5000 chars → automatic segmentation into chunks ≤5000 | Business rule BR-1.2 boundary, text splitting algorithm correctness |
| 4.1-UNIT-004 | U | P0 | TtsSynthesisService: orchestrate multi-paragraph synthesis → aggregate durations, collect audio URLs | Core orchestration logic, pure business flow with mocked dependencies |
| 4.1-UNIT-005 | U | P1 | TtsSynthesisService: upload generated audio to OSS path audio/{task_id}/tts_{paragraph_id}.mp3 | File path convention and upload delegation, mock OSS client |
| 4.1-UNIT-006 | U | P0 | ComposeService: validate task status = script_edited before publishing compose message | Status guard is critical path, prevents invalid state transitions |
| 4.1-UNIT-007 | U | P1 | ComposeService: publish ComposeMessage to compose.queue with correct payload structure | MQ message format correctness, mock publisher |
| 4.1-UNIT-008 | U | P1 | VoiceType validation: accept valid voice types (xiaomei, standard male, intellectual female) | Input validation, business rule BR-1.1 |
| 4.1-UNIT-009 | U | P1 | VoiceType validation: reject unknown voice type → 400 error | Input validation negative path |
| 4.1-INT-001 | I | P0 | POST /compose → MQ publish → ComposeMessageConsumer receives message with correct payload | Critical cross-service integration point via RabbitMQ |
| 4.1-INT-002 | I | P1 | PUT /voice-type → tasks.voice_type updated in DB → verify persistence | REST → DB persistence contract |
| 4.1-INT-003 | I | P0 | ComposeMessageConsumer → TtsSynthesisService: full synthesis flow with mocked TTS client | Consumer-to-service wiring verification |
| 4.1-INT-004 | I | P1 | Full compose flow: POST compose → MQ → consumer → mocked TTS → OSS upload → callback to task-service | Multi-component integration with all internal boundaries |
| 4.1-E2E-001 | E | P0 | Complete compose journey: select voice → POST compose → MQ → TTS synthesis → OSS upload → progress updates → callback completion | Revenue-critical end-to-end path, full system validation |

### AC2: 配音进度跟踪 (TTS Progress Tracking)

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.1-UNIT-010 | U | P0 | ComposeProgressService: read progress from Redis hash → return ComposeProgressResponse DTO | Core progress query logic, pure function with mocked Redis |
| 4.1-UNIT-011 | U | P0 | ComposeProgressService: update progress in Redis after paragraph completion (increment completed_paragraphs) | Progress write correctness, atomic Redis operation |
| 4.1-UNIT-012 | U | P1 | ComposeProgressService: estimate remaining time based on average paragraph duration × remaining count | Calculation algorithm correctness |
| 4.1-UNIT-013 | U | P1 | Single paragraph TTS failure → isolated retry without blocking other paragraphs' progress | Partial failure isolation logic |
| 4.1-INT-005 | I | P0 | GET /compose-progress → Redis read → correct ComposeProgressResponse JSON structure | REST endpoint → Redis → DTO contract |
| 4.1-INT-006 | I | P1 | TTS paragraph completion → Redis progress update → subsequent GET /compose-progress returns updated counts | Cross-component data flow (media-service writes, task-service reads) |
| 4.1-E2E-002 | E | P1 | Full progress tracking during compose: start → query shows 0/N → track increments → query shows N/N at completion | User-facing progress accuracy across full lifecycle |

## Blind Spot Scenarios [BLIND-SPOT]

### BOUNDARY Scenarios

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 4.1-BLIND-BOUNDARY-001 | BOUNDARY | P1 | Null/empty script text → reject compose with 400 error | BOUNDARY-001 |
| 4.1-BLIND-BOUNDARY-002 | BOUNDARY | P1 | Script with zero paragraphs array → reject compose with 400 error | BOUNDARY-001 |
| 4.1-BLIND-BOUNDARY-003 | BOUNDARY | P2 | Single paragraph exactly 5000 chars → process without segmentation | BOUNDARY-003 |
| 4.1-BLIND-BOUNDARY-004 | BOUNDARY | P1 | Single paragraph 5001 chars → trigger segmentation into 2 segments | BOUNDARY-004 |
| 4.1-BLIND-BOUNDARY-005 | BOUNDARY | P1 | Voice type as empty string or null in PUT /voice-type → 400 error | BOUNDARY-001 |
| 4.1-BLIND-BOUNDARY-006 | BOUNDARY | P1 | Compose request for non-existent task ID → 404 error | BOUNDARY-005 |

### ERROR Scenarios

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 4.1-BLIND-ERROR-001 | ERROR | P1 | TTS service returns malformed/unexpected JSON response → graceful error with structured message | ERROR-003 |
| 4.1-BLIND-ERROR-002 | ERROR | P1 | OSS upload fails (service unavailable) → mark synthesis as failed, report via callback | ERROR-002 |
| 4.1-BLIND-ERROR-003 | ERROR | P1 | RabbitMQ unavailable when publishing ComposeMessage → return 503 to client | ERROR-002 |
| 4.1-BLIND-ERROR-004 | ERROR | P1 | Redis unavailable for progress tracking → synthesis continues, progress query returns 503 | ERROR-002 |
| 4.1-BLIND-ERROR-005 | ERROR | P1 | TTS timeout exhausted after 3 retries → mark paragraph as failed, update progress | ERROR-001 |
| 4.1-BLIND-ERROR-006 | ERROR | P1 | Callback to task-service fails after successful TTS → retry callback with backoff | ERROR-004 |

### CONCURRENCY Scenarios

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 4.1-BLIND-CONCURRENCY-001 | CONCURRENCY | P1 | Duplicate POST /compose for same task (already composing) → reject with 409 conflict | CONCURRENCY-002 |
| 4.1-BLIND-CONCURRENCY-002 | CONCURRENCY | P2 | Concurrent GET /compose-progress queries → consistent Redis reads (no partial hash reads) | CONCURRENCY-004 |
| 4.1-BLIND-CONCURRENCY-003 | CONCURRENCY | P2 | Parallel paragraph completions update same Redis progress key → atomic HINCRBY correctness | CONCURRENCY-002 |

### DATA Scenarios

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 4.1-BLIND-DATA-001 | DATA | P1 | Task status transition atomicity: script_edited → composing must be atomic (no intermediate state visible) | DATA-001 |
| 4.1-BLIND-DATA-002 | DATA | P2 | Redis progress key TTL expires during long synthesis → progress data lost, query returns empty/default | DATA-002 |
| 4.1-BLIND-DATA-003 | DATA | P2 | Orphan audio files on OSS if task fails mid-synthesis (partial uploads not cleaned up) | DATA-004 |

### RESOURCE Scenarios

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 4.1-BLIND-RESOURCE-001 | RESOURCE | P1 | HTTP connection to TTS service released on timeout/error (connection pool not leaked) | RESOURCE-001 |
| 4.1-BLIND-RESOURCE-002 | RESOURCE | P2 | Temporary audio byte buffer cleared after OSS upload (no memory leak on large files) | RESOURCE-004 |
| 4.1-BLIND-RESOURCE-003 | RESOURCE | P2 | Redis connection returned to pool on progress query error | RESOURCE-001 |

### FLOW Scenarios

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 4.1-BLIND-FLOW-001 | FLOW | P1 | POST /compose when task status != script_edited (e.g., draft, completed) → 400 with clear error | FLOW-003 |
| 4.1-BLIND-FLOW-002 | FLOW | P1 | POST /compose when task already in composing status → 409 conflict, no duplicate MQ message | FLOW-002 |

## Risk Coverage

| Risk | Mitigated By |
|------|-------------|
| TTS service instability | 4.1-UNIT-002, 4.1-BLIND-ERROR-001, 4.1-BLIND-ERROR-005, 4.1-BLIND-RESOURCE-001 |
| Text size boundary violations | 4.1-UNIT-003, 4.1-BLIND-BOUNDARY-003, 4.1-BLIND-BOUNDARY-004 |
| MQ reliability | 4.1-INT-001, 4.1-BLIND-ERROR-003 |
| Redis data consistency | 4.1-INT-005, 4.1-INT-006, 4.1-BLIND-CONCURRENCY-002, 4.1-BLIND-CONCURRENCY-003, 4.1-BLIND-DATA-002 |
| Partial failure handling | 4.1-UNIT-013, 4.1-BLIND-ERROR-004, 4.1-BLIND-ERROR-006, 4.1-BLIND-DATA-003 |
| Duplicate request handling | 4.1-BLIND-CONCURRENCY-001, 4.1-BLIND-FLOW-002 |
| Invalid state transitions | 4.1-UNIT-006, 4.1-BLIND-FLOW-001, 4.1-BLIND-DATA-001 |

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 44
  by_level: {unit: 28, integration: 14, e2e: 2}
  by_priority: {p0: 11, p1: 26, p2: 7}
  blind_spot_scenarios:
    total: 23
    by_category: {BOUNDARY: 6, ERROR: 6, FLOW: 2, CONCURRENCY: 3, DATA: 3, RESOURCE: 3}
  coverage_gaps: []
```

## Execution Order

1. P0 Unit (7 scenarios): UNIT-001, 002, 003, 004, 006, 010, 011
2. P0 Integration (3 scenarios): INT-001, 003, 005
3. P0 E2E (1 scenario): E2E-001
4. P1 Unit (8 standard + 11 blind spot = 19 scenarios)
5. P1 Integration (3 standard + 5 blind spot = 8 scenarios)
6. P1 E2E (1 scenario): E2E-002
7. P2 Blind Spot (7 scenarios)

## Quality Checklist

**Standard Coverage**:
- [x] Every AC covered (AC1: 14 scenarios, AC2: 7 scenarios)
- [x] Levels appropriate (unit for logic, integration for boundaries, e2e for journeys)
- [x] No duplicates (each scenario tests distinct behavior)
- [x] Priorities align with risk (status guard, TTS core, progress = P0)
- [x] IDs follow convention (4.1-{LEVEL}-{SEQ})
- [x] Scenarios atomic (one behavior per scenario)

**Blind Spot Coverage**:
- [x] BOUNDARY scenarios for input fields (6 scenarios covering script text, paragraphs, voice type, task ID, char limits)
- [x] ERROR scenarios for external dependencies (6 scenarios: TTS, OSS, RabbitMQ, Redis, callback)
- [x] FLOW scenarios for multi-step processes (2 scenarios: invalid status, duplicate request)
- [x] CONCURRENCY scenarios for parallel operations (3 scenarios: duplicate compose, concurrent reads, parallel writes)
- [x] DATA scenarios for cross-service consistency (3 scenarios: atomicity, TTL, orphans)
- [x] RESOURCE scenarios for cleanup (3 scenarios: HTTP, memory, Redis connections)
- [x] All [BLIND-SPOT] scenarios tagged correctly
