# Test Design: Story 4.5 - 字幕设置页面

**Story ID**: 4.5
**Created**: 2026-02-03
**QA Engineer**: JW (QA Agent)
**Test Design Level**: Standard

---

## 1. Story Summary

**Title**: 字幕设置页面 (Subtitle Settings UI)

**Acceptance Criteria**:
- AC1: 字幕开关控制 - Toggle switch with default ON, API persistence, disabled state propagation
- AC2: 字幕样式模板选择 - 5 preset styles with selection, preview, and disabled states

**Story Type**: Full-stack (Frontend Vue 3 + Backend Spring Boot API)

**Components**:
- Frontend: SubtitleToggle, StyleSelector, StyleCard, SubtitleSettings, useSubtitleSettings
- Backend: PUT /api/v1/tasks/{id}/subtitle-settings endpoint

---

## 2. Test Scenarios

### 2.1 Unit Tests - Frontend Components

#### SubtitleToggle.vue

| Test ID | Scenario | Input | Expected | Priority | AC |
|---------|----------|-------|----------|----------|-----|
| 4.5-UNIT-001 | Toggle renders enabled state | enabled=true | Toggle switch is ON position | P0 | AC1 |
| 4.5-UNIT-002 | Toggle renders disabled state | enabled=false | Toggle switch is OFF position | P0 | AC1 |
| 4.5-UNIT-003 | Toggle emits update:enabled on click | User clicks toggle | Emits 'update:enabled' with !currentValue | P0 | AC1 |
| 4.5-UNIT-004 | Toggle shows label text | - | Displays "为视频添加字幕" | P1 | AC1 |
| 4.5-UNIT-005 | Toggle shows loading spinner | loading=true | Displays spinner, toggle disabled | P1 | AC1 |
| 4.5-UNIT-006 | Toggle disabled during loading | loading=true, click | No emit, no state change | P1 | AC1 |
| 4.5-UNIT-007 | Toggle disabled prop prevents interaction | disabled=true, click | No emit | P2 | AC1 |

#### StyleCard.vue

| Test ID | Scenario | Input | Expected | Priority | AC |
|---------|----------|-------|----------|----------|-----|
| 4.5-UNIT-008 | Card renders style name | style={name:'简约白字'} | Displays "简约白字" | P0 | AC2 |
| 4.5-UNIT-009 | Card renders preview image | style={previewUrl:'/img/x.png'} | Image src set correctly | P0 | AC2 |
| 4.5-UNIT-010 | Card selected state shows border | selected=true | Has blue border class (border-blue-500) | P0 | AC2 |
| 4.5-UNIT-011 | Card unselected state no border | selected=false | Has gray border class | P1 | AC2 |
| 4.5-UNIT-012 | Card emits select on click | click event | Emits 'select' with style.id | P0 | AC2 |
| 4.5-UNIT-013 | Card disabled state grayscale | disabled=true | Has grayscale filter class | P0 | AC2 |
| 4.5-UNIT-014 | Card disabled prevents click | disabled=true, click | No emit | P0 | AC2 |
| 4.5-UNIT-015 | Card hover effect when enabled | hover | Scale transform applied | P2 | AC2 |
| 4.5-UNIT-016 | Card no hover effect when disabled | disabled=true, hover | No scale transform | P2 | AC2 |
| 4.5-UNIT-017 | Card image fallback on error | img onerror | Shows placeholder or style name | P1 | AC2 |

#### StyleSelector.vue

| Test ID | Scenario | Input | Expected | Priority | AC |
|---------|----------|-------|----------|----------|-----|
| 4.5-UNIT-018 | Selector renders all 5 style cards | - | Renders 5 StyleCard components | P0 | AC2 |
| 4.5-UNIT-019 | Selector passes selected to correct card | selectedStyle='neon' | Only neon card has selected=true | P0 | AC2 |
| 4.5-UNIT-020 | Selector disabled prop propagates | disabled=true | All 5 cards receive disabled=true | P0 | AC2 |
| 4.5-UNIT-021 | Selector emits update:selectedStyle | Card emits select | Emits 'update:selectedStyle' with styleId | P0 | AC2 |
| 4.5-UNIT-022 | Selector default selection is simple_white | No selectedStyle prop | simple_white card selected | P1 | AC2 |

#### SubtitleSettings.vue (Container)

| Test ID | Scenario | Input | Expected | Priority | AC |
|---------|----------|-------|----------|----------|-----|
| 4.5-UNIT-023 | Container renders toggle and selector | - | Both SubtitleToggle and StyleSelector present | P0 | AC1,AC2 |
| 4.5-UNIT-024 | Container passes enabled to toggle | subtitleEnabled=true | Toggle receives enabled=true | P0 | AC1 |
| 4.5-UNIT-025 | Container passes style to selector | subtitleStyle='neon' | Selector receives selectedStyle='neon' | P0 | AC2 |
| 4.5-UNIT-026 | Container disables selector when toggle off | subtitleEnabled=false | StyleSelector receives disabled=true | P0 | AC1,AC2 |

#### useSubtitleSettings Composable

| Test ID | Scenario | Input | Expected | Priority | AC |
|---------|----------|-------|----------|----------|-----|
| 4.5-UNIT-027 | Initial state subtitleEnabled=true | composable init | subtitleEnabled.value === true | P0 | AC1 |
| 4.5-UNIT-028 | Initial state subtitleStyle=simple_white | composable init | subtitleStyle.value === 'simple_white' | P0 | AC2 |
| 4.5-UNIT-029 | toggleSubtitle calls API | toggleSubtitle() | API PUT called with new enabled value | P0 | AC1 |
| 4.5-UNIT-030 | toggleSubtitle success updates state | API returns 200 | subtitleEnabled toggled | P0 | AC1 |
| 4.5-UNIT-031 | toggleSubtitle error rolls back state | API returns 500 | subtitleEnabled unchanged, error set | P0 | AC1 |
| 4.5-UNIT-032 | setStyle calls API | setStyle('neon') | API PUT called with style='neon' | P0 | AC2 |
| 4.5-UNIT-033 | setStyle success updates state | API returns 200 | subtitleStyle updated to new value | P0 | AC2 |
| 4.5-UNIT-034 | setStyle error rolls back state | API returns 500 | subtitleStyle unchanged, error set | P0 | AC2 |
| 4.5-UNIT-035 | loading state during API call | toggleSubtitle() | loading.value === true during call | P1 | AC1 |
| 4.5-UNIT-036 | loadSettings fetches from task | loadSettings(taskId) | State populated from GET response | P1 | AC1,AC2 |

---

### 2.2 Unit Tests - Backend

| Test ID | Scenario | Input | Expected | Priority | AC |
|---------|----------|-------|----------|----------|-----|
| 4.5-UNIT-037 | DTO validation accepts valid style | {subtitleStyle:'neon'} | Validation passes | P0 | AC2 |
| 4.5-UNIT-038 | DTO validation rejects invalid style | {subtitleStyle:'invalid'} | Validation fails | P0 | AC2 |
| 4.5-UNIT-039 | DTO accepts boolean subtitleEnabled | {subtitleEnabled:true} | Validation passes | P0 | AC1 |
| 4.5-UNIT-040 | Service updateSubtitleSettings updates DB | valid request | tasks table updated | P0 | AC1,AC2 |
| 4.5-UNIT-041 | Service returns updated settings | valid request | Response contains new values | P1 | AC1,AC2 |

---

### 2.3 Integration Tests

| Test ID | Scenario | Input | Expected | Priority | AC |
|---------|----------|-------|----------|----------|-----|
| 4.5-INT-001 | PUT subtitle-settings returns 200 | Valid JSON body | 200 + updated settings | P0 | AC1,AC2 |
| 4.5-INT-002 | PUT with task not found | Non-existent taskId | 404 + TASK_NOT_FOUND error | P0 | AC1,AC2 |
| 4.5-INT-003 | PUT with invalid style value | {subtitleStyle:'bad'} | 400 + validation error | P0 | AC2 |
| 4.5-INT-004 | PUT unauthorized access | Other user's task | 403 + 无权访问此任务 | P1 | AC1,AC2 |
| 4.5-INT-005 | Toggle off disables style selector | Toggle off in UI | StyleSelector becomes disabled | P0 | AC1 |
| 4.5-INT-006 | Style selection with API success | Select different style | API called, UI updated, selection persisted | P0 | AC2 |
| 4.5-INT-007 | Toggle API error shows toast | API returns 500 | Toast displayed, toggle reverted | P0 | AC1 |
| 4.5-INT-008 | Style API error shows toast | API returns 500 | Toast displayed, selection reverted | P0 | AC2 |
| 4.5-INT-009 | Settings load on page mount | Navigate to settings page | Current subtitle settings displayed | P1 | AC1,AC2 |
| 4.5-INT-010 | Network timeout handling | API timeout | Toast displayed, state unchanged | P1 | AC1 |

---

### 2.4 E2E Tests

| Test ID | Scenario | Steps | Expected | Priority | AC |
|---------|----------|-------|----------|----------|-----|
| 4.5-E2E-001 | Complete subtitle toggle flow | 1. Open voice settings<br>2. Toggle subtitle off<br>3. Verify disabled<br>4. Toggle on<br>5. Verify enabled | Toggle persists, selector state follows | P0 | AC1 |
| 4.5-E2E-002 | Complete style selection flow | 1. Open voice settings<br>2. Click "霓虹炫彩"<br>3. Verify selected<br>4. Refresh page<br>5. Verify persisted | Style selection persists across refresh | P0 | AC2 |
| 4.5-E2E-003 | Disabled style selection | 1. Toggle subtitle off<br>2. Try click style card<br>3. Verify no change | Cards unclickable when disabled | P1 | AC1,AC2 |
| 4.5-E2E-004 | Error recovery flow | 1. Disconnect network<br>2. Toggle subtitle<br>3. Verify error toast<br>4. Verify state unchanged | Graceful error handling | P1 | AC1 |

---

## 3. Blind Spot Analysis

### 3.1 BOUNDARY - 边界条件测试

| Test ID | Scenario | Category | Priority |
|---------|----------|----------|----------|
| 4.5-BS-001 | Toggle rapid clicks (debounce) | BOUNDARY | P1 |
| 4.5-BS-002 | Style card long name truncation | BOUNDARY | P2 |
| 4.5-BS-003 | Preview image various sizes | BOUNDARY | P2 |
| 4.5-BS-004 | Empty taskId parameter | BOUNDARY | P1 |

### 3.2 ERROR - 错误处理场景

| Test ID | Scenario | Category | Priority |
|---------|----------|----------|----------|
| 4.5-BS-005 | API returns malformed JSON | ERROR | P1 |
| 4.5-BS-006 | Network disconnected mid-request | ERROR | P1 |
| 4.5-BS-007 | Server returns 503 | ERROR | P2 |
| 4.5-BS-008 | All preview images 404 | ERROR | P2 |

### 3.3 FLOW - 状态流转测试

| Test ID | Scenario | Category | Priority |
|---------|----------|----------|----------|
| 4.5-BS-009 | Toggle while style save in progress | FLOW | P1 |
| 4.5-BS-010 | Style change while toggle in progress | FLOW | P1 |
| 4.5-BS-011 | Page navigation during save | FLOW | P2 |
| 4.5-BS-012 | Multiple style clicks before response | FLOW | P1 |

### 3.4 CONCURRENCY - 并发与竞态条件

| Test ID | Scenario | Category | Priority |
|---------|----------|----------|----------|
| 4.5-BS-013 | Concurrent toggle and style change | CONCURRENCY | P1 |
| 4.5-BS-014 | Two tabs same task different actions | CONCURRENCY | P2 |

### 3.5 DATA - 数据完整性

| Test ID | Scenario | Category | Priority |
|---------|----------|----------|----------|
| 4.5-BS-015 | Task with null subtitle_enabled in DB | DATA | P1 |
| 4.5-BS-016 | Task with invalid subtitle_style in DB | DATA | P1 |

---

## 4. Test Summary

### 4.1 By Test Level

| Level | Count |
|-------|-------|
| Unit Tests (Frontend) | 36 |
| Unit Tests (Backend) | 5 |
| Integration Tests | 10 |
| E2E Tests | 4 |
| Blind Spot Tests | 16 |
| **Total** | **71** |

### 4.2 By Priority

| Priority | Count | Description |
|----------|-------|-------------|
| P0 | 32 | Must pass for release |
| P1 | 29 | Should pass, minor impact if fail |
| P2 | 10 | Nice to have, edge cases |

### 4.3 By Acceptance Criteria

| AC | Test Count |
|----|------------|
| AC1 (Toggle) | 28 |
| AC2 (Style) | 35 |
| AC1+AC2 | 8 |

---

## 5. AC Traceability Matrix

| AC | Business Rules | Test IDs |
|----|----------------|----------|
| AC1 | BR-1.1 默认开启 | 4.5-UNIT-001, 4.5-UNIT-027 |
| AC1 | BR-1.2 实时保存 | 4.5-UNIT-029, 4.5-UNIT-030, 4.5-INT-001 |
| AC1 | BR-1.3 关闭置灰 | 4.5-UNIT-026, 4.5-INT-005 |
| AC1 | BR-1.4 DB同步 | 4.5-UNIT-040, 4.5-INT-001 |
| AC2 | BR-2.1 5种样式 | 4.5-UNIT-018 |
| AC2 | BR-2.2 默认simple_white | 4.5-UNIT-022, 4.5-UNIT-028 |
| AC2 | BR-2.3 实时保存 | 4.5-UNIT-032, 4.5-UNIT-033, 4.5-INT-006 |
| AC2 | BR-2.4 卡片显示 | 4.5-UNIT-008, 4.5-UNIT-009 |
| AC2 | BR-2.5 选中高亮 | 4.5-UNIT-010, 4.5-UNIT-011 |

---

## 6. Testing Framework & Tools

### Frontend
- **Test Runner**: Vitest
- **Component Testing**: @vue/test-utils
- **API Mocking**: MSW (Mock Service Worker) or vi.mock
- **Coverage**: vitest --coverage

### Backend
- **Test Runner**: JUnit 5
- **Mocking**: Mockito
- **API Testing**: MockMvc
- **Validation Testing**: @WebMvcTest with BindingResult

---

## 7. Recommendations

1. **Priority Focus**: Start with P0 unit tests for components, then integration tests
2. **Mock Strategy**: Use MSW for frontend API mocking to test error scenarios
3. **Composable Testing**: Apply vi.stubGlobal pattern learned from Story 4.4 if needed
4. **Backend First**: API endpoint should be ready before frontend integration tests
5. **Image Assets**: Use placeholder images during test development

---

## 8. Handoff to Dev

**Status Change**: AwaitingTestDesign → TestDesignComplete

**Test Design Document**: `docs/qa/assessments/4.5-test-design-20260203.md`

**Key Points for Dev**:
1. 71 test scenarios designed (36 unit frontend, 5 unit backend, 10 integration, 4 E2E, 16 blind spot)
2. Test IDs follow pattern: 4.5-UNIT-XXX, 4.5-INT-XXX, 4.5-E2E-XXX, 4.5-BS-XXX
3. Apply vi.stubGlobal pattern from Story 4.4 for any module-level singletons
4. Focus on optimistic update + rollback pattern in useSubtitleSettings
5. Ensure disabled state propagation from toggle to style selector

**Next Step**: Dev to implement code with test coverage based on this design.

---

*Generated by QA Agent (JW) - 2026-02-03*
