# Test Design: 4.3 - Video Composition

2026-01-28 | JW

## Overview

Total: 49 | Unit: 21 (43%) | Int: 22 (45%) | E2E: 6 (12%)
Priority: P0: 13, P1: 30, P2: 6
Blind Spot Scenarios: 16

## Scenarios by AC

### AC1: 视频片段裁剪

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.3-UNIT-001 | U | P0 | Center position calculation: start = (video_duration - segment_duration) / 2 | Pure arithmetic logic, critical correctness (BR-1.3) |
| 4.3-UNIT-002 | U | P0 | Segment duration = TTS actual duration + 0.5s transition | Pure calculation (BR-1.2) |
| 4.3-UNIT-003 | U | P1 | Recommended shot selection (is_recommended=true prioritized) | Business rule logic (BR-1.1) |
| 4.3-UNIT-004 | U | P1 | Video too short: loop handling via `-stream_loop -1` | Error recovery logic, isolatable |
| 4.3-UNIT-005 | U | P0 | FFmpeg cut command construction: `-ss {start} -t {duration} -c copy` | Command correctness, mockable process |
| 4.3-UNIT-006 | U | P1 | shot_id not found → 404 error with task marked failed | Error path, isolated validation |
| 4.3-INT-001 | I | P0 | Full segment cutting pipeline: DB query → OSS download → FFmpeg cut → temp file | Multi-component integration |
| 4.3-INT-002 | I | P1 | FFmpeg cut failure with 1x automatic retry | Retry mechanism across components |

### AC2: 音视频合成

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.3-UNIT-007 | U | P0 | FFmpeg concat demuxer command construction with segments.txt | Command correctness, core pipeline |
| 4.3-UNIT-008 | U | P1 | Audio merge command: download TTS files → merge into single track | Audio processing logic |
| 4.3-UNIT-009 | U | P0 | Output format params: H.264, 1080x1920, 4Mbps, 30fps, AAC 128k, faststart | Business rules BR-2.1~BR-2.7 |
| 4.3-UNIT-010 | U | P1 | Scale/pad filter for non-standard aspect ratio: `scale=1080:1920:force_original_aspect_ratio=decrease,pad=...` | Visual correctness (BR-2.2) |
| 4.3-UNIT-011 | U | P1 | segments.txt generation: correct file format for FFmpeg concat | File format correctness |
| 4.3-INT-003 | I | P0 | Full composition pipeline: concat segments + overlay audio → output MP4 | Core multi-component flow |
| 4.3-INT-004 | I | P1 | OSS upload failure with 2x retry, 5s interval | Retry mechanism with external service |
| 4.3-INT-005 | I | P1 | Callback to task-service with outputOssKey, outputDurationSeconds, outputFileSize | Cross-service integration |
| 4.3-INT-006 | I | P1 | Callback failure retry: 3x attempts, 10s interval | Retry mechanism with external service |
| 4.3-E2E-001 | E | P0 | Complete pipeline: ComposeMessage → TTS → subtitle → cut → compose → upload → callback → GET /output | Critical full journey |

### AC3: 字幕生成与烧录

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.3-UNIT-012 | U | P0 | ASS file generation with [Script Info], [V4+ Styles], [Events] sections | Format correctness, core subtitle feature |
| 4.3-UNIT-013 | U | P0 | Time axis cumulative calculation: each paragraph start = sum of previous durations | Critical timing logic |
| 4.3-UNIT-014 | U | P1 | Dual-line scrolling: current line normal + next line semi-transparent | Visual effect logic (BR-3.2) |
| 4.3-UNIT-015 | U | P1 | Auto-wrap at 20 Chinese characters using `\N` line break | Text processing (BR-3.5) |
| 4.3-UNIT-016 | U | P1 | 5 preset style constants: simple_white, vibrant_yellow, xiaohongshu, douyin_hot, neon | Style definition validation (BR-3.6) |
| 4.3-UNIT-017 | U | P0 | subtitleEnabled=false skips subtitle generation entirely | Feature toggle (BR-3.4) |
| 4.3-UNIT-018 | U | P2 | Semi-transparent next line alpha=80 (`\alpha&H80`) | Visual detail (BR-3.2 sub-detail) |
| 4.3-INT-007 | I | P1 | Subtitle burn integration: `-vf "subtitles=subtitle.ass"` added to FFmpeg command | Component integration |
| 4.3-INT-008 | I | P0 | Graceful degradation: subtitle generation fails → continue without subtitles | Non-blocking error path, critical reliability |

### Cross-AC: Pipeline & Output Endpoint

| ID | Lvl | Pri | Test | Why |
|----|-----|-----|------|-----|
| 4.3-INT-009 | I | P1 | ComposeProgressTracker phase updates: tts → subtitle → cutting → composition → upload | Multi-phase tracking |
| 4.3-INT-010 | I | P1 | Temporary file cleanup after successful composition | Resource management |
| 4.3-INT-011 | I | P0 | GET /api/v1/tasks/{id}/output returns OutputResponse with video URL, duration, size | New endpoint validation |
| 4.3-INT-012 | I | P1 | GET /api/v1/tasks/{id}/output returns 404 OUTPUT_NOT_READY when task not completed | Error path for new endpoint |
| 4.3-E2E-002 | E | P1 | FFmpeg composition failure → 2x retry → task marked failed with error_message | Full error journey |
| 4.3-E2E-003 | E | P1 | Subtitle failure → fallback → video delivered without subtitles | Degradation journey |

## Blind Spot Scenarios [BLIND-SPOT]

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 4.3-BLIND-BOUNDARY-001 | BOUNDARY | P1 | Empty paragraphs list in ComposeMessage → graceful error | BOUNDARY-001 |
| 4.3-BLIND-BOUNDARY-002 | BOUNDARY | P2 | Video duration exactly equals needed duration (center offset = 0) | BOUNDARY-002 |
| 4.3-BLIND-BOUNDARY-003 | BOUNDARY | P2 | Single paragraph input (minimum segment count) | BOUNDARY-002 |
| 4.3-BLIND-BOUNDARY-004 | BOUNDARY | P1 | TTS actual duration = 0 seconds (degenerate case) | BOUNDARY-002 |
| 4.3-BLIND-BOUNDARY-005 | BOUNDARY | P1 | Unknown/invalid subtitle_style value → fallback to default | BOUNDARY-005 |
| 4.3-BLIND-ERROR-001 | ERROR | P1 | OSS download failure when fetching source video for cutting | ERROR-001 |
| 4.3-BLIND-ERROR-002 | ERROR | P1 | FFmpeg binary not found or not executable at configured path | ERROR-002 |
| 4.3-BLIND-ERROR-003 | ERROR | P1 | Partial segment cutting failure: 3rd of 5 segments fails after 2 succeed | ERROR-004 |
| 4.3-BLIND-ERROR-004 | ERROR | P2 | Corrupted/invalid audio file received from TTS service | ERROR-003 |
| 4.3-BLIND-CONCURRENCY-001 | CONCURRENCY | P1 | Duplicate ComposeMessage consumed for same task_id | CONCURRENCY-002 |
| 4.3-BLIND-DATA-001 | DATA | P1 | Task status transition atomicity: composing → completed with all output fields | DATA-001 |
| 4.3-BLIND-DATA-002 | DATA | P2 | Callback updates all output fields atomically (no partial update) | DATA-001 |
| 4.3-BLIND-RESOURCE-001 | RESOURCE | P1 | Temp files cleaned on failure path (not just success) | RESOURCE-003 |
| 4.3-BLIND-RESOURCE-002 | RESOURCE | P1 | Downloaded source video files deleted after cutting completes | RESOURCE-003 |
| 4.3-BLIND-RESOURCE-003 | RESOURCE | P2 | Large video file handling without full memory load (streaming) | RESOURCE-004 |
| 4.3-BLIND-FLOW-001 | FLOW | P1 | Reprocessing same task after failure (idempotency check) | FLOW-002 |

## Risk Coverage

| Risk | Scenarios Mitigating |
|------|---------------------|
| FFmpeg process failure | UNIT-005, INT-001, INT-002, E2E-002, BLIND-ERROR-002 |
| Video quality/format issues | UNIT-009, UNIT-010, INT-003 |
| Subtitle rendering incorrect | UNIT-012, UNIT-013, UNIT-014, UNIT-015, UNIT-018 |
| Data loss (temp files) | INT-010, BLIND-RESOURCE-001, BLIND-RESOURCE-002 |
| Pipeline reliability | E2E-001, E2E-002, E2E-003, BLIND-ERROR-003, BLIND-FLOW-001 |
| OSS upload failure | INT-004, BLIND-ERROR-001 |
| Callback failure | INT-005, INT-006, BLIND-DATA-001 |
| Concurrent processing | BLIND-CONCURRENCY-001 |

## Execution Order

1. P0 Unit (7): UNIT-001, UNIT-002, UNIT-005, UNIT-007, UNIT-009, UNIT-012, UNIT-013, UNIT-017
2. P0 Integration (4): INT-001, INT-003, INT-008, INT-011
3. P0 E2E (1): E2E-001
4. P1 Unit (7): UNIT-003, UNIT-004, UNIT-006, UNIT-008, UNIT-010, UNIT-011, UNIT-014, UNIT-015, UNIT-016
5. P1 Integration (10): INT-002, INT-004, INT-005, INT-006, INT-007, INT-009, INT-010, INT-012
6. P1 Blind Spot (10): BLIND-BOUNDARY-001, BOUNDARY-004, BOUNDARY-005, ERROR-001, ERROR-002, ERROR-003, CONCURRENCY-001, DATA-001, RESOURCE-001, RESOURCE-002, FLOW-001
7. P1 E2E (2): E2E-002, E2E-003
8. P2 (6): UNIT-018, BLIND-BOUNDARY-002, BOUNDARY-003, ERROR-004, DATA-002, RESOURCE-003

## Gate YAML

```yaml
test_design:
  scenarios_total: 49
  by_level: {unit: 21, integration: 22, e2e: 6}
  by_priority: {p0: 13, p1: 30, p2: 6}
  blind_spot_scenarios:
    total: 16
    by_category: {BOUNDARY: 5, ERROR: 4, FLOW: 1, CONCURRENCY: 1, DATA: 2, RESOURCE: 3}
  coverage_gaps: []
```
