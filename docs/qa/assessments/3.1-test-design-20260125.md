# Test Design: 3.1 - AI脚本生成服务

**Date:** 2026-01-25 | **QA Engineer:** JW

---

## Overview

| Metric | Count |
|--------|-------|
| **Total Scenarios** | 32 |
| **Unit Tests** | 14 (44%) |
| **Integration Tests** | 16 (50%) |
| **E2E Tests** | 2 (6%) |
| **Priority** | P0: 8, P1: 14, P2: 10 |
| **Blind Spot Scenarios** | 12 |

---

## Scenarios by AC

### AC1: 调用豆包API生成脚本

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 3.1-UNIT-001 | U | P0 | Prompt includes shop_name, shop_type, promotion_text | Core prompt building |
| 3.1-UNIT-002 | U | P0 | Prompt includes shot_summaries from analyzed videos | Critical data inclusion |
| 3.1-UNIT-003 | U | P1 | Prompt template varies by video_style (recommend/review/vlog) | BR-1.4 |
| 3.1-UNIT-004 | U | P1 | Parse valid JSON response into paragraphs array | Response parsing |
| 3.1-UNIT-005 | U | P1 | Validate paragraph count (5-7 range) | BR-1.1 |
| 3.1-UNIT-006 | U | P1 | Validate each paragraph has shot_id reference | BR-1.2 |
| 3.1-UNIT-007 | U | P1 | Validate total_duration ~60s (±10s tolerance) | BR-1.3 |
| 3.1-INT-001 | I | P0 | Generate script successfully → insert to scripts table | Core flow |
| 3.1-INT-002 | I | P0 | Generate script → update task.status='script_ready' | State transition |
| 3.1-INT-003 | I | P0 | Doubao API timeout → retry 2x with 5s, 10s backoff | Error handling |
| 3.1-INT-004 | I | P1 | Doubao API returns error → task.status='failed', log error | 50302 handling |
| 3.1-INT-005 | I | P1 | Invalid JSON response → retry with adjusted temperature | 50301 handling |
| 3.1-INT-006 | I | P2 | All retries exhausted → final failure status | Retry exhaustion |
| 3.1-INT-007 | I | P2 | Script generation triggered after analysis completion | Integration trigger |

---

### AC2: 重新生成脚本

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 3.1-UNIT-008 | U | P0 | Regenerate count check (count < 5 allows) | BR-2.1 |
| 3.1-UNIT-009 | U | P0 | Regenerate count check (count >= 5 rejects) | BR-2.1 boundary |
| 3.1-UNIT-010 | U | P1 | Temperature increases on regeneration (0.7→0.8→0.9) | Prompt variation |
| 3.1-INT-008 | I | P0 | POST regenerate → new version, count++ | Core regeneration |
| 3.1-INT-009 | I | P1 | Regenerate updates scripts.version (1→2→3...) | BR-2.2 |
| 3.1-INT-010 | I | P1 | Previous script version preserved | Version history |
| 3.1-INT-011 | I | P1 | Count=5 → return 429, regenerate_remaining=0 | Limit enforcement |

---

### API Endpoint Tests (T3)

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 3.1-INT-012 | I | P1 | GET /tasks/{id}/script → return script content | Read endpoint |
| 3.1-INT-013 | I | P1 | GET /tasks/{id}/script with invalid id → 404 | Not found |
| 3.1-INT-014 | I | P1 | GET /tasks/{id}/script before generation → 404 | Pre-generation |
| 3.1-INT-015 | I | P2 | POST regenerate with invalid task_id → 404 | Validation |
| 3.1-INT-016 | I | P2 | Response includes regenerate_remaining field | UI enablement |

---

## Blind Spot Scenarios [BLIND-SPOT]

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 3.1-BLIND-BOUNDARY-001 | BOUNDARY | P1 | Empty shop_name in prompt building | BOUNDARY-001 |
| 3.1-BLIND-BOUNDARY-002 | BOUNDARY | P1 | Empty shot_summaries (no analyzed videos) | BOUNDARY-001 |
| 3.1-BLIND-BOUNDARY-003 | BOUNDARY | P2 | Regenerate count exactly at limit (count=4→5) | BOUNDARY-002 |
| 3.1-BLIND-ERROR-001 | ERROR | P1 | Doubao API returns malformed JSON | ERROR-003 |
| 3.1-BLIND-ERROR-002 | ERROR | P1 | Doubao API returns valid JSON missing required fields | ERROR-003 |
| 3.1-BLIND-ERROR-003 | ERROR | P2 | Database connection lost during script save | ERROR-002 |
| 3.1-BLIND-DATA-001 | DATA | P1 | Script insert fails → task.status NOT updated | DATA-001 |
| 3.1-BLIND-DATA-002 | DATA | P2 | Regenerate fails mid-update → version rollback | DATA-001 |
| 3.1-BLIND-CONCURRENCY-001 | CONCURRENCY | P2 | Concurrent regenerate requests for same task | CONCURRENCY-001 |
| 3.1-BLIND-RESOURCE-001 | RESOURCE | P2 | HTTP client connection released after timeout | RESOURCE-001 |
| 3.1-BLIND-FLOW-001 | FLOW | P2 | Regenerate called before initial generation | FLOW-003 |
| 3.1-BLIND-FLOW-002 | FLOW | P2 | Script generation triggered for non-analyzed task | FLOW-003 |

---

## Execution Order

1. **P0 Unit Tests** (4 scenarios) - Business rule validation
2. **P0 Integration Tests** (4 scenarios) - Core flows
3. **P1 Unit Tests** (6 scenarios) - Secondary logic
4. **P1 Integration Tests** (8 scenarios) - API & error handling
5. **P1 Blind Spot** (5 scenarios) - Critical edge cases
6. **P2 All** (10 scenarios) - Extended coverage

---

## Test Environment Requirements

| Requirement | Details |
|-------------|---------|
| Doubao API Mock | WireMock or similar for HTTP mocking |
| Test Database | In-memory H2 or test MySQL instance |
| Timeout Simulation | Configurable delay injection |
| Test Data | Pre-populated tasks with analyzed videos |

---

## Risk Coverage

| Risk | Mitigated By |
|------|--------------|
| Doubao API unreliable | 3.1-INT-003, 3.1-INT-004, 3.1-INT-005 |
| Invalid AI responses | 3.1-UNIT-004, 3.1-BLIND-ERROR-001, 3.1-BLIND-ERROR-002 |
| Regeneration abuse | 3.1-UNIT-008, 3.1-UNIT-009, 3.1-INT-011 |
| Data inconsistency | 3.1-BLIND-DATA-001, 3.1-BLIND-DATA-002 |

---

## Quality Checklist

- [x] Every AC covered (AC1: 14 scenarios, AC2: 7 scenarios)
- [x] Levels appropriate (Unit for logic, Integration for I/O)
- [x] No duplicates (checked for overlap)
- [x] Priorities align with risk (P0 for revenue-critical)
- [x] IDs follow convention (3.1-{LEVEL}-{SEQ})
- [x] Scenarios atomic (single behavior per test)
- [x] BOUNDARY scenarios for inputs (3 scenarios)
- [x] ERROR scenarios for external deps (3 scenarios)
- [x] DATA scenarios for transactions (2 scenarios)
- [x] All [BLIND-SPOT] scenarios tagged (12 total)
