# Test Design: 2.3 AI Shot Analysis

**Date:** 2026-01-22 | **QA Engineer:** JW

---

## Overview

| Metric | Value |
|--------|-------|
| **Total Scenarios** | 32 |
| **Unit Tests** | 14 (44%) |
| **Integration Tests** | 12 (38%) |
| **E2E Tests** | 6 (19%) |
| **Priority Distribution** | P0: 8, P1: 14, P2: 8, P3: 2 |
| **Blind Spot Scenarios** | 12 |

---

## Scenarios by AC

### AC1: 集成通义千问VL进行镜头分析

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 2.3-UNIT-001 | U | P0 | Validate frame input format (JPEG, valid dimensions) | Input validation - pure function |
| 2.3-UNIT-002 | U | P0 | Parse Qwen-VL JSON response correctly | Response parsing - core logic |
| 2.3-UNIT-003 | U | P1 | Validate category enum (food/person/environment/other) | Business rule BR-1.1 validation |
| 2.3-UNIT-004 | U | P1 | Validate tag count ≤5 (truncate if exceeds) | Business rule BR-1.2 enforcement |
| 2.3-UNIT-005 | U | P1 | Validate quality score range 0-100 (clamp) | Business rule BR-1.3 boundary |
| 2.3-UNIT-006 | U | P2 | Calculate quality score from factors (clarity, composition, lighting, stability) | BR-1.3 composite scoring |
| 2.3-INT-001 | I | P0 | Qwen-VL API call with valid frame returns expected structure | External API integration |
| 2.3-INT-002 | I | P0 | Retry logic: 3 retries on 504 timeout | Error handling per spec |
| 2.3-INT-003 | I | P1 | Skip frame on 422, continue processing others | Error handling per spec |
| 2.3-INT-004 | I | P1 | Batch frame processing (parallel API calls) | Performance - multi-component |
| 2.3-INT-005 | I | P1 | Persist analysis results to videos table | DB operation verification |
| 2.3-INT-006 | I | P2 | Queue message consumption from analysis.queue | Message queue integration |
| 2.3-E2E-001 | E | P0 | POST /api/v1/tasks/{id}/analyze triggers full analysis | Critical API endpoint |
| 2.3-E2E-002 | E | P1 | GET /api/v1/tasks/{id}/analysis-progress returns accurate progress | User-facing progress tracking |

### AC2: 标记推荐镜头

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 2.3-UNIT-007 | U | P0 | Group frames by category correctly | Core algorithm - grouping |
| 2.3-UNIT-008 | U | P0 | Sort frames by quality score descending | Core algorithm - sorting |
| 2.3-UNIT-009 | U | P1 | Mark exactly top 2 per category as recommended | BR-2.1 enforcement |
| 2.3-UNIT-010 | U | P2 | Handle tie-breaking when scores equal | Edge case - deterministic behavior |
| 2.3-UNIT-011 | U | P2 | Handle category with <2 frames (mark all as recommended) | Edge case - insufficient frames |
| 2.3-INT-007 | I | P1 | Recommendation algorithm with real video data | Integration with actual data |
| 2.3-INT-008 | I | P1 | Update is_recommended flag in videos table | DB operation - BR-2.2 |
| 2.3-E2E-003 | E | P1 | Full flow: analyze → recommend → verify recommendations in response | End-to-end journey |

---

## Blind Spot Scenarios [BLIND-SPOT]

| ID | Category | Pri | Scenario | Blind Spot Ref |
|----|----------|-----|----------|----------------|
| 2.3-BLIND-BOUNDARY-001 | BOUNDARY | P1 | Empty frames array (zero frames extracted) | BOUNDARY-001 |
| 2.3-BLIND-BOUNDARY-002 | BOUNDARY | P1 | Single frame input (minimum case) | BOUNDARY-002 |
| 2.3-BLIND-BOUNDARY-003 | BOUNDARY | P2 | Quality score at boundaries (0 and 100) | BOUNDARY-002/003 |
| 2.3-BLIND-BOUNDARY-004 | BOUNDARY | P2 | Max tags exceeded in Qwen-VL response (>5) | BOUNDARY-004 |
| 2.3-BLIND-ERROR-001 | ERROR | P0 | Qwen-VL returns malformed JSON | ERROR-003 |
| 2.3-BLIND-ERROR-002 | ERROR | P1 | Qwen-VL returns 500 Internal Server Error | ERROR-002 |
| 2.3-BLIND-ERROR-003 | ERROR | P1 | Frame file not found/corrupted | ERROR-002 |
| 2.3-BLIND-ERROR-004 | ERROR | P2 | Partial batch failure (3/10 frames fail) | ERROR-004 |
| 2.3-BLIND-CONCURRENCY-001 | CONCURRENCY | P1 | Multiple analysis requests for same task | CONCURRENCY-002 |
| 2.3-BLIND-DATA-001 | DATA | P1 | Analysis results persist correctly to videos table | DATA-001 |
| 2.3-BLIND-RESOURCE-001 | RESOURCE | P2 | Temporary frame files cleaned up after analysis | RESOURCE-003 |
| 2.3-BLIND-FLOW-001 | FLOW | P3 | Re-trigger analysis on already-analyzed task | FLOW-002 |

---

## Risk Coverage

| Risk | Mitigating Scenarios |
|------|----------------------|
| AI service unavailability | 2.3-INT-002, 2.3-INT-003, 2.3-BLIND-ERROR-002 |
| Data corruption | 2.3-BLIND-ERROR-001, 2.3-INT-005, 2.3-BLIND-DATA-001 |
| Performance degradation | 2.3-INT-004, 2.3-BLIND-CONCURRENCY-001 |
| Business rule violations | 2.3-UNIT-003, 2.3-UNIT-004, 2.3-UNIT-005, 2.3-UNIT-009 |

---

## Execution Order

1. **P0 Unit** (4 scenarios): Core logic validation
2. **P0 Integration** (2 scenarios): Critical external integration
3. **P0 E2E** (1 scenario): Primary API endpoint
4. **P1 Unit + Integration** (10 scenarios): Feature completeness
5. **P1 Blind Spot** (6 scenarios): Edge case coverage
6. **P2+ scenarios**: As time permits

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 14
    integration: 12
    e2e: 6
  by_priority:
    p0: 8
    p1: 14
    p2: 8
    p3: 2
  blind_spot_scenarios:
    total: 12
    by_category:
      BOUNDARY: 4
      ERROR: 4
      CONCURRENCY: 1
      DATA: 1
      RESOURCE: 1
      FLOW: 1
  coverage_gaps: []
  design_date: "2026-01-22"
  designed_by: "JW"
```

---

## Trace References

- Test Design: `docs/qa/assessments/2.3-test-design-20260122.md`
- Story: `docs/stories/2.3.ai-shot-analysis.md`
- Architecture: `docs/architecture.md - Section 4.4`
