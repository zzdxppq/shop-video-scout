# Test Design: 1.2 - API网关路由和认证

**Date:** 2026-01-15 | **Author:** JW (QA Engineer)

## Overview

| Metric | Value |
|--------|-------|
| **Total Scenarios** | 34 |
| **Unit Tests** | 6 (18%) |
| **Integration Tests** | 16 (47%) |
| **Blind Spot Scenarios** | 12 (35%) |

**Priority Distribution:**
- P0: 14 (Critical - Security)
- P1: 14 (High - Core functionality)
- P2: 6 (Medium - Edge cases)

**Blind Spot Coverage:**
- BOUNDARY: 4 scenarios
- ERROR: 4 scenarios
- CONCURRENCY: 2 scenarios
- RESOURCE: 1 scenario
- FLOW: 1 scenario

---

## Scenarios by AC

### AC1: 路由配置

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 1.2-UNIT-001 | U | P1 | Route predicate path matching logic | Pure routing logic |
| 1.2-INT-001 | I | P0 | Request to `/api/v1/auth/**` routes to user-service | Critical route verification |
| 1.2-INT-002 | I | P0 | Request to `/api/v1/tasks/**` routes to task-service | Critical route verification |
| 1.2-INT-003 | I | P1 | Request to `/api/v1/ai/**` routes to ai-service | Service routing |
| 1.2-INT-004 | I | P1 | Request to `/api/v1/media/**` routes to media-service | Service routing |
| 1.2-INT-005 | I | P1 | Request to `/api/v1/publish/**` routes to publish-service | Service routing |
| 1.2-INT-006 | I | P1 | Request to `/api/v1/voice/**` routes to user-service | Voice route (from Dev Notes) |
| 1.2-INT-007 | I | P1 | Unknown route returns 404 | Invalid route handling |
| 1.2-INT-008 | I | P2 | CORS headers present in response | Cross-origin support |

---

### AC2: JWT Token验证 (Security Critical)

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 1.2-UNIT-002 | U | P0 | JWT token parsing extracts claims correctly | Core security logic |
| 1.2-UNIT-003 | U | P0 | Token signature validation (valid signature) | Security verification |
| 1.2-UNIT-004 | U | P0 | Token signature validation (invalid signature) | Security rejection |
| 1.2-UNIT-005 | U | P0 | Token expiry check (non-expired token) | Time validation |
| 1.2-UNIT-006 | U | P0 | Token expiry check (expired token) | Time validation |
| 1.2-INT-009 | I | P0 | Request without token to protected endpoint returns 401 | Auth enforcement |
| 1.2-INT-010 | I | P0 | Request with valid token passes through | Happy path |
| 1.2-INT-011 | I | P0 | Request with expired token returns 401 (Token expired) | Expiry handling |
| 1.2-INT-012 | I | P0 | Request with invalid signature returns 401 | Security rejection |
| 1.2-INT-013 | I | P0 | Whitelist path `/api/v1/auth/send-code` bypasses auth | Whitelist check |
| 1.2-INT-014 | I | P0 | Whitelist path `/api/v1/auth/login` bypasses auth | Whitelist check |
| 1.2-INT-015 | I | P1 | X-User-Id header added to forwarded request | User context propagation |
| 1.2-INT-016 | I | P1 | Malformed Bearer token format returns 401 | Format validation |

---

### AC3: 限流熔断配置

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 1.2-INT-017 | I | P1 | Requests below 100 QPS pass through | Rate limit baseline |
| 1.2-INT-018 | I | P1 | Request exceeding 100 QPS returns 429 | Rate limit enforcement |
| 1.2-INT-019 | I | P1 | Rate limit per IP isolation | Multi-client isolation |
| 1.2-INT-020 | I | P1 | Circuit opens when failure rate >50% | Circuit breaker trigger |
| 1.2-INT-021 | I | P2 | Circuit half-open after 30s recovery | Recovery behavior |
| 1.2-INT-022 | I | P2 | Circuit closes after successful requests | Recovery completion |

---

## Blind Spot Scenarios [BLIND-SPOT]

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 1.2-BLIND-BOUNDARY-001 | BOUNDARY | P1 | Empty Authorization header | BOUNDARY-001 |
| 1.2-BLIND-BOUNDARY-002 | BOUNDARY | P1 | Token with only "Bearer " (no token value) | BOUNDARY-001 |
| 1.2-BLIND-BOUNDARY-003 | BOUNDARY | P1 | Token at exact expiry timestamp | BOUNDARY-002 |
| 1.2-BLIND-BOUNDARY-004 | BOUNDARY | P2 | Extremely long token (>8KB) | BOUNDARY-003 |
| 1.2-BLIND-ERROR-001 | ERROR | P1 | Downstream service timeout | ERROR-001 |
| 1.2-BLIND-ERROR-002 | ERROR | P1 | Downstream service returns 503 | ERROR-002 |
| 1.2-BLIND-ERROR-003 | ERROR | P1 | Nacos service discovery unavailable | ERROR-002 |
| 1.2-BLIND-ERROR-004 | ERROR | P2 | Downstream returns malformed response | ERROR-003 |
| 1.2-BLIND-CONCURRENCY-001 | CONCURRENCY | P1 | Burst of 200 concurrent requests from same IP | CONCURRENCY-002 |
| 1.2-BLIND-CONCURRENCY-002 | CONCURRENCY | P2 | Rate limit counter race condition | CONCURRENCY-002 |
| 1.2-BLIND-RESOURCE-001 | RESOURCE | P2 | Connection pool exhaustion under load | RESOURCE-001 |
| 1.2-BLIND-FLOW-001 | FLOW | P2 | Token expires mid-request processing | FLOW-004 |

---

## Risk Coverage

| Risk | Mitigated By |
|------|--------------|
| Unauthorized access | 1.2-INT-009 through 1.2-INT-014, 1.2-UNIT-002 through 1.2-UNIT-006 |
| Service unavailability | 1.2-BLIND-ERROR-001 through 1.2-BLIND-ERROR-003 |
| DDoS/Rate abuse | 1.2-INT-017 through 1.2-INT-019, 1.2-BLIND-CONCURRENCY-001 |
| Token manipulation | 1.2-UNIT-003, 1.2-UNIT-004, 1.2-INT-012 |

---

## Execution Order

1. **P0 Unit Tests** (1.2-UNIT-002 through 1.2-UNIT-006) - Fail fast on security logic
2. **P0 Integration Tests** (1.2-INT-001, 1.2-INT-002, 1.2-INT-009 through 1.2-INT-014) - Critical paths
3. **P1 Integration Tests** (remaining INT scenarios) - Core functionality
4. **P1 Blind Spot Tests** - Security edge cases
5. **P2 Tests** - Nice-to-have edge cases

---

## Test Environment Requirements

- Gateway service with test JWT secret
- Mock downstream services (user-service, task-service, etc.)
- Redis for distributed rate limiting (if implemented)
- Load testing tool for concurrency scenarios (e.g., k6, JMeter)

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 34
  by_level:
    unit: 6
    integration: 16
    blind_spot: 12
  by_priority:
    p0: 14
    p1: 14
    p2: 6
  blind_spot_scenarios:
    total: 12
    by_category:
      BOUNDARY: 4
      ERROR: 4
      CONCURRENCY: 2
      RESOURCE: 1
      FLOW: 1
  coverage_gaps: []
```
