# Test Design: 1.3 - 用户认证和基础功能

**Date:** 2026-01-15 | **Author:** JW (QA Engineer)

## Overview

| Metric | Value |
|--------|-------|
| **Total Scenarios** | 34 |
| **Unit Tests** | 7 (21%) |
| **Integration Tests** | 12 (35%) |
| **Blind Spot Scenarios** | 15 (44%) |

**Priority Distribution:**
- P0: 17 (Critical - Security/Auth)
- P1: 14 (High - Core functionality)
- P2: 3 (Medium - Edge cases)

**Blind Spot Coverage:**
- BOUNDARY: 5 scenarios
- ERROR: 4 scenarios
- CONCURRENCY: 2 scenarios
- DATA: 2 scenarios
- FLOW: 2 scenarios

---

## Scenarios by AC

### AC1: 验证码发送

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 1.3-UNIT-001 | U | P0 | Phone number validation (11 digits) | Input validation |
| 1.3-UNIT-002 | U | P1 | 6-digit verification code generation | Code format |
| 1.3-UNIT-003 | U | P1 | Redis key format `sms:code:{phone}` | Storage pattern |
| 1.3-INT-001 | I | P0 | Valid phone sends SMS successfully | Happy path |
| 1.3-INT-002 | I | P0 | Invalid phone format returns 400 | Input rejection |
| 1.3-INT-003 | I | P0 | Rate limit: second request within 60s returns 429 | Anti-abuse |
| 1.3-INT-004 | I | P1 | Code stored in Redis with 5min TTL | Expiry verification |
| 1.3-INT-005 | I | P1 | SMS service failure returns 500 | Error handling |

---

### AC2: 验证码登录 (Security Critical)

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 1.3-UNIT-004 | U | P0 | JWT access_token generation with 2h expiry | Token creation |
| 1.3-UNIT-005 | U | P0 | JWT refresh_token generation with 7d expiry | Token creation |
| 1.3-UNIT-006 | U | P0 | Verification code comparison (case-sensitive) | Security logic |
| 1.3-INT-006 | I | P0 | Correct code + existing user → login + tokens | Happy path |
| 1.3-INT-007 | I | P0 | Correct code + new user → auto-register + 2 quota | New user flow |
| 1.3-INT-008 | I | P0 | Wrong code returns 400 "验证码错误" | Security rejection |
| 1.3-INT-009 | I | P0 | Expired code returns 400 "验证码已过期" | Expiry check |
| 1.3-INT-010 | I | P0 | No code in Redis returns 400 "请先获取验证码" | Missing code |
| 1.3-INT-011 | I | P0 | Code deleted from Redis after successful login | One-time use |
| 1.3-INT-012 | I | P1 | Response contains access_token, refresh_token, expires_in | Response format |

---

### AC3: Token刷新

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 1.3-UNIT-007 | U | P0 | Refresh token validation logic | Security |
| 1.3-INT-013 | I | P0 | Valid refresh_token returns new access_token | Happy path |
| 1.3-INT-014 | I | P0 | Expired refresh_token returns 401 | Expiry handling |
| 1.3-INT-015 | I | P0 | Invalid refresh_token returns 401 | Security rejection |
| 1.3-INT-016 | I | P1 | Original refresh_token remains valid | Token persistence |

---

### AC4: 用户信息查询

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 1.3-INT-017 | I | P1 | Authenticated user gets profile | Happy path |
| 1.3-INT-018 | I | P1 | Profile includes membership_type, remaining_quota | Response completeness |
| 1.3-INT-019 | I | P1 | Unauthenticated request returns 401 | Auth required |

---

## Blind Spot Scenarios [BLIND-SPOT]

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 1.3-BLIND-BOUNDARY-001 | BOUNDARY | P1 | Phone with 10 digits (too short) | BOUNDARY-002 |
| 1.3-BLIND-BOUNDARY-002 | BOUNDARY | P1 | Phone with 12 digits (too long) | BOUNDARY-004 |
| 1.3-BLIND-BOUNDARY-003 | BOUNDARY | P1 | Phone with non-numeric characters | BOUNDARY-005 |
| 1.3-BLIND-BOUNDARY-004 | BOUNDARY | P1 | Empty phone number | BOUNDARY-001 |
| 1.3-BLIND-BOUNDARY-005 | BOUNDARY | P1 | Empty verification code | BOUNDARY-001 |
| 1.3-BLIND-ERROR-001 | ERROR | P1 | Redis connection failure during code storage | ERROR-002 |
| 1.3-BLIND-ERROR-002 | ERROR | P1 | Aliyun SMS API timeout | ERROR-001 |
| 1.3-BLIND-ERROR-003 | ERROR | P1 | Database connection failure during user creation | ERROR-002 |
| 1.3-BLIND-ERROR-004 | ERROR | P2 | Aliyun SMS returns rate limit error | ERROR-005 |
| 1.3-BLIND-CONCURRENCY-001 | CONCURRENCY | P1 | Two login requests with same code simultaneously | CONCURRENCY-002 |
| 1.3-BLIND-CONCURRENCY-002 | CONCURRENCY | P1 | Send code + login race condition | CONCURRENCY-002 |
| 1.3-BLIND-DATA-001 | DATA | P1 | User created but token generation fails (rollback) | DATA-001 |
| 1.3-BLIND-DATA-002 | DATA | P2 | Duplicate phone registration attempt | DATA-002 |
| 1.3-BLIND-FLOW-001 | FLOW | P1 | Code expires exactly during login validation | FLOW-004 |
| 1.3-BLIND-FLOW-002 | FLOW | P2 | Multiple rapid send-code requests from same phone | FLOW-002 |

---

## Risk Coverage

| Risk | Mitigated By |
|------|--------------|
| Unauthorized access | 1.3-INT-008 through 1.3-INT-010, 1.3-INT-014, 1.3-INT-015 |
| Account takeover | 1.3-BLIND-CONCURRENCY-001, 1.3-INT-011 |
| SMS abuse/cost | 1.3-INT-003, 1.3-BLIND-FLOW-002 |
| Data integrity | 1.3-BLIND-DATA-001, 1.3-INT-007 |
| Service availability | 1.3-BLIND-ERROR-001 through 1.3-BLIND-ERROR-003 |

---

## Execution Order

1. **P0 Unit Tests** (1.3-UNIT-001, 1.3-UNIT-004 through 1.3-UNIT-007) - Security logic first
2. **P0 Integration Tests** (1.3-INT-001 through 1.3-INT-003, 1.3-INT-006 through 1.3-INT-015) - Auth flows
3. **P1 Tests** - Remaining integration + blind spots
4. **P2 Tests** - Edge cases

---

## Test Environment Requirements

- User-service with test database
- Redis instance for verification codes
- Mock Aliyun SMS service (or sandbox)
- JWT secret for token generation/validation
- Load testing tool for concurrency scenarios

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 34
  by_level:
    unit: 7
    integration: 12
    blind_spot: 15
  by_priority:
    p0: 17
    p1: 14
    p2: 3
  blind_spot_scenarios:
    total: 15
    by_category:
      BOUNDARY: 5
      ERROR: 4
      CONCURRENCY: 2
      DATA: 2
      FLOW: 2
  coverage_gaps: []
```
