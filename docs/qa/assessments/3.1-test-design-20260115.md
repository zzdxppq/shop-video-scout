# Test Design: 3.1 - 集成通义千问VL实现镜头分析

**Date:** 2026-01-15 | **Author:** JW (QA Engineer)

## Overview

| Metric | Value |
|--------|-------|
| **Total Scenarios** | 38 |
| **Unit Tests** | 8 (21%) |
| **Integration Tests** | 16 (42%) |
| **Blind Spot Scenarios** | 14 (37%) |

**Priority Distribution:**
- P0: 12 (Critical - Core AI pipeline)
- P1: 18 (High - Core functionality)
- P2: 8 (Medium - Edge cases)

**Blind Spot Coverage:**
- BOUNDARY: 4 scenarios
- ERROR: 5 scenarios
- CONCURRENCY: 2 scenarios
- DATA: 2 scenarios
- RESOURCE: 1 scenario

---

## Scenarios by AC

### AC1: 关键帧提取

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 3.1-UNIT-001 | U | P1 | Frame rate calculation (0.5 fps = 1 frame per 2s) | Core extraction logic |
| 3.1-UNIT-002 | U | P1 | Resolution scaling to max 1280x720 | Image size constraint |
| 3.1-UNIT-003 | U | P1 | Timestamp recording for each frame | Frame metadata |
| 3.1-INT-001 | I | P0 | Valid 10s video extracts 5 frames | Happy path |
| 3.1-INT-002 | I | P0 | Extracted frames saved as JPEG to OSS | Storage verification |
| 3.1-INT-003 | I | P1 | Short video (<2s) extracts at least 1 frame | Minimum extraction |
| 3.1-INT-004 | I | P1 | 60s video extracts 30 frames | Large video handling |
| 3.1-INT-005 | I | P1 | Invalid video format returns error | Error handling |

---

### AC2: 视觉AI分析 (Core AI Pipeline)

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 3.1-UNIT-004 | U | P0 | Image Base64 encoding correct | API input format |
| 3.1-UNIT-005 | U | P0 | Analysis prompt contains required fields | Prompt correctness |
| 3.1-UNIT-006 | U | P0 | API response parsed to FrameAnalysisResult | Response parsing |
| 3.1-INT-006 | I | P0 | Valid frame returns category (food/person/environment/other) | Category classification |
| 3.1-INT-007 | I | P0 | Valid frame returns 3-8 tags | Tag extraction |
| 3.1-INT-008 | I | P0 | Valid frame returns description | Content description |
| 3.1-INT-009 | I | P0 | API timeout (>60s) triggers retry | Timeout handling |
| 3.1-INT-010 | I | P0 | API error triggers retry up to 3 times | Retry mechanism |
| 3.1-INT-011 | I | P1 | Unsupported image format skips frame with log | Skip invalid frames |
| 3.1-INT-012 | I | P1 | All 3 retries exhausted returns 500 error | Exhausted retries |

---

### AC3: 质量评分

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 3.1-UNIT-007 | U | P0 | Score formula: clarity*0.4 + composition*0.3 + lighting*0.3 | Core scoring logic |
| 3.1-UNIT-008 | U | P0 | Score ≥70 marks frame as recommended | Recommendation threshold |
| 3.1-INT-013 | I | P1 | High quality frame (scores 80/85/90) gets score 84.5 | Formula verification |
| 3.1-INT-014 | I | P1 | Low quality frame (scores 40/50/45) gets score 44.5 | Low score calculation |
| 3.1-INT-015 | I | P1 | Score exactly 70 marked as recommended | Boundary inclusion |
| 3.1-INT-016 | I | P1 | Score 69 not marked as recommended | Boundary exclusion |

---

### AC4: 结果存储

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 3.1-INT-017 | I | P0 | Analysis results saved to task_videos table | Data persistence |
| 3.1-INT-018 | I | P1 | Recommended shots marked in database | Recommendation storage |
| 3.1-INT-019 | I | P1 | Task progress updated after analysis | Progress tracking |
| 3.1-INT-020 | I | P1 | Temp frame images cleaned up after completion | Resource cleanup |
| 3.1-INT-021 | I | P2 | analysis_status set to 'completed' | Status update |

---

## Blind Spot Scenarios [BLIND-SPOT]

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 3.1-BLIND-BOUNDARY-001 | BOUNDARY | P1 | Video exactly 2 seconds extracts 1 frame | BOUNDARY-002 |
| 3.1-BLIND-BOUNDARY-002 | BOUNDARY | P2 | Video 1.9 seconds extracts 1 frame | BOUNDARY-002 |
| 3.1-BLIND-BOUNDARY-003 | BOUNDARY | P2 | Quality scores at exact boundaries (0, 100) | BOUNDARY-002 |
| 3.1-BLIND-BOUNDARY-004 | BOUNDARY | P2 | Tags returned exactly 3 (minimum) and 8 (maximum) | BOUNDARY-002 |
| 3.1-BLIND-ERROR-001 | ERROR | P0 | FFmpeg process crashes mid-extraction | ERROR-002 |
| 3.1-BLIND-ERROR-002 | ERROR | P1 | Qwen-VL API returns malformed JSON | ERROR-003 |
| 3.1-BLIND-ERROR-003 | ERROR | P1 | OSS upload fails during frame storage | ERROR-002 |
| 3.1-BLIND-ERROR-004 | ERROR | P1 | Database connection lost during result save | ERROR-002 |
| 3.1-BLIND-ERROR-005 | ERROR | P2 | API returns valid JSON but missing required fields | ERROR-003 |
| 3.1-BLIND-CONCURRENCY-001 | CONCURRENCY | P1 | Multiple frames analyzed in parallel (thread safety) | CONCURRENCY-001 |
| 3.1-BLIND-CONCURRENCY-002 | CONCURRENCY | P1 | Concurrent video analysis tasks don't interfere | CONCURRENCY-002 |
| 3.1-BLIND-DATA-001 | DATA | P1 | Partial frame analysis results (some frames fail) | DATA-001 |
| 3.1-BLIND-DATA-002 | DATA | P2 | Cleanup fails but analysis results preserved | DATA-003 |
| 3.1-BLIND-RESOURCE-001 | RESOURCE | P1 | Large video (>100MB) doesn't exhaust memory | RESOURCE-002 |

---

## Risk Coverage

| Risk | Mitigated By |
|------|--------------|
| AI analysis failures | 3.1-INT-009 through 3.1-INT-012, 3.1-BLIND-ERROR-001/002 |
| Data loss | 3.1-INT-017/018, 3.1-BLIND-DATA-001/002 |
| Resource exhaustion | 3.1-BLIND-RESOURCE-001, 3.1-INT-020 |
| Incorrect scoring | 3.1-UNIT-007/008, 3.1-INT-013 through 3.1-INT-016 |
| Pipeline failures | 3.1-BLIND-ERROR-001 through 3.1-BLIND-ERROR-004 |

---

## Execution Order

1. **P0 Unit Tests** (3.1-UNIT-004 through 3.1-UNIT-008) - Core logic first
2. **P0 Integration Tests** (3.1-INT-001/002, 3.1-INT-006 through 3.1-INT-010, 3.1-INT-017) - Critical pipeline
3. **P1 Tests** - Remaining integration + blind spots
4. **P2 Tests** - Edge cases

---

## Test Environment Requirements

- AI-service with mock Qwen-VL API (or sandbox)
- FFmpeg installed and accessible
- OSS bucket for temp frame storage
- Test videos of various durations (2s, 10s, 60s)
- Mock server for API failure simulation
- Database with task_videos table

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 38
  by_level:
    unit: 8
    integration: 16
    blind_spot: 14
  by_priority:
    p0: 12
    p1: 18
    p2: 8
  blind_spot_scenarios:
    total: 14
    by_category:
      BOUNDARY: 4
      ERROR: 5
      CONCURRENCY: 2
      DATA: 2
      RESOURCE: 1
  coverage_gaps: []
```
