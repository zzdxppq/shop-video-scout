# Test Design: 2.4 - 分析进度展示页面

2026-01-23 | JW (QA Engineer)

## Overview

| Metric | Value |
|--------|-------|
| **Total Scenarios** | 32 |
| **Unit Tests** | 14 (44%) |
| **Integration Tests** | 8 (25%) |
| **E2E Tests** | 4 (12%) |
| **Blind Spot Scenarios** | 6 (19%) |

**Priority Distribution:**
- P0: 6
- P1: 16
- P2: 8
- P3: 2

## Scenarios by AC

### AC1: 分析进度展示

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 2.4-UNIT-001 | U | P0 | Progress bar renders correct percentage (0-100) | Core visual feedback |
| 2.4-UNIT-002 | U | P1 | Video count display renders "已分析 X/Y 个视频" | BR-1.1 polling shows video progress |
| 2.4-UNIT-003 | U | P1 | Estimated time remaining display | UX requirement from wireframe |
| 2.4-UNIT-004 | U | P1 | Stage list renders with correct status markers (✓/●/○) | BR-1.2 stage progression display |
| 2.4-UNIT-005 | U | P1 | Progress bar animation uses linear easing, 100ms transition | BR-1.3 smooth animation |
| 2.4-UNIT-006 | U | P2 | Completion animation displays before redirect | BR-1.4 visual feedback |
| 2.4-INT-001 | I | P0 | Polling starts on component mount (2s interval) | BR-1.1 core functionality |
| 2.4-INT-002 | I | P1 | Polling updates state from API response | Core data flow |
| 2.4-INT-003 | I | P1 | Polling stops on component unmount (cleanup) | Memory leak prevention |
| 2.4-INT-004 | I | P1 | Auto-redirect after 2 seconds on completion | BR-1.4 flow progression |
| 2.4-INT-005 | I | P1 | beforeunload handler activates during analysis | BR-1.5 data protection |
| 2.4-INT-006 | I | P1 | beforeunload handler deactivates on completion | BR-1.5 cleanup |
| 2.4-E2E-001 | E | P0 | Complete analysis progress flow (start → complete → redirect) | Critical user journey |
| 2.4-E2E-002 | E | P1 | Long-running analysis shows 3min/5min warnings | Error handling LONG_WAIT |

### AC2: 镜头分类结果展示

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 2.4-UNIT-007 | U | P0 | Tab rendering with 5 categories (全部/食物/人物/环境/其他) | Core UI structure |
| 2.4-UNIT-008 | U | P1 | Tab labels show frame counts "食物(12)" | BR-2.4 count display |
| 2.4-UNIT-009 | U | P1 | Frame card renders thumbnail, category label, quality score | Core display element |
| 2.4-UNIT-010 | U | P1 | Recommended frame shows star icon (⭐) | BR-2.2 recommendation marker |
| 2.4-UNIT-011 | U | P2 | Quality score positioned at thumbnail bottom-right | BR-2.3 layout compliance |
| 2.4-UNIT-012 | U | P2 | Default tab selection is "全部" | BR-2.1 initial state |
| 2.4-UNIT-013 | U | P2 | Empty state displays "暂无分析结果" with guidance | Error handling NO_RESULTS |
| 2.4-UNIT-014 | U | P2 | Thumbnail placeholder on image load failure | Error handling IMG_ERROR |
| 2.4-INT-007 | I | P1 | Tab click filters frames by category | Core interaction |
| 2.4-INT-008 | I | P2 | Thumbnail hover shows tooltip with tags/description | UI interaction |
| 2.4-E2E-003 | E | P1 | Frame gallery navigation (tab switch, preview modal) | User journey |
| 2.4-E2E-004 | E | P2 | Click thumbnail opens preview modal with details | UI interaction |

## Blind Spot Scenarios [BLIND-SPOT]

### BOUNDARY Category

| ID | Pri | Scenario | Input | Expected | Ref |
|----|-----|----------|-------|----------|-----|
| 2.4-BLIND-BOUNDARY-001 | P1 | Progress at 0% | percent=0 | Progress bar empty, stages all pending | BOUNDARY-001 |
| 2.4-BLIND-BOUNDARY-002 | P1 | Progress at 100% | percent=100 | Progress bar full, all stages completed | BOUNDARY-002 |
| 2.4-BLIND-BOUNDARY-003 | P2 | Single frame in results | frames.length=1 | Tab counts correct, single card displayed | BOUNDARY-003 |

### ERROR Category

| ID | Pri | Scenario | Condition | Expected | Ref |
|----|-----|----------|-----------|----------|-----|
| 2.4-BLIND-ERROR-001 | P0 | Analysis failure response | status=failed | Retry button visible, error message shown | ERROR-001 |
| 2.4-BLIND-ERROR-002 | P1 | Polling network timeout | 3 consecutive failures | Display retry UI after 3 attempts | ERROR-002 |
| 2.4-BLIND-ERROR-003 | P3 | API returns malformed progress | Invalid JSON | Graceful degradation, retry polling | ERROR-003 |

### FLOW Category

| ID | Pri | Scenario | Trigger | Expected | Ref |
|----|-----|----------|---------|----------|-----|
| 2.4-BLIND-FLOW-001 | P1 | Retry button click | Click retry after failure | POST /analyze called, progress reset | FLOW-001 |
| 2.4-BLIND-FLOW-002 | P3 | Component remount during analysis | Navigate away and back | Resume polling, preserve state | FLOW-002 |

## Risk Coverage

| Risk | Mitigated By |
|------|--------------|
| User loses progress on page close | 2.4-INT-005, 2.4-INT-006 (beforeunload) |
| Stuck on analysis page | 2.4-E2E-002 (long wait warnings), 2.4-BLIND-ERROR-001 (retry) |
| Memory leaks from polling | 2.4-INT-003 (cleanup on unmount) |
| Empty results confusion | 2.4-UNIT-013 (empty state guidance) |
| Broken thumbnails | 2.4-UNIT-014 (placeholder fallback) |
| Polling storm on error | 2.4-BLIND-ERROR-002 (max retry limit) |

## Execution Order

1. **P0 Unit Tests** (foundation)
   - 2.4-UNIT-001: Progress bar percentage
   - 2.4-UNIT-007: Tab rendering

2. **P0 Integration Tests** (critical paths)
   - 2.4-INT-001: Polling mechanism
   - 2.4-BLIND-ERROR-001: Failure handling

3. **P0 E2E Tests** (user journeys)
   - 2.4-E2E-001: Complete progress flow

4. **P1 Tests** (core functionality + blind spots)
   - All P1 unit tests (UI rendering, state)
   - All P1 integration tests (API/state interaction)
   - All P1 blind spot scenarios

5. **P2+ Tests** (secondary features)
   - Alternative paths, edge cases, minor UI details

## Test Implementation Notes

### Unit Test Setup
- Use Vitest for Vue 3 component testing
- Use `@vue/test-utils` for component mounting
- Mock `useProgressPolling` composable for isolated component tests
- Test CSS transition properties for animation specs (BR-1.3)

### Integration Test Setup
- Mock backend API with MSW or vi.mock
- Use `vi.useFakeTimers()` for polling interval testing
- Test Pinia store `useAnalysisStore` state updates
- Verify `beforeunload` event registration/cleanup

### E2E Test Setup
- Use Playwright for full flow testing
- Test complete path: `/task/:id` → analyzing → completed → redirect
- Mock API responses for deterministic timing
- Verify visual states (progress bar animation, stage markers)

### Key Test Fixtures

```typescript
// Progress response fixture
const mockProgressInProgress = {
  percent: 65,
  currentVideo: 13,
  totalVideos: 20,
  stage: 'shot_marking',
  stages: [
    { id: 'upload', label: '上传完成', status: 'completed' },
    { id: 'content_recognition', label: '镜头内容识别', status: 'completed' },
    { id: 'quality_assessment', label: '画面质量评估', status: 'completed' },
    { id: 'shot_marking', label: '推荐镜头标记', status: 'in_progress' },
    { id: 'script_generation', label: '脚本生成', status: 'pending' }
  ],
  estimatedTimeRemaining: 60,
  status: 'analyzing'
};

const mockProgressCompleted = {
  percent: 100,
  currentVideo: 20,
  totalVideos: 20,
  stage: 'script_generation',
  stages: [/* all completed */],
  estimatedTimeRemaining: 0,
  status: 'completed'
};

// Frame results fixture
const mockFrames = [
  { id: 1, thumbnailUrl: '/thumb1.jpg', category: 'food', tags: ['美食', '精美'], qualityScore: 85, isRecommended: true },
  { id: 2, thumbnailUrl: '/thumb2.jpg', category: 'environment', tags: ['环境'], qualityScore: 72, isRecommended: false },
  // ...
];
```

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 14
    integration: 8
    e2e: 4
  by_priority:
    p0: 6
    p1: 16
    p2: 8
    p3: 2
  blind_spot_scenarios:
    total: 6
    by_category:
      BOUNDARY: 3
      ERROR: 3
      FLOW: 2
  coverage_gaps: []
  story_type: frontend_ui
  test_design_level: Standard
```

## Traceability Matrix

| Requirement | Test Coverage |
|-------------|---------------|
| BR-1.1 (2s polling) | 2.4-INT-001 |
| BR-1.2 (stage display) | 2.4-UNIT-004 |
| BR-1.3 (animation) | 2.4-UNIT-005 |
| BR-1.4 (auto-redirect) | 2.4-INT-004, 2.4-UNIT-006 |
| BR-1.5 (beforeunload) | 2.4-INT-005, 2.4-INT-006 |
| BR-2.1 (default tab) | 2.4-UNIT-012 |
| BR-2.2 (star marker) | 2.4-UNIT-010 |
| BR-2.3 (score position) | 2.4-UNIT-011 |
| BR-2.4 (tab counts) | 2.4-UNIT-008 |
| Error: ANALYSIS_ERROR | 2.4-BLIND-ERROR-001 |
| Error: POLL_TIMEOUT | 2.4-BLIND-ERROR-002 |
| Error: LONG_WAIT | 2.4-E2E-002 |
| Error: NO_RESULTS | 2.4-UNIT-013 |
| Error: IMG_ERROR | 2.4-UNIT-014 |
