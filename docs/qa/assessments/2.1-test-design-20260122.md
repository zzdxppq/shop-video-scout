# Test Design: 2.1 - 视频上传服务实现

**Date:** 2026-01-22 | **Author:** JW (QA Engineer)

## Overview

| Metric | Value |
|--------|-------|
| **Total Scenarios** | 27 |
| **Unit Tests** | 11 (41%) |
| **Integration Tests** | 11 (41%) |
| **E2E Tests** | 0 (0%) |
| **Blind Spot Tests** | 5 (19%) |
| **Priority Distribution** | P0: 12, P1: 11, P2: 4 |

## Scenarios by AC

### AC1: 获取OSS预签名上传URL

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 2.1-UNIT-001 | U | P0 | Valid MP4 filename → accept | Pure validation logic |
| 2.1-UNIT-002 | U | P0 | Valid MOV filename → accept | Pure validation logic |
| 2.1-UNIT-003 | U | P0 | Invalid extension (avi, mkv) → 400 | Boundary: format restriction |
| 2.1-UNIT-004 | U | P0 | File size = 100MB → accept | Boundary: at limit |
| 2.1-UNIT-005 | U | P0 | File size = 100MB + 1 byte → 400 | Boundary: over limit |
| 2.1-UNIT-006 | U | P1 | Empty filename → 400 | Error: null input |
| 2.1-UNIT-007 | U | P1 | Null file_size → 400 | Error: missing required |
| 2.1-UNIT-008 | U | P1 | Case insensitive extension (MP4, Mov) | Edge: mixed case |
| 2.1-INT-001 | I | P0 | OSS presigned URL generation success | External service |
| 2.1-INT-002 | I | P1 | OSS path format: videos/{user_id}/{task_id}/{uuid}.{ext} | Path validation |
| 2.1-INT-003 | I | P1 | Presigned URL expires in 15 minutes | Business rule |

### AC2: 确认上传完成并处理

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 2.1-UNIT-009 | U | P0 | Video duration = 180s → accept | Boundary: at limit |
| 2.1-UNIT-010 | U | P0 | Video duration = 181s → 400 | Boundary: over limit |
| 2.1-UNIT-011 | U | P0 | Video count = 20 → accept | Boundary: at limit |
| 2.1-INT-004 | I | P0 | Video record created in DB | Database operation |
| 2.1-INT-005 | I | P0 | FFmpeg keyframe extraction (1 per 2s) | External process |
| 2.1-INT-006 | I | P1 | Thumbnail generated (320x180) | Media processing |
| 2.1-INT-007 | I | P1 | Video metadata extracted (duration, resolution) | FFmpeg output |
| 2.1-INT-008 | I | P1 | File deleted on duration exceeded error | Cleanup logic |
| 2.1-INT-009 | I | P1 | Video count exceeded returns current count | Error response |

### API Endpoint Tests

| ID | Lvl | Pri | Test Scenario | Justification |
|----|-----|-----|---------------|---------------|
| 2.1-INT-010 | I | P0 | POST /tasks/{id}/videos/upload-url → 200 | API contract |
| 2.1-INT-011 | I | P0 | POST /tasks/{id}/videos → 201 | API contract |
| 2.1-INT-012 | I | P1 | GET /tasks/{id}/videos → list | API contract |
| 2.1-INT-013 | I | P1 | DELETE /tasks/{id}/videos/{vid} → 200 | API contract |
| 2.1-INT-014 | I | P1 | Unauthorized request → 401 | Security |

---

## Blind Spot Scenarios [BLIND-SPOT]

| ID | Category | Pri | Scenario | Ref |
|----|----------|-----|----------|-----|
| 2.1-BLIND-BOUNDARY-001 | BOUNDARY | P1 | Filename with special chars (中文, spaces, &) | BOUNDARY-001 |
| 2.1-BLIND-BOUNDARY-002 | BOUNDARY | P2 | Filename at max length (255 chars) | BOUNDARY-002 |
| 2.1-BLIND-ERROR-001 | ERROR | P1 | OSS service timeout handling | ERROR-001 |
| 2.1-BLIND-ERROR-002 | ERROR | P1 | FFmpeg process failure handling | ERROR-002 |
| 2.1-BLIND-RESOURCE-001 | RESOURCE | P2 | Large file cleanup on processing error | RESOURCE-001 |

---

## Risk Coverage

| Risk | Mitigated By |
|------|--------------|
| Invalid file uploads | 2.1-UNIT-001 to 008 |
| OSS integration failure | 2.1-INT-001, 2.1-BLIND-ERROR-001 |
| FFmpeg processing failure | 2.1-INT-005 to 007, 2.1-BLIND-ERROR-002 |
| Video limit bypass | 2.1-UNIT-009 to 011 |
| Resource leaks | 2.1-INT-008, 2.1-BLIND-RESOURCE-001 |

---

## Execution Order

1. **P0 Unit Tests** (2.1-UNIT-001 to 005, 009-011) - Validation logic first
2. **P0 Integration Tests** (2.1-INT-001, 004, 005, 010, 011) - Core functionality
3. **P1 Unit Tests** (2.1-UNIT-006 to 008) - Error handling
4. **P1 Integration Tests** (2.1-INT-002, 003, 006-009, 012-014) - Secondary paths
5. **P1 Blind Spot Tests** (2.1-BLIND-*-001) - Edge cases
6. **P2 Tests** - Low priority scenarios

---

## Test Data Requirements

| Data Type | Values |
|-----------|--------|
| Valid filename | `test.mp4`, `video.mov` |
| Invalid filename | `test.avi`, `video.mkv`, `file.jpg` |
| File size at limit | 104857600 bytes (100MB) |
| File size over limit | 104857601 bytes |
| Duration at limit | 180 seconds |
| Duration over limit | 181 seconds |
| Video count at limit | 20 |

---

## Gate YAML

```yaml
test_design:
  scenarios_total: 27
  by_level:
    unit: 11
    integration: 11
    e2e: 0
  by_priority:
    p0: 12
    p1: 11
    p2: 4
  blind_spot_scenarios:
    total: 5
    by_category:
      BOUNDARY: 2
      ERROR: 2
      RESOURCE: 1
  coverage_gaps: []
```
