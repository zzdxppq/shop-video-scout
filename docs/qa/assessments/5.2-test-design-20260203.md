# Test Design Document
# Story 5.2: ä¸‹è½½å¯¼å‡ºåŠŸèƒ½
# Generated: 2026-02-03

## Overview

| Field | Value |
|-------|-------|
| Story ID | 5.2 |
| Story Title | ä¸‹è½½å¯¼å‡ºåŠŸèƒ½ |
| Epic | 5 - é¢„è§ˆå¯¼å‡ºä¸å‘å¸ƒè¾…åŠ© |
| Test Design Level | Standard |
| Risk Level | LOW |
| Total Test Scenarios | 78 |
| Assigned QA | JW (QA Agent) |
| Design Date | 2026-02-03 |

## AC Summary

| AC ID | Title | Complexity | Test Focus |
|-------|-------|------------|------------|
| AC1 | ä¸‹è½½æˆå“è§†é¢‘ | Low | URLç­¾åã€æ–‡ä»¶åæ¸…ç†ã€Content-Disposition |
| AC2 | ä¸‹è½½ç´ æåŒ… | Medium | ZIPæ‰“åŒ…ã€ç¼“å­˜ã€è¶…æ—¶å¤„ç†ã€éƒ¨åˆ†å¤±è´¥æ¢å¤ |

---

## Unit Test Scenarios

### AC1: ä¸‹è½½æˆå“è§†é¢‘

#### Backend - DownloadService (5.2-UNIT-001 to 5.2-UNIT-016)

| Test ID | Scenario | Input | Expected | Priority |
|---------|----------|-------|----------|----------|
| 5.2-UNIT-001 | Generate signed URL success | task done, output exists | signed URL with expiry returned | P0 |
| 5.2-UNIT-002 | Task not found | non-existent taskId | TASK_NOT_FOUND (40303) | P0 |
| 5.2-UNIT-003 | Task not done | task status=composing | OUTPUT_NOT_READY (1025) | P0 |
| 5.2-UNIT-004 | No output file | output_oss_key=null | OUTPUT_NOT_READY (1025) | P0 |
| 5.2-UNIT-005 | Signed URL expiry | any | expires_at = now + 3600s | P0 |
| 5.2-UNIT-006 | Content-Disposition header | any | attachment; filename="..." set | P0 |
| 5.2-UNIT-007 | Filename format | shop_name="æµ·åº•ææœ›äº¬åº—" | "æµ·åº•ææœ›äº¬åº—-æ¢åº—è§†é¢‘-20260203.mp4" | P0 |
| 5.2-UNIT-008 | Filename sanitize slash | "æµ·åº•æ/æœ›äº¬åº—" | "æµ·åº•æ-æœ›äº¬åº—" | P1 |
| 5.2-UNIT-009 | Filename sanitize colon | "åº—å:test" | "åº—å-test" | P1 |
| 5.2-UNIT-010 | Filename sanitize asterisk | "åº—å*file" | "åº—å-file" | P1 |
| 5.2-UNIT-011 | Filename sanitize backslash | "åº—å\\test" | "åº—å-test" | P1 |
| 5.2-UNIT-012 | Filename sanitize question | "åº—å?" | "åº—å-" | P1 |
| 5.2-UNIT-013 | Filename sanitize quote | "åº—å\"test" | "åº—å-test" | P1 |
| 5.2-UNIT-014 | Filename sanitize angle | "åº—å<>test" | "åº—å--test" | P1 |
| 5.2-UNIT-015 | Filename sanitize pipe | "åº—å|test" | "åº—å-test" | P1 |
| 5.2-UNIT-016 | Filename max length 50 | 60-char shop name | truncated to 50 chars | P1 |

#### Backend - DownloadController (5.2-UNIT-017 to 5.2-UNIT-022)

| Test ID | Scenario | Input | Expected | Priority |
|---------|----------|-------|----------|----------|
| 5.2-UNIT-017 | GET /output/download returns 200 | valid taskId | DownloadUrlResponse | P0 |
| 5.2-UNIT-018 | Missing taskId | no path param | 400 Bad Request | P1 |
| 5.2-UNIT-019 | Invalid taskId format | "abc" | 400 Bad Request | P1 |
| 5.2-UNIT-020 | Unauthorized access | no JWT | 401 Unauthorized | P0 |
| 5.2-UNIT-021 | Not task owner | other user's task | 403 Forbidden | P0 |
| 5.2-UNIT-022 | OSS signing failed | OSS error | 500 + OSS_ERROR (1028) | P1 |

#### Frontend - useDownload composable (5.2-UNIT-023 to 5.2-UNIT-032)

| Test ID | Scenario | Input | Expected | Priority |
|---------|----------|-------|----------|----------|
| 5.2-UNIT-023 | Initial state | - | isDownloading=false, error=null | P0 |
| 5.2-UNIT-024 | downloadVideo starts loading | call downloadVideo(1) | isDownloading=true | P0 |
| 5.2-UNIT-025 | downloadVideo success | API returns URL | triggers browser download | P0 |
| 5.2-UNIT-026 | downloadVideo sets loading false on success | API success | isDownloading=false | P0 |
| 5.2-UNIT-027 | downloadVideo error sets error | API error | error set, isDownloading=false | P0 |
| 5.2-UNIT-028 | triggerDownload creates anchor | URL, filename | hidden anchor clicked | P0 |
| 5.2-UNIT-029 | triggerDownload sets download attribute | filename | anchor.download = filename | P1 |
| 5.2-UNIT-030 | triggerDownload removes anchor after | - | anchor removed from DOM | P1 |
| 5.2-UNIT-031 | clearError clears error | error exists | error=null | P1 |
| 5.2-UNIT-032 | downloadProgress initial 0 | - | downloadProgress=0 | P2 |

#### Frontend - DownloadButtons.vue AC1 (5.2-UNIT-033 to 5.2-UNIT-040)

| Test ID | Scenario | Input | Expected | Priority |
|---------|----------|-------|----------|----------|
| 5.2-UNIT-033 | Renders download video button | default props | button visible with "ä¸‹è½½è§†é¢‘" | P0 |
| 5.2-UNIT-034 | Click download video | click button | downloadVideo called | P0 |
| 5.2-UNIT-035 | Shows loading state | isDownloading=true | button shows spinner/disabled | P0 |
| 5.2-UNIT-036 | Shows success toast | download success | toast "ä¸‹è½½å®Œæˆ" | P1 |
| 5.2-UNIT-037 | Shows error toast | download error | toast with error message | P0 |
| 5.2-UNIT-038 | Button enabled after error | error occurred | button clickable again | P0 |
| 5.2-UNIT-039 | Button disabled during download | isDownloading=true | button disabled | P1 |
| 5.2-UNIT-040 | Retry on 401 | URL expired | auto-refresh URL | P1 |

---

### AC2: ä¸‹è½½ç´ æåŒ…

#### Backend - AssetPackService (5.2-UNIT-041 to 5.2-UNIT-058)

| Test ID | Scenario | Input | Expected | Priority |
|---------|----------|-------|----------|----------|
| 5.2-UNIT-041 | Generate assets pack success | 3 recommended videos | ZIP URL returned | P0 |
| 5.2-UNIT-042 | No recommended videos | is_recommended all false | NO_ASSETS_TO_PACK (1026) | P0 |
| 5.2-UNIT-043 | Task not found | non-existent taskId | TASK_NOT_FOUND (40303) | P0 |
| 5.2-UNIT-044 | Task not done | status=composing | OUTPUT_NOT_READY (1025) | P0 |
| 5.2-UNIT-045 | Cache hit returns cached | cached ZIP exists | return cached URL, no re-pack | P0 |
| 5.2-UNIT-046 | Cache miss creates new ZIP | no cache | create ZIP, cache result | P0 |
| 5.2-UNIT-047 | ZIP filename format | shop_name="æµ·åº•æ" | "æµ·åº•æ-ç´ æåŒ…-20260203.zip" | P0 |
| 5.2-UNIT-048 | Inner file naming seq 1 | video seq=1, category="ç¾é£Ÿ" | "01-ç¾é£Ÿ.mp4" | P0 |
| 5.2-UNIT-049 | Inner file naming seq 10 | video seq=10, category="ç¯å¢ƒ" | "10-ç¯å¢ƒ.mp4" | P1 |
| 5.2-UNIT-050 | Max 10 videos limit | 15 recommended videos | pack first 10 only | P0 |
| 5.2-UNIT-051 | Partial failure continues | 1 of 3 videos fails | ZIP with 2 files, log warning | P0 |
| 5.2-UNIT-052 | All videos fail | all 3 fail download | ASSET_PACK_FAILED (1027) | P1 |
| 5.2-UNIT-053 | Cache key format | taskId=123, hash=abc | "assets-pack:123:abc" | P1 |
| 5.2-UNIT-054 | Cache TTL 1 hour | set cache | TTL=3600 seconds | P1 |
| 5.2-UNIT-055 | Response includes file_count | 5 videos packed | file_count=5 | P0 |
| 5.2-UNIT-056 | Response includes total_size | 3 files @ 10MB each | total_size=31457280 | P1 |
| 5.2-UNIT-057 | Temp files cleaned up | ZIP created | no temp files remain | P1 |
| 5.2-UNIT-058 | Videos ordered by sequence | 3 videos unordered | sorted by sequence_in_output | P1 |

#### Backend - AssetPackController (5.2-UNIT-059 to 5.2-UNIT-062)

| Test ID | Scenario | Input | Expected | Priority |
|---------|----------|-------|----------|----------|
| 5.2-UNIT-059 | GET /assets-pack returns 200 | valid taskId | AssetPackResponse | P0 |
| 5.2-UNIT-060 | Unauthorized access | no JWT | 401 Unauthorized | P0 |
| 5.2-UNIT-061 | Not task owner | other user's task | 403 Forbidden | P0 |
| 5.2-UNIT-062 | ZIP creation failed | internal error | ASSET_PACK_FAILED (1027) | P1 |

#### Frontend - useDownload composable AC2 (5.2-UNIT-063 to 5.2-UNIT-068)

| Test ID | Scenario | Input | Expected | Priority |
|---------|----------|-------|----------|----------|
| 5.2-UNIT-063 | downloadAssetsPack starts loading | call downloadAssetsPack(1) | isDownloading=true | P0 |
| 5.2-UNIT-064 | downloadAssetsPack success | API returns URL | triggers browser download | P0 |
| 5.2-UNIT-065 | downloadAssetsPack error | API error | error set | P0 |
| 5.2-UNIT-066 | downloadAssetsPack timeout | 60s+ wait | timeout error | P1 |
| 5.2-UNIT-067 | isPackingAssets state | packing in progress | isPackingAssets=true | P1 |
| 5.2-UNIT-068 | packProgress updates | packing progress | packProgress updates | P2 |

#### Frontend - DownloadButtons.vue AC2 (5.2-UNIT-069 to 5.2-UNIT-078)

| Test ID | Scenario | Input | Expected | Priority |
|---------|----------|-------|----------|----------|
| 5.2-UNIT-069 | Renders assets pack button | default props | button visible "ä¸‹è½½ç´ æåŒ…" | P0 |
| 5.2-UNIT-070 | Assets button disabled no shots | hasRecommendedShots=false | button disabled | P0 |
| 5.2-UNIT-071 | Disabled button shows tooltip | hover disabled button | tooltip "æ— æ¨èé•œå¤´" | P1 |
| 5.2-UNIT-072 | Click download assets | click button | downloadAssetsPack called | P0 |
| 5.2-UNIT-073 | Shows packing state | isPacking=true | shows "æ‰“åŒ…ä¸­..." | P0 |
| 5.2-UNIT-074 | Packing complete triggers download | pack success | browser download triggered | P0 |
| 5.2-UNIT-075 | Pack error shows toast | pack failed | toast with error | P0 |
| 5.2-UNIT-076 | Pack timeout shows error | 60s timeout | toast "æ‰“åŒ…è¶…æ—¶" | P1 |
| 5.2-UNIT-077 | Button enabled after error | error occurred | button clickable again | P0 |
| 5.2-UNIT-078 | Both buttons rendered | default | 2 buttons visible | P0 |

---

## Integration Test Scenarios (5.2-INT-001 to 5.2-INT-008)

| Test ID | Scenario | Setup | Steps | Expected | Priority |
|---------|----------|-------|-------|----------|----------|
| 5.2-INT-001 | Full video download flow | task done with output | 1. GET /output/download 2. Follow URL | File downloads | P0 |
| 5.2-INT-002 | Assets pack with caching | task with 3 recommended | 1. First GET /assets-pack 2. Second GET /assets-pack | Second uses cache | P0 |
| 5.2-INT-003 | Expired URL auto-refresh | URL expired mid-download | Frontend detects 401 | Auto-fetches new URL | P1 |
| 5.2-INT-004 | Download controller auth | no auth header | GET /output/download | 401 Unauthorized | P0 |
| 5.2-INT-005 | Task ownership check | user A's task, user B token | GET /output/download | 403 Forbidden | P0 |
| 5.2-INT-006 | OSS signed URL validity | generated URL | Access URL directly | Content downloaded | P1 |
| 5.2-INT-007 | Content-Disposition forces download | signed URL | Browser opens URL | File downloads, not plays | P1 |
| 5.2-INT-008 | ZIP structure valid | assets pack created | Extract ZIP | Correct file names, all files valid | P1 |

---

## E2E Test Scenarios (5.2-E2E-001 to 5.2-E2E-004)

| Test ID | Scenario | Steps | Expected | Priority |
|---------|----------|-------|----------|----------|
| 5.2-E2E-001 | Download video from preview page | 1. Navigate to /task/1/preview 2. Click "ä¸‹è½½è§†é¢‘" 3. Wait for download | MP4 file downloaded with correct name | P0 |
| 5.2-E2E-002 | Download assets pack | 1. Navigate to /task/1/preview 2. Click "ä¸‹è½½ç´ æåŒ…" 3. Wait for pack 4. Download | ZIP file with recommended videos | P0 |
| 5.2-E2E-003 | No recommended shots UI | 1. Navigate to preview with 0 recommended 2. Check assets button | Button disabled, tooltip shows | P1 |
| 5.2-E2E-004 | Error recovery | 1. Simulate network error 2. Click download 3. Check error toast 4. Retry | Error shown, retry works | P1 |

---

## Blind Spot Test Scenarios (5.2-BS-001 to 5.2-BS-018)

### BOUNDARY Category

| Test ID | Category | Scenario | Test Approach | Priority |
|---------|----------|----------|---------------|----------|
| 5.2-BS-001 | BOUNDARY | Empty shop name | shop_name="" | Default filename used | P1 |
| 5.2-BS-002 | BOUNDARY | Shop name all special chars | shop_name="/*\\:?" | Filename becomes "-----" or default | P1 |
| 5.2-BS-003 | BOUNDARY | Exactly 50 char shop name | 50-char string | No truncation | P2 |
| 5.2-BS-004 | BOUNDARY | Exactly 10 recommended videos | 10 videos | All 10 packed | P1 |
| 5.2-BS-005 | BOUNDARY | 11 recommended videos | 11 videos | Only first 10 packed | P1 |
| 5.2-BS-006 | BOUNDARY | 1 recommended video | 1 video | ZIP with 1 file | P1 |
| 5.2-BS-007 | BOUNDARY | URL expires exactly at 3600s | check at 3600s | URL still valid | P2 |

### ERROR Category

| Test ID | Category | Scenario | Test Approach | Priority |
|---------|----------|----------|---------------|----------|
| 5.2-BS-008 | ERROR | OSS bucket not found | invalid bucket config | OSS_ERROR returned | P1 |
| 5.2-BS-009 | ERROR | OSS network timeout | slow OSS response | Timeout error | P1 |
| 5.2-BS-010 | ERROR | Redis connection lost | Redis down | Fallback: recreate pack | P1 |
| 5.2-BS-011 | ERROR | Disk full during ZIP | no temp space | ASSET_PACK_FAILED | P2 |
| 5.2-BS-012 | ERROR | Malformed video file | corrupted OSS file | Skip file, continue | P1 |
| 5.2-BS-013 | ERROR | Concurrent pack requests | 2 simultaneous | Only 1 creates, other waits/uses cache | P1 |

### FLOW Category

| Test ID | Category | Scenario | Test Approach | Priority |
|---------|----------|----------|---------------|----------|
| 5.2-BS-014 | FLOW | Task status changes mid-download | statusâ†’failed during pack | Error returned | P2 |
| 5.2-BS-015 | FLOW | User cancels download | browser cancel | No side effects | P2 |

### DATA Category

| Test ID | Category | Scenario | Test Approach | Priority |
|---------|----------|----------|---------------|----------|
| 5.2-BS-016 | DATA | Unicode in shop name | "åº—é“ºğŸ‰åç§°" | Emoji handled in filename | P2 |
| 5.2-BS-017 | DATA | Video category with spaces | "ç¾é£Ÿ ç¯å¢ƒ" | Filename handles spaces | P2 |
| 5.2-BS-018 | DATA | Very large video file | 500MB video | Download handles large file | P2 |

---

## Test Coverage Summary

| Category | Count | P0 | P1 | P2 |
|----------|-------|----|----|----|
| Unit Tests | 78 | 38 | 34 | 6 |
| Integration Tests | 8 | 4 | 4 | 0 |
| E2E Tests | 4 | 2 | 2 | 0 |
| Blind Spot Tests | 18 | 0 | 12 | 6 |
| **Total** | **108** | **44** | **52** | **12** |

## AC Coverage Matrix

| AC | Unit | Integration | E2E | Blind Spot | Total |
|----|------|-------------|-----|------------|-------|
| AC1 | 40 | 5 | 2 | 9 | 56 |
| AC2 | 38 | 3 | 2 | 9 | 52 |

## Test Execution Notes

### Prerequisites
- Task with status='done' and output_oss_key set
- Task with recommended videos (is_recommended=true)
- OSS bucket configured with signing permissions
- Redis available for caching tests

### Mock Requirements
- OSS client for unit tests
- Redis client for unit tests
- Browser download API for frontend tests

### Special Considerations
1. **File Download Testing**: Browser download triggers cannot be directly verified in unit tests; use anchor creation as proxy
2. **Timeout Testing**: Use mock timers for 60s timeout tests
3. **Cache Testing**: Clear Redis before cache miss tests
4. **Large File Testing**: Use mock/stub for very large file scenarios

---

## Appendix: Business Rules Traceability

### AC1 Business Rules

| BR ID | Rule | Test IDs |
|-------|------|----------|
| BR-1.1 | ä¸‹è½½é“¾æ¥æœ‰æ•ˆæœŸ1å°æ—¶ | 5.2-UNIT-005, 5.2-BS-007 |
| BR-1.2 | æ–‡ä»¶åæ ¼å¼ | 5.2-UNIT-007 |
| BR-1.3 | ä»…doneçŠ¶æ€å¯ä¸‹è½½ | 5.2-UNIT-003, 5.2-UNIT-044 |
| BR-1.4 | ç‰¹æ®Šå­—ç¬¦æ›¿æ¢ | 5.2-UNIT-008 to 5.2-UNIT-015 |
| BR-1.5 | æ—¥æœŸæ ¼å¼YYYYMMDD | 5.2-UNIT-007 |
| BR-1.6 | Content-Disposition | 5.2-UNIT-006, 5.2-INT-007 |

### AC2 Business Rules

| BR ID | Rule | Test IDs |
|-------|------|----------|
| BR-2.1 | ä»…æ¨èé•œå¤´ | 5.2-UNIT-041, 5.2-UNIT-042 |
| BR-2.2 | ZIPæ–‡ä»¶åæ ¼å¼ | 5.2-UNIT-047 |
| BR-2.3 | å†…éƒ¨æ–‡ä»¶å‘½å | 5.2-UNIT-048, 5.2-UNIT-049 |
| BR-2.4 | æ‰“åŒ…è¶…æ—¶60ç§’ | 5.2-UNIT-066, 5.2-BS-009 |
| BR-2.5 | æœ€å¤š10ä¸ªè§†é¢‘ | 5.2-UNIT-050, 5.2-BS-004, 5.2-BS-005 |
| BR-2.6 | ZIPç¼“å­˜1å°æ—¶ | 5.2-UNIT-045, 5.2-UNIT-054 |
| BR-2.7 | ç¼“å­˜keyæ ¼å¼ | 5.2-UNIT-053 |

---

*Document generated by QA Agent (JW) - 2026-02-03*
