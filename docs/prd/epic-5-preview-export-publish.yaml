epic_id: 5
title: "预览导出与发布辅助"
description: |
  实现成品视频的在线预览播放、下载导出功能，
  集成AI生成热门话题标签和视频标题推荐，提升发布效率。

stories:
  - id: "5.1"
    title: "视频预览播放器"
    repository_type: monolith
    estimated_complexity: medium
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "视频预览播放"
        scenario:
          given: "视频合成完成"
          when: "用户进入结果页面"
          then:
            - "显示视频播放器组件"
            - "支持播放/暂停控制"
            - "显示播放进度条"
            - "显示视频时长"

        business_rules:
          - id: "BR-1.1"
            rule: "视频自动加载但不自动播放"
          - id: "BR-1.2"
            rule: "支持全屏播放"
          - id: "BR-1.3"
            rule: "显示加载进度"

        error_handling:
          - scenario: "视频加载失败"
            code: "LOAD_ERROR"
            message: "视频加载失败，请刷新重试"
            action: "显示重新加载按钮"

        interaction:
          - trigger: "页面加载"
            behavior: "预加载视频，显示封面帧"
          - trigger: "点击播放"
            behavior: "开始播放，显示控制条"
          - trigger: "双击视频"
            behavior: "切换全屏状态"

      - id: AC2
        title: "使用镜头展示"
        scenario:
          given: "视频预览页面"
          when: "用户查看镜头详情"
          then:
            - "显示使用的镜头缩略图列表"
            - "显示每个镜头的分类和时长"
            - "支持展开/收起"

        business_rules:
          - id: "BR-2.1"
            rule: "默认收起状态"
          - id: "BR-2.2"
            rule: "显示镜头使用顺序"

        interaction:
          - trigger: "点击展开"
            behavior: "显示镜头缩略图网格"
          - trigger: "悬停镜头"
            behavior: "显示镜头详细信息"

    provides_apis: []
    consumes_apis:
      - "GET /api/v1/tasks/{id}/output"
    dependencies:
      - "4.3"
    sm_hints:
      front_end_spec: null
      architecture: null

  - id: "5.2"
    title: "下载导出功能"
    repository_type: monolith
    estimated_complexity: low
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "下载成品视频"
        scenario:
          given: "用户在结果页面"
          when: "用户点击下载成品"
          then:
            - "获取带签名的下载URL"
            - "触发浏览器下载"
            - "显示下载进度（如支持）"

        business_rules:
          - id: "BR-1.1"
            rule: "下载链接有效期1小时"
          - id: "BR-1.2"
            rule: "文件名格式：{店铺名}-探店视频-{日期}.mp4"

        error_handling:
          - scenario: "链接过期"
            code: "401"
            message: "下载链接已过期，正在刷新"
            action: "自动获取新链接"

        interaction:
          - trigger: "点击下载"
            behavior: "显示下载中状态，触发下载"

      - id: AC2
        title: "下载素材包"
        scenario:
          given: "用户需要原始推荐镜头"
          when: "用户点击下载素材包"
          then:
            - "打包所有推荐镜头原片"
            - "生成ZIP文件"
            - "提供下载链接"

        business_rules:
          - id: "BR-2.1"
            rule: "素材包仅包含推荐镜头"
          - id: "BR-2.2"
            rule: "ZIP文件名：{店铺名}-素材包-{日期}.zip"

        error_handling:
          - scenario: "打包失败"
            code: "500"
            message: "素材包生成失败，请重试"
            action: "显示重试按钮"

    provides_apis:
      - "GET /api/v1/tasks/{id}/output/download"
      - "GET /api/v1/tasks/{id}/assets-pack"
    consumes_apis: []
    dependencies:
      - "5.1"
    sm_hints:
      front_end_spec: null
      architecture: null

  - id: "5.3"
    title: "发布辅助服务"
    repository_type: monolith
    estimated_complexity: medium
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "热门话题推荐"
        scenario:
          given: "视频合成完成"
          when: "系统生成话题推荐"
          then:
            - "基于店铺信息和脚本内容"
            - "调用豆包API生成话题"
            - "返回5-10个热门话题标签"
            - "格式符合抖音/小红书规范"

        business_rules:
          - id: "BR-1.1"
            rule: "话题以#开头"
          - id: "BR-1.2"
            rule: "包含店铺名、品类、地区相关话题"
          - id: "BR-1.3"
            rule: "优先推荐当前热门话题"

        error_handling:
          - scenario: "生成失败"
            code: "500"
            message: "话题生成失败"
            action: "返回通用默认话题"

        examples:
          - input: "海底捞火锅望京店"
            expected: |
              ["#海底捞", "#火锅探店", "#望京美食", "#必吃榜", "#美食推荐", "#吃货日常", "#探店达人", "#北京美食", "#团购优惠", "#周末去哪吃"]

      - id: AC2
        title: "标题推荐"
        scenario:
          given: "视频合成完成"
          when: "系统生成标题推荐"
          then:
            - "基于脚本内容生成吸引眼球的标题"
            - "返回3-5个标题选项"

        business_rules:
          - id: "BR-2.1"
            rule: "标题20-50字"
          - id: "BR-2.2"
            rule: "包含吸引点击的元素"
          - id: "BR-2.3"
            rule: "符合平台调性"

        examples:
          - input: "海底捞火锅探店脚本"
            expected: |
              ["望京这家海底捞太绝了！服务好到让你感动流泪", "人均89吃海底捞？这个团购也太香了吧！", "海底捞探店｜必点招牌毛肚，七上八下太嫩了", "朋友聚餐首选！望京海底捞氛围感拉满"]

    provides_apis:
      - "GET /api/v1/tasks/{id}/publish-assist"
      - "POST /api/v1/tasks/{id}/publish-assist/regenerate"
    consumes_apis: []
    dependencies:
      - "4.3"
    sm_hints:
      front_end_spec: null
      architecture: null

  - id: "5.4"
    title: "发布辅助UI组件"
    repository_type: monolith
    estimated_complexity: low
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "话题标签展示与复制"
        scenario:
          given: "用户在结果页面"
          when: "查看话题推荐"
          then:
            - "显示话题标签列表"
            - "支持一键复制所有话题"
            - "支持单个话题复制"

        business_rules:
          - id: "BR-1.1"
            rule: "话题标签显示为芯片样式"
          - id: "BR-1.2"
            rule: "复制后显示成功提示"

        interaction:
          - trigger: "点击一键复制"
            behavior: "复制所有话题到剪贴板，显示成功Toast"
          - trigger: "点击单个话题"
            behavior: "复制该话题，显示成功提示"

      - id: AC2
        title: "标题推荐展示与复制"
        scenario:
          given: "用户在结果页面"
          when: "查看标题推荐"
          then:
            - "显示标题选项列表"
            - "每个标题带复制按钮"

        business_rules:
          - id: "BR-2.1"
            rule: "标题显示为单选列表样式"

        interaction:
          - trigger: "点击复制按钮"
            behavior: "复制对应标题，显示成功提示"

    provides_apis: []
    consumes_apis:
      - "GET /api/v1/tasks/{id}/publish-assist"
    dependencies:
      - "5.3"
    sm_hints:
      front_end_spec: null
      architecture: null

  - id: "5.5"
    title: "历史任务管理"
    repository_type: monolith
    estimated_complexity: low
    priority: P1

    acceptance_criteria:
      - id: AC1
        title: "历史任务列表"
        scenario:
          given: "用户访问历史任务页面"
          when: "页面加载"
          then:
            - "显示用户所有任务列表"
            - "按创建时间倒序排列"
            - "显示任务状态、店铺名、创建时间"
            - "支持分页加载"

        business_rules:
          - id: "BR-1.1"
            rule: "每页显示10条"
          - id: "BR-1.2"
            rule: "显示任务状态图标"

        interaction:
          - trigger: "点击任务卡片"
            behavior: "跳转到任务详情/结果页面"
          - trigger: "滚动到底部"
            behavior: "自动加载更多"

      - id: AC2
        title: "删除任务"
        scenario:
          given: "用户在历史任务列表"
          when: "用户删除任务"
          then:
            - "显示确认弹窗"
            - "确认后删除任务和相关文件"
            - "从列表中移除"

        business_rules:
          - id: "BR-2.1"
            rule: "删除后无法恢复"
          - id: "BR-2.2"
            rule: "同时删除OSS上的视频文件"

        error_handling:
          - scenario: "删除失败"
            code: "500"
            message: "删除失败，请重试"
            action: "显示重试按钮"

        interaction:
          - trigger: "点击删除"
            behavior: "显示确认弹窗"
          - trigger: "确认删除"
            behavior: "显示加载状态，删除后从列表移除"

    provides_apis:
      - "DELETE /api/v1/tasks/{id}"
    consumes_apis:
      - "GET /api/v1/tasks"
    dependencies:
      - "1.4"
    sm_hints:
      front_end_spec: null
      architecture: null
