epic_id: 0
title: "DevOps基础设施"
description: |
  建立项目的持续集成/持续部署基础设施，包括CI/CD流水线、测试框架、监控告警系统，
  确保开发团队能够高效协作和快速迭代。

stories:
  - id: "0.1"
    title: "CI/CD流水线搭建"
    repository_type: monolith
    estimated_complexity: medium
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "代码构建流水线"
        scenario:
          given: "开发者提交代码到Git仓库"
          when: "代码推送到develop或main分支"
          then:
            - "自动触发构建流水线"
            - "前端: 执行npm install && npm run build"
            - "后端: 执行mvn clean package -DskipTests"
            - "构建产物存档（Docker镜像或JAR包）"
            - "构建失败时通知开发者"

        business_rules:
          - id: "BR-1.1"
            rule: "develop分支触发CI，main分支触发CI+CD"
          - id: "BR-1.2"
            rule: "构建超时时间30分钟"
          - id: "BR-1.3"
            rule: "Docker镜像标签格式: {service}:{branch}-{commit_sha}"

        error_handling:
          - scenario: "构建失败"
            code: "BUILD_FAILED"
            message: "构建失败，请检查代码"
            action: "发送企业微信/钉钉通知，附带错误日志链接"

      - id: AC2
        title: "自动化测试阶段"
        scenario:
          given: "代码构建成功"
          when: "进入测试阶段"
          then:
            - "执行前端单元测试 (Vitest)"
            - "执行后端单元测试 (JUnit)"
            - "生成测试覆盖率报告"
            - "覆盖率低于阈值时标记警告"

        business_rules:
          - id: "BR-2.1"
            rule: "后端核心服务单元测试覆盖率 >= 60%"
          - id: "BR-2.2"
            rule: "前端组件测试覆盖率 >= 50%"
          - id: "BR-2.3"
            rule: "测试失败阻止后续部署"

        error_handling:
          - scenario: "测试失败"
            code: "TEST_FAILED"
            message: "单元测试失败"
            action: "阻止部署，通知开发者修复"

      - id: AC3
        title: "自动部署到Staging环境"
        scenario:
          given: "develop分支构建和测试通过"
          when: "触发Staging部署"
          then:
            - "推送Docker镜像到私有仓库"
            - "更新Staging环境Kubernetes部署"
            - "等待健康检查通过"
            - "部署成功后通知团队"

        business_rules:
          - id: "BR-3.1"
            rule: "Staging部署采用滚动更新策略"
          - id: "BR-3.2"
            rule: "健康检查超时5分钟"
          - id: "BR-3.3"
            rule: "部署失败自动回滚到上一版本"

        error_handling:
          - scenario: "部署失败"
            code: "DEPLOY_FAILED"
            message: "Staging部署失败"
            action: "自动回滚，通知运维团队"

      - id: AC4
        title: "生产环境部署流程"
        scenario:
          given: "Staging验证通过"
          when: "触发Production部署（手动审批）"
          then:
            - "需要至少1名审批者确认"
            - "执行蓝绿部署或金丝雀发布"
            - "保留最近3个版本用于回滚"
            - "部署完成后执行冒烟测试"

        business_rules:
          - id: "BR-4.1"
            rule: "生产部署必须经过手动审批"
          - id: "BR-4.2"
            rule: "保留最近3个可回滚版本"
          - id: "BR-4.3"
            rule: "一键回滚响应时间 < 5分钟"

        error_handling:
          - scenario: "冒烟测试失败"
            code: "SMOKE_TEST_FAILED"
            message: "生产冒烟测试失败"
            action: "自动回滚，触发告警"

    provides_apis: []
    consumes_apis: []
    dependencies: []
    sm_hints:
      tech_stack: "GitHub Actions / GitLab CI, Docker, Kubernetes/阿里云ACK"

  - id: "0.2"
    title: "测试基础设施搭建"
    repository_type: monolith
    estimated_complexity: medium
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "后端单元测试框架"
        scenario:
          given: "后端微服务项目已创建"
          when: "配置测试框架"
          then:
            - "集成JUnit 5测试框架"
            - "集成Mockito用于Mock依赖"
            - "集成Testcontainers用于数据库测试"
            - "创建测试基类和通用工具类"
            - "配置测试数据库连接（H2内存数据库）"

        business_rules:
          - id: "BR-1.1"
            rule: "每个Service类必须有对应的Test类"
          - id: "BR-1.2"
            rule: "测试方法命名: should_预期行为_when_条件"
          - id: "BR-1.3"
            rule: "测试数据使用@BeforeEach准备，@AfterEach清理"

        error_handling:
          - scenario: "测试数据库连接失败"
            code: "TEST_DB_ERROR"
            message: "测试数据库初始化失败"
            action: "检查H2配置，确保测试隔离"

      - id: AC2
        title: "后端集成测试框架"
        scenario:
          given: "单元测试框架已配置"
          when: "配置集成测试"
          then:
            - "使用@SpringBootTest加载完整上下文"
            - "使用Testcontainers启动MySQL和Redis容器"
            - "配置MockMvc进行API端点测试"
            - "创建集成测试基类"

        business_rules:
          - id: "BR-2.1"
            rule: "集成测试使用独立的test profile"
          - id: "BR-2.2"
            rule: "每个API端点至少有Happy Path测试"
          - id: "BR-2.3"
            rule: "集成测试不依赖外部AI服务（使用Mock）"

        error_handling:
          - scenario: "容器启动失败"
            code: "CONTAINER_ERROR"
            message: "Testcontainers启动失败"
            action: "检查Docker环境，确保Docker daemon运行"

      - id: AC3
        title: "前端单元测试框架"
        scenario:
          given: "Vue3前端项目已创建"
          when: "配置前端测试框架"
          then:
            - "集成Vitest作为测试运行器"
            - "集成Vue Test Utils进行组件测试"
            - "集成MSW (Mock Service Worker)模拟API"
            - "配置测试覆盖率报告 (c8/istanbul)"

        business_rules:
          - id: "BR-3.1"
            rule: "核心组件必须有单元测试"
          - id: "BR-3.2"
            rule: "Composables必须有单元测试"
          - id: "BR-3.3"
            rule: "测试文件与源文件同目录: Component.vue → Component.test.ts"

        error_handling:
          - scenario: "组件渲染失败"
            code: "RENDER_ERROR"
            message: "组件测试渲染失败"
            action: "检查组件依赖是否正确Mock"

      - id: AC4
        title: "E2E测试框架"
        scenario:
          given: "前后端集成完成"
          when: "配置E2E测试"
          then:
            - "集成Playwright"
            - "创建关键用户流程测试"
            - "配置无头浏览器运行"
            - "生成测试报告和截图"

        business_rules:
          - id: "BR-4.1"
            rule: "E2E测试仅覆盖核心Happy Path"
          - id: "BR-4.2"
            rule: "E2E测试不在每次CI运行，仅在发布前"
          - id: "BR-4.3"
            rule: "测试失败自动截图保存"

        error_handling:
          - scenario: "浏览器启动失败"
            code: "BROWSER_ERROR"
            message: "E2E测试浏览器启动失败"
            action: "检查Playwright依赖是否正确安装"

    provides_apis: []
    consumes_apis: []
    dependencies:
      - "1.1"
      - "1.3"
    sm_hints:
      tech_stack: "JUnit 5, Mockito, Testcontainers, Vitest, Vue Test Utils, Playwright"
      priority_note: "AC1-AC3为P0，AC4 E2E测试为P1可延后"

  - id: "0.3"
    title: "监控告警系统搭建"
    repository_type: monolith
    estimated_complexity: medium
    priority: P1

    acceptance_criteria:
      - id: AC1
        title: "应用日志收集"
        scenario:
          given: "微服务应用已部署"
          when: "配置日志收集"
          then:
            - "配置统一JSON日志格式"
            - "集成阿里云SLS日志服务"
            - "配置日志索引和查询"
            - "设置日志保留策略（30天）"

        business_rules:
          - id: "BR-1.1"
            rule: "日志必须包含traceId用于链路追踪"
          - id: "BR-1.2"
            rule: "敏感信息（手机号、Token）脱敏处理"
          - id: "BR-1.3"
            rule: "ERROR级别日志自动触发告警"

        error_handling:
          - scenario: "日志服务不可用"
            code: "LOG_SERVICE_ERROR"
            message: "日志服务连接失败"
            action: "本地文件备份，服务恢复后补传"

      - id: AC2
        title: "应用指标采集"
        scenario:
          given: "微服务应用已部署"
          when: "配置指标采集"
          then:
            - "集成Spring Boot Actuator"
            - "暴露Prometheus格式指标端点"
            - "配置Grafana仪表盘"
            - "创建核心业务指标"

        business_rules:
          - id: "BR-2.1"
            rule: "指标采集间隔15秒"
          - id: "BR-2.2"
            rule: "指标保留时间15天"
          - id: "BR-2.3"
            rule: "核心指标: http_request_total, task_created_total, ai_api_calls_total, queue_depth"

        error_handling:
          - scenario: "指标端点不可用"
            code: "METRICS_ERROR"
            message: "指标采集失败"
            action: "记录采集失败，不影响主服务"

      - id: AC3
        title: "告警规则配置"
        scenario:
          given: "指标采集已运行"
          when: "配置告警规则"
          then:
            - "配置错误率告警（5xx > 1%持续5分钟）"
            - "配置延迟告警（P99 > 5s持续5分钟）"
            - "配置队列积压告警（depth > 100持续10分钟）"
            - "配置AI服务失败告警（failures > 10次/5分钟）"
            - "配置通知渠道（企业微信/钉钉）"

        business_rules:
          - id: "BR-3.1"
            rule: "Critical告警触发短信+即时通讯"
          - id: "BR-3.2"
            rule: "Warning告警触发即时通讯"
          - id: "BR-3.3"
            rule: "告警去重窗口5分钟"

        error_handling:
          - scenario: "通知发送失败"
            code: "NOTIFY_ERROR"
            message: "告警通知发送失败"
            action: "重试3次，记录到备用日志"

      - id: AC4
        title: "分布式链路追踪"
        scenario:
          given: "微服务通信已建立"
          when: "配置链路追踪"
          then:
            - "集成Spring Cloud Sleuth"
            - "配置Zipkin或Jaeger收集器"
            - "跨服务传播traceId"
            - "设置采样率（生产10%，测试100%）"

        business_rules:
          - id: "BR-4.1"
            rule: "生产环境采样率10%"
          - id: "BR-4.2"
            rule: "Trace数据保留7天"
          - id: "BR-4.3"
            rule: "慢请求（>3s）100%采样"

        error_handling:
          - scenario: "追踪服务不可用"
            code: "TRACE_ERROR"
            message: "链路追踪服务不可用"
            action: "降级为本地日志记录traceId"

      - id: AC5
        title: "监控仪表盘"
        scenario:
          given: "指标和日志已收集"
          when: "创建监控仪表盘"
          then:
            - "创建服务概览仪表盘（QPS、延迟、错误率）"
            - "创建任务处理仪表盘（任务数、成功率、处理时长）"
            - "创建AI服务仪表盘（调用量、延迟、成本）"
            - "创建基础设施仪表盘（CPU、内存、磁盘）"

        business_rules:
          - id: "BR-5.1"
            rule: "仪表盘刷新间隔1分钟"
          - id: "BR-5.2"
            rule: "支持时间范围选择（1h/6h/24h/7d）"

        error_handling:
          - scenario: "仪表盘加载失败"
            code: "DASHBOARD_ERROR"
            message: "仪表盘数据加载失败"
            action: "显示错误提示，提供刷新按钮"

    provides_apis:
      - "GET /actuator/health"
      - "GET /actuator/prometheus"
    consumes_apis: []
    dependencies:
      - "1.1"
      - "0.1"
    sm_hints:
      tech_stack: "Spring Boot Actuator, Prometheus, Grafana, 阿里云SLS, Spring Cloud Sleuth"
      priority_note: "AC1-AC3为P0核心监控，AC4-AC5为P1可与业务功能并行开发"
