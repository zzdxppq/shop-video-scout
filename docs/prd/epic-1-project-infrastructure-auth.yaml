epic_id: 1
title: "项目基础架构与用户认证"
description: |
  建立项目的技术基础架构，包括前端Vue3项目、后端Spring Cloud微服务框架、
  MySQL数据库、Redis缓存、OSS存储配置。实现手机号验证码登录和JWT认证，
  以及基础的任务创建表单。

stories:
  - id: "1.1"
    title: "后端微服务基础架构搭建"
    repository_type: monolith
    estimated_complexity: high
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "Spring Cloud项目初始化"
        scenario:
          given: "开发环境已准备好Java 21和Maven"
          when: "创建Spring Cloud微服务项目结构"
          then:
            - "创建gateway、user-service、task-service、ai-service、media-service、publish-service模块"
            - "配置Spring Cloud Gateway路由"
            - "配置Nacos服务注册发现"
            - "所有服务可正常启动并注册到Nacos"

        business_rules:
          - id: "BR-1.1"
            rule: "所有服务使用统一的Spring Boot 3.x版本"
          - id: "BR-1.2"
            rule: "Gateway统一处理跨域配置"

        error_handling:
          - scenario: "服务启动失败"
            code: "500"
            message: "Service startup failed"
            action: "记录错误日志，检查配置和依赖"

      - id: AC2
        title: "数据库和缓存配置"
        scenario:
          given: "MySQL和Redis服务已部署"
          when: "配置数据源和连接"
          then:
            - "创建数据库shop_video_scout"
            - "执行初始化SQL创建核心表结构"
            - "配置MyBatis-Plus和连接池"
            - "配置Redis连接和序列化"

        business_rules:
          - id: "BR-2.1"
            rule: "数据库连接池最大连接数为20"
          - id: "BR-2.2"
            rule: "Redis使用JSON序列化"

        error_handling:
          - scenario: "数据库连接失败"
            code: "503"
            message: "Database connection failed"
            action: "服务启动时检查连接，失败则阻止启动"

    provides_apis: []
    consumes_apis: []
    dependencies: []
    sm_hints:
      front_end_spec: null
      architecture: null

  - id: "1.2"
    title: "用户认证服务实现"
    repository_type: monolith
    estimated_complexity: medium
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "发送验证码接口"
        scenario:
          given: "用户在登录页输入手机号"
          when: "用户点击发送验证码"
          then:
            - "系统生成6位数字验证码"
            - "验证码存储到Redis，有效期5分钟"
            - "调用短信服务发送验证码"
            - "返回发送成功提示"

        business_rules:
          - id: "BR-1.1"
            rule: "同一手机号60秒内只能发送一次验证码"
          - id: "BR-1.2"
            rule: "验证码为6位随机数字"
          - id: "BR-1.3"
            rule: "验证码有效期5分钟"

        data_validation:
          - field: "phone"
            type: "string"
            required: true
            rules: "中国大陆手机号格式，11位数字，以1开头"
            error_message: "请输入正确的手机号"

        error_handling:
          - scenario: "请求过于频繁"
            code: "429"
            message: "请求过于频繁，请60秒后重试"
            action: "返回剩余等待时间"
          - scenario: "短信服务不可用"
            code: "503"
            message: "短信服务暂时不可用，请稍后重试"
            action: "记录错误日志，不暴露内部错误"

        examples:
          - input: |
              POST /api/v1/auth/send-code
              {"phone": "13800138000"}
            expected: |
              200 OK
              {"success": true, "message": "验证码已发送"}

      - id: AC2
        title: "手机号验证码登录"
        scenario:
          given: "用户已收到验证码"
          when: "用户输入手机号和验证码提交登录"
          then:
            - "系统验证验证码正确性"
            - "如果是新用户，自动创建账号"
            - "生成JWT访问令牌和刷新令牌"
            - "返回用户信息和令牌"

        business_rules:
          - id: "BR-2.1"
            rule: "验证码验证失败次数超过5次，锁定该手机号15分钟"
          - id: "BR-2.2"
            rule: "访问令牌有效期15分钟"
          - id: "BR-2.3"
            rule: "刷新令牌有效期7天"
          - id: "BR-2.4"
            rule: "新用户默认为免费会员"

        data_validation:
          - field: "phone"
            type: "string"
            required: true
            rules: "中国大陆手机号格式"
            error_message: "请输入正确的手机号"
          - field: "code"
            type: "string"
            required: true
            rules: "6位数字"
            error_message: "请输入6位验证码"

        error_handling:
          - scenario: "验证码错误"
            code: "401"
            message: "验证码错误，请重新输入"
            action: "增加错误计数，返回剩余尝试次数"
          - scenario: "验证码已过期"
            code: "401"
            message: "验证码已过期，请重新获取"
            action: "提示用户重新发送验证码"
          - scenario: "手机号已被锁定"
            code: "423"
            message: "验证码错误次数过多，请15分钟后重试"
            action: "返回剩余锁定时间"

        examples:
          - input: |
              POST /api/v1/auth/login
              {"phone": "13800138000", "code": "123456"}
            expected: |
              200 OK
              {"user": {"id": 1, "phone": "138****8000", "nickname": "用户138000", "membership_type": "free"}, "access_token": "jwt...", "refresh_token": "jwt...", "expires_in": 900}

    provides_apis:
      - "POST /api/v1/auth/send-code"
      - "POST /api/v1/auth/login"
      - "POST /api/v1/auth/refresh"
      - "POST /api/v1/auth/logout"
    consumes_apis: []
    dependencies:
      - "1.1"
    sm_hints:
      front_end_spec: null
      architecture: null

  - id: "1.3"
    title: "前端项目搭建与登录页面"
    repository_type: monolith
    estimated_complexity: medium
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "Vue3项目初始化"
        scenario:
          given: "开发环境已准备好Node.js"
          when: "创建前端项目"
          then:
            - "使用Vite创建Vue3 + TypeScript项目"
            - "配置TailwindCSS和Element Plus"
            - "配置Vue Router和Pinia"
            - "配置Axios请求拦截器"
            - "项目可正常启动运行"

        business_rules:
          - id: "BR-1.1"
            rule: "所有请求自动携带Authorization头"
          - id: "BR-1.2"
            rule: "401响应自动尝试刷新Token"

        error_handling:
          - scenario: "构建失败"
            code: "BUILD_ERROR"
            message: "项目构建失败"
            action: "检查依赖和配置"

      - id: AC2
        title: "登录页面实现"
        scenario:
          given: "用户访问需要认证的页面或点击登录"
          when: "用户进入登录页"
          then:
            - "显示手机号输入框"
            - "显示验证码输入框和发送按钮"
            - "发送按钮点击后显示60秒倒计时"
            - "登录成功后跳转到目标页面"

        business_rules:
          - id: "BR-2.1"
            rule: "手机号输入时实时格式验证"
          - id: "BR-2.2"
            rule: "发送验证码后按钮禁用60秒"
          - id: "BR-2.3"
            rule: "登录成功后Token存储到localStorage"

        data_validation:
          - field: "phone"
            type: "string"
            required: true
            rules: "11位数字，以1开头"
            error_message: "请输入正确的手机号"
          - field: "code"
            type: "string"
            required: true
            rules: "6位数字"
            error_message: "请输入6位验证码"

        error_handling:
          - scenario: "网络错误"
            code: "NETWORK_ERROR"
            message: "网络连接失败，请检查网络"
            action: "显示重试按钮"

        interaction:
          - trigger: "页面加载"
            behavior: "自动聚焦手机号输入框"
          - trigger: "点击发送验证码"
            behavior: "按钮显示60秒倒计时，禁用状态"
          - trigger: "登录成功"
            behavior: "显示成功提示，1秒后跳转"

    provides_apis: []
    consumes_apis:
      - "POST /api/v1/auth/send-code"
      - "POST /api/v1/auth/login"
    dependencies:
      - "1.2"
    sm_hints:
      front_end_spec: null
      architecture: null

  - id: "1.4"
    title: "任务创建表单页面"
    repository_type: monolith
    estimated_complexity: medium
    priority: P0

    acceptance_criteria:
      - id: AC1
        title: "店铺信息表单"
        scenario:
          given: "已登录用户访问创建任务页面"
          when: "用户填写店铺信息"
          then:
            - "显示店铺名称输入框（必填）"
            - "显示店铺类型单选按钮组（必填）"
            - "显示商品/优惠描述文本框（选填）"
            - "显示视频风格单选按钮组（必填）"
            - "表单验证通过后启用下一步按钮"

        business_rules:
          - id: "BR-1.1"
            rule: "店铺名称最大200字符"
          - id: "BR-1.2"
            rule: "优惠描述最大500字符"
          - id: "BR-1.3"
            rule: "必填项未填写时显示红色提示"

        data_validation:
          - field: "shop_name"
            type: "string"
            required: true
            rules: "1-200字符"
            error_message: "请输入店铺名称"
          - field: "shop_type"
            type: "enum"
            required: true
            rules: "food|beauty|entertainment|other"
            error_message: "请选择店铺类型"
          - field: "promotion_text"
            type: "string"
            required: false
            rules: "最大500字符"
            error_message: "优惠描述不能超过500字"
          - field: "video_style"
            type: "enum"
            required: true
            rules: "recommend|review|vlog"
            error_message: "请选择视频风格"

        error_handling:
          - scenario: "表单验证失败"
            code: "VALIDATION_ERROR"
            message: "请填写必填项"
            action: "高亮显示未填写的必填项"

        interaction:
          - trigger: "输入内容"
            behavior: "实时验证并显示错误提示"
          - trigger: "点击下一步"
            behavior: "验证通过则显示视频上传区域"

      - id: AC2
        title: "创建任务API"
        scenario:
          given: "用户填写完店铺信息"
          when: "提交创建任务请求"
          then:
            - "后端创建任务记录"
            - "返回任务ID"
            - "任务状态设为uploading"

        business_rules:
          - id: "BR-2.1"
            rule: "任务与当前登录用户关联"
          - id: "BR-2.2"
            rule: "同一用户同时最多有5个进行中的任务"

        error_handling:
          - scenario: "任务数量超限"
            code: "429"
            message: "您有太多进行中的任务，请完成后再创建"
            action: "返回当前进行中任务列表"

        examples:
          - input: |
              POST /api/v1/tasks
              {"shop_name": "海底捞火锅(望京店)", "shop_type": "food", "promotion_text": "人均89，必点招牌毛肚", "video_style": "recommend"}
            expected: |
              201 Created
              {"id": 12345, "status": "uploading", "created_at": "2026-01-16T10:00:00Z"}

    provides_apis:
      - "POST /api/v1/tasks"
      - "GET /api/v1/tasks"
      - "GET /api/v1/tasks/{id}"
    consumes_apis: []
    dependencies:
      - "1.2"
      - "1.3"
    sm_hints:
      front_end_spec: null
      architecture: null
