# Dev Log: 5.3

**Story:** 5.3 - 发布辅助服务 | **Started:** 2026-02-05 | **Agent:** JT (Dev)

---

## Implementation Summary

Story 5.3 implements the Publish Assist Service which generates AI-powered topic hashtags and video title recommendations for users publishing shop videos to social platforms.

### Key Technical Decisions

1. **common-doubao module**: Created new shared module for Doubao (Volcengine) API client, allowing both ai-service and publish-service to use the same client
2. **Feign cross-service calls**: publish-service calls task-service via internal APIs to get task details and script content
3. **Redis caching**: 24-hour TTL cache for publish assist results to reduce API calls
4. **Temperature-based regeneration**: Each regeneration increases temperature (0.7 → 0.8 → 0.9 → 1.0) for more diverse results

---

## Task Completion

### T0: publish-service模块与基础架构

**Status:** ✅ Complete

- Created PublishServiceApplication with @EnableFeignClients
- Added Doubao configuration to application.yml
- Created database migration V5_3__create_publish_assists_table.sql
- Configured gateway routes for /api/v1/publish/**

---

### T1: DoubaoClient提取到common模块

**Status:** ✅ Complete

**Created:**
- `common-doubao/pom.xml` - Maven module configuration
- `DoubaoProperties.java` - Configuration properties class
- `DoubaoClient.java` - HTTP client with retry logic (3 attempts, exponential backoff)
- `DoubaoRequest.java` - Request body DTO
- `DoubaoResponse.java` - Response body DTO
- `DoubaoAutoConfiguration.java` - Spring Boot auto-configuration
- `META-INF/spring.factories` - Auto-configuration registration
- `DoubaoClientTest.java` - Unit tests

**Features:**
- @Retryable for HttpServerErrorException and ResourceAccessException
- Configurable timeout (default 30s)
- Bearer token authentication
- JSON request/response handling

---

### T2: 话题生成服务实现 (AC1)

**Status:** ✅ Complete

**Created:**
- `TopicGenerationService.java` - Interface
- `TopicGenerationServiceImpl.java` - Implementation
- `PublishAssistPromptBuilder.java` - Prompt construction
- `TopicGenerationServiceTest.java` - Unit tests

**Business Rules Implemented:**
- BR-1.1: Topics start with # (auto-prepend if missing)
- BR-1.2-1.5: AI generates shop/category/location related topics
- BR-1.6: Max 20 characters per topic (truncation)
- BR-1.7: Results cached in Redis (24h TTL)

**Fallback:** Default topics returned on API failure

---

### T3: 标题生成服务实现 (AC2)

**Status:** ✅ Complete

**Created:**
- `TitleGenerationService.java` - Interface
- `TitleGenerationServiceImpl.java` - Implementation
- `TitleGenerationServiceTest.java` - Unit tests

**Business Rules Implemented:**
- BR-2.1: 20-50 character length validation
- BR-2.2-2.3: AI generates engaging titles for short video platforms
- BR-2.5-2.6: Returns 3-5 titles, first is recommended

**Fallback:** Template-based titles with shop name substitution

---

### T4: 发布辅助编排与持久化服务 (AC3)

**Status:** ✅ Complete

**Created:**
- `PublishAssistService.java` - Interface
- `PublishAssistServiceImpl.java` - Orchestration service
- `PublishAssist.java` - Entity
- `PublishAssistMapper.java` - MyBatis mapper
- `TaskServiceClient.java` - Feign client
- `TaskDetailDto.java` - DTO
- `ScriptDto.java` - DTO with summary extraction
- `PublishAssistServiceTest.java` - Unit tests

**Business Rules Implemented:**
- BR-3.1: Max 3 regenerations per task
- BR-3.2: Temperature increases with each regeneration
- BR-3.3: Updates DB and Redis cache
- BR-3.4: Returns error when limit reached

**Flow:**
1. Check Redis cache → 2. Check DB → 3. Generate via AI → 4. Store & Cache

---

### T5: API集成与测试

**Status:** ✅ Complete

**Created:**
- `PublishAssistController.java` - REST endpoints
- `PublishAssistControllerTest.java` - Controller unit tests
- `InternalTaskController.java` (task-service) - Internal APIs
- Extended `ResultCode.java` with SCRIPT_CONTENT_MISSING(1030), PUBLISH_ASSIST_LIMIT_EXCEEDED(1031)

**Endpoints:**
- `GET /api/v1/publish/tasks/{id}/assist` - Get publish assist
- `POST /api/v1/publish/tasks/{id}/assist/regenerate` - Regenerate

---

## Files Created/Modified

| File | Purpose |
|------|---------|
| `backend/common-doubao/pom.xml` | New module for Doubao client |
| `backend/common-doubao/.../DoubaoClient.java` | HTTP client with retry |
| `backend/common-doubao/.../DoubaoProperties.java` | Configuration properties |
| `backend/common-doubao/.../DoubaoRequest.java` | Request DTO |
| `backend/common-doubao/.../DoubaoResponse.java` | Response DTO |
| `backend/common-doubao/.../DoubaoAutoConfiguration.java` | Auto-config |
| `backend/common-doubao/.../DoubaoClientTest.java` | Unit tests |
| `backend/publish-service/pom.xml` | Added doubao dependency |
| `backend/publish-service/.../PublishServiceApplication.java` | Added @EnableFeignClients |
| `backend/publish-service/.../controller/PublishAssistController.java` | REST controller |
| `backend/publish-service/.../service/PublishAssistService.java` | Interface |
| `backend/publish-service/.../service/impl/PublishAssistServiceImpl.java` | Orchestration |
| `backend/publish-service/.../service/TopicGenerationService.java` | Interface |
| `backend/publish-service/.../service/impl/TopicGenerationServiceImpl.java` | Topic generation |
| `backend/publish-service/.../service/TitleGenerationService.java` | Interface |
| `backend/publish-service/.../service/impl/TitleGenerationServiceImpl.java` | Title generation |
| `backend/publish-service/.../prompt/PublishAssistPromptBuilder.java` | Prompt building |
| `backend/publish-service/.../client/TaskServiceClient.java` | Feign client |
| `backend/publish-service/.../entity/PublishAssist.java` | Entity |
| `backend/publish-service/.../mapper/PublishAssistMapper.java` | MyBatis mapper |
| `backend/publish-service/.../dto/*.java` | DTOs |
| `backend/publish-service/.../resources/application.yml` | Added Doubao config |
| `backend/publish-service/.../db/migration/V5_3__create_publish_assists_table.sql` | DB migration |
| `backend/task-service/.../controller/InternalTaskController.java` | Internal APIs |
| `backend/task-service/.../dto/internal/*.java` | Internal DTOs |
| `backend/common-core/.../result/ResultCode.java` | New error codes |

---

## Test Results

**Backend Unit Tests:**
- TopicGenerationServiceTest: 11 test cases
- TitleGenerationServiceTest: 12 test cases
- PublishAssistServiceTest: 12 test cases
- PublishAssistControllerTest: 7 test cases
- DoubaoClientTest: 11 test cases

**Coverage:**
- Topic parsing, sanitization, fallback
- Title length validation, truncation
- Cache hit/miss/DB fallback logic
- Regeneration limits and temperature increment
- Authorization and error handling

---

## Blockers

None

---

## Self-Review Checklist

- [x] All ACs implemented (AC1, AC2, AC3)
- [x] Unit tests created for all services
- [x] Controller tests with security context
- [x] DB migration created
- [x] Gateway routes configured
- [x] ResultCode extended
- [x] Feign client for cross-service calls
- [x] Redis caching implemented
- [x] Fallback mechanisms in place
- [x] No hardcoded values (all configurable)

---

## Resumption Guide

**Status:** Implementation Complete - Ready for Review

All tasks (T0-T5) completed. Story is ready for QA verification.

---
