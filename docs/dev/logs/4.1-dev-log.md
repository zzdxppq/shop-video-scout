# Dev Log: Story 4.1 - TTS配音服务实现

## Implementation Summary

Implemented the TTS voice-over service for Story 4.1 across two microservices (task-service and media-service). The implementation covers:

- **AC1 (Standard Voice TTS)**: Full TTS synthesis pipeline — REST API triggers compose via RabbitMQ, media-service consumes messages and calls Volcano Engine Seed-TTS API per paragraph with retry logic (3x exponential backoff), text segmentation for >5000 chars, audio upload to OSS, and callback to task-service on completion.
- **AC2 (Progress Tracking)**: Redis Hash-based progress tracking with per-paragraph updates, percentage calculation, estimated remaining time, and a REST endpoint for frontend polling.

Total: 32 files created, 5 files modified, 42 unit tests across 5 test classes.

## Change Log

| Phase | Task | Status | Notes |
|-------|------|--------|-------|
| T0 | Infrastructure Setup | ✅ Complete | Migration V4_1, RabbitMQ (compose.queue + DLQ), TTS config, OSS config, ComposeMessage shared DTO |
| T1 | AC1: Standard Voice TTS | ✅ Complete | VolcanoTtsClient, TtsSynthesisService, ComposeService, ComposeController, VoiceTypeController, ComposeMessagePublisher/Consumer |
| T2 | AC2: Progress Tracking | ✅ Complete | ComposeProgressTracker (Redis writer), ComposeProgressService (Redis reader), GET /compose-progress endpoint |
| T3 | Tests | ✅ Complete | 42 tests: VolcanoTtsClientTest (11), TtsSynthesisServiceTest (6), ComposeServiceTest (11), ComposeProgressServiceTest (7), ComposeControllerTest (7) |
| T4 | Final Verification | ✅ Complete | Self-review passed. Story status → Review. Registries updated. |

## Key Decisions

1. **POST /compose accepts both `script_edited` and `voice_set`** as valid preconditions (Architect option b for status flow issue).
2. **PUT /voice-type transitions task status to `voice_set`** — implementing the full status machine: script_edited → voice_set → composing.
3. **ComposeMessage placed in common-core** (`com.shopvideoscout.common.mq`) for cross-service sharing via RabbitMQ.
4. **No FK constraint on voice_sample_id** — voice_samples table deferred to Story 4.2 (Voice Clone). Column added as nullable BIGINT.
5. **Minimal read-only ScriptMapper** in task-service — reads raw JSON content from shared DB to build ComposeMessage paragraphs.
6. **Internal callback pattern** — media-service calls `POST /internal/tasks/{id}/compose-complete` on task-service after synthesis completes/fails.
7. **7 new ResultCode enum values** (1010-1016) added to common-core for TTS-specific errors.

## Open Issues

1. **Maven compilation not verified** — Maven is not installed in the dev environment. Manual code review was performed. QA should verify compilation.
2. **Migration file path** — `V4_1__add_voice_fields_to_tasks.sql` placed in `backend/db/migration/`. Verify Flyway scans this path correctly.

## Resumption Guide

### Current Phase
T4: Final Verification — COMPLETE

### Status
Story 4.1 is in **Review** status. All tasks completed. Handoff to QA pending.

### Files Created (32)
- Migration: `backend/db/migration/V4_1__add_voice_fields_to_tasks.sql`
- Common: `ComposeMessage.java`, `MqConstants.java`
- Task-service (14): RabbitMqConfig, ComposeMessagePublisher, ScriptMapper, VoiceConstants, ComposeService, ComposeProgressService, ComposeController, VoiceTypeController, ComposeCallbackController, VoiceTypeRequest, ComposeRequest, ComposeResponse, ComposeProgressResponse
- Media-service (12): RabbitMqConfig, VolcanoTtsProperties, OssConfig, ComposeProperties, MediaServiceConfig, VolcanoTtsClient, TtsSynthesisService, ComposeProgressTracker, ComposeMessageConsumer, TaskCallbackClient
- Tests (5): ComposeServiceTest, ComposeProgressServiceTest, ComposeControllerTest, VolcanoTtsClientTest, TtsSynthesisServiceTest

### Files Modified (5)
- ResultCode.java (+7 enum values)
- task-service/pom.xml (+amqp dep)
- media-service/pom.xml (+amqp, oss, hutool deps)
- task-service/application.yml (+rabbitmq config)
- media-service/application.yml (+rabbitmq, volcano-tts, compose config)
