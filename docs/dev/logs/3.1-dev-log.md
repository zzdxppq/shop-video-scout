# Dev Log: 3.1

**Story:** 3.1 - AI脚本生成服务 | **Started:** 2026-01-25 | **Agent:** Claude Opus 4.5

---

## Implementation Summary

### AC1: 调用豆包API生成脚本

**Implementation:** Complete

Files created:
- `DoubaoConfig.java` - API configuration (timeout=60s, retry=2x, temp=0.7-0.9)
- `DoubaoClient.java` - API client with exponential backoff retry
- `DoubaoRequest.java`, `DoubaoResponse.java` - API DTOs
- `ScriptPromptBuilder.java` - Prompt construction with shop info + shots
- `ScriptResponseParser.java` - JSON extraction and parsing
- `ScriptGenerationService.java` - Main service with validation retry

Tests created:
- `ScriptPromptBuilderTest.java` - 8 tests (prompt building, BR-1.4)
- `ScriptResponseParserTest.java` - 9 tests (JSON parsing, blind spots)
- `DoubaoClientTest.java` - 8 tests (API integration, retry, temp)
- `ScriptGenerationServiceTest.java` - 10 tests (generation, regeneration)

### AC2: 重新生成脚本

**Implementation:** Complete

- `ScriptGenerationService.regenerateScript()` - with count validation
- `MAX_REGENERATE_COUNT = 5` (BR-2.1)
- Temperature variation: 0.7 → 0.8 → 0.9 on regeneration
- Version increment on regeneration (BR-2.2)

### T3: API Endpoints

**Implementation:** Complete

- `GET /api/v1/tasks/{id}/script` - Returns script with regenerate_remaining
- `POST /api/v1/tasks/{id}/regenerate-script` - Triggers regeneration
- `TaskServiceClient.java` - Feign client for task-service communication
- `ScriptControllerTest.java` - 6 tests (endpoints, 404, 429)

---

## Files Created/Modified

| File | Action | Purpose |
|------|--------|---------|
| `ai-service/src/main/java/.../config/DoubaoConfig.java` | CREATE | Doubao API configuration |
| `ai-service/src/main/java/.../dto/DoubaoRequest.java` | CREATE | API request DTO |
| `ai-service/src/main/java/.../dto/DoubaoResponse.java` | CREATE | API response DTO |
| `ai-service/src/main/java/.../dto/ScriptContent.java` | CREATE | Script content structure |
| `ai-service/src/main/java/.../dto/ScriptResponse.java` | CREATE | API response DTO |
| `ai-service/src/main/java/.../dto/ShotSummary.java` | CREATE | Shot summary for prompts |
| `ai-service/src/main/java/.../entity/Script.java` | CREATE | Script entity |
| `ai-service/src/main/java/.../mapper/ScriptMapper.java` | CREATE | MyBatis mapper |
| `ai-service/src/main/java/.../client/DoubaoClient.java` | CREATE | Doubao API client |
| `ai-service/src/main/java/.../client/TaskServiceClient.java` | CREATE | Feign client |
| `ai-service/src/main/java/.../service/ScriptPromptBuilder.java` | CREATE | Prompt builder |
| `ai-service/src/main/java/.../service/ScriptResponseParser.java` | CREATE | Response parser |
| `ai-service/src/main/java/.../service/ScriptGenerationService.java` | CREATE | Main service |
| `ai-service/src/main/java/.../controller/ScriptController.java` | CREATE | REST controller |
| `ai-service/src/main/java/.../mapper/VideoFrameMapper.java` | MODIFY | Added findAnalyzedByTaskId |
| `ai-service/src/main/java/.../AiServiceApplication.java` | MODIFY | Added @EnableFeignClients |
| `ai-service/src/main/resources/application.yml` | MODIFY | Added Doubao config |
| `ai-service/pom.xml` | MODIFY | Added OpenFeign dependency |
| `ai-service/src/test/java/.../service/ScriptPromptBuilderTest.java` | CREATE | Unit tests |
| `ai-service/src/test/java/.../service/ScriptResponseParserTest.java` | CREATE | Unit tests |
| `ai-service/src/test/java/.../service/ScriptGenerationServiceTest.java` | CREATE | Unit tests |
| `ai-service/src/test/java/.../client/DoubaoClientTest.java` | CREATE | Unit tests |
| `ai-service/src/test/java/.../controller/ScriptControllerTest.java` | CREATE | Controller tests |

---

## Test Coverage

| Test Class | Tests | Coverage |
|------------|-------|----------|
| ScriptPromptBuilderTest | 8 | BR-1.4, BLIND-BOUNDARY-001/002 |
| ScriptResponseParserTest | 9 | BLIND-ERROR-001/002 |
| ScriptGenerationServiceTest | 10 | BR-2.1, BLIND-BOUNDARY-002/003 |
| DoubaoClientTest | 8 | Retry logic, temperature |
| ScriptControllerTest | 6 | All endpoints, 404, 429 |
| **Total** | **41** | |

---

## Blockers

None

---

## Deviations from Design

1. **Package name**: Used `com.shopvideoscout.ai` (existing pattern) instead of `com.svs.ai` (story spec)
2. **Feign Client**: Added TaskServiceClient as Feign interface for service-to-service communication

---

## Final Summary

**Duration:** 1 session | **Completed:** 2026-01-25
**Files Created:** 18 new files (DTOs, entities, services, tests)
**Files Modified:** 4 files (mapper, application, pom, main class)
**Tests:** 41 unit/integration tests
**Status:** Ready for Review
