# Story 5.3: 使用克隆声音进行脚本配音

## Status
AwaitingTestDesign

## Story

**As a** 用户,
**I want** 在配音时选择使用我克隆的声音,
**so that** 视频配音更自然、更有个人特色

## Description

实现使用克隆声音进行TTS配音：
- 音色选择器中显示"我的声音"
- 调用克隆音色进行TTS
- 克隆配音质量可接受

## Acceptance Criteria

### AC1: 音色选择器

**Scenario**
```gherkin
GIVEN 用户已完成声音克隆
WHEN 进入配音音色选择
THEN
  - 显示标准音色列表
  - 显示"我的声音"选项 (如已克隆)
  - 未克隆用户显示"克隆我的声音"引导
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | "我的声音"仅在克隆完成后显示 |
| BR-1.2 | 克隆中显示"声音克隆中..." |
| BR-1.3 | 未克隆显示引导链接 |

### AC2: 克隆声音配音

**Scenario**
```gherkin
GIVEN 用户选择"我的声音"
WHEN 提交配音请求
THEN
  - 使用克隆音色ID调用TTS
  - 合成效果与克隆样本相似
  - 语调自然、清晰
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 使用 clone_voice_id 调用TTS |
| BR-2.2 | 克隆TTS与标准TTS调用方式一致 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 克隆音色失效 | 400 | 声音克隆已过期，请重新上传 | 提示重新克隆 |
| 克隆TTS失败 | 500 | 配音失败 | 回退到标准音色 |

### AC3: 音色切换

**Scenario**
```gherkin
GIVEN 用户已选择配音音色
WHEN 用户切换到其他音色
THEN
  - 重新生成该音色的配音
  - 更新预览效果
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 切换音色需重新合成全部配音 |
| BR-3.2 | 保留之前生成的音频 (可回退) |

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 接口扩展** `[ALL ACs]`
  - [ ] TtsService支持克隆音色参数
  - [ ] 前端音色选择器组件

## Feature Implementation Tasks

### AC1: 音色选择器

- [ ] **T1: 实现音色选择器接口** `[AC1]`
  - [ ] 创建 /voice/options 接口
  - [ ] 返回标准音色 + 用户克隆音色
  - [ ] 前端实现选择器UI
  - [ ] 编写单元测试

### AC2: 克隆声音配音

- [ ] **T2: 实现克隆音色TTS** `[AC2]`
  - [ ] 扩展 TtsService 支持 clone_voice_id
  - [ ] 处理克隆音色失效情况
  - [ ] 编写单元测试

### AC3: 音色切换

- [ ] **T3: 实现音色切换** `[AC3]`
  - [ ] 创建 /tasks/{id}/voice 接口 (PUT)
  - [ ] 触发配音重新生成
  - [ ] 更新任务状态
  - [ ] 编写单元测试

## Integration & Verification Tasks

- [ ] **T4: 集成测试** `[ALL ACs]`
  - [ ] 端到端: 选择克隆声音→配音→预览
  - [ ] 音色切换测试
  - [ ] 克隆失效场景测试

## Dev Notes

### Technical Constraints

- 调用已克隆音色进行TTS
- 克隆音色ID从 user_voice_samples 获取
- 需要校验克隆状态为 completed

### Voice Options Response

```json
{
  "standard_voices": [
    {"id": "xiaoyun", "name": "标准女声", "sample_url": "..."},
    {"id": "xiaogang", "name": "标准男声", "sample_url": "..."},
    {"id": "xiaomeng", "name": "甜美女声", "sample_url": "..."}
  ],
  "user_voices": [
    {
      "id": "voice_sample_123",
      "name": "我的声音",
      "clone_voice_id": "aliyun_clone_xxx",
      "status": "completed",
      "created_at": "2026-01-14"
    }
  ]
}
```

### API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /api/v1/voice/options | 获取可用音色列表 |
| PUT | /api/v1/tasks/{id}/voice | 切换任务配音音色 |

### File Locations

```
backend/media-service/
├── src/main/java/
│   └── service/
│       └── TtsService.java  # 扩展支持克隆音色

frontend/
├── src/components/
│   └── VoiceSelector.vue
```

## Source Proposals
- PCP-2026-001 Story Requirement 9

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.5/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story逻辑上构建在E5.1(TTS)和E5.2(声音克隆上传)之上，将克隆声音集成到TTS工作流中。音色选择器设计合理，voice_sample_id与tasks表正确关联。由于涉及多服务集成（user-service查询样本 + media-service执行TTS），需要QA进行测试设计。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (1)
- **API端点扩展** (API Endpoints): `/voice/options` GET 和 `PUT /tasks/{id}/voice` 未在TCP API规范中明确定义。虽为合理扩展，建议补充到TCP或标注为Story级扩展

#### Low Issues (2)
- **回退音色未指定** (AC2 Error Handling): "回退到标准音色"应明确指定默认回退音色（建议: xiaoyun）
- **服务边界说明** (File Locations): /voice/options可能需要user-service（查询样本）与media-service（TTS能力）协调，建议明确接口实现位置

### Recommendations
- 建议在user-service实现/voice/options，聚合标准音色配置和用户克隆音色列表
- 音色切换时建议保留历史音频版本，支持快速回退
- 考虑添加克隆音色过期/失效的定期检查机制
- 前端VoiceSelector组件建议支持音色试听功能

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 2 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from PCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.5/10, 0 critical / 1 medium issues |
