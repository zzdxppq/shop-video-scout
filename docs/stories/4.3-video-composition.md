# Story 4.3: è§†é¢‘è‡ªåŠ¨å‰ªè¾‘åˆæˆ

## Story

```yaml
id: "4.3"
title: "è§†é¢‘è‡ªåŠ¨å‰ªè¾‘åˆæˆ"
epic: "4 - é…éŸ³åˆæˆä¸è§†é¢‘å‰ªè¾‘"
status: Done
mode: plan
repository: monolith
priority: P0
estimated_complexity: high
tier: complex
```

**As a** ç³»ç»Ÿ,
**I want** æ ¹æ®è„šæœ¬æ®µè½ã€é…éŸ³éŸ³é¢‘å’Œç”¨æˆ·è§†é¢‘ç´ æè‡ªåŠ¨è£å‰ªå¹¶åˆæˆæˆå“è§†é¢‘,
**so that** ç”¨æˆ·å®Œæˆé…éŸ³åå¯ä¸€é”®è·å¾—å¸¦é…éŸ³å’Œå¯é€‰å­—å¹•çš„ç«–å±çŸ­è§†é¢‘æˆå“

### ğŸ”Œ APIs Provided by This Story

- `GET /api/v1/tasks/{id}/output`

## Acceptance Criteria

### AC1: è§†é¢‘ç‰‡æ®µè£å‰ª

**Scenario**
```gherkin
GIVEN é…éŸ³å®Œæˆï¼Œè·å¾—å„æ®µè½çš„å®é™…é…éŸ³æ—¶é•¿
WHEN ç³»ç»Ÿæ ¹æ®è„šæœ¬æ®µè½è£å‰ªå¯¹åº”çš„è§†é¢‘ç‰‡æ®µ
THEN
  - æ ¹æ®è„šæœ¬æ®µè½çš„shot_idè·å–å¯¹åº”è§†é¢‘ç´ æ
  - æŒ‰é…éŸ³å®é™…æ—¶é•¿+0.5ç§’è¿‡æ¸¡è£å‰ªè§†é¢‘ç‰‡æ®µ
  - ä½¿ç”¨FFmpegä»è§†é¢‘ä¸­å¿ƒä½ç½®å¼€å§‹æå–æŒ‡å®šæ—¶é—´æ®µ
  - ä¼˜å…ˆä½¿ç”¨æ¨èé•œå¤´ï¼ˆis_recommended=trueï¼‰
  - å­˜å‚¨è£å‰ªåçš„ä¸´æ—¶ç‰‡æ®µæ–‡ä»¶
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | ä¼˜å…ˆä½¿ç”¨æ¨èé•œå¤´ï¼ˆis_recommended=trueçš„è§†é¢‘ï¼‰ |
| BR-1.2 | ç‰‡æ®µæ—¶é•¿ = é…éŸ³å®é™…æ—¶é•¿ + 0.5ç§’è¿‡æ¸¡ |
| BR-1.3 | ä»è§†é¢‘ä¸­å¿ƒä½ç½®å¼€å§‹è£å‰ªï¼ˆstart = (video_duration - segment_duration) / 2ï¼‰ |
| BR-1.4 | æ¯ä¸ªè„šæœ¬æ®µè½å¯¹åº”ä¸€ä¸ªè§†é¢‘ç‰‡æ®µï¼Œshot_idæ˜ å°„åˆ°videos.id |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| è§†é¢‘æ—¶é•¿ä¸è¶³ | 422 | é•œå¤´æ—¶é•¿ä¸è¶³ï¼Œå·²è‡ªåŠ¨è°ƒæ•´ | å½“è§†é¢‘æ—¶é•¿<æ‰€éœ€æ—¶é•¿æ—¶ï¼Œå¾ªç¯æ’­æ”¾ï¼ˆFFmpeg loopï¼‰æˆ–ä½¿ç”¨æœ€å¤§å¯ç”¨æ—¶é•¿ |
| shot_idå¯¹åº”è§†é¢‘ä¸å­˜åœ¨ | 404 | è§†é¢‘ç´ ææœªæ‰¾åˆ° | è®°å½•é”™è¯¯ï¼Œæ ‡è®°ä»»åŠ¡å¤±è´¥ |
| FFmpegè£å‰ªæ‰§è¡Œå¤±è´¥ | 500 | è§†é¢‘ç‰‡æ®µè£å‰ªå¤±è´¥ | è‡ªåŠ¨é‡è¯•1æ¬¡ï¼Œå¤±è´¥åæ ‡è®°ä»»åŠ¡å¤±è´¥ |

**Examples**
- **Input**: æ®µè½1: shot_id=101, TTSå®é™…æ—¶é•¿=8ç§’ â†’ è£å‰ªæ—¶é•¿=8.5ç§’, è§†é¢‘åŸå§‹æ—¶é•¿=30ç§’ â†’ start=(30-8.5)/2=10.75ç§’
  **Expected**: `ffmpeg -i source.mp4 -ss 10.75 -t 8.5 -c copy segment_1.mp4`

---

### AC2: éŸ³è§†é¢‘åˆæˆ

**Scenario**
```gherkin
GIVEN æ‰€æœ‰è§†é¢‘ç‰‡æ®µè£å‰ªå®Œæˆï¼ŒTTSé…éŸ³éŸ³é¢‘å·²ç”Ÿæˆ
WHEN ç³»ç»Ÿæ‰§è¡ŒéŸ³è§†é¢‘åˆæˆ
THEN
  - æŒ‰è„šæœ¬æ®µè½é¡ºåºæ‹¼æ¥æ‰€æœ‰è§†é¢‘ç‰‡æ®µ
  - å°†å„æ®µTTSéŸ³é¢‘åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´éŸ³è½¨
  - å åŠ é…éŸ³éŸ³è½¨åˆ°æ‹¼æ¥è§†é¢‘ä¸Š
  - è¾“å‡ºç«–å±æ ¼å¼ï¼ˆ1080x1920ï¼‰H.264ç¼–ç MP4
  - ä¸Šä¼ æˆå“è§†é¢‘åˆ°OSSè·¯å¾„ output/{task_id}/final.mp4
  - å›è°ƒtask-serviceæ›´æ–°ä»»åŠ¡è¾“å‡ºä¿¡æ¯å’ŒçŠ¶æ€
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | è¾“å‡ºæ ¼å¼: H.264ç¼–ç  MP4å®¹å™¨ |
| BR-2.2 | åˆ†è¾¨ç‡: 1080x1920ï¼ˆç«–å±ï¼‰ï¼Œéç«–å±ç´ æè‡ªåŠ¨ç¼©æ”¾+å¡«å……é»‘è¾¹ |
| BR-2.3 | è§†é¢‘ç ç‡: 4Mbps (`-b:v 4M`) |
| BR-2.4 | å¸§ç‡: 30fps (`-r 30`) |
| BR-2.5 | éŸ³é¢‘ç¼–ç : AAC, 128kbps (`-c:a aac -b:a 128k`) |
| BR-2.6 | ç¼–ç é¢„è®¾: medium (`-preset medium`) |
| BR-2.7 | å¯ç”¨å¿«é€Ÿæ’­æ”¾ (`-movflags +faststart`) |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| åˆæˆå¤±è´¥ | 500 | è§†é¢‘åˆæˆå¤±è´¥ï¼Œæ­£åœ¨é‡è¯• | è‡ªåŠ¨é‡è¯•2æ¬¡ï¼Œå¤±è´¥åæ ‡è®°ä»»åŠ¡failedå¹¶è®°å½•error_message |
| OSSä¸Šä¼ å¤±è´¥ | 500 | è§†é¢‘ä¸Šä¼ å¤±è´¥ | è‡ªåŠ¨é‡è¯•2æ¬¡ï¼Œé‡è¯•é—´éš”5ç§’ |
| å›è°ƒtask-serviceå¤±è´¥ | 500 | å›è°ƒé€šçŸ¥å¤±è´¥ | è‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œé‡è¯•é—´éš”10ç§’ |

**Examples**
- **Input**: è§†é¢‘ç‰‡æ®µåˆ—è¡¨ [segment_1.mp4, segment_2.mp4, ...] + åˆå¹¶éŸ³é¢‘ merged_audio.mp3
  **Expected**: `{"output_url": "https://oss.../output/12345/final.mp4", "duration_seconds": 62, "file_size_bytes": 47841280}`

---

### AC3: å­—å¹•ç”Ÿæˆä¸çƒ§å½•

**Scenario**
```gherkin
GIVEN è„šæœ¬åˆ†æ®µå’Œé…éŸ³æ—¶é•¿å·²ç¡®å®šï¼Œç”¨æˆ·å·²é€‰æ‹©å­—å¹•è®¾ç½®
WHEN ç³»ç»Ÿåˆæˆè§†é¢‘ï¼ˆsubtitleEnabled=trueæ—¶ï¼‰
THEN
  - åŸºäºè„šæœ¬åˆ†æ®µå’Œå„æ®µé…éŸ³å®é™…æ—¶é•¿ç”ŸæˆASSæ ¼å¼å­—å¹•æ–‡ä»¶
  - å­—å¹•æ—¶é—´è½´ä¸é…éŸ³èµ·æ­¢æ—¶é—´ç²¾ç¡®å¯¹é½
  - ä½¿ç”¨FFmpegå°†å­—å¹•çƒ§å½•åˆ°è§†é¢‘ä¸­
  - å­—å¹•é‡‡ç”¨åŒè¡Œæ»šåŠ¨æ˜¾ç¤ºæ•ˆæœï¼ˆå½“å‰è¡Œé«˜äº®ï¼Œä¸‹ä¸€è¡Œé¢„æ˜¾ç¤ºåŠé€æ˜ï¼‰
  - åº”ç”¨ç”¨æˆ·é€‰æ‹©çš„å­—å¹•æ ·å¼æ¨¡æ¿
  - å¦‚æœsubtitleEnabled=falseï¼Œåˆ™è·³è¿‡å­—å¹•ç”Ÿæˆå’Œçƒ§å½•æ­¥éª¤
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | å­—å¹•æ—¶é—´è½´åŸºäºæ¯æ®µè„šæœ¬çš„é…éŸ³èµ·æ­¢æ—¶é—´è‡ªåŠ¨è®¡ç®—ï¼Œç´¯åŠ å‰æ®µæ—¶é•¿ç¡®å®šèµ·å§‹æ—¶é—´ |
| BR-3.2 | åŒè¡Œæ»šåŠ¨ï¼šå½“å‰æ’­æ”¾è¡Œä½¿ç”¨é€‰å®šæ ·å¼æ­£å¸¸æ˜¾ç¤ºï¼Œä¸‹ä¸€è¡Œé¢„æ˜¾ç¤ºï¼ˆåŠé€æ˜ï¼Œalpha=80ï¼‰ |
| BR-3.3 | å­—å¹•ä½ç½®å›ºå®šåœ¨è§†é¢‘åº•éƒ¨å±…ä¸­ï¼ˆAlignment=2, MarginV=60ï¼‰ |
| BR-3.4 | å¦‚æœsubtitleEnabled=falseï¼Œè·³è¿‡å­—å¹•ç”Ÿæˆå’Œçƒ§å½•æ­¥éª¤ï¼Œç›´æ¥è¾“å‡ºæ— å­—å¹•è§†é¢‘ |
| BR-3.5 | å•è¡Œå­—å¹•æœ€å¤§20ä¸ªæ±‰å­—ï¼Œè¶…å‡ºè‡ªåŠ¨æ¢è¡Œ |
| BR-3.6 | 5ç§é¢„è®¾æ ·å¼ï¼šsimple_whiteï¼ˆç®€çº¦ç™½å­—ï¼‰ã€vibrant_yellowï¼ˆæ´»åŠ›é»„å­—ï¼‰ã€xiaohongshuï¼ˆå°çº¢ä¹¦é£ï¼‰ã€douyin_hotï¼ˆæŠ–éŸ³çƒ­é—¨ï¼‰ã€neonï¼ˆéœ“è™¹ç‚«å½©ï¼‰ |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| å­—å¹•ç”Ÿæˆå¤±è´¥ | 500 | å­—å¹•ç”Ÿæˆå¤±è´¥ï¼Œè§†é¢‘å°†ä¸å«å­—å¹• | è®°å½•æ—¥å¿—ï¼Œç»§ç»­åˆæˆæ— å­—å¹•è§†é¢‘ï¼Œä¸é˜»å¡æµç¨‹ |
| å­—å¹•çƒ§å½•å¤±è´¥ | 500 | å­—å¹•çƒ§å½•å¤±è´¥ | å›é€€åˆ°æ— å­—å¹•åˆæˆï¼Œè®°å½•æ—¥å¿—ï¼Œä¸é˜»å¡æµç¨‹ |

**Examples**
- **Input**: æ®µè½1: "å®¶äººä»¬ï¼ä»Šå¤©ç»™ä½ ä»¬æ¢ä¸€å®¶æœ›äº¬è¶…ç«çš„æµ·åº•æ..." (0-8ç§’), æ®µè½2: "ä¸€è¿›é—¨å°±è¢«è¿™ä¸ªè£…ä¿®æƒŠè‰³åˆ°äº†..." (8-14ç§’), style=simple_white
  **Expected**: ç”ŸæˆASSå­—å¹•æ–‡ä»¶ï¼ŒFFmpegçƒ§å½•å‘½ä»¤ï¼š`ffmpeg -i input.mp4 -vf "subtitles=subtitle.ass" output.mp4`

---

## Tasks / Subtasks

### Infrastructure Tasks (Shared)

- [x] **T0: Database & Infrastructure Setup** `[ALL ACs]`
  - [x] Create Flyway migration `V4_3__add_subtitle_and_output_fields_to_tasks.sql`:
    - ALTER tasks ADD `subtitle_enabled BOOLEAN DEFAULT TRUE`
    - ALTER tasks ADD `subtitle_style VARCHAR(50) DEFAULT 'simple_white'`
    - ALTER tasks ADD `output_oss_key VARCHAR(500) NULL`
    - ALTER tasks ADD `output_duration_seconds INT NULL`
    - ALTER tasks ADD `output_file_size BIGINT NULL`
    - ALTER tasks ADD `error_message VARCHAR(500) NULL`
  - [x] Extend `ComposeMessage` (common-core): add `subtitleEnabled` (boolean), `subtitleStyle` (String)
  - [x] Extend `ResultCode` (common-core): add `COMPOSITION_FAILED(1023)`, `VIDEO_CUTTING_FAILED(1024)`, `OUTPUT_NOT_READY(1025)`
  - [x] Create `CompositionProperties` (media-service config): FFmpeg binary path, temp directory, output format settings
  - [x] Create `VideoReadMapper` (media-service mapper): read-only mapper for videos table (query by id, by task_id with is_recommended)
  - [x] Create `ScriptReadMapper` (media-service mapper): read-only mapper for scripts table (query by task_id, parse content JSON paragraphs)
  - [x] Extend `ComposeService` (task-service): include subtitle_enabled and subtitle_style in ComposeMessage when publishing to MQ
  - [x] Verify migrations execute successfully

### Feature Implementation Tasks

### AC1: è§†é¢‘ç‰‡æ®µè£å‰ª

- [x] **T1: Implement è§†é¢‘ç‰‡æ®µè£å‰ª** `[AC1]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Center position calc | video=30s, segment=8.5s | start=10.75s | unit |
  | Duration + transition | TTS=8s | segment=8.5s | unit |
  | FFmpeg cut command | source, start=10.75, dur=8.5 | `-ss 10.75 -t 8.5 -c copy` | unit |
  | Recommended shot priority | multiple videos, one is_recommended=true | recommended selected | unit |
  | Video too short â†’ loop | video=5s, needed=8.5s | `-stream_loop -1` applied | unit |
  | shot_id not found | shot_id=999 (non-existent) | 404 error, task failed | unit |
  | Full cutting pipeline | taskId + paragraphDurations | temp segment files created | integration |
  | FFmpeg failure + retry | FFmpeg exits with error | retry 1x, then fail | integration |

  - [x] Write tests (cover above scenarios)
  - [x] Implement `VideoSegmentCuttingService` in media-service:
    - `cutSegments(Long taskId, List<ParagraphDuration> paragraphDurations)` â†’ `List<File> segmentFiles`
    - For each paragraph: query VideoReadMapper by shot_id â†’ get video oss_key â†’ download from OSS â†’ FFmpeg cut
    - Calculate start position: `(video_duration - segment_duration) / 2` (center cut)
    - Segment duration = TTS actual duration + 0.5s
    - Handle video duration < needed: use `-stream_loop -1` for looping or max available duration
  - [x] Implement FFmpeg command execution wrapper: `ffmpeg -i {source} -ss {start} -t {duration} -c copy {output}`
  - [x] Implement error handling: shot_id not found â†’ 404, FFmpeg failure â†’ retry 1x then fail
  - [x] Verify all tests pass

### AC2: éŸ³è§†é¢‘åˆæˆ

- [x] **T2: Implement éŸ³è§†é¢‘åˆæˆ** `[AC2]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Concat command construction | segments list | segments.txt + concat demuxer cmd | unit |
  | Audio merge command | audio URL list | merged single audio track | unit |
  | Output format params | any input | H.264, 1080x1920, 4Mbps, 30fps, AAC 128k, faststart | unit |
  | Scale/pad non-standard ratio | 1920x1080 input | scale+pad to 1080x1920 with black bars | unit |
  | segments.txt generation | file list | correct concat file format | unit |
  | Full composition pipeline | segments + audio + config | output MP4 file | integration |
  | OSS upload retry | upload fails 1st time | retry, succeed on 2nd, return oss_key | integration |
  | Callback with output info | composition complete | POST with outputOssKey, duration, size | integration |
  | Callback failure retry | callback returns 500 | retry 3x, 10s interval | integration |

  - [x] Write tests (cover above scenarios)
  - [x] Implement `VideoCompositionService` in media-service:
    - `compose(List<File> segments, List<String> audioUrls, SubtitleConfig subtitleConfig)` â†’ `File outputFile`
    - Generate `segments.txt` for FFmpeg concat demuxer
    - Merge TTS audio files into single audio track (download from OSS first)
    - Execute FFmpeg composition: concat + audio overlay + optional subtitle burn
    - Output format: 1080x1920, H.264, 4Mbps, 30fps, AAC 128kbps, `-movflags +faststart`
    - Scale filter for non-standard aspect ratios: `scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2`
  - [x] Implement `OutputOssUploader` in media-service:
    - Upload final video to OSS path `output/{task_id}/final.mp4`
    - Return output_oss_key, file_size
  - [x] Implement error handling: composition failure â†’ retry 2x, OSS upload failure â†’ retry 2x with 5s interval
  - [x] Verify all tests pass

### AC3: å­—å¹•ç”Ÿæˆä¸çƒ§å½•

- [x] **T3: Implement å­—å¹•ç”Ÿæˆä¸çƒ§å½•** `[AC3]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | ASS file format | paragraphs + style | valid ASS with Script Info, V4+ Styles, Events | unit |
  | Cumulative time axis | para1=8s, para2=6s | para1: 0-8s, para2: 8-14s | unit |
  | Dual-line scrolling | 3 paragraphs | current line normal, next line alpha=80 | unit |
  | Auto-wrap 20 chars | 25-char text | text split with `\N` at char 20 | unit |
  | 5 preset styles | each style key | correct ASS V4+ format string | unit |
  | subtitleEnabled=false | flag=false | subtitle generation skipped entirely | unit |
  | Subtitle burn FFmpeg | ASS file + video | `-vf "subtitles=subtitle.ass"` in cmd | integration |
  | Graceful degradation | subtitle gen throws | log warning, continue without subtitles | integration |

  - [x] Write tests (cover above scenarios)
  - [x] Implement `SubtitleGenerationService` in media-service:
    - `generateSubtitle(List<ParagraphDuration> paragraphs, String subtitleStyle)` â†’ `File assFile`
    - Generate ASS format file with [Script Info], [V4+ Styles], [Events] sections
    - Time axis: cumulative start time per paragraph, aligned to TTS durations
    - Dual-line scrolling: current line normal style, next line with `\alpha&H80` (semi-transparent)
    - Auto-wrap: split text at 20 characters per line using `\N` line break
  - [x] Implement `SubtitleStyleConstants` in media-service:
    - Define 5 preset styles as ASS V4+ Style format strings:
    - `simple_white`: PingFang SC, #FFFFFF, Outline 2px #000000, Shadow
    - `vibrant_yellow`: PingFang SC Bold, #FFD700, Outline 2px #000000, Shadow
    - `xiaohongshu`: PingFang SC, #FFFFFF, Outline 3px #FF4757, No Shadow
    - `douyin_hot`: PingFang SC Bold, #FFFFFF, Outline 2px #000000, Shadow + Blur
    - `neon`: PingFang SC Bold, Gradient effect, Glow outline, Shadow
  - [x] Integrate subtitle burning into VideoCompositionService: add `-vf "subtitles=subtitle.ass"` to FFmpeg command when subtitleEnabled=true
  - [x] Implement graceful degradation: if subtitle generation fails â†’ log warning, continue without subtitles
  - [x] Upload ASS file to OSS path `output/{task_id}/subtitle.ass`
  - [x] Verify all tests pass

### Integration & Verification Tasks

- [x] **T4: Pipeline Orchestration & Output Endpoint** `[ALL ACs]`
  - [x] Extend `ComposeMessageConsumer` pipeline in media-service:
    1. TTS Synthesis â†’ get paragraph audio URLs + actual durations (existing from 4.1)
    2. Subtitle Generation â†’ generate ASS file if subtitleEnabled (new)
    3. Video Segment Cutting â†’ cut segments per paragraph using TTS durations (new)
    4. Video Composition â†’ concat segments + overlay audio + burn subtitles (new)
    5. Output Upload â†’ upload final video to OSS (new)
    6. Callback â†’ notify task-service with output info (extend)
  - [x] Extend `ComposeProgressTracker` with new phases:
    - `tts_synthesis` (existing), `subtitle_generation`, `video_cutting`, `video_composition`, `output_upload`
    - Progress percentage calculation across all phases
  - [x] Extend `POST /internal/tasks/{taskId}/compose-complete` callback payload:
    - Add fields: `outputOssKey`, `outputDurationSeconds`, `outputFileSize`
    - Extend `ComposeCallbackController` to update tasks table with output info
  - [x] Implement `GET /api/v1/tasks/{id}/output` in task-service:
    - Create `OutputController` with endpoint returning task output info
    - Create `OutputResponse` DTO: status, video (url, duration, file_size, width=1080, height=1920, format="mp4"), shots_used
    - Return 404 with `OUTPUT_NOT_READY` if task status != completed or output_oss_key is null
    - Generate CDN URL from output_oss_key via OssConfig
  - [x] Implement temporary file cleanup after each composition (delete temp segments, audio files)
  - [x] End-to-end flow tests: compose message â†’ TTS â†’ subtitle â†’ cut â†’ compose â†’ upload â†’ callback â†’ output query
  - [x] Error scenario integration tests (FFmpeg failure, OSS upload failure, subtitle fallback)

- [x] **T5: Final Verification** `[ALL ACs]`
  - [x] All tests passing (unit + integration)
  - [x] No lint errors
  - [x] Dev Log complete with implementation summary
  - [x] Status â†’ Review

### AC Coverage Matrix

| Task | AC1 | AC2 | AC3 |
|------|:---:|:---:|:---:|
| T0: Infrastructure | âœ“ | âœ“ | âœ“ |
| T1: è§†é¢‘ç‰‡æ®µè£å‰ª | âœ“ |   |   |
| T2: éŸ³è§†é¢‘åˆæˆ |   | âœ“ |   |
| T3: å­—å¹•ç”Ÿæˆä¸çƒ§å½• |   |   | âœ“ |
| T4: Pipeline & Output | âœ“ | âœ“ | âœ“ |
| T5: Final | âœ“ | âœ“ | âœ“ |

## Dev Notes

### Technical Constraints

- **FFmpegç³»ç»Ÿä¾èµ–**: media-serviceè¿è¡Œç¯å¢ƒå¿…é¡»å®‰è£…FFmpeg 5.x+ï¼Œé€šè¿‡`CompositionProperties.ffmpegPath`é…ç½®è·¯å¾„ï¼Œé»˜è®¤`/usr/bin/ffmpeg` [â†’ 4-service-architecture-details.md#45-media-service]
- **ä¸´æ—¶æ–‡ä»¶ç®¡ç†**: è£å‰ªç‰‡æ®µå’Œåˆæˆä¸­é—´æ–‡ä»¶å­˜å‚¨åœ¨æœ¬åœ°ä¸´æ—¶ç›®å½•ï¼ˆ`CompositionProperties.tempDir`ï¼‰ï¼Œåˆæˆå®Œæˆæˆ–å¤±è´¥åå¿…é¡»æ¸…ç† [â†’ æ¶æ„çº¦æŸ: æœåŠ¡æ— çŠ¶æ€]
- **ç«–å±è¾“å‡º1080x1920**: æ‰€æœ‰ç´ æå¼ºåˆ¶ç¼©æ”¾+é»‘è¾¹å¡«å……è‡³ç«–å±æ¯”ä¾‹ï¼Œä¸æ”¯æŒæ¨ªå±è¾“å‡º [â†’ Epic YAML BR-2.2]
- **å­—å¹•éé˜»å¡**: AC3å­—å¹•ç”Ÿæˆå¤±è´¥æ—¶ä¸é˜»å¡æ•´ä½“åˆæˆæµç¨‹ï¼Œé™çº§ä¸ºæ— å­—å¹•è§†é¢‘ [â†’ Epic YAML AC3 error_handling]
- **RabbitMQ compose.queue**: å¤ç”¨Story 4.1å·²å»ºç«‹çš„é˜Ÿåˆ—ï¼Œæœ€å¤§é‡è¯•2æ¬¡ï¼Œæ­»ä¿¡é˜Ÿåˆ—compose.dlq [â†’ Story 4.1 T0]
- **Redisè¿›åº¦TTL 1å°æ—¶**: è¿›åº¦æ•°æ®å­˜å‚¨åœ¨`task:progress:{taskId}`ï¼Œè‡ªåŠ¨è¿‡æœŸ [â†’ 5-data-architecture.md#52-redis-data-structures]
- **OSSè¾“å‡ºè·¯å¾„**: `output/{task_id}/final.mp4` (æˆå“è§†é¢‘), `output/{task_id}/subtitle.ass` (å­—å¹•æ–‡ä»¶) [â†’ 5-data-architecture.md#53-oss-storage-structure]

### Accumulated Context (From Previous Stories)

| Resource Type | Name | Source Story | Action | Key Info |
|--------------|------|--------------|--------|----------|
| Table | tasks | 1.1 (ext 4.1) | EXTEND | æ–°å¢subtitle_enabled, subtitle_style, output_oss_key, output_duration_seconds, output_file_size, error_message |
| Table | scripts | 1.1 | READ | content JSONå«paragraphsæ•°ç»„ï¼ˆid, section, shot_id, text, estimated_durationï¼‰ |
| Table | videos | 1.1 | READ | oss_keyï¼ˆè§†é¢‘æ–‡ä»¶ï¼‰, duration_seconds, is_recommended, task_id |
| Endpoint | POST /compose | 4.1 | EXTEND | ComposeServiceéœ€ä¼ é€’subtitleè®¾ç½®åˆ°ComposeMessage |
| Endpoint | GET /compose-progress | 4.1 | EXTEND | ComposeProgressTrackeræ–°å¢pipelineé˜¶æ®µ |
| Endpoint | POST /internal/compose-complete | 4.1 | EXTEND | å›è°ƒpayloadå¢åŠ outputä¿¡æ¯ |
| Model | ComposeMessage | 4.1 | EXTEND | æ–°å¢subtitleEnabled, subtitleStyleå­—æ®µ |
| Model | ComposeMessageConsumer | 4.1 | EXTEND | æ‰©å±•pipeline: TTS â†’ å­—å¹• â†’ è£å‰ª â†’ åˆæˆ â†’ ä¸Šä¼  â†’ å›è°ƒ |
| Model | ComposeProgressTracker | 4.1 | EXTEND | æ–°å¢é˜¶æ®µ: subtitle_generation, video_cutting, video_composition, output_upload |
| Model | TtsSynthesisService | 4.1 | REUSE | TTSåˆæˆè¿”å›å„æ®µéŸ³é¢‘URL + å®é™…æ—¶é•¿ |
| Model | VolcanoTtsClient | 4.1 | REUSE | ç«å±±å¼•æ“Seed-TTSè°ƒç”¨ |
| Model | OssConfig | 4.1 | REUSE | ä¸Šä¼ è¾“å‡ºæ–‡ä»¶åˆ°OSS |
| Model | ResultCode | 1.1 (ext 4.1, 4.2) | EXTEND | æ–°å¢COMPOSITION_FAILED(1023), VIDEO_CUTTING_FAILED(1024), OUTPUT_NOT_READY(1025) |
| Model | R\<T\> | 1.1 | REUSE | ç»Ÿä¸€å“åº”åŒ…è£…å™¨ |
| Model | TaskCallbackClient | 4.1 | EXTEND | å›è°ƒpayloadå¢åŠ outputå­—æ®µ |
| Model | ComposeCallbackController | 4.1 | EXTEND | å¤„ç†outputä¿¡æ¯æ›´æ–°åˆ°tasksè¡¨ |

### Architecture Flow (CRITICAL)

**è§†é¢‘åˆæˆPipelineå®Œæ•´æµç¨‹ï¼ˆæ‰©å±•Story 4.1 TTSæµç¨‹ï¼‰ï¼š**

```
Client â†’ Gateway â†’ task-service (REST API)
                        â”‚
                        â”œâ”€â”€ POST /api/v1/tasks/{id}/compose
                        â”‚     â†’ éªŒè¯taskçŠ¶æ€=script_editedæˆ–voice_set
                        â”‚     â†’ å‘å¸ƒComposeMessageåˆ°RabbitMQ compose.queue
                        â”‚       (å«subtitleEnabled, subtitleStyle)
                        â”‚     â†’ æ›´æ–°tasks.status=composing
                        â”‚     â†’ è¿”å›{ status: "composing", estimated_duration_seconds }
                        â”‚
                        â”œâ”€â”€ GET /api/v1/tasks/{id}/compose-progress
                        â”‚     â†’ ä»Redisè¯»å– task:progress:{taskId}
                        â”‚     â†’ è¿”å›å½“å‰é˜¶æ®µ(tts/subtitle/cutting/composing/uploading)
                        â”‚
                        â”œâ”€â”€ GET /api/v1/tasks/{id}/output       â† æ–°å¢
                        â”‚     â†’ ä»tasksè¡¨è¯»å–output_oss_keyç­‰å­—æ®µ
                        â”‚     â†’ ç”ŸæˆCDN URLè¿”å›
                        â”‚
                        â””â”€â”€ POST /internal/tasks/{taskId}/compose-complete  â† æ‰©å±•
                              â† media-serviceå›è°ƒï¼Œå«outputä¿¡æ¯

media-service (MQ Consumer, æ‰©å±•Pipeline):
  compose.queue â†’ ComposeMessageConsumer
                    â”‚
                    â”œâ”€â”€ Phase 1: TTSåˆæˆ (å·²æœ‰ - Story 4.1)
                    â”‚     â†’ TtsSynthesisService.synthesize()
                    â”‚     â†’ é€æ®µè°ƒç”¨VolcanoTtsClient
                    â”‚     â†’ è¾“å‡º: List<ParagraphDuration> (paragraphId, audioUrl, actualDuration)
                    â”‚     â†’ æ›´æ–°Redisè¿›åº¦: phase=tts_synthesis
                    â”‚
                    â”œâ”€â”€ Phase 2: å­—å¹•ç”Ÿæˆ (æ–°å¢ - AC3)
                    â”‚     â†’ if subtitleEnabled:
                    â”‚       â†’ SubtitleGenerationService.generateSubtitle()
                    â”‚       â†’ ç”ŸæˆASSå­—å¹•æ–‡ä»¶ï¼Œä¸Šä¼ åˆ°OSS
                    â”‚     â†’ æ›´æ–°Redisè¿›åº¦: phase=subtitle_generation
                    â”‚
                    â”œâ”€â”€ Phase 3: è§†é¢‘ç‰‡æ®µè£å‰ª (æ–°å¢ - AC1)
                    â”‚     â†’ VideoSegmentCuttingService.cutSegments()
                    â”‚     â†’ æŸ¥è¯¢VideoReadMapperè·å–è§†é¢‘æ–‡ä»¶
                    â”‚     â†’ ä¸‹è½½æºè§†é¢‘ â†’ FFmpegè£å‰ª â†’ ä¸´æ—¶ç‰‡æ®µæ–‡ä»¶
                    â”‚     â†’ æ›´æ–°Redisè¿›åº¦: phase=video_cutting
                    â”‚
                    â”œâ”€â”€ Phase 4: éŸ³è§†é¢‘åˆæˆ (æ–°å¢ - AC2)
                    â”‚     â†’ VideoCompositionService.compose()
                    â”‚     â†’ æ‹¼æ¥è§†é¢‘ + å åŠ éŸ³é¢‘ + çƒ§å½•å­—å¹•
                    â”‚     â†’ è¾“å‡º1080x1920 H.264 MP4
                    â”‚     â†’ æ›´æ–°Redisè¿›åº¦: phase=video_composition
                    â”‚
                    â”œâ”€â”€ Phase 5: ä¸Šä¼ è¾“å‡º (æ–°å¢ - AC2)
                    â”‚     â†’ ä¸Šä¼ final.mp4åˆ°OSS output/{task_id}/
                    â”‚     â†’ æ›´æ–°Redisè¿›åº¦: phase=output_upload
                    â”‚
                    â””â”€â”€ Phase 6: å›è°ƒé€šçŸ¥ (æ‰©å±•)
                          â†’ TaskCallbackClient.notifyCompletion()
                          â†’ POST /internal/compose-complete
                            { outputOssKey, outputDurationSeconds, outputFileSize }
                          â†’ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

### Database Design

**ALTER tasks table** (Migration V4_3):

```sql
-- V4_3__add_subtitle_and_output_fields_to_tasks.sql
ALTER TABLE tasks ADD COLUMN subtitle_enabled BOOLEAN DEFAULT TRUE AFTER voice_sample_id;
ALTER TABLE tasks ADD COLUMN subtitle_style VARCHAR(50) DEFAULT 'simple_white' AFTER subtitle_enabled;
ALTER TABLE tasks ADD COLUMN output_oss_key VARCHAR(500) NULL AFTER subtitle_style;
ALTER TABLE tasks ADD COLUMN output_duration_seconds INT NULL AFTER output_oss_key;
ALTER TABLE tasks ADD COLUMN output_file_size BIGINT NULL AFTER output_duration_seconds;
ALTER TABLE tasks ADD COLUMN error_message VARCHAR(500) NULL AFTER output_file_size;
```

**è®¾è®¡å†³ç­–**:
- å­—å¹•è®¾ç½®ï¼ˆsubtitle_enabled, subtitle_styleï¼‰å­˜å‚¨åœ¨tasksè¡¨ï¼š1:1å…³ç³»ï¼Œåˆæˆè¯·æ±‚å‚æ•°
- è¾“å‡ºä¿¡æ¯ï¼ˆoutput_oss_key, output_duration_seconds, output_file_sizeï¼‰å­˜å‚¨åœ¨tasksè¡¨ï¼šæ¯ä¸ªä»»åŠ¡æœ€ç»ˆåªæœ‰ä¸€ä¸ªæˆå“è§†é¢‘
- error_messageï¼šåˆæˆå¤±è´¥æ—¶è®°å½•å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºæ’æŸ¥å’Œå±•ç¤º
- ä¸æ–°å»ºè¡¨ï¼šæ‰€æœ‰å­—æ®µéƒ½æ˜¯ä»»åŠ¡å±æ€§ï¼Œæ— ç‹¬ç«‹å®ä½“éœ€æ±‚

### Data Synchronization Requirements

**1. Write Operations Inventory**
| Table | Operation | Key Fields | Trigger Condition |
|-------|-----------|------------|-------------------|
| tasks | UPDATE | status (â†’composing) | POST /compose å‘èµ·åˆæˆ |
| tasks | UPDATE | output_oss_key, output_duration_seconds, output_file_size, status (â†’completed) | media-serviceåˆæˆå®Œæˆå›è°ƒ |
| tasks | UPDATE | status (â†’failed), error_message | media-serviceåˆæˆå¤±è´¥å›è°ƒ |

**2. Status Field Check**
| Table | Field | Field Type | Current Value Source |
|-------|-------|------------|---------------------|
| tasks | status | ENUM | task-serviceæ§åˆ¶ï¼Œmedia-serviceé€šè¿‡å›è°ƒè§¦å‘ |
| tasks | error_message | VARCHAR(500) | media-serviceå›è°ƒè®¾ç½® |

**3. Related Field Synchronization Analysis**
| This Story Updates | Potentially Related Field | Sync Needed? | Reasoning | AC Coverage |
|--------------------|--------------------------|--------------|-----------|-------------|
| tasks.statusâ†’composing | Redis task:progress:{id} | YES | å¼€å§‹åˆæˆæ—¶éœ€åˆå§‹åŒ–Redisè¿›åº¦(å·²æœ‰4.1é€»è¾‘) | AC2 (è¿›åº¦è·Ÿè¸ªï¼Œå¤ç”¨4.1) |
| tasks.statusâ†’completed | Redis task:progress:{id} | NO | Redis TTLè‡ªåŠ¨è¿‡æœŸï¼Œæ— éœ€ä¸»åŠ¨æ¸…ç† | N/A |
| tasks.output_oss_key | æ—  | NO | è¾“å‡ºä¿¡æ¯ä»…åœ¨tasksè¡¨å­˜å‚¨ï¼Œæ— å…¶ä»–è¡¨ä¾èµ– | N/A |
| tasks.statusâ†’failed + error_message | Redis task:progress:{id} | YES | å¤±è´¥æ—¶éœ€æ›´æ–°Redisè¿›åº¦çŠ¶æ€ä¸ºfailed | AC2 (é€šè¿‡å›è°ƒå¤„ç†) |

**4. Uncovered Sync Requirements Handling**
- [x] After analysis, all sync requirements are covered by existing ACs or existing 4.1 mechanisms

### Data Models

**ComposeMessage** (æ‰©å±• - common-core RabbitMQæ¶ˆæ¯ä½“):
```json
{
  "task_id": 12345,
  "script": {
    "paragraphs": [
      { "id": "para_1", "section": "å¼€åœº", "shot_id": 101, "text": "å®¶äººä»¬...", "estimated_duration": 8 },
      { "id": "para_2", "section": "ç¯å¢ƒ", "shot_id": 102, "text": "ä¸€è¿›é—¨...", "estimated_duration": 6 }
    ]
  },
  "voice_config": {
    "type": "standard",
    "voice_id": "xiaomei",
    "voice_sample_id": null
  },
  "subtitle_enabled": true,
  "subtitle_style": "simple_white",
  "callback_url": "http://task-service/internal/tasks/12345/compose-complete"
}
```

**ParagraphDuration** (å†…éƒ¨DTO - TTSè¾“å‡ºä¼ é€’åˆ°è£å‰ª/å­—å¹•):
```json
{
  "paragraph_id": "para_1",
  "shot_id": 101,
  "text": "å®¶äººä»¬ï¼ä»Šå¤©ç»™ä½ ä»¬æ¢ä¸€å®¶æœ›äº¬è¶…ç«çš„æµ·åº•æ...",
  "audio_url": "https://oss.../audio/12345/tts_para_1.mp3",
  "actual_duration_seconds": 8.2
}
```

**ComposeCompleteå›è°ƒ** (æ‰©å±•payload):
```json
{
  "status": "completed",
  "output_oss_key": "output/12345/final.mp4",
  "output_duration_seconds": 62,
  "output_file_size": 47841280
}
```
å¤±è´¥æ—¶:
```json
{
  "status": "failed",
  "error_message": "FFmpeg composition failed: exit code 1"
}
```

**OutputResponse** (æ–°å¢ - task-service GET /output å“åº”):
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "status": "completed",
    "video": {
      "url": "https://cdn.../output/12345/final.mp4",
      "duration_seconds": 62,
      "file_size": 47841280,
      "width": 1080,
      "height": 1920,
      "format": "mp4"
    },
    "shots_used": [
      {
        "id": 101,
        "thumbnail_url": "https://cdn.../thumb.jpg",
        "category": "person",
        "duration_seconds": 8
      }
    ]
  }
}
```

**SubtitleStyleConstants** (ASS V4+ Styleæ ¼å¼):
| Style Key | Font | PrimaryColour | OutlineColour | Outline | Shadow | Bold |
|-----------|------|---------------|---------------|---------|--------|------|
| simple_white | PingFang SC | &H00FFFFFF | &H00000000 | 2 | 1 | 0 |
| vibrant_yellow | PingFang SC | &H0000D7FF | &H00000000 | 2 | 1 | 1 |
| xiaohongshu | PingFang SC | &H00FFFFFF | &H005747FF | 3 | 0 | 0 |
| douyin_hot | PingFang SC | &H00FFFFFF | &H00000000 | 2 | 2 | 1 |
| neon | PingFang SC | &H00FF88FF | &H0000FFFF | 3 | 2 | 1 |

> ASSé¢œè‰²æ ¼å¼ä¸º &HAABBGGRR (æ³¨æ„BGRé¡ºåº)

### File Locations

```
backend/
  common/common-core/
    src/main/java/com/shopvideoscout/common/
      mq/
        ComposeMessage.java              # æ‰©å±•: +subtitleEnabled, +subtitleStyle
      result/
        ResultCode.java                  # æ‰©å±•: +COMPOSITION_FAILED, +VIDEO_CUTTING_FAILED, +OUTPUT_NOT_READY

  task-service/
    src/main/java/com/shopvideoscout/task/
      controller/
        OutputController.java            # æ–°å¢: GET /tasks/{id}/output
        ComposeCallbackController.java   # æ‰©å±•: å¤„ç†outputå›è°ƒä¿¡æ¯
      service/
        ComposeService.java              # æ‰©å±•: ä¼ é€’subtitleè®¾ç½®åˆ°ComposeMessage
      dto/
        OutputResponse.java              # æ–°å¢: è¾“å‡ºè§†é¢‘ä¿¡æ¯DTO
        OutputVideoInfo.java             # æ–°å¢: è§†é¢‘è¯¦æƒ…å†…éƒ¨DTO
        ShotUsedInfo.java                # æ–°å¢: ä½¿ç”¨çš„é•œå¤´ä¿¡æ¯å†…éƒ¨DTO
        ComposeCompleteRequest.java      # æ‰©å±•: +outputOssKey, +outputDurationSeconds, +outputFileSize
    src/main/resources/
      db/migration/
        V4_3__add_subtitle_and_output_fields_to_tasks.sql  # æ–°å¢
    src/test/java/com/shopvideoscout/task/
      controller/
        OutputControllerTest.java        # æ–°å¢
        ComposeCallbackControllerTest.java  # æ‰©å±•

  media-service/
    src/main/java/com/shopvideoscout/media/
      service/
        VideoSegmentCuttingService.java  # æ–°å¢: FFmpegè§†é¢‘è£å‰ª
        VideoCompositionService.java     # æ–°å¢: FFmpegéŸ³è§†é¢‘åˆæˆ
        SubtitleGenerationService.java   # æ–°å¢: ASSå­—å¹•ç”Ÿæˆ
        ComposeProgressTracker.java      # æ‰©å±•: æ–°å¢pipelineé˜¶æ®µ
      config/
        CompositionProperties.java       # æ–°å¢: FFmpegé…ç½®
        SubtitleStyleConstants.java      # æ–°å¢: 5ç§å­—å¹•æ ·å¼å®šä¹‰
      mapper/
        VideoReadMapper.java             # æ–°å¢: åªè¯»è§†é¢‘æ•°æ®mapper
        ScriptReadMapper.java            # æ–°å¢: åªè¯»è„šæœ¬æ•°æ®mapper
      mq/
        ComposeMessageConsumer.java      # æ‰©å±•: å®Œæ•´pipelineç¼–æ’
    src/main/resources/
      application.yml                    # æ‰©å±•: FFmpegè·¯å¾„é…ç½®
    src/test/java/com/shopvideoscout/media/
      service/
        VideoSegmentCuttingServiceTest.java   # æ–°å¢
        VideoCompositionServiceTest.java      # æ–°å¢
        SubtitleGenerationServiceTest.java    # æ–°å¢
      mq/
        ComposeMessageConsumerTest.java       # æ‰©å±•
```

### Deliverable Bindings

> **SM**: Binding for each new code unit. Dev Gate will verify these.
> **Dev**: Ensure all bindings are implemented before self-review.

```yaml
deliverable_bindings:
  # Infrastructure
  - deliverable: "V4_3__add_subtitle_and_output_fields_to_tasks.sql"
    consumer: "backend/task-service/src/main/resources/application.yml"
    binding_type: schema_applied
    verify: "flyway"

  # task-service new classes
  - deliverable: "backend/task-service/.../controller/OutputController.java"
    consumer: "backend/gateway/src/main/resources/application.yml"
    binding_type: route_mount
    verify: "Path=/api/v1/tasks/**"

  - deliverable: "backend/task-service/.../dto/OutputResponse.java"
    consumer: "backend/task-service/.../controller/OutputController.java"
    binding_type: import_usage
    verify: "OutputResponse"

  - deliverable: "backend/task-service/.../dto/OutputVideoInfo.java"
    consumer: "backend/task-service/.../dto/OutputResponse.java"
    binding_type: import_usage
    verify: "OutputVideoInfo"

  - deliverable: "backend/task-service/.../dto/ShotUsedInfo.java"
    consumer: "backend/task-service/.../dto/OutputResponse.java"
    binding_type: import_usage
    verify: "ShotUsedInfo"

  # media-service new classes
  - deliverable: "backend/media-service/.../service/VideoSegmentCuttingService.java"
    consumer: "backend/media-service/.../mq/ComposeMessageConsumer.java"
    binding_type: di_inject
    verify: "VideoSegmentCuttingService"

  - deliverable: "backend/media-service/.../service/VideoCompositionService.java"
    consumer: "backend/media-service/.../mq/ComposeMessageConsumer.java"
    binding_type: di_inject
    verify: "VideoCompositionService"

  - deliverable: "backend/media-service/.../service/SubtitleGenerationService.java"
    consumer: "backend/media-service/.../mq/ComposeMessageConsumer.java"
    binding_type: di_inject
    verify: "SubtitleGenerationService"

  - deliverable: "backend/media-service/.../config/SubtitleStyleConstants.java"
    consumer: "backend/media-service/.../service/SubtitleGenerationService.java"
    binding_type: import_usage
    verify: "SubtitleStyleConstants"

  - deliverable: "backend/media-service/.../config/CompositionProperties.java"
    consumer: "backend/media-service/.../service/VideoSegmentCuttingService.java"
    binding_type: di_inject
    verify: "CompositionProperties"

  - deliverable: "backend/media-service/.../mapper/VideoReadMapper.java"
    consumer: "backend/media-service/.../service/VideoSegmentCuttingService.java"
    binding_type: di_inject
    verify: "VideoReadMapper"

  - deliverable: "backend/media-service/.../mapper/ScriptReadMapper.java"
    consumer: "backend/media-service/.../mq/ComposeMessageConsumer.java"
    binding_type: di_inject
    verify: "ScriptReadMapper"
```

**Binding Status**: â³ Pending Dev verification

### Testing Requirements

- **å•å…ƒæµ‹è¯•é‡ç‚¹**:
  - FFmpegå‘½ä»¤æ„å»ºå’Œå‚æ•°éªŒè¯ï¼ˆmock Processæ‰§è¡Œï¼‰
  - ASSå­—å¹•æ–‡ä»¶ç”Ÿæˆæ ¼å¼æ­£ç¡®æ€§ï¼ˆæ—¶é—´è½´ã€æ ·å¼ã€æ¢è¡Œï¼‰
  - è§†é¢‘è£å‰ªèµ·å§‹ä½ç½®è®¡ç®—ï¼ˆä¸­å¿ƒè£å‰ªé€»è¾‘ã€å¾ªç¯å¤„ç†ï¼‰
  - è¾“å‡ºç«¯ç‚¹æƒé™å’Œæ•°æ®è¿”å›
- **é›†æˆæµ‹è¯•é‡ç‚¹**:
  - å®Œæ•´Pipelineæµç¨‹: composeæ¶ˆæ¯ â†’ TTS â†’ å­—å¹• â†’ è£å‰ª â†’ åˆæˆ â†’ ä¸Šä¼  â†’ å›è°ƒ
  - å­—å¹•é™çº§: å­—å¹•ç”Ÿæˆå¤±è´¥æ—¶ç»§ç»­æ— å­—å¹•åˆæˆ
  - å›è°ƒå¤±è´¥é‡è¯•æœºåˆ¶
  - ä¸´æ—¶æ–‡ä»¶æ¸…ç†éªŒè¯
- **è¾¹ç•Œæµ‹è¯•**:
  - è§†é¢‘æ—¶é•¿ä¸è¶³æ—¶çš„å¾ªç¯/æˆªæ–­å¤„ç†
  - è¶…é•¿è„šæœ¬æ–‡æœ¬çš„å­—å¹•æ¢è¡Œï¼ˆ>20å­—ç¬¦ï¼‰
  - subtitleEnabled=falseæ—¶è·³è¿‡å­—å¹•æ­¥éª¤
  - ä»»åŠ¡écompletedçŠ¶æ€ä¸‹æŸ¥è¯¢outputè¿”å›OUTPUT_NOT_READY

---

## AC Traceability Matrix

> **Dev**: Fill this section BEFORE self-review. Every AC needs evidence.
> **QA**: Verify each entry during AC Coverage Verification.

### AC1: è§†é¢‘ç‰‡æ®µè£å‰ª

```yaml
ac_id: AC1
code_locations:
  - "backend/media-service/src/main/java/com/shopvideoscout/media/service/VideoSegmentCuttingService.java"
  - "backend/media-service/src/main/java/com/shopvideoscout/media/mapper/VideoReadMapper.java"
test_locations:
  - "backend/media-service/src/test/java/com/shopvideoscout/media/service/VideoSegmentCuttingServiceTest.java"
verification_type: unit_test
aspects_covered:
  main_scenario: true
  business_rules: true
  data_validation: true
  error_handling: true
notes: "Center position calculation, 0.5s transition, loop for short videos, shot_id lookup"
```

### AC2: éŸ³è§†é¢‘åˆæˆ

```yaml
ac_id: AC2
code_locations:
  - "backend/media-service/src/main/java/com/shopvideoscout/media/service/VideoCompositionService.java"
  - "backend/media-service/src/main/java/com/shopvideoscout/media/config/CompositionProperties.java"
  - "backend/task-service/src/main/java/com/shopvideoscout/task/controller/OutputController.java"
test_locations:
  - "backend/media-service/src/test/java/com/shopvideoscout/media/service/VideoCompositionServiceTest.java"
  - "backend/task-service/src/test/java/com/shopvideoscout/task/controller/OutputControllerTest.java"
verification_type: unit_test
aspects_covered:
  main_scenario: true
  business_rules: true
  data_validation: true
  error_handling: true
notes: "FFmpeg concat demuxer, H.264 1080x1920, 4Mbps, 30fps, AAC 128k, faststart, OSS upload with retry"
```

### AC3: å­—å¹•ç”Ÿæˆä¸çƒ§å½•

```yaml
ac_id: AC3
code_locations:
  - "backend/media-service/src/main/java/com/shopvideoscout/media/service/SubtitleGenerationService.java"
  - "backend/media-service/src/main/java/com/shopvideoscout/media/config/SubtitleStyleConstants.java"
test_locations:
  - "backend/media-service/src/test/java/com/shopvideoscout/media/service/SubtitleGenerationServiceTest.java"
verification_type: unit_test
aspects_covered:
  main_scenario: true
  business_rules: true
  data_validation: true
  error_handling: true
notes: "ASS format, cumulative time axis, dual-line scrolling, 20-char wrap, 5 preset styles, graceful degradation"
```

---

### Traceability Summary

| AC | Code Location | Test Location | Type | Status |
|----|---------------|---------------|------|--------|
| AC1 | VideoSegmentCuttingService.java | VideoSegmentCuttingServiceTest.java | unit | âœ… |
| AC2 | VideoCompositionService.java, OutputController.java | VideoCompositionServiceTest.java, OutputControllerTest.java | unit | âœ… |
| AC3 | SubtitleGenerationService.java, SubtitleStyleConstants.java | SubtitleGenerationServiceTest.java | unit | âœ… |

**Legend**: âœ… Verified | â³ Pending | âŒ Missing

## Dev Agent Record

### Implementation Summary

**Date**: 2026-01-29
**Developer**: JT (Dev Agent)

### Files Created/Modified

#### Infrastructure (T0)
- `backend/task-service/src/main/resources/db/migration/V4_3__add_subtitle_and_output_fields_to_tasks.sql` - NEW
- `backend/common-core/src/main/java/com/shopvideoscout/common/mq/ComposeMessage.java` - MODIFIED (added subtitleEnabled, subtitleStyle, shotId)
- `backend/common-core/src/main/java/com/shopvideoscout/common/result/ResultCode.java` - MODIFIED (added COMPOSITION_FAILED, VIDEO_CUTTING_FAILED, OUTPUT_NOT_READY)
- `backend/media-service/src/main/java/com/shopvideoscout/media/config/CompositionProperties.java` - NEW
- `backend/media-service/src/main/java/com/shopvideoscout/media/mapper/VideoReadMapper.java` - NEW
- `backend/media-service/src/main/java/com/shopvideoscout/media/mapper/ScriptReadMapper.java` - NEW
- `backend/task-service/src/main/java/com/shopvideoscout/task/service/ComposeService.java` - MODIFIED (pass subtitle settings)

#### Video Cutting (T1)
- `backend/media-service/src/main/java/com/shopvideoscout/media/service/VideoSegmentCuttingService.java` - NEW
- `backend/media-service/src/test/java/com/shopvideoscout/media/service/VideoSegmentCuttingServiceTest.java` - NEW

#### Video Composition (T2)
- `backend/media-service/src/main/java/com/shopvideoscout/media/service/VideoCompositionService.java` - NEW
- `backend/media-service/src/test/java/com/shopvideoscout/media/service/VideoCompositionServiceTest.java` - NEW

#### Subtitle Generation (T3)
- `backend/media-service/src/main/java/com/shopvideoscout/media/config/SubtitleStyleConstants.java` - NEW
- `backend/media-service/src/main/java/com/shopvideoscout/media/service/SubtitleGenerationService.java` - NEW
- `backend/media-service/src/test/java/com/shopvideoscout/media/service/SubtitleGenerationServiceTest.java` - NEW

#### Pipeline & Output (T4)
- `backend/media-service/src/main/java/com/shopvideoscout/media/service/ComposeProgressTracker.java` - MODIFIED (added phases)
- `backend/media-service/src/main/java/com/shopvideoscout/media/mq/ComposeMessageConsumer.java` - MODIFIED (full pipeline)
- `backend/media-service/src/main/java/com/shopvideoscout/media/service/TaskCallbackClient.java` - MODIFIED (output info)
- `backend/task-service/src/main/java/com/shopvideoscout/task/controller/ComposeCallbackController.java` - MODIFIED (handle output)
- `backend/task-service/src/main/java/com/shopvideoscout/task/dto/OutputVideoInfo.java` - NEW
- `backend/task-service/src/main/java/com/shopvideoscout/task/dto/ShotUsedInfo.java` - NEW
- `backend/task-service/src/main/java/com/shopvideoscout/task/dto/OutputResponse.java` - NEW
- `backend/task-service/src/main/java/com/shopvideoscout/task/controller/OutputController.java` - NEW
- `backend/task-service/src/test/java/com/shopvideoscout/task/controller/OutputControllerTest.java` - NEW

### Database Changes

```yaml
database-changes:
  - table: tasks
    operation: ALTER
    columns_added:
      - subtitle_enabled (BOOLEAN DEFAULT TRUE)
      - subtitle_style (VARCHAR(50) DEFAULT 'simple_white')
      - output_oss_key (VARCHAR(500) NULL)
      - output_duration_seconds (INT NULL)
      - output_file_size (BIGINT NULL)
      - error_message (VARCHAR(500) NULL)
    indexes_added:
      - idx_tasks_output_oss_key
```

### API Endpoints Created

```yaml
api-endpoints-created:
  - method: GET
    path: /api/v1/tasks/{id}/output
    service: task-service
    controller: OutputController
    response: OutputResponse
    auth_required: true
```

### Shared Models Created

```yaml
shared-models-created:
  - name: ComposeMessage.subtitleEnabled
    type: Boolean
    location: common-core
  - name: ComposeMessage.subtitleStyle
    type: String
    location: common-core
  - name: ComposeMessage.Paragraph.shotId
    type: Long
    location: common-core
  - name: ResultCode.COMPOSITION_FAILED
    type: enum
    code: 1023
    location: common-core
  - name: ResultCode.VIDEO_CUTTING_FAILED
    type: enum
    code: 1024
    location: common-core
  - name: ResultCode.OUTPUT_NOT_READY
    type: enum
    code: 1025
    location: common-core
```

### Architecture Decisions

1. **FFmpeg Process Execution**: Direct process execution via ProcessBuilder with timeout and retry logic
2. **Temporary File Management**: Task-specific temp directories under configurable base path, cleaned up after composition
3. **Subtitle Graceful Degradation**: Subtitle generation failures don't block video composition
4. **OSS Upload Retry**: Configurable retry with exponential backoff for upload operations
5. **Pipeline Phase Tracking**: Redis-based progress tracking with phase names for frontend display

## QA Results

### Review Date: 2026-01-29
### Reviewed By: JW (Test Architect)
### Review Round: 1
### Gate: PASS
### Quality Score: 95/100

### AC Coverage Verification

| AC | Code Verified | Tests Verified | Status |
|----|:-------------:|:--------------:|:------:|
| AC1 | VideoSegmentCuttingService, VideoReadMapper | VideoSegmentCuttingServiceTest | VERIFIED |
| AC2 | VideoCompositionService, CompositionProperties, OutputController | VideoCompositionServiceTest, OutputControllerTest | VERIFIED |
| AC3 | SubtitleGenerationService, SubtitleStyleConstants | SubtitleGenerationServiceTest | VERIFIED |

### Automated Tests
- Total: 18 | Passed: 18 | Failed: 0
- Coverage: 85%
- Status: PASS

### Blind Spot Coverage
- Total: 16 scenarios | Covered: 14 (87%)
- Missing (Low severity): Large file streaming test, MQ idempotency test

### Deliverables Verified
- Migration V4_3: All 6 columns added correctly
- media-service: VideoSegmentCuttingService, VideoCompositionService, SubtitleGenerationService, SubtitleStyleConstants, CompositionProperties, VideoReadMapper, ScriptReadMapper
- task-service: OutputController, OutputResponse, OutputVideoInfo, ShotUsedInfo

### Issues Found
None (blocking). Two low-severity blind spot gaps noted but acceptable.

### Gate File
`docs/qa/gates/4.3-video-composition.yml`

---

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Comprehensive |
| test_design_status | Complete |
| complexity_indicators | 6 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-28 |
| document | qa/assessments/4.3-test-design-20260128.md |

---

## Architect Review Results

### Review Date: 2026-01-28
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.0/10
### Review Round: 1

### Decision: AwaitingTestDesign (Approved â†’ Needs QA Test Design)

### Issues

#### Critical Issues (0)
None.

#### High Issues (0)
None.

#### Medium Issues (1)
- **OutputResponse Example Code Field** (Dev Notes â†’ Data Models â†’ OutputResponse): Response example shows `"code": 200` but architecture Â§6.1 R<T> convention uses `"code": 0` for success. Since OutputController will use `R.ok(data)`, the actual implementation will produce the correct value, but the example should match to avoid developer confusion.
  - Recommendation: Change `"code": 200` to `"code": 0` in the OutputResponse example JSON.

#### Low Issues (1)
- **shots_used Data Source Not Explicit** (T4 â†’ OutputController): OutputResponse includes `shots_used` array (matching Â§6.2) but T4 subtasks don't describe how OutputController retrieves shot data. It needs to query scripts table (for paragraph shot_ids) and videos table (for thumbnail, category, duration). Straightforward in monolith with shared DB but should be documented.
  - Recommendation: Add T4 subtask: "Query scripts and videos tables to build shots_used in OutputResponse (join tasks â†’ scripts.content.paragraphs[].shot_id â†’ videos)."

### Recommendations
- Fix the OutputResponse code field in the Data Models example.
- Add the shots_used query subtask to T4 for implementation clarity.

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-28 | SM | Draft â†’ AwaitingArchReview | Story recreated with comprehensive Dev Notes, YAML metadata, full pipeline spec |
| 2026-01-28 | Architect | AwaitingArchReview â†’ AwaitingTestDesign | Score: 9.0/10, 0 critical / 0 major issues. Test Design Level: Comprehensive. Handoff to QA |
| 2026-01-28 | QA | AwaitingTestDesign â†’ TestDesignComplete â†’ Approved | Test Design Doc: qa/assessments/4.3-test-design-20260128.md. Scenarios: 49 (P0: 13, P1: 30, P2: 6). Blind Spot: 16. Status: AwaitingTestDesign â†’ TestDesignComplete â†’ Approved (QA two-phase transition). Ready for Dev implementation |
| 2026-01-29 | Dev | Approved â†’ Review | Implementation complete. T0-T5 all done. 22 files created/modified. Full pipeline: TTS â†’ Subtitle â†’ Cut â†’ Compose â†’ Upload â†’ Callback. Unit tests for all 3 ACs. Ready for QA review. |
| 2026-01-29 | QA | Review â†’ Done | Round 1. Gate: PASS. Score: 95/100. All 3 ACs verified. 18/18 tests passing. 87% blind spot coverage. No blocking issues. |
