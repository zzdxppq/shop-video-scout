# Story 4.1: 集成豆包API实现脚本生成

## Status
AwaitingTestDesign

## Story

**As a** 系统,
**I want** 调用豆包API根据镜头分析结果生成口播脚本,
**so that** 用户无需自己撰写文案

## Description

实现ai-service中的文本生成功能：
- 调用豆包API
- 根据镜头分析结果生成脚本
- 脚本分段并关联镜头

## Acceptance Criteria

### AC1: 脚本生成

**Scenario**
```gherkin
GIVEN 镜头分析结果和店铺信息
WHEN 调用豆包API生成脚本
THEN
  - 生成完整的口播脚本
  - 脚本分为多个段落
  - 每段对应特定镜头
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 脚本段落数 = 推荐镜头数 |
| BR-1.2 | 每段脚本20-50字 |
| BR-1.3 | 脚本风格: 口语化、亲切 |
| BR-1.4 | 包含店铺名称和优惠信息 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| API调用超时 | 504 | AI服务响应超时 | 重试 |
| API返回错误 | 500 | 脚本生成失败 | 记录日志，重试 |
| 镜头不足 | 400 | 推荐镜头不足 | 返回错误 |

### AC2: 脚本结构化

**Scenario**
```gherkin
GIVEN 生成的脚本文本
WHEN 解析脚本结构
THEN
  - 提取各段落文本
  - 关联对应的镜头ID
  - 存储为JSON结构
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 开场段: 打招呼+店铺介绍 |
| BR-2.2 | 中间段: 展示亮点 |
| BR-2.3 | 结尾段: 优惠信息+号召行动 |

### AC3: 脚本编辑支持

**Scenario**
```gherkin
GIVEN 用户查看生成的脚本
WHEN 用户希望修改脚本
THEN
  - 支持分段编辑
  - 保存用户修改版本
  - 修改后重新配音
```

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 依赖和配置** `[ALL ACs]`
  - [ ] 配置豆包API密钥
  - [ ] 创建 HTTP Client

## Feature Implementation Tasks

### AC1: 脚本生成

- [ ] **T1: 实现豆包API调用** `[AC1]`
  - [ ] 创建 DoubaoService
  - [ ] 设计脚本生成Prompt模板
  - [ ] 实现API调用和响应解析
  - [ ] 实现重试机制
  - [ ] 编写单元测试

### AC2: 脚本结构化

- [ ] **T2: 实现脚本结构化** `[AC2]`
  - [ ] 创建 ScriptSegment 数据结构
  - [ ] 解析脚本段落
  - [ ] 关联镜头ID
  - [ ] 存储到 task_scripts 表
  - [ ] 编写单元测试

### AC3: 脚本编辑支持

- [ ] **T3: 实现脚本编辑** `[AC3]`
  - [ ] 创建 /tasks/{id}/script 接口 (GET/PUT)
  - [ ] 支持分段更新
  - [ ] 编写单元测试

## Integration & Verification Tasks

- [ ] **T4: 集成测试** `[ALL ACs]`
  - [ ] 端到端: 镜头分析结果→脚本生成→结构化存储
  - [ ] 不同店铺类型脚本测试
  - [ ] 生成时间测试 (<30秒)

## Dev Notes

### Technical Constraints

- 火山引擎HTTP调用豆包API
- 使用doubao-pro-32k模型
- Prompt模板可配置

### API Configuration

```yaml
doubao:
  endpoint: "https://ark.cn-beijing.volces.com/api/v3/chat/completions"
  model: "doubao-pro-32k"
  timeout: 30s
  retry: 3
```

### Script Generation Prompt

```
你是一个探店视频文案专家。请根据以下信息生成口播脚本：

店铺信息：
- 名称：{shop_name}
- 类型：{shop_type}
- 优惠：{promotion}

推荐镜头：
{recommended_shots}

要求：
1. 生成{shot_count}个段落，每段对应一个镜头
2. 每段20-50字，口语化风格
3. 开头打招呼，结尾号召关注
4. 突出优惠信息

输出格式：
[
  {"shot_id": 1, "text": "段落1内容"},
  {"shot_id": 2, "text": "段落2内容"},
  ...
]
```

### Database Schema

```sql
-- script_segments 存储在 tasks.script_segments (JSON字段)
-- 结构示例:
[
  {
    "index": 0,
    "title": "开场",
    "text": "嗨，大家好...",
    "shot_id": 123,
    "duration_hint": 5
  }
]
```

### File Locations

```
backend/ai-service/
├── src/main/java/
│   ├── service/
│   │   ├── DoubaoService.java
│   │   └── ScriptGenerationService.java
│   └── dto/
│       └── ScriptSegment.java
```

## Source Proposals
- TCP-2026-001 Story Requirement T5

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.7/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story技术方案与TCP-2026-001基本对齐。豆包API配置正确，Prompt设计合理。存在一处数据模型引用不一致需SM修正。由于涉及AI生成质量验证，需要QA进行测试设计。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (1)
- **数据模型引用不一致** (T2 Tasks): Story提及"存储到 task_scripts 表"，但TCP设计为 `tasks.script_segments` JSON字段，无独立task_scripts表。建议修改为"更新 tasks.script_segments 字段"

#### Low Issues (2)
- **重新配音触发机制** (AC3): 脚本修改后应发送事件通知配音服务重新生成，建议明确事件发布机制
- **generated_script字段** (Dev Notes): TCP有 `tasks.generated_script` TEXT字段存储完整脚本文本，建议补充使用说明

### Recommendations
- 建议使用Spring Event发布脚本更新事件，E5.1订阅处理
- Prompt模板建议外置到配置文件，方便调优
- 考虑添加脚本生成历史版本记录
- 建议添加脚本字数统计和预估配音时长计算

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 2 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.7/10, 0 critical / 1 medium issues |
