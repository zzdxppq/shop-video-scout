# Story 1.2: 实现API网关路由和认证

## Status
Approved

## Story

**As a** 系统架构师,
**I want** 实现统一的API网关服务,
**so that** 可以集中管理路由、认证和限流

## Description

实现Gateway服务核心功能：
- 路由配置 (路由到各微服务)
- JWT Token验证
- 限流熔断基础配置

## Acceptance Criteria

### AC1: 路由配置

**Scenario**
```gherkin
GIVEN API网关服务已启动
WHEN 收到匹配路由规则的请求
THEN
  - 请求被正确转发到对应微服务
  - 支持路径前缀匹配
  - 支持API版本化 (/api/v1/*)
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | /api/v1/auth/** → user-service |
| BR-1.2 | /api/v1/user/** → user-service |
| BR-1.3 | /api/v1/tasks/** → task-service |
| BR-1.4 | /api/v1/ai/** → ai-service |
| BR-1.5 | /api/v1/media/** → media-service |
| BR-1.6 | /api/v1/publish/** → publish-service |

### AC2: JWT Token验证

**Scenario**
```gherkin
GIVEN 请求到达API网关
WHEN 请求路径不在白名单中
THEN
  - 验证Authorization头中的JWT Token
  - Token有效则转发请求
  - Token无效返回401
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 白名单: /api/v1/auth/send-code, /api/v1/auth/login |
| BR-2.2 | Token格式: Bearer {jwt_token} |
| BR-2.3 | 验证Token签名和过期时间 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| Token缺失 | 401 | Token is required | 返回错误 |
| Token格式错误 | 401 | Invalid token format | 返回错误 |
| Token过期 | 401 | Token expired | 返回错误 |
| Token签名无效 | 401 | Invalid token signature | 返回错误 |

### AC3: 限流熔断配置

**Scenario**
```gherkin
GIVEN API网关收到大量请求
WHEN 请求频率超过限流阈值
THEN
  - 超出限制的请求返回429
  - 下游服务异常时触发熔断
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 默认限流: 100 QPS per IP |
| BR-3.2 | 熔断阈值: 失败率>50% |
| BR-3.3 | 熔断恢复时间: 30秒 |

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 依赖配置** `[ALL ACs]`
  - [ ] 添加 Spring Cloud Gateway 依赖
  - [ ] 添加 Spring Security 依赖
  - [ ] 添加 jjwt 库
  - [ ] 添加 Resilience4j 依赖

## Feature Implementation Tasks

### AC1: 路由配置

- [ ] **T1: 实现路由配置** `[AC1]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Auth route | GET /api/v1/auth/xxx | Forward to user-service | integration |
  | Tasks route | GET /api/v1/tasks/xxx | Forward to task-service | integration |
  | Unknown route | GET /api/v1/unknown | 404 Not Found | integration |
  | CORS headers | OPTIONS request | Access-Control headers | integration |

  - [ ] 创建 application.yml 路由配置
  - [ ] 配置各服务路由规则
  - [ ] 添加 CORS 配置
  - [ ] 验证路由转发正确

### AC2: JWT Token验证

- [ ] **T2: 实现JWT认证过滤器** `[AC2]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Valid token | Bearer {valid_jwt} | 200 + X-User-Id header | integration |
  | No token | No Authorization header | 401 Token is required | integration |
  | Expired token | Bearer {expired_jwt} | 401 Token expired | unit |
  | Invalid signature | Bearer {tampered_jwt} | 401 Invalid token signature | unit |
  | Whitelist bypass | GET /api/v1/auth/login | 200 (no auth needed) | integration |
  | Empty bearer | Authorization: Bearer | 401 Invalid token format | integration |

  - [ ] 创建 JwtAuthenticationFilter
  - [ ] 配置白名单路径
  - [ ] 实现Token解析和验证
  - [ ] 添加用户信息到请求头 (X-User-Id)
  - [ ] 编写单元测试

### AC3: 限流熔断配置

- [ ] **T3: 配置限流熔断** `[AC3]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Below rate limit | <100 QPS from IP | 200 OK | integration |
  | Exceed rate limit | >100 QPS from IP | 429 Too Many Requests | integration |
  | Circuit open | >50% failures | 503 Service Unavailable | integration |
  | Circuit recovery | After 30s wait | Allow test request | integration |

  - [ ] 配置 Resilience4j RateLimiter
  - [ ] 配置 CircuitBreaker
  - [ ] 添加自定义错误响应
  - [ ] 验证限流和熔断生效

## Integration & Verification Tasks

- [ ] **T4: 集成测试** `[ALL ACs]`
  - [ ] 测试无Token请求返回401
  - [ ] 测试有效Token请求通过
  - [ ] 测试路由转发正确
  - [ ] 测试限流生效

## Dev Notes

### Technical Constraints

- Spring Cloud Gateway + Spring Security
- JWT使用jjwt库
- Resilience4j实现限流熔断

### Route Configuration

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/v1/auth/**, /api/v1/user/**, /api/v1/voice/**
        - id: task-service
          uri: lb://task-service
          predicates:
            - Path=/api/v1/tasks/**
        # ... more routes
```

### File Locations

```
backend/gateway-service/
├── src/main/java/
│   ├── config/
│   │   ├── SecurityConfig.java
│   │   ├── CorsConfig.java
│   │   └── RateLimiterConfig.java
│   └── filter/
│       └── JwtAuthenticationFilter.java
└── src/main/resources/
    └── application.yml
```

## Source Proposals
- TCP-2026-001 Story Requirement T2

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story技术方案与TCP-2026-001完全对齐。路由配置、JWT认证、限流熔断设计合理。由于涉及安全认证逻辑，需要QA进行测试设计。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (3)
- **Voice路由规则缺失** (AC1 BR): Dev Notes示例包含 `/api/v1/voice/**` 但BR未列出，建议补充BR-1.7
- **JWT密钥管理** (AC2): 建议补充密钥配置策略说明（环境变量/配置中心）
- **请求日志** (Dev Notes): TCP提及request logging功能，建议补充日志记录任务

### Recommendations
- 建议使用 `@ConfigurationProperties` 管理JWT配置
- 考虑添加 `GlobalFilter` 记录请求响应日志
- Rate Limiter建议使用Redis实现分布式限流

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 2 |
| security_sensitive | true |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |
| test_design_status | Complete |
| test_design_document | docs/qa/assessments/E1.2-test-design-20260115.md |
| scenarios_total | 34 |
| scenarios_p0 | 14 |
| scenarios_p1 | 14 |
| scenarios_p2 | 6 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9/10, 0 critical / 0 major issues, security_sensitive=true |
| 2026-01-15 | QA | AwaitingTestDesign → Approved | Test Design Complete: 34 scenarios (P0:14, P1:14, P2:6), Doc: docs/qa/assessments/E1.2-test-design-20260115.md |
