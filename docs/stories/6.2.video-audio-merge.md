# Story 6.2: 合并视频片段与配音音频

## Status
AwaitingTestDesign

## Story

**As a** 系统,
**I want** 将裁剪的视频片段与TTS配音合并为完整视频,
**so that** 用户可以获得成品视频

## Description

实现视频合成功能：
- 视频片段按脚本顺序拼接
- 配音音频与视频画面同步
- 输出完整MP4成品

## Acceptance Criteria

### AC1: 视频片段拼接

**Scenario**
```gherkin
GIVEN 多个裁剪好的视频片段
WHEN 执行视频拼接
THEN
  - 按脚本顺序拼接片段
  - 无黑帧、无卡顿
  - 保持原始画质
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 拼接顺序按 segment_index |
| BR-1.2 | 使用concat协议拼接 |
| BR-1.3 | 统一输出分辨率 (如不一致则缩放) |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 片段缺失 | 400 | 视频片段不完整 | 返回错误 |
| 分辨率不一致 | - | - | 自动缩放到最大分辨率 |

### AC2: 音视频合并

**Scenario**
```gherkin
GIVEN 拼接好的视频和配音音频
WHEN 执行音视频合并
THEN
  - 配音替换原始音轨
  - 音画同步
  - 输出完整MP4
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 移除原始音轨 |
| BR-2.2 | 添加TTS配音音轨 |
| BR-2.3 | 音频编码: AAC |

### AC3: 简单转场效果

**Scenario**
```gherkin
GIVEN 用户选择添加转场
WHEN 执行视频合成
THEN
  - 片段之间添加淡入淡出
  - 转场时长0.3-0.5秒
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 默认转场: crossfade 0.3秒 |
| BR-3.2 | 转场为可选功能 |

### AC4: 输出压缩

**Scenario**
```gherkin
GIVEN 合成完成的视频
WHEN 执行输出压缩
THEN
  - 文件大小合理 (<100MB/分钟)
  - 画质可接受 (1080p)
  - 上传到OSS
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-4.1 | 输出格式: MP4 (H.264) |
| BR-4.2 | 视频码率: 5Mbps (1080p) |
| BR-4.3 | 音频码率: 128kbps |

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 环境配置** `[ALL ACs]`
  - [ ] FFmpeg支持libx264
  - [ ] 配置输出目录

## Feature Implementation Tasks

### AC1: 视频片段拼接

- [ ] **T1: 实现视频拼接** `[AC1]`
  - [ ] 创建 VideoMergeService
  - [ ] 生成concat文件列表
  - [ ] 执行FFmpeg拼接
  - [ ] 编写单元测试

### AC2: 音视频合并

- [ ] **T2: 实现音视频合并** `[AC2]`
  - [ ] 合并配音音频
  - [ ] 移除原始音轨
  - [ ] 输出最终视频
  - [ ] 编写单元测试

### AC3: 简单转场效果

- [ ] **T3: 实现转场效果** `[AC3]`
  - [ ] 实现crossfade滤镜
  - [ ] 支持转场开关参数
  - [ ] 编写单元测试

### AC4: 输出压缩

- [ ] **T4: 实现输出压缩** `[AC4]`
  - [ ] 配置编码参数
  - [ ] 执行压缩编码
  - [ ] 上传成品到OSS
  - [ ] 更新任务状态
  - [ ] 编写单元测试

## Integration & Verification Tasks

- [ ] **T5: 集成测试** `[ALL ACs]`
  - [ ] 端到端: 片段裁剪→拼接→合并→压缩
  - [ ] 不同分辨率视频测试
  - [ ] 性能测试 (合成时间)

## Dev Notes

### Technical Constraints

- FFmpeg 6.x with libx264
- 临时文件清理
- 大文件处理优化

### FFmpeg Commands

```bash
# 生成concat列表
echo "file 'seg1.mp4'" > list.txt
echo "file 'seg2.mp4'" >> list.txt

# 拼接视频
ffmpeg -f concat -safe 0 -i list.txt -c copy merged.mp4

# 合并音频
ffmpeg -i merged.mp4 -i voice.mp3 -c:v copy -c:a aac -map 0:v:0 -map 1:a:0 output.mp4

# 带转场的拼接 (更复杂)
ffmpeg -i seg1.mp4 -i seg2.mp4 -filter_complex "[0][1]xfade=transition=fade:duration=0.3:offset=4.7" output.mp4

# 压缩输出
ffmpeg -i input.mp4 -c:v libx264 -preset medium -crf 23 -c:a aac -b:a 128k output.mp4
```

### File Locations

```
backend/media-service/
├── src/main/java/
│   ├── service/
│   │   ├── VideoMergeService.java
│   │   ├── VideoComposeService.java
│   │   └── VideoCompressService.java
│   └── util/
│       └── FfmpegUtils.java
```

## Source Proposals
- TCP-2026-001 Story Requirement T8
- PCP-2026-001 Story Requirement 3

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.2/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story技术方案与TCP-2026-001完全对齐。FFmpeg concat和merge_audio命令与TCP定义一致，覆盖了media-service video模块的所有功能（音视频合并、转场效果、输出压缩）。由于涉及复杂的FFmpeg操作链和大文件处理，需要QA进行测试设计。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (1)
- **多音频片段处理** (AC2 Tasks): Story假设合并单个voice.mp3，但E5.1 TTS按segment生成多个音频文件（task_voice_segments表）。建议在T2中明确：1)先concat所有voice segments为单个音频文件，2)再与视频合并。或采用逐段合并策略

#### Low Issues (3)
- **tasks表输出字段更新** (T4 Tasks): 建议明确更新 `output_video_key`, `output_video_url`, `output_video_duration`, `output_video_size` 字段，并设置任务状态为COMPLETED
- **转场效果性能** (AC3): xfade滤镜需要重新编码（无法使用 `-c copy`），会显著增加处理时间。建议明确：启用转场时预计增加2-3x处理时间
- **分辨率统一策略** (BR-1.3): "缩放到最大分辨率"可能导致小视频被拉伸失真，建议改为固定输出1080p或保持原始分辨率中的最小值

### Recommendations
- 建议将视频合成流程封装为Pipeline: cut → concat video → concat audio → merge → compress
- 转场效果建议作为高级选项，默认关闭以优化处理速度
- 压缩参数CRF 23较为保守，可考虑CRF 20-21获得更好画质
- 大文件处理建议使用流式写入，避免内存溢出

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 3 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP/PCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.2/10, 0 critical / 1 medium issues |
