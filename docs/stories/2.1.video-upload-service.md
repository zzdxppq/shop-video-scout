# Story 2.1: 视频上传服务实现

## Status
Draft

## Story

**As a** 用户,
**I want** 上传探店视频文件到系统,
**so that** AI可以分析视频内容

## Acceptance Criteria

### AC1: 获取OSS预签名上传URL

**Scenario**
```gherkin
GIVEN 用户准备上传视频文件
WHEN 请求上传URL
THEN
  - 生成OSS预签名上传URL
  - URL有效期15分钟
  - 返回上传URL和文件key
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 文件存储路径格式：videos/{user_id}/{task_id}/{uuid}.{ext} |
| BR-1.2 | 仅支持mp4和mov格式 |
| BR-1.3 | 单文件最大100MB |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| filename | string | true | 有效文件名，扩展名为mp4或mov | 仅支持MP4和MOV格式视频 |
| file_size | number | true | 小于100MB | 单个视频不能超过100MB |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 文件格式不支持 | 400 | 仅支持MP4和MOV格式 | 返回支持的格式列表 |
| 文件过大 | 400 | 单个视频不能超过100MB | 返回文件大小限制 |

---

### AC2: 确认上传完成并处理

**Scenario**
```gherkin
GIVEN 视频文件已上传到OSS
WHEN 前端确认上传完成
THEN
  - 创建视频记录
  - 使用FFmpeg提取关键帧
  - 生成视频缩略图
  - 获取视频元信息（时长、分辨率）
  - 返回视频信息
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 每2秒提取1帧关键帧 |
| BR-2.2 | 缩略图尺寸为320x180 |
| BR-2.3 | 视频时长超过3分钟则拒绝 |
| BR-2.4 | 每个任务最多20个视频 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 视频时长超限 | 400 | 视频时长不能超过3分钟 | 删除已上传文件，返回错误 |
| 视频数量超限 | 400 | 每个任务最多上传20个视频 | 返回当前视频数量 |

---

## Tasks / Subtasks

- [ ] **T1: OSS预签名URL生成** `[AC1]`
- [ ] **T2: 视频处理服务（FFmpeg）** `[AC2]`
- [ ] **T3: 视频CRUD API** `[ALL ACs]`

## Dev Notes

### Provides APIs
- `POST /api/v1/tasks/{id}/videos/upload-url`
- `POST /api/v1/tasks/{id}/videos`
- `GET /api/v1/tasks/{id}/videos`
- `DELETE /api/v1/tasks/{id}/videos/{video_id}`

### Dependencies
- 依赖 Story 1.4 (任务创建)

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created → Draft | Story created from PRD Epic 2 |
