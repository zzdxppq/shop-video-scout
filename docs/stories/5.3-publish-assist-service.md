---
id: "5.3"
title: "å‘å¸ƒè¾…åŠ©æœåŠ¡"
epic: "5 - é¢„è§ˆå¯¼å‡ºä¸å‘å¸ƒè¾…åŠ©"
status: Review
mode: plan
repository: monolith
priority: P0
estimated_complexity: medium
tier: standard
---

# Story 5.3: å‘å¸ƒè¾…åŠ©æœåŠ¡

## Story

**As a** ç³»ç»Ÿ,
**I want** ä¸ºç”¨æˆ·ç”Ÿæˆçƒ­é—¨è¯é¢˜æ ‡ç­¾å’Œè§†é¢‘æ ‡é¢˜æ¨è,
**so that** ç”¨æˆ·å‘å¸ƒè§†é¢‘åˆ°ç¤¾äº¤å¹³å°æ—¶æ›´é«˜æ•ˆã€æ›´æœ‰å¸å¼•åŠ›

### ğŸ”Œ APIs Provided by This Story

- `GET /api/v1/publish/tasks/{id}/assist` (publish-service)
- `POST /api/v1/publish/tasks/{id}/assist/regenerate` (publish-service)

### ğŸ”Œ APIs Consumed by This Story

- `GET /internal/tasks/{id}` (from task-service - get task details: shop_name, shop_type)
- `GET /internal/tasks/{id}/script` (from task-service - get script content)
- Doubao API (External - ç«å±±å¼•æ“è±†åŒ…å¤§æ¨¡å‹, via common/doubao-client)

## Epic Context

**Epic**: 5 - é¢„è§ˆå¯¼å‡ºä¸å‘å¸ƒè¾…åŠ©

å®ç°æˆå“è§†é¢‘çš„åœ¨çº¿é¢„è§ˆæ’­æ”¾ã€ä¸‹è½½å¯¼å‡ºåŠŸèƒ½ï¼Œé›†æˆAIç”Ÿæˆçƒ­é—¨è¯é¢˜æ ‡ç­¾å’Œè§†é¢‘æ ‡é¢˜æ¨èï¼Œæå‡å‘å¸ƒæ•ˆç‡ã€‚

**Story Deliverables**:
- å‘å¸ƒè¾…åŠ©APIæ§åˆ¶å™¨ (PublishAssistController in publish-service)
- è¯é¢˜ç”ŸæˆæœåŠ¡ (TopicGenerationService)
- æ ‡é¢˜ç”ŸæˆæœåŠ¡ (TitleGenerationService)
- Doubao APIé›†æˆå®¢æˆ·ç«¯ (DoubaoClient in common module - shared)
- å‘å¸ƒè¾…åŠ©æ•°æ®æŒä¹…åŒ– (publish_assists table)

## Architecture Alignment

> **Revision Note**: This revision addresses architect feedback from Round 1 (Score 6.0/10)

| Issue | Fix Applied |
|-------|-------------|
| æœåŠ¡å½’å±é”™è¯¯ | âœ… All code migrated from `ai-service` to `publish-service` per Â§4.6 |
| Gatewayè·¯ç”±é…ç½®å†²çª | âœ… API path changed to `/api/v1/publish/tasks/{id}/assist` to match Â§4.1 gateway pattern |
| æ•°æ®æ¨¡å‹ä¸æ¶æ„ä¸ä¸€è‡´ | âœ… Using `publish_assists` table per Â§5-data-architecture.md:132-145 |
| DoubaoClientå¤ç”¨é—®é¢˜ | âœ… Extracted DoubaoClient to `common/doubao-client` module for ai-service and publish-service sharing |
| Redisç¼“å­˜Keyæœªå®šä¹‰ | âœ… Added `publish:assist:{taskId}` key pattern definition |
| å†…éƒ¨APIè·¯å¾„ä¸æ˜ç¡® | âœ… Documented internal APIs with task-service |

## Acceptance Criteria

### AC1: çƒ­é—¨è¯é¢˜æ¨è

**Scenario**
```gherkin
GIVEN è§†é¢‘åˆæˆå®Œæˆ (task.status = 'done')
WHEN ç³»ç»Ÿç”Ÿæˆè¯é¢˜æ¨è
THEN
  - åŸºäºåº—é“ºä¿¡æ¯å’Œè„šæœ¬å†…å®¹æ„å»ºPrompt
  - è°ƒç”¨è±†åŒ…APIç”Ÿæˆè¯é¢˜
  - è¿”å›5-10ä¸ªçƒ­é—¨è¯é¢˜æ ‡ç­¾
  - æ ¼å¼ç¬¦åˆæŠ–éŸ³/å°çº¢ä¹¦è§„èŒƒï¼ˆ#å¼€å¤´ï¼‰
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | è¯é¢˜ä»¥#å¼€å¤´ï¼Œä¸å«ç©ºæ ¼ |
| BR-1.2 | åŒ…å«åº—é“ºåç›¸å…³è¯é¢˜ï¼ˆå¦‚ #æµ·åº•æï¼‰ |
| BR-1.3 | åŒ…å«å“ç±»ç›¸å…³è¯é¢˜ï¼ˆå¦‚ #ç«é”…æ¢åº—ã€#ç¾é£Ÿæ¨èï¼‰ |
| BR-1.4 | åŒ…å«åœ°åŒºç›¸å…³è¯é¢˜ï¼ˆä»åº—é“ºåæå–ï¼Œå¦‚ #æœ›äº¬ç¾é£Ÿï¼‰ |
| BR-1.5 | è¿”å›5-10ä¸ªè¯é¢˜ï¼ŒæŒ‰æ¨èä¼˜å…ˆçº§æ’åº |
| BR-1.6 | å•ä¸ªè¯é¢˜æœ€é•¿20ä¸ªå­—ç¬¦ï¼ˆå«#ï¼‰ |
| BR-1.7 | ç”Ÿæˆç»“æœç¼“å­˜24å°æ—¶ï¼Œé¿å…é‡å¤è°ƒç”¨API |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| task_id | Long | Y | must exist | ä»»åŠ¡ä¸å­˜åœ¨ |
| task.status | string | Y | must be 'done' | è§†é¢‘å°šæœªå®Œæˆåˆæˆ |
| task.shop_name | string | Y | not empty | åº—é“ºä¿¡æ¯ç¼ºå¤± |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| ä»»åŠ¡ä¸å­˜åœ¨ | 40303 | ä»»åŠ¡ä¸å­˜åœ¨ | è¿”å›é”™è¯¯ |
| ä»»åŠ¡æœªå®Œæˆ | 1025 | è§†é¢‘å°šæœªå®Œæˆåˆæˆ | è¿”å›é”™è¯¯ |
| Doubao APIå¤±è´¥ | 50301 | AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ | è¿”å›é»˜è®¤è¯é¢˜åˆ—è¡¨ |
| Doubao APIè¶…æ—¶ | 50302 | AIæœåŠ¡å“åº”è¶…æ—¶ | è¿”å›é»˜è®¤è¯é¢˜åˆ—è¡¨ |
| è§£æå¤±è´¥ | 50303 | è¯é¢˜ç”Ÿæˆå¤±è´¥ | è¿”å›é»˜è®¤è¯é¢˜åˆ—è¡¨ |

**Default Fallback Topics** (å½“AIç”Ÿæˆå¤±è´¥æ—¶):
```json
["#æ¢åº—", "#ç¾é£Ÿæ¢åº—", "#å¿…åƒæ¦œ", "#æ¢åº—vlog", "#ç¾é£Ÿæ¨è", "#å‘¨æœ«å»å“ªåƒ", "#åƒè´§æ—¥å¸¸", "#æœ¬åœ°ç¾é£Ÿ"]
```

**Examples**
| Input | Expected Output |
|-------|-----------------|
| shop_name: "æµ·åº•æç«é”…(æœ›äº¬åº—)", shop_type: "food" | ["#æµ·åº•æ", "#ç«é”…æ¢åº—", "#æœ›äº¬ç¾é£Ÿ", "#å¿…åƒæ¦œ", "#ç¾é£Ÿæ¨è", "#åƒè´§æ—¥å¸¸", "#æ¢åº—è¾¾äºº", "#åŒ—äº¬ç¾é£Ÿ", "#å›¢è´­ä¼˜æƒ ", "#å‘¨æœ«å»å“ªåƒ"] |
| shop_name: "æ˜Ÿå·´å…‹è‡»é€‰(ä¸‰é‡Œå±¯åº—)", shop_type: "food" | ["#æ˜Ÿå·´å…‹", "#å’–å•¡æ¢åº—", "#ä¸‰é‡Œå±¯", "#ä¸‹åˆèŒ¶", "#å’–å•¡æ§", "#æ‰“å¡åœ£åœ°", "#çº¦ä¼šå¥½å»å¤„", "#åŒ—äº¬å’–å•¡"] |

---

### AC2: æ ‡é¢˜æ¨è

**Scenario**
```gherkin
GIVEN è§†é¢‘åˆæˆå®Œæˆ (task.status = 'done')
WHEN ç³»ç»Ÿç”Ÿæˆæ ‡é¢˜æ¨è
THEN
  - åŸºäºè„šæœ¬å†…å®¹ç”Ÿæˆå¸å¼•çœ¼çƒçš„æ ‡é¢˜
  - è¿”å›3-5ä¸ªæ ‡é¢˜é€‰é¡¹
  - æ ‡é¢˜ç¬¦åˆçŸ­è§†é¢‘å¹³å°è°ƒæ€§
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | æ ‡é¢˜é•¿åº¦20-50ä¸ªå­—ç¬¦ |
| BR-2.2 | åŒ…å«å¸å¼•ç‚¹å‡»çš„å…ƒç´ ï¼ˆæ•°å­—ã€ç–‘é—®ã€æƒŠå¹ã€emojiå¯é€‰ï¼‰ |
| BR-2.3 | ç¬¦åˆæŠ–éŸ³/å°çº¢ä¹¦å¹³å°è°ƒæ€§ |
| BR-2.4 | ä¸å«æ•æ„Ÿè¯æˆ–è¿è§„å†…å®¹ |
| BR-2.5 | è¿”å›3-5ä¸ªæ ‡é¢˜é€‰é¡¹ |
| BR-2.6 | ç¬¬ä¸€ä¸ªæ ‡é¢˜ä¸ºæœ€æ¨èé€‰é¡¹ |
| BR-2.7 | ç”Ÿæˆç»“æœä¸è¯é¢˜ä¸€èµ·å­˜å‚¨åˆ°publish_assistsè¡¨ |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| task_id | Long | Y | must exist | ä»»åŠ¡ä¸å­˜åœ¨ |
| task.status | string | Y | must be 'done' | è§†é¢‘å°šæœªå®Œæˆåˆæˆ |
| script.content | string | Y | not empty | è„šæœ¬å†…å®¹ç¼ºå¤± |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| è„šæœ¬å†…å®¹ä¸ºç©º | 1030 | è„šæœ¬å†…å®¹ç¼ºå¤± | è¿”å›é»˜è®¤æ ‡é¢˜æ¨¡æ¿ |
| Doubao APIå¤±è´¥ | 50301 | AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ | è¿”å›é»˜è®¤æ ‡é¢˜æ¨¡æ¿ |
| æ ‡é¢˜é•¿åº¦ä¸åˆè§„ | - | - | è‡ªåŠ¨æˆªæ–­æˆ–é‡æ–°ç”Ÿæˆ |

**Default Fallback Titles** (å½“AIç”Ÿæˆå¤±è´¥æ—¶):
```json
[
  "{shop_name}æ¢åº—ï½œå¿…åƒæ¨è",
  "å‘ç°{shop_name}çš„å®è—åƒæ³•",
  "{shop_name}çœŸå®æµ‹è¯„ï¼Œå€¼ä¸å€¼å¾—å»ï¼Ÿ"
]
```

**Examples**
| Input (Script Summary) | Expected Output |
|------------------------|-----------------|
| æµ·åº•æç«é”…ï¼Œæ‹›ç‰Œæ¯›è‚šï¼Œäººå‡89 | ["æœ›äº¬è¿™å®¶æµ·åº•æå¤ªç»äº†ï¼æœåŠ¡å¥½åˆ°è®©ä½ æ„ŸåŠ¨æµæ³ª", "äººå‡89åƒæµ·åº•æï¼Ÿè¿™ä¸ªå›¢è´­ä¹Ÿå¤ªé¦™äº†å§ï¼", "æµ·åº•ææ¢åº—ï½œå¿…ç‚¹æ‹›ç‰Œæ¯›è‚šï¼Œä¸ƒä¸Šå…«ä¸‹å¤ªå«©äº†", "æœ‹å‹èšé¤é¦–é€‰ï¼æœ›äº¬æµ·åº•ææ°›å›´æ„Ÿæ‹‰æ»¡"] |

---

### AC3: é‡æ–°ç”ŸæˆåŠŸèƒ½

**Scenario**
```gherkin
GIVEN ç”¨æˆ·å¯¹å½“å‰æ¨èä¸æ»¡æ„
WHEN ç”¨æˆ·è¯·æ±‚é‡æ–°ç”Ÿæˆ
THEN
  - æ¸…é™¤Redisç¼“å­˜
  - é‡æ–°è°ƒç”¨AIç”Ÿæˆ
  - è¿”å›æ–°çš„è¯é¢˜å’Œæ ‡é¢˜
  - æ›´æ–°publish_assistsè¡¨ä¸­çš„regenerate_count
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | æ¯ä¸ªä»»åŠ¡æœ€å¤šé‡æ–°ç”Ÿæˆ3æ¬¡ |
| BR-3.2 | é‡æ–°ç”Ÿæˆä½¿ç”¨ä¸åŒçš„temperatureå‚æ•°æé«˜å¤šæ ·æ€§ |
| BR-3.3 | é‡æ–°ç”Ÿæˆåæ›´æ–°publish_assistsè¡¨å’ŒRedisç¼“å­˜ |
| BR-3.4 | è¶…è¿‡æ¬¡æ•°é™åˆ¶è¿”å›é”™è¯¯æç¤º |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| publish_assists.regenerate_count | int | N | < 3 | å·²è¾¾åˆ°é‡æ–°ç”Ÿæˆæ¬¡æ•°ä¸Šé™ |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| è¶…è¿‡é‡ç”Ÿæˆæ¬¡æ•° | 1031 | å·²è¾¾åˆ°é‡æ–°ç”Ÿæˆæ¬¡æ•°ä¸Šé™ï¼ˆ3æ¬¡ï¼‰ | è¿”å›é”™è¯¯ï¼Œæ˜¾ç¤ºå½“å‰ç»“æœ |

---

## Tasks / Subtasks

### Infrastructure Tasks (T0)

- [x] **T0: publish-serviceæ¨¡å—ä¸åŸºç¡€æ¶æ„** `[ALL ACs]`
  - **File Locations**:
    - `backend/publish-service/pom.xml` (create - if not exists)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/PublishServiceApplication.java` (create)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/controller/PublishAssistController.java` (create)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/service/PublishAssistService.java` (create)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/dto/PublishAssistResponse.java` (create)
    - `backend/publish-service/src/main/resources/db/migration/V5_3__create_publish_assists_table.sql` (create)
    - `backend/gateway/src/main/resources/application.yml` (modify - add publish-assist route)
  - **Subtasks**:
    - [x] T0.1: Create publish-service module structure (if not exists):
      ```
      backend/publish-service/
      â”œâ”€â”€ pom.xml
      â””â”€â”€ src/main/java/com/shopvideoscout/publish/
          â”œâ”€â”€ PublishServiceApplication.java
          â”œâ”€â”€ controller/
          â”œâ”€â”€ service/
          â”œâ”€â”€ dto/
          â”œâ”€â”€ mapper/
          â””â”€â”€ client/
      ```
    - [x] T0.2: Create database migration for publish_assists table (per Â§5-data-architecture.md):
      ```sql
      CREATE TABLE publish_assists (
          id BIGINT PRIMARY KEY AUTO_INCREMENT,
          task_id BIGINT NOT NULL UNIQUE,
          topics JSON,
          titles JSON,
          regenerate_count INT DEFAULT 0,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
          FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
      ```
    - [x] T0.3: Update gateway routes to include publish-assist path:
      ```yaml
      - id: publish-service
        uri: lb://publish-service
        predicates:
          - Path=/api/v1/publish/**
      ```
      Note: API uses `/api/v1/publish/tasks/{id}/assist` to match gateway pattern
    - [x] T0.4: Create PublishAssistController with endpoint skeletons:
      - GET /api/v1/publish/tasks/{id}/assist
      - POST /api/v1/publish/tasks/{id}/assist/regenerate
    - [x] T0.5: Create PublishAssistService interface
    - [x] T0.6: Create PublishAssistResponse DTO (topics, titles, regenerate_remaining)
    - [x] T0.7: Create PublishAssistMapper for publish_assists table CRUD
  - **Complexity**: Medium (new service setup)
  - **AC Traceability**: Foundation for AC1, AC2, AC3

---

### Shared Module Tasks (T1)

- [x] **T1: DoubaoClientæå–åˆ°commonæ¨¡å—** `[AC1, AC2]`
  - **File Locations**:
    - `backend/common/doubao-client/pom.xml` (create)
    - `backend/common/doubao-client/src/main/java/com/shopvideoscout/common/doubao/DoubaoClient.java` (create)
    - `backend/common/doubao-client/src/main/java/com/shopvideoscout/common/doubao/DoubaoProperties.java` (create)
    - `backend/common/doubao-client/src/main/java/com/shopvideoscout/common/doubao/DoubaoRequest.java` (create)
    - `backend/common/doubao-client/src/main/java/com/shopvideoscout/common/doubao/DoubaoResponse.java` (create)
    - `backend/common/doubao-client/src/main/java/com/shopvideoscout/common/doubao/DoubaoAutoConfiguration.java` (create)
  - **Subtasks**:
    - [x] T1.1: Create common/doubao-client module:
      ```xml
      <artifactId>doubao-client</artifactId>
      <dependencies>
        <dependency>spring-boot-starter-web</dependency>
        <dependency>spring-retry</dependency>
      </dependencies>
      ```
    - [x] T1.2: Implement DoubaoClient:
      - HTTP client with RestTemplate/WebClient
      - Retry: 3 attempts, exponential backoff (1s, 2s, 4s)
      - Timeout: 30 seconds
      - Temperature parameter support
      - JSON response parsing
    - [x] T1.3: Create DoubaoProperties configuration:
      ```java
      @ConfigurationProperties(prefix = "doubao")
      public class DoubaoProperties {
          private String apiKey;
          private String endpoint = "https://api.volcengine.com/doubao/v1/chat/completions";
          private String model = "doubao-pro-32k";
          private int timeoutSeconds = 30;
          private double defaultTemperature = 0.7;
      }
      ```
    - [x] T1.4: Create DoubaoAutoConfiguration for Spring Boot auto-config
    - [x] T1.5: Add doubao-client dependency to publish-service and ai-service
    - [x] T1.6: Write unit tests for DoubaoClient
  - **Complexity**: Medium
  - **AC Traceability**: Shared infrastructure for AC1, AC2

---

### Feature Implementation Tasks

### AC1: çƒ­é—¨è¯é¢˜æ¨è

- [x] **T2: è¯é¢˜ç”ŸæˆæœåŠ¡å®ç°** `[AC1]`
  - **File Locations**:
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/service/TopicGenerationService.java` (create)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/service/impl/TopicGenerationServiceImpl.java` (create)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/prompt/PublishAssistPromptBuilder.java` (create)
    - `backend/publish-service/src/test/java/com/shopvideoscout/publish/service/TopicGenerationServiceTest.java` (create)
  - **Subtasks**:
    - [x] T2.1: Implement PublishAssistPromptBuilder (combined prompt for topics + titles):
      ```java
      public String buildPrompt(String shopName, String shopType, String scriptSummary) {
        // See Prompt Template in Dev Notes
      }
      ```
    - [x] T2.2: Implement TopicGenerationServiceImpl.generateTopics():
      - Build prompt from task data
      - Call DoubaoClient (from common module)
      - Parse response to extract topics array
      - Validate each topic (starts with #, max 20 chars)
      - Return List<String> topics
    - [x] T2.3: Implement topic validation:
      - Auto-prepend # if missing
      - Truncate to 20 chars if too long
      - Remove spaces
    - [x] T2.4: Implement fallback to default topics on any failure
  - **Complexity**: Medium
  - **Error Handling**:
    | Scenario | Handler |
    |----------|---------|
    | Doubao API 4xx | Log error, return default topics |
    | Doubao API 5xx | Retry 3x, then return default topics |
    | Timeout | Return default topics |
    | Invalid JSON response | Log warning, return default topics |

  **Test Specs** (unit):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Generate topics success | valid task | 5-10 topics starting with # | unit |
  | Topics have # prefix | AI returns without # | auto-prepend # | unit |
  | Topic max length | 25-char topic | truncated to 20 chars | unit |
  | Doubao API failure | API throws exception | default topics returned | unit |
  | Shop name extraction | "æµ·åº•æ(æœ›äº¬åº—)" | includes #æµ·åº•æ and #æœ›äº¬ | unit |

---

### AC2: æ ‡é¢˜æ¨è

- [x] **T3: æ ‡é¢˜ç”ŸæˆæœåŠ¡å®ç°** `[AC2]`
  - **File Locations**:
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/service/TitleGenerationService.java` (create)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/service/impl/TitleGenerationServiceImpl.java` (create)
    - `backend/publish-service/src/test/java/com/shopvideoscout/publish/service/TitleGenerationServiceTest.java` (create)
  - **Subtasks**:
    - [x] T3.1: Implement TitleGenerationServiceImpl.generateTitles():
      - Use combined prompt (same API call as topics)
      - Parse response to extract titles array
      - Validate each title (20-50 chars)
      - Filter sensitive words
      - Return List<String> titles (3-5 items)
    - [x] T3.2: Implement title length validation:
      - Too short (< 20): discard or pad
      - Too long (> 50): truncate at word boundary + "..."
    - [x] T3.3: Implement fallback to template-based titles
  - **Complexity**: Medium
  - **Error Handling**:
    | Scenario | Handler |
    |----------|---------|
    | Script content empty | Return template titles with shop_name |
    | All titles too short | Regenerate with different prompt |
    | Sensitive word detected | Filter out that title |

  **Test Specs** (unit):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Generate titles success | valid task + script | 3-5 titles, 20-50 chars | unit |
  | Title too short | 15-char title | filtered out | unit |
  | Title too long | 60-char title | truncated to ~50 + "..." | unit |
  | No script content | empty script | template titles returned | unit |
  | First title is recommended | any | titles[0] is best option | unit |

---

### AC3: é‡æ–°ç”Ÿæˆä¸æ•°æ®æŒä¹…åŒ–

- [x] **T4: å‘å¸ƒè¾…åŠ©ç¼–æ’ä¸æŒä¹…åŒ–æœåŠ¡** `[AC1, AC2, AC3]`
  - **File Locations**:
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/service/impl/PublishAssistServiceImpl.java` (create)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/client/TaskServiceClient.java` (create)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/entity/PublishAssist.java` (create)
    - `backend/publish-service/src/main/java/com/shopvideoscout/publish/mapper/PublishAssistMapper.java` (create)
    - `backend/publish-service/src/test/java/com/shopvideoscout/publish/service/PublishAssistServiceTest.java` (create)
  - **Subtasks**:
    - [x] T4.1: Create PublishAssist entity:
      ```java
      @Table("publish_assists")
      public class PublishAssist {
          private Long id;
          private Long taskId;
          private String topics;     // JSON array string
          private String titles;     // JSON array string
          private Integer regenerateCount;
          private LocalDateTime createdAt;
          private LocalDateTime updatedAt;
      }
      ```
    - [x] T4.2: Create PublishAssistMapper (MyBatis):
      - `selectByTaskId(Long taskId)`
      - `insert(PublishAssist entity)`
      - `updateTopicsAndTitles(Long taskId, String topics, String titles)`
      - `incrementRegenerateCount(Long taskId)`
    - [x] T4.3: Implement TaskServiceClient (Feign) for cross-service:
      ```java
      @FeignClient(name = "task-service")
      public interface TaskServiceClient {
          @GetMapping("/internal/tasks/{id}")
          TaskDetailDto getTask(@PathVariable Long id);

          @GetMapping("/internal/tasks/{id}/script")
          ScriptDto getScript(@PathVariable Long id);
      }
      ```
    - [x] T4.4: Add internal endpoints to task-service:
      - `GET /internal/tasks/{id}` â†’ returns TaskDetailDto (id, shop_name, shop_type, status)
      - `GET /internal/tasks/{id}/script` â†’ returns ScriptDto (paragraphs[].text)
    - [x] T4.5: Implement PublishAssistServiceImpl:
      - `getPublishAssist(taskId)`:
        1. Check Redis cache `publish:assist:{taskId}`
        2. If miss, check DB (publish_assists table)
        3. If not in DB, call AI generation
        4. Store to DB and cache
        5. Return response
      - `regenerate(taskId)`:
        1. Validate regenerate_count < 3
        2. Delete Redis cache
        3. Call AI with higher temperature (0.7 + count * 0.1)
        4. Update DB (topics, titles, regenerate_count++)
        5. Update Redis cache
        6. Return response
    - [x] T4.6: Implement Redis caching:
      - Key: `publish:assist:{taskId}`
      - TTL: 24 hours (86400 seconds)
      - Value: JSON {topics, titles, regenerate_count}
  - **Complexity**: Medium
  - **Error Handling**:
    | Scenario | Handler |
    |----------|---------|
    | Regenerate count exceeded | Return error 1031 with remaining = 0 |
    | Task service unavailable | Return cached data if available, else error |
    | DB insert failure | Log error, return generated data (cache only) |

  **Test Specs** (unit):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | First regenerate | count=0 | success, countâ†’1 | unit |
  | Max regenerates | count=3 | error 1031 | unit |
  | Regenerate clears cache | regenerate call | Redis key deleted before new call | unit |
  | Temperature increases | each regenerate | 0.7 â†’ 0.8 â†’ 0.9 â†’ 1.0 | unit |
  | Response includes remaining | any | regenerate_remaining field present | unit |
  | Cache hit | cached data exists | return cached, no DB/API call | unit |
  | Cache miss, DB hit | no cache, DB has data | return DB data, update cache | unit |
  | Cache miss, DB miss | no cache, no DB | call AI, store to DB and cache | unit |

---

### Integration & API Tasks

- [x] **T5: APIé›†æˆä¸ç«¯åˆ°ç«¯æµ‹è¯•** `[ALL ACs]`
  - **File Locations**:
    - `backend/publish-service/src/test/java/com/shopvideoscout/publish/controller/PublishAssistControllerTest.java` (create)
    - `backend/publish-service/src/test/java/com/shopvideoscout/publish/integration/PublishAssistIntegrationTest.java` (create)
    - `backend/task-service/src/main/java/com/shopvideoscout/task/controller/InternalTaskController.java` (create)
    - `backend/common/common-core/src/main/java/com/shopvideoscout/common/result/ResultCode.java` (modify)
  - **Subtasks**:
    - [x] T5.1: Implement PublishAssistController endpoints:
      ```java
      @RestController
      @RequestMapping("/api/v1/publish/tasks")
      public class PublishAssistController {

          @GetMapping("/{id}/assist")
          public R<PublishAssistResponse> getPublishAssist(@PathVariable Long id)

          @PostMapping("/{id}/assist/regenerate")
          public R<PublishAssistResponse> regenerate(@PathVariable Long id)
      }
      ```
    - [x] T5.2: Implement InternalTaskController in task-service:
      ```java
      @RestController
      @RequestMapping("/internal/tasks")
      public class InternalTaskController {

          @GetMapping("/{id}")
          public TaskDetailDto getTaskDetail(@PathVariable Long id)

          @GetMapping("/{id}/script")
          public ScriptDto getScript(@PathVariable Long id)
      }
      ```
    - [x] T5.3: Write controller unit tests:
      - Auth required
      - Task ownership validation (via task-service)
      - Response format validation
    - [x] T5.4: Write integration tests:
      - Full flow: task done â†’ get publish assist
      - Regenerate flow with count tracking
      - Cache and DB behavior verification
    - [x] T5.5: Add ResultCode extensions:
      - PUBLISH_ASSIST_LIMIT_EXCEEDED(1031)
      - SCRIPT_CONTENT_MISSING(1030)
  - **Complexity**: Low

- [x] **T6: Final Verification** `[ALL ACs]`
  - [x] T6.1: All tests passing (unit + integration)
  - [x] T6.2: No lint errors
  - [x] T6.3: Dev Log complete with implementation summary
  - [x] T6.4: Status â†’ Review

### AC Coverage Matrix

| Task | AC1 | AC2 | AC3 |
|------|:---:|:---:|:---:|
| T0: publish-serviceæ¨¡å— | âœ“ | âœ“ | âœ“ |
| T1: DoubaoClient commonæ¨¡å— | âœ“ | âœ“ |   |
| T2: Topic Generation | âœ“ |   |   |
| T3: Title Generation |   | âœ“ |   |
| T4: ç¼–æ’ä¸æŒä¹…åŒ– | âœ“ | âœ“ | âœ“ |
| T5: API Integration | âœ“ | âœ“ | âœ“ |
| T6: Final | âœ“ | âœ“ | âœ“ |

## Dev Notes

### Technical Constraints

- **publish-service**: ç‹¬ç«‹å¾®æœåŠ¡ï¼Œè´Ÿè´£å‘å¸ƒè¾…åŠ©åŠŸèƒ½ [â†’ 4-service-architecture-details.md#46-publish-service]
- **Doubao API**: ä½¿ç”¨ç«å±±å¼•æ“è±†åŒ…å¤§æ¨¡å‹APIï¼ŒDoubaoClientæå–åˆ°commonæ¨¡å—ä¾›ai-serviceå’Œpublish-serviceå…±äº«
- **APIé™æµ**: Doubao APIæœ‰å¹¶å‘é™åˆ¶ï¼Œä½¿ç”¨ä»¤ç‰Œæ¡¶é™æµï¼ˆ10 req/sï¼‰[â†’ ç«å±±å¼•æ“é…é¢]
- **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨publish_assistsè¡¨å­˜å‚¨ç”Ÿæˆç»“æœ [â†’ 5-data-architecture.md#publish-assist-table]
- **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜24å°æ—¶ï¼Œkeyæ ¼å¼`publish:assist:{taskId}` [â†’ 5-data-architecture.md#52-redis]
- **è·¨æœåŠ¡è°ƒç”¨**: publish-serviceé€šè¿‡Feignè°ƒç”¨task-serviceå†…éƒ¨APIè·å–ä»»åŠ¡å’Œè„šæœ¬æ•°æ®
- **æ•æ„Ÿè¯è¿‡æ»¤**: æ ‡é¢˜ç”Ÿæˆåéœ€è¿‡æ»¤æ•æ„Ÿè¯ [â†’ å¹³å°åˆè§„è¦æ±‚]
- **Temperatureå‚æ•°**: æ§åˆ¶AIç”Ÿæˆçš„å¤šæ ·æ€§ï¼Œé‡æ–°ç”Ÿæˆæ—¶é€æ­¥æé«˜ (0.7 â†’ 0.8 â†’ 0.9 â†’ 1.0)

### Prompt Engineering (CRITICAL)

**ç»„åˆè¯·æ±‚Promptï¼ˆå•æ¬¡APIè°ƒç”¨ç”Ÿæˆè¯é¢˜+æ ‡é¢˜ï¼Œper Â§4.6ï¼‰**:
```
åŸºäºä»¥ä¸‹æ¢åº—è§†é¢‘ä¿¡æ¯ï¼Œç”Ÿæˆå‘å¸ƒè¾…åŠ©å†…å®¹ï¼š

åº—é“ºï¼š{{shop_name}}
ç±»å‹ï¼š{{shop_type}}
è„šæœ¬æ‘˜è¦ï¼š{{script_summary}}

è¯·ç”Ÿæˆï¼š
1. 8-10ä¸ªç›¸å…³è¯é¢˜æ ‡ç­¾ï¼ˆä»¥#å¼€å¤´ï¼Œç¬¦åˆæŠ–éŸ³/å°çº¢ä¹¦è§„èŒƒï¼Œæ¯ä¸ªä¸è¶…è¿‡20å­—ç¬¦ï¼‰
2. 4ä¸ªå¸å¼•çœ¼çƒçš„è§†é¢‘æ ‡é¢˜ï¼ˆ20-50å­—ï¼ŒåŒ…å«æ•°å­—/ç–‘é—®/æƒŠå¹ç­‰å¸å¼•å…ƒç´ ï¼‰

è¾“å‡ºJSONï¼š
{
  "topics": ["#è¯é¢˜1", "#è¯é¢˜2", ...],
  "titles": ["æ ‡é¢˜1", "æ ‡é¢˜2", "æ ‡é¢˜3", "æ ‡é¢˜4"]
}
```

### Accumulated Context (From Previous Stories)

| Resource Type | Name | Source Story | Action | Key Info |
|--------------|------|--------------|--------|----------|
| Table | publish_assists | Architecture | CREATE | ç‹¬ç«‹è¡¨å­˜å‚¨è¯é¢˜ã€æ ‡é¢˜ã€é‡ç”Ÿæˆæ¬¡æ•° (per Â§5-data-architecture.md) |
| Table | tasks | 1.1 | READ | shop_name, shop_type, status (via internal API) |
| Table | scripts | 1.1 | READ | content JSONå«paragraphsæ•°ç»„ (via internal API) |
| Endpoint | GET /internal/tasks/{id} | 5.3 | CREATE | æ–°å¢å†…éƒ¨API for cross-service |
| Endpoint | GET /internal/tasks/{id}/script | 5.3 | CREATE | æ–°å¢å†…éƒ¨API for cross-service |
| Model | R\<T\> | 1.1 | REUSE | ç»Ÿä¸€å“åº”åŒ…è£…å™¨ |
| Model | ResultCode | 1.1 (ext 5.2) | EXTEND | æ–°å¢ PUBLISH_ASSIST_LIMIT_EXCEEDED(1031), SCRIPT_CONTENT_MISSING(1030) |
| Module | doubao-client | 5.3 | CREATE | æ–°å»ºcommonæ¨¡å—ï¼Œä¾›ai-serviceå’Œpublish-serviceå…±äº« |
| Redis Key | publish:assist:{taskId} | 5.3 | CREATE | ç¼“å­˜å‘å¸ƒè¾…åŠ©æ•°æ®ï¼ŒTTL 24h |

### Architecture Flow (CRITICAL)

**è·å–å‘å¸ƒè¾…åŠ©æµç¨‹ï¼š**

```
Client (Frontend)
    â”‚
    â”œâ”€â”€ GET /api/v1/publish/tasks/{id}/assist
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Gateway routes to publish-service (per Â§4.1 /api/v1/publish/**)
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Auth: JWTéªŒè¯
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Check Redis cache: publish:assist:{taskId}
    â”‚     â”‚     â”œâ”€â”€ HIT â†’ Return cached data
    â”‚     â”‚     â””â”€â”€ MISS â†“
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Check DB: publish_assists table
    â”‚     â”‚     â”œâ”€â”€ FOUND â†’ Return DB data, update cache
    â”‚     â”‚     â””â”€â”€ NOT FOUND â†“
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Fetch task details via Feign
    â”‚     â”‚     â””â”€â”€ GET task-service:/internal/tasks/{id}
    â”‚     â”‚         â†’ shop_name, shop_type, status
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Validate task.status == 'done'
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Fetch script via Feign
    â”‚     â”‚     â””â”€â”€ GET task-service:/internal/tasks/{id}/script
    â”‚     â”‚         â†’ paragraphs[].text â†’ script_summary
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Build prompt & Call Doubao API (via common/doubao-client)
    â”‚     â”‚     â”œâ”€â”€ POST https://api.volcengine.com/doubao/v1/chat/completions
    â”‚     â”‚     â””â”€â”€ Parse JSON response â†’ topics[], titles[]
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Validate & sanitize results
    â”‚     â”‚     â”œâ”€â”€ Topics: ensure # prefix, max 20 chars
    â”‚     â”‚     â””â”€â”€ Titles: 20-50 chars
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Store to DB: INSERT publish_assists
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Cache to Redis (TTL 24h)
    â”‚     â”‚
    â”‚     â””â”€â”€ Return PublishAssistResponse
    â”‚           {
    â”‚             topics: [...],
    â”‚             titles: [...],
    â”‚             regenerate_remaining: 3
    â”‚           }
```

**é‡æ–°ç”Ÿæˆæµç¨‹ï¼š**

```
Client (Frontend)
    â”‚
    â”œâ”€â”€ POST /api/v1/publish/tasks/{id}/assist/regenerate
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Auth: JWTéªŒè¯
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Query DB: publish_assists.regenerate_count
    â”‚     â”‚     â””â”€â”€ If count >= 3 â†’ Return error 1031
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Delete Redis cache: publish:assist:{taskId}
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Calculate temperature: 0.7 + (count * 0.1)
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Call Doubao API with higher temperature
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Update DB: topics, titles, regenerate_count++
    â”‚     â”‚
    â”‚     â”œâ”€â”€ Update Redis cache (TTL 24h)
    â”‚     â”‚
    â”‚     â””â”€â”€ Return PublishAssistResponse
    â”‚           {
    â”‚             topics: [...],
    â”‚             titles: [...],
    â”‚             regenerate_remaining: 3 - new_count
    â”‚           }
```

### Data Models

**PublishAssistResponse** (å‘å¸ƒè¾…åŠ©å“åº”):
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "topics": [
      "#æµ·åº•æ",
      "#ç«é”…æ¢åº—",
      "#æœ›äº¬ç¾é£Ÿ",
      "#å¿…åƒæ¦œ",
      "#ç¾é£Ÿæ¨è",
      "#åƒè´§æ—¥å¸¸",
      "#æ¢åº—è¾¾äºº",
      "#åŒ—äº¬ç¾é£Ÿ"
    ],
    "titles": [
      "æœ›äº¬è¿™å®¶æµ·åº•æå¤ªç»äº†ï¼æœåŠ¡å¥½åˆ°è®©ä½ æ„ŸåŠ¨æµæ³ª",
      "äººå‡89åƒæµ·åº•æï¼Ÿè¿™ä¸ªå›¢è´­ä¹Ÿå¤ªé¦™äº†å§ï¼",
      "æµ·åº•ææ¢åº—ï½œå¿…ç‚¹æ‹›ç‰Œæ¯›è‚šï¼Œä¸ƒä¸Šå…«ä¸‹å¤ªå«©äº†",
      "æœ‹å‹èšé¤é¦–é€‰ï¼æœ›äº¬æµ·åº•ææ°›å›´æ„Ÿæ‹‰æ»¡"
    ],
    "regenerate_remaining": 3
  }
}
```

**Error Response** (è¶…è¿‡é‡ç”Ÿæˆæ¬¡æ•°):
```json
{
  "code": 1031,
  "message": "å·²è¾¾åˆ°é‡æ–°ç”Ÿæˆæ¬¡æ•°ä¸Šé™ï¼ˆ3æ¬¡ï¼‰",
  "details": {
    "task_id": 12345,
    "regenerate_remaining": 0
  }
}
```

**TaskDetailDto** (å†…éƒ¨APIå“åº”):
```json
{
  "id": 12345,
  "shop_name": "æµ·åº•æç«é”…(æœ›äº¬åº—)",
  "shop_type": "food",
  "status": "done"
}
```

**ScriptDto** (å†…éƒ¨APIå“åº”):
```json
{
  "task_id": 12345,
  "paragraphs": [
    { "id": "para_1", "text": "å®¶äººä»¬ï¼ä»Šå¤©ç»™ä½ ä»¬æ¢ä¸€å®¶æœ›äº¬è¶…ç«çš„æµ·åº•æ..." },
    { "id": "para_2", "text": "ä¸€è¿›é—¨å°±è¢«è¿™ä¸ªè£…ä¿®æƒŠè‰³åˆ°äº†..." }
  ]
}
```

**Redis Cache Structure**:
```json
// Key: publish:assist:{taskId}
// TTL: 86400 (24 hours)
{
  "topics": ["#è¯é¢˜1", ...],
  "titles": ["æ ‡é¢˜1", ...],
  "regenerate_count": 0
}
```

### Database Changes

**Migration V5_3 (publish_assists table per Â§5-data-architecture.md:132-145)**:
```sql
-- V5_3__create_publish_assists_table.sql
CREATE TABLE IF NOT EXISTS publish_assists (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id BIGINT NOT NULL UNIQUE,
    topics JSON,
    titles JSON,
    regenerate_count INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE INDEX idx_publish_assists_task_id ON publish_assists(task_id);
```

### File Locations

```
backend/
  common/
    doubao-client/                         # æ–°å»ºæ¨¡å—
      pom.xml                              # æ–°å¢
      src/main/java/com/shopvideoscout/common/doubao/
        DoubaoClient.java                  # æ–°å¢: HTTPå®¢æˆ·ç«¯
        DoubaoProperties.java              # æ–°å¢: é…ç½®ç±»
        DoubaoRequest.java                 # æ–°å¢: è¯·æ±‚ä½“
        DoubaoResponse.java                # æ–°å¢: å“åº”ä½“
        DoubaoAutoConfiguration.java       # æ–°å¢: è‡ªåŠ¨é…ç½®
      src/main/resources/
        META-INF/spring.factories          # æ–°å¢: è‡ªåŠ¨é…ç½®æ³¨å†Œ
      src/test/java/com/shopvideoscout/common/doubao/
        DoubaoClientTest.java              # æ–°å¢

  publish-service/                         # æ–°å»º/æ‰©å±•æœåŠ¡
    pom.xml                                # æ–°å¢/ä¿®æ”¹
    src/main/java/com/shopvideoscout/publish/
      PublishServiceApplication.java       # æ–°å¢
      controller/
        PublishAssistController.java       # æ–°å¢: GET/POST /publish/tasks/{id}/assist
      service/
        PublishAssistService.java          # æ–°å¢: æ¥å£
        TopicGenerationService.java        # æ–°å¢: æ¥å£
        TitleGenerationService.java        # æ–°å¢: æ¥å£
        impl/
          PublishAssistServiceImpl.java    # æ–°å¢: ç¼–æ’æœåŠ¡
          TopicGenerationServiceImpl.java  # æ–°å¢: è¯é¢˜ç”Ÿæˆ
          TitleGenerationServiceImpl.java  # æ–°å¢: æ ‡é¢˜ç”Ÿæˆ
      client/
        TaskServiceClient.java             # æ–°å¢: Feignå®¢æˆ·ç«¯
      entity/
        PublishAssist.java                 # æ–°å¢: å®ä½“ç±»
      mapper/
        PublishAssistMapper.java           # æ–°å¢: MyBatis Mapper
      dto/
        PublishAssistResponse.java         # æ–°å¢
      prompt/
        PublishAssistPromptBuilder.java    # æ–°å¢: Promptæ„å»º
    src/main/resources/
      application.yml                      # æ–°å¢: æœåŠ¡é…ç½®
      db/migration/
        V5_3__create_publish_assists_table.sql  # æ–°å¢
    src/test/java/com/shopvideoscout/publish/
      controller/
        PublishAssistControllerTest.java   # æ–°å¢
      service/
        TopicGenerationServiceTest.java    # æ–°å¢
        TitleGenerationServiceTest.java    # æ–°å¢
        PublishAssistServiceTest.java      # æ–°å¢
      integration/
        PublishAssistIntegrationTest.java  # æ–°å¢

  task-service/
    src/main/java/com/shopvideoscout/task/
      controller/
        InternalTaskController.java        # æ–°å¢: å†…éƒ¨API
      dto/
        TaskDetailDto.java                 # æ–°å¢
        ScriptDto.java                     # æ–°å¢

  gateway/
    src/main/resources/
      application.yml                      # ä¿®æ”¹: ç¡®è®¤publish-serviceè·¯ç”±

  common/common-core/
    src/main/java/com/shopvideoscout/common/
      result/
        ResultCode.java                    # æ‰©å±•: +PUBLISH_ASSIST_LIMIT_EXCEEDED, +SCRIPT_CONTENT_MISSING
```

### Deliverable Bindings

> **SM**: Binding for each new code unit. Dev Gate will verify these.
> **Dev**: Ensure all bindings are implemented before self-review.

```yaml
deliverable_bindings:
  # Common module
  - deliverable: "backend/common/doubao-client"
    consumer: "backend/publish-service/pom.xml"
    binding_type: maven_dependency
    verify: "doubao-client"

  - deliverable: "backend/common/doubao-client"
    consumer: "backend/ai-service/pom.xml"
    binding_type: maven_dependency
    verify: "doubao-client"

  # publish-service classes
  - deliverable: "backend/publish-service/.../controller/PublishAssistController.java"
    consumer: "backend/gateway/src/main/resources/application.yml"
    binding_type: route_mount
    verify: "Path=/api/v1/publish/**"

  - deliverable: "backend/publish-service/.../service/impl/PublishAssistServiceImpl.java"
    consumer: "backend/publish-service/.../controller/PublishAssistController.java"
    binding_type: di_inject
    verify: "PublishAssistService"

  - deliverable: "backend/publish-service/.../service/impl/TopicGenerationServiceImpl.java"
    consumer: "backend/publish-service/.../service/impl/PublishAssistServiceImpl.java"
    binding_type: di_inject
    verify: "TopicGenerationService"

  - deliverable: "backend/publish-service/.../service/impl/TitleGenerationServiceImpl.java"
    consumer: "backend/publish-service/.../service/impl/PublishAssistServiceImpl.java"
    binding_type: di_inject
    verify: "TitleGenerationService"

  - deliverable: "backend/publish-service/.../client/TaskServiceClient.java"
    consumer: "backend/publish-service/.../service/impl/PublishAssistServiceImpl.java"
    binding_type: di_inject
    verify: "TaskServiceClient"

  - deliverable: "backend/publish-service/.../mapper/PublishAssistMapper.java"
    consumer: "backend/publish-service/.../service/impl/PublishAssistServiceImpl.java"
    binding_type: di_inject
    verify: "PublishAssistMapper"

  # task-service internal API
  - deliverable: "backend/task-service/.../controller/InternalTaskController.java"
    consumer: "backend/publish-service/.../client/TaskServiceClient.java"
    binding_type: feign_client
    verify: "/internal/tasks"

  # Database migration
  - deliverable: "V5_3__create_publish_assists_table.sql"
    consumer: "backend/publish-service/src/main/resources/application.yml"
    binding_type: schema_applied
    verify: "flyway"
```

**Binding Status**: â³ Pending Dev verification

### Testing Requirements

- **å•å…ƒæµ‹è¯•é‡ç‚¹**:
  - Promptæ„å»ºé€»è¾‘ï¼ˆå˜é‡æ›¿æ¢ã€æ ¼å¼æ­£ç¡®ï¼‰
  - Doubaoå“åº”JSONè§£æ
  - è¯é¢˜æ ¼å¼éªŒè¯ï¼ˆ#å‰ç¼€ã€é•¿åº¦é™åˆ¶ï¼‰
  - æ ‡é¢˜é•¿åº¦éªŒè¯ï¼ˆ20-50å­—ç¬¦ï¼‰
  - ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­/DB fallbacké€»è¾‘
  - é‡ç”Ÿæˆæ¬¡æ•°é™åˆ¶
  - Temperatureé€’å¢é€»è¾‘
- **é›†æˆæµ‹è¯•é‡ç‚¹**:
  - å®Œæ•´æµç¨‹ï¼ˆä»»åŠ¡å®Œæˆ â†’ è·å–å‘å¸ƒè¾…åŠ©ï¼‰
  - è·¨æœåŠ¡è°ƒç”¨ï¼ˆpublish-service â†” task-service via Feignï¼‰
  - Redisç¼“å­˜ + DBæŒä¹…åŒ–
  - Doubao API Mockæµ‹è¯•
- **è¾¹ç•Œæµ‹è¯•**:
  - AIè¿”å›æ ¼å¼å¼‚å¸¸æ—¶çš„é™çº§å¤„ç†
  - è¶…é•¿å“åº”æˆªæ–­
  - task-serviceä¸å¯ç”¨æ—¶çš„é”™è¯¯å¤„ç†
  - ç½‘ç»œè¶…æ—¶é™çº§

---

## AC Traceability Matrix

> **Dev**: Fill this section BEFORE self-review. Every AC needs evidence.
> **QA**: Verify each entry during AC Coverage Verification.

### AC1: çƒ­é—¨è¯é¢˜æ¨è

```yaml
ac_id: AC1
code_locations:
  - "backend/publish-service/src/main/java/com/shopvideoscout/publish/service/impl/TopicGenerationServiceImpl.java"
  - "backend/publish-service/src/main/java/com/shopvideoscout/publish/prompt/PublishAssistPromptBuilder.java"
  - "backend/common/doubao-client/src/main/java/com/shopvideoscout/common/doubao/DoubaoClient.java"
test_locations:
  - "backend/publish-service/src/test/java/com/shopvideoscout/publish/service/TopicGenerationServiceTest.java"
verification_type: unit_test
aspects_covered:
  main_scenario: true
  business_rules: true
  data_validation: true
  error_handling: true
notes: "Doubao API integration via common module, # prefix validation, 20-char limit, fallback topics"
```

### AC2: æ ‡é¢˜æ¨è

```yaml
ac_id: AC2
code_locations:
  - "backend/publish-service/src/main/java/com/shopvideoscout/publish/service/impl/TitleGenerationServiceImpl.java"
  - "backend/publish-service/src/main/java/com/shopvideoscout/publish/prompt/PublishAssistPromptBuilder.java"
test_locations:
  - "backend/publish-service/src/test/java/com/shopvideoscout/publish/service/TitleGenerationServiceTest.java"
verification_type: unit_test
aspects_covered:
  main_scenario: true
  business_rules: true
  data_validation: true
  error_handling: true
notes: "20-50 char validation, fallback templates"
```

### AC3: é‡æ–°ç”ŸæˆåŠŸèƒ½

```yaml
ac_id: AC3
code_locations:
  - "backend/publish-service/src/main/java/com/shopvideoscout/publish/service/impl/PublishAssistServiceImpl.java"
  - "backend/publish-service/src/main/java/com/shopvideoscout/publish/controller/PublishAssistController.java"
  - "backend/publish-service/src/main/java/com/shopvideoscout/publish/mapper/PublishAssistMapper.java"
test_locations:
  - "backend/publish-service/src/test/java/com/shopvideoscout/publish/service/PublishAssistServiceTest.java"
verification_type: unit_test
aspects_covered:
  main_scenario: true
  business_rules: true
  data_validation: true
  error_handling: true
notes: "3x limit, temperature increase, cache invalidation, DB persistence, count tracking"
```

---

### Traceability Summary

| AC | Code Location | Test Location | Type | Status |
|----|---------------|---------------|------|--------|
| AC1 | TopicGenerationServiceImpl.java, PublishAssistPromptBuilder.java, DoubaoClient.java | TopicGenerationServiceTest.java | unit | âœ… |
| AC2 | TitleGenerationServiceImpl.java, PublishAssistPromptBuilder.java | TitleGenerationServiceTest.java | unit | âœ… |
| AC3 | PublishAssistServiceImpl.java, PublishAssistController.java, PublishAssistMapper.java | PublishAssistServiceTest.java | unit | âœ… |

**Legend**: âœ… Verified | â³ Pending | âŒ Missing

---

## Architect Review Results

### Review Date: 2026-02-05
### Reviewed By: Aiden (Architect Agent)
### Architecture Score: 10.0/10
### Review Round: 2

### Decision: AwaitingTestDesign

### Round 2 Summary

All 6 issues from Round 1 have been successfully resolved. The Story now fully aligns with the architecture:

| Validation | Reference | Status |
|------------|-----------|--------|
| Service ownership | Â§4.6 Publish Service | âœ… publish-service |
| API routing | Â§4.1 Gateway routes | âœ… /api/v1/publish/** |
| Data model | Â§5.1 publish_assists table | âœ… Correct table |
| Cross-service calls | Feign + internal APIs | âœ… InternalTaskController |
| Redis caching | Â§5.2 Redis structures | âœ… publish:assist:{taskId} |
| Shared module | common/doubao-client | âœ… Extracted |

### Round 1 Issues (All Resolved)

#### Critical Issues (2) - RESOLVED

- **æœåŠ¡å½’å±é”™è¯¯**: âœ… æ‰€æœ‰ä»£ç è¿ç§»åˆ° `backend/publish-service/`
- **Gateway è·¯ç”±é…ç½®å†²çª**: âœ… API è·¯å¾„æ”¹ä¸º `/api/v1/publish/tasks/{id}/assist`

#### High Issues (2) - RESOLVED

- **æ•°æ®æ¨¡å‹ä¸æ¶æ„ä¸ä¸€è‡´**: âœ… ä½¿ç”¨ `publish_assists` è¡¨ (per Â§5-data-architecture.md:132-145)
- **DoubaoClient å¤ç”¨é—®é¢˜**: âœ… æå–åˆ° `common/doubao-client` æ¨¡å—

#### Medium Issues (2) - RESOLVED

- **Redis ç¼“å­˜ Key æœªå®šä¹‰**: âœ… å®šä¹‰ `publish:assist:{taskId}` key pattern
- **å†…éƒ¨ API è·¯å¾„ä¸æ˜ç¡®**: âœ… æ–°å¢ InternalTaskController æä¾›å†…éƒ¨ API

### Recommendations

- Story ready for QA test design (Standard tier)
- No additional architectural concerns

---

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| test_design_status | Complete |
| complexity_indicators | 3 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-02-05 |
| assigned_date | 2026-02-05 |
| completed_date | 2026-02-05 |
| test_scenarios | 132 |
| test_document | docs/qa/assessments/5.3-test-design-20260205.md |

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created â†’ Draft | Story created from PRD Epic 5 |
| 2026-02-04 | SM | Draft â†’ AwaitingArchReview | Full elaboration with prompt engineering, Doubao integration, caching strategy |
| 2026-02-05 14:30 | Architect | AwaitingArchReview â†’ RequiresRevision | Score: 6.0/10, 2 critical / 2 major issues - æœåŠ¡å½’å±é”™è¯¯ï¼Œéœ€è¿ç§»åˆ° publish-service |
| 2026-02-05 15:00 | SM | RequiresRevision â†’ AwaitingArchReview | Round 2: Fixed all 6 issues - migrated to publish-service, updated API path, used publish_assists table, extracted DoubaoClient to common module, added internal APIs |
| 2026-02-05 15:30 | Architect | AwaitingArchReview â†’ AwaitingTestDesign | Score: 10.0/10, All issues resolved. Story approved for QA test design (Standard tier) |
| 2026-02-05 16:00 | QA | AwaitingTestDesign â†’ Approved | Test design complete: 132 scenarios (98 unit, 18 integration, 6 E2E, 10 blind spot). Doc: 5.3-test-design-20260205.md. Ready for Dev. |
| 2026-02-05 18:30 | Dev | Approved â†’ Review | Implementation complete: common-doubao module, publish-service APIs, task-service internal APIs, all unit tests. Dev Log: 5.3-dev-log.md |
