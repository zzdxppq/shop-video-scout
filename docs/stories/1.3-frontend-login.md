# Story 1.3: å‰ç«¯é¡¹ç›®æ­å»ºä¸ç™»å½•é¡µé¢

## Status
Done

## Story

**As a** ç”¨æˆ·,
**I want** é€šè¿‡å‹å¥½çš„ç™»å½•é¡µé¢è¿›è¡Œæ‰‹æœºå·éªŒè¯ç ç™»å½•,
**so that** å¯ä»¥æ–¹ä¾¿å¿«æ·åœ°è¿›å…¥ç³»ç»Ÿ

## Acceptance Criteria

### AC1: Vue3é¡¹ç›®åˆå§‹åŒ–

**Scenario**
```gherkin
GIVEN å¼€å‘ç¯å¢ƒå·²å‡†å¤‡å¥½Node.js
WHEN åˆ›å»ºå‰ç«¯é¡¹ç›®
THEN
  - ä½¿ç”¨Viteåˆ›å»ºVue3 + TypeScripté¡¹ç›®
  - é…ç½®TailwindCSSå’ŒElement Plus
  - é…ç½®Vue Routerå’ŒPinia
  - é…ç½®Axiosè¯·æ±‚æ‹¦æˆªå™¨
  - é¡¹ç›®å¯æ­£å¸¸å¯åŠ¨è¿è¡Œ
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | æ‰€æœ‰è¯·æ±‚è‡ªåŠ¨æºå¸¦Authorizationå¤´ |
| BR-1.2 | 401å“åº”è‡ªåŠ¨å°è¯•åˆ·æ–°Token |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| æ„å»ºå¤±è´¥ | BUILD_ERROR | é¡¹ç›®æ„å»ºå¤±è´¥ | æ£€æŸ¥ä¾èµ–å’Œé…ç½® |

---

### AC2: ç™»å½•é¡µé¢å®ç°

**Scenario**
```gherkin
GIVEN ç”¨æˆ·è®¿é—®éœ€è¦è®¤è¯çš„é¡µé¢æˆ–ç‚¹å‡»ç™»å½•
WHEN ç”¨æˆ·è¿›å…¥ç™»å½•é¡µ
THEN
  - æ˜¾ç¤ºæ‰‹æœºå·è¾“å…¥æ¡†
  - æ˜¾ç¤ºéªŒè¯ç è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®
  - å‘é€æŒ‰é’®ç‚¹å‡»åæ˜¾ç¤º60ç§’å€’è®¡æ—¶
  - ç™»å½•æˆåŠŸåè·³è½¬åˆ°ç›®æ ‡é¡µé¢
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | æ‰‹æœºå·è¾“å…¥æ—¶å®æ—¶æ ¼å¼éªŒè¯ |
| BR-2.2 | å‘é€éªŒè¯ç åæŒ‰é’®ç¦ç”¨60ç§’ |
| BR-2.3 | ç™»å½•æˆåŠŸåTokenå­˜å‚¨åˆ°localStorage |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| phone | string | true | 11ä½æ•°å­—ï¼Œä»¥1å¼€å¤´ | è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå· |
| code | string | true | 6ä½æ•°å­— | è¯·è¾“å…¥6ä½éªŒè¯ç  |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| ç½‘ç»œé”™è¯¯ | NETWORK_ERROR | ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ | æ˜¾ç¤ºé‡è¯•æŒ‰é’® |

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| é¡µé¢åŠ è½½ | è‡ªåŠ¨èšç„¦æ‰‹æœºå·è¾“å…¥æ¡† |
| ç‚¹å‡»å‘é€éªŒè¯ç  | æŒ‰é’®æ˜¾ç¤º60ç§’å€’è®¡æ—¶ï¼Œç¦ç”¨çŠ¶æ€ |
| ç™»å½•æˆåŠŸ | æ˜¾ç¤ºæˆåŠŸæç¤ºï¼Œ1ç§’åè·³è½¬ |

---

## Tasks / Subtasks

### Infrastructure Tasks (Shared)

- [x] **T0: ç¯å¢ƒå‡†å¤‡** `[ALL ACs]`
  - [x] ç¡®è®¤Node.js 18+ç¯å¢ƒ
  - [x] å‡†å¤‡APIä»£ç†é…ç½®

### Feature Implementation Tasks

#### AC1: Vue3é¡¹ç›®åˆå§‹åŒ–

- [x] **T1: åˆ›å»ºVue3é¡¹ç›®** `[AC1]`
  - [x] ä½¿ç”¨`npm create vite@latest`åˆ›å»ºé¡¹ç›®
  - [x] é…ç½®TypeScriptä¸¥æ ¼æ¨¡å¼
  - [x] é…ç½®è·¯å¾„åˆ«å(@/)

- [x] **T2: å®‰è£…å’Œé…ç½®UIæ¡†æ¶** `[AC1]`
  - [x] å®‰è£…TailwindCSS
  - [x] å®‰è£…Element Plus
  - [x] é…ç½®è‡ªåŠ¨å¯¼å…¥

- [x] **T3: é…ç½®è·¯ç”±å’ŒçŠ¶æ€ç®¡ç†** `[AC1]`
  - [x] å®‰è£…Vue Router
  - [x] åˆ›å»ºè·¯ç”±é…ç½®ï¼ˆç™»å½•ã€é¦–é¡µã€åˆ›å»ºä»»åŠ¡ç­‰ï¼‰
  - [x] å®‰è£…Pinia
  - [x] åˆ›å»ºç”¨æˆ·çŠ¶æ€store

- [x] **T4: é…ç½®Axios** `[AC1]`

  **Test Specs** (from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Auth header auto-added | Request + stored token | `Authorization: Bearer {token}` | unit |
  | Auth endpoints excluded | Request to `/auth/*` | No header added | unit |
  | 401 triggers refresh | 401 response | Refresh API called | unit |
  | Refresh fail -> logout | Refresh returns 401 | Redirect to /login | unit |
  | Routes load correctly | App init | All routes accessible | integration |

  - [x] åˆ›å»ºAxioså®ä¾‹
  - [x] é…ç½®è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨æºå¸¦Tokenï¼‰
  - [x] é…ç½®å“åº”æ‹¦æˆªå™¨ï¼ˆ401è‡ªåŠ¨åˆ·æ–°Tokenï¼‰
  - [x] é…ç½®APIä»£ç†

#### AC2: ç™»å½•é¡µé¢å®ç°

- [x] **T5: åˆ›å»ºç™»å½•é¡µé¢ç»„ä»¶** `[AC2]`

  **Test Specs** (from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Valid phone passes | `13800138000` | validation passes | unit |
  | Phone 10 digits fails | `1380013800` | "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·" | unit |
  | Phone non-numeric fails | `1380013800a` | "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·" | unit |
  | Valid code passes | `123456` | validation passes | unit |
  | Code 5 digits fails | `12345` | "è¯·è¾“å…¥6ä½éªŒè¯ç " | unit |
  | Countdown 60->0 | Click send | Decrement every second | unit |

  - [x] åˆ›å»ºLoginView.vue
  - [x] å®ç°æ‰‹æœºå·è¾“å…¥æ¡†ï¼ˆå¸¦æ ¼å¼éªŒè¯ï¼‰
  - [x] å®ç°éªŒè¯ç è¾“å…¥æ¡†
  - [x] å®ç°å‘é€éªŒè¯ç æŒ‰é’®ï¼ˆå¸¦å€’è®¡æ—¶ï¼‰

- [x] **T6: å®ç°ç™»å½•é€»è¾‘** `[AC2]`

  **Test Specs** (from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Send code API | Valid phone | 200 OK, countdown starts | integration |
  | Login API | Valid credentials | Token returned | integration |
  | Token stored | Login success | Token in localStorage | unit |
  | Complete login E2E | Phone + code | Login success, redirect | e2e |

  - [x] è°ƒç”¨å‘é€éªŒè¯ç API
  - [x] è°ƒç”¨ç™»å½•API
  - [x] å­˜å‚¨Tokenåˆ°localStorage
  - [x] ç™»å½•æˆåŠŸè·³è½¬

- [x] **T7: å®ç°è·¯ç”±å®ˆå«** `[AC2]`

  **Test Specs** (from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Route guard blocks | No token + /create | Redirect to /login | integration |
  | Guard saves redirect | Blocked request | `redirect` query saved | integration |
  | Login with redirect | Login after block | Redirect to original URL | e2e |

  - [x] åˆ›å»ºè·¯ç”±å‰ç½®å®ˆå«
  - [x] æœªç™»å½•è·³è½¬åˆ°ç™»å½•é¡µ
  - [x] è®°å½•åŸç›®æ ‡é¡µé¢ï¼Œç™»å½•åè·³å›

### Integration Tasks

- [x] **T8: é›†æˆéªŒè¯** `[ALL ACs]`
  - [x] å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•
  - [x] Tokenåˆ·æ–°æµ‹è¯•
  - [x] è·¯ç”±å®ˆå«æµ‹è¯•

---

## Dev Notes

### Technical Constraints

- Vueç‰ˆæœ¬: 3.4+
- Viteç‰ˆæœ¬: 5.x
- TypeScriptä¸¥æ ¼æ¨¡å¼
- Node.js: 18+

### UI/UX Specification Reference

**ğŸ“ Reference File**: `docs/front-end-spec.md`

| Section | Why Relevant |
|---------|--------------|
| è®¾è®¡ç³»ç»Ÿ - é¢œè‰²è§„èŒƒ | ç™»å½•é¡µé…è‰² |
| è®¾è®¡ç³»ç»Ÿ - è¡¨å•ç»„ä»¶ | è¾“å…¥æ¡†ã€æŒ‰é’®æ ·å¼ |
| é¡µé¢è®¾è®¡ - ç™»å½•é¡µ | ç™»å½•é¡µå¸ƒå±€å’Œäº¤äº’ |

### Consumes APIs

- `POST /api/v1/auth/send-code` - å‘é€éªŒè¯ç 
- `POST /api/v1/auth/login` - ç™»å½•

### Dependencies

- ä¾èµ– Story 1.2 (ç”¨æˆ·è®¤è¯æœåŠ¡)

### File Locations

```
frontend/
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ tailwind.config.js
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts
â”‚   â”œâ”€â”€ App.vue
â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ user.ts
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ axios.ts
â”‚   â”‚   â””â”€â”€ auth.ts
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ LoginView.vue
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ common/
â””â”€â”€ index.html
```

---

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| test_design_status | Complete |
| complexity_indicators | 3 |
| security_sensitive | true |
| calculated_by | Architect (review) |
| calculation_date | 2026-01-22 |
| test_design_document | docs/qa/assessments/1.3-test-design-20260122.md |
| total_scenarios | 42 |
| p0_scenarios | 10 |
| p1_scenarios | 18 |
| p2_scenarios | 14 |
| blind_spot_scenarios | 8 |

---

## Architect Review Results

### Review Date: 2026-01-22
### Reviewed By: Aiden (Architect)
### Architecture Score: 10/10
### Review Round: 1

### Decision: Approved â†’ AwaitingTestDesign

### Issues

#### Critical Issues (0)
None

#### High Issues (0)
None

#### Medium Issues (0)
None

#### Low Issues (0)
None

### Scoring Breakdown

| Criterion | Score | Notes |
|-----------|-------|-------|
| Tech Stack Compliance | 1/1 | Vue 3 + TypeScript + Vite, TailwindCSS + Element Plus per Section 2.2 |
| Naming Convention Adherence | 1/1 | LoginView.vue, user.ts, axios.ts follow conventions |
| Project Structure Alignment | 1/1 | File paths match architecture Section 12.1 |
| API Design Consistency | 1/1 | Correctly consumes /api/v1/auth/* endpoints from Section 4.2 |
| Data Model Accuracy | 1/1 | Token/user model aligns with architecture |
| Architecture Pattern Compliance | 1/1 | Vue composition API, Pinia stores, Axios interceptors |
| Complete Dependency Mapping | 1/1 | Story 1.2 dependency correctly identified and satisfied |
| Integration Feasibility | 1/1 | Backend APIs implemented and ready |
| Accurate Documentation References | 1/1 | front-end-spec.md correctly referenced for UI/UX |
| Overall Implementation Feasibility | 1/1 | Story is complete and implementable |
| **Total** | **10/10** | |

### Recommendations
- Story is well-structured with clear ACs and comprehensive task breakdown
- UI/UX spec references are properly linked
- Security-sensitive (auth token handling) â†’ requires test design
- Test design should include E2E tests for complete login flow

### Test Design Level Calculation

| Factor | Value | Weight |
|--------|-------|--------|
| Number of ACs | 2 | Low |
| External API Integration | 2 APIs | Medium |
| UI Interactions | Form validation, countdown, redirect | Medium |
| Security Sensitivity | Auth tokens, localStorage | High |
| **Complexity Score** | 3 | Standard |

**Rationale:** Frontend story handling authentication tokens requires proper E2E test coverage to verify login flow, token storage, and route guards work correctly.

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created â†’ Draft | Story created from PRD Epic 1 |
| 2026-01-22 | SM | Draft â†’ AwaitingArchReview | Dependency 1.2 satisfied, ready for review |
| 2026-01-22 | Architect | AwaitingArchReview â†’ AwaitingTestDesign | Score: 10/10, 0 issues, security-sensitive |
| 2026-01-22 | QA | AwaitingTestDesign â†’ Approved | Test Design Complete: 42 scenarios (P0:10, P1:18, P2:14), 8 blind-spot |
| 2026-01-23 | Dev | Approved â†’ Review | Implementation complete: 8 source files, 5 test files, 154 tests passing |
| 2026-01-24 | QA | Review â†’ InProgress | Round 1, Gate: FAIL, Tests: 100% automated pass, E2E blocked by CSS build error |
| 2026-01-24 | Dev | InProgress â†’ Review | QA Round 1 fixes: TailwindCSS v4 config, 429 rate limit handling, checkboxes updated |
| 2026-01-27 | QA | Review â†’ InProgress | Round 2, Gate: FAIL, R1 issues resolved, new CRITICAL: Pinia not initialized in main.ts |
| 2026-01-27 | Dev | InProgress â†’ Review | QA Round 2 fixes: Pinia init in main.ts (ISSUE-004), behavioral 429 tests (ISSUE-005), 299 tests passing |
| 2026-01-27 | QA | Review â†’ Done | Round 3, Gate: PASS, 299/299 automated + 6/6 E2E, all R2 issues resolved |

---

## Dev Agent Record

### Implementation Summary

| Metric | Value |
|--------|-------|
| Source Files Created/Modified | 10 |
| Test Files Created | 5 |
| Tests Passing | 299 |
| Implementation Round | 3 (QA Round 2 fixes) |

### Files Created/Modified

| Path | Status | Description |
|------|--------|-------------|
| frontend/src/types/auth.ts | created | Auth types (LoginRequest, LoginResponse, etc.) |
| frontend/src/api/auth.ts | created | Auth API functions (sendCode, login, refreshToken) |
| frontend/src/api/request.ts | modified | Added token refresh interceptor, auth endpoint exclusion |
| frontend/src/stores/user.ts | created | Pinia store for user authentication state |
| frontend/src/views/LoginView.vue | created | Login page with phone/code inputs |
| frontend/src/router/index.ts | modified | Added login route, redirect preservation |
| frontend/src/api/__tests__/auth.spec.ts | created | Auth API unit tests |
| frontend/src/api/__tests__/request.spec.ts | created | Request interceptor tests |
| frontend/src/stores/__tests__/user.spec.ts | created | User store tests |
| frontend/src/views/__tests__/LoginView.spec.ts | created | LoginView component tests |
| frontend/src/router/__tests__/router.spec.ts | created | Router guard tests |
| frontend/src/style.css | modified | Fixed TailwindCSS v4 config (QA Round 1 ISSUE-001) |
| frontend/src/main.ts | modified | Added Pinia initialization (QA Round 2 ISSUE-004) |

### QA Round 1 Fixes Applied

| Issue ID | Severity | Fix Applied |
|----------|----------|-------------|
| ISSUE-001 | CRITICAL | Updated style.css: replaced @tailwind directives with @import "tailwindcss" and @config for TailwindCSS v4 |
| ISSUE-002 | HIGH | Marked all 24 task checkboxes as completed |
| ISSUE-003 | MEDIUM | Added 429 rate limit error handling in auth.ts with RATE_LIMIT_ERROR_CODE and user-friendly messages |

### QA Round 2 Fixes Applied

| Issue ID | Severity | Fix Applied |
|----------|----------|-------------|
| ISSUE-004 | CRITICAL | Added Pinia initialization to main.ts: import createPinia, create instance, app.use(pinia) before router |
| ISSUE-005 | MEDIUM | Added 6 behavioral tests for handleAuthError() with mocked 429 responses: Retry-After parsing, default 60s fallback, login/refreshToken 429, server error messages, non-axios error rethrow |

### Debug Log References (QA Round 2)

```
$ cd frontend && npx vitest run
âœ“ 16 test files passed (299 tests)
  - src/api/__tests__/auth.spec.ts: 18 tests (6 new behavioral 429 tests)
  - All other test files: unchanged, passing
```

### Completion Notes (QA Round 2)

- **ISSUE-004 (CRITICAL)**: Added `createPinia()` to `main.ts`. Root cause: Pinia was never registered as a Vue plugin, but unit tests masked this because `createTestingPinia()` creates its own instance. Fix: 3 lines added â€” import, create, app.use(pinia) before router.
- **ISSUE-005 (MEDIUM)**: Added 6 behavioral tests to `auth.spec.ts` that mock axios to test `handleAuthError()` with real 429 responses. Tests cover: Retry-After header parsing (30s), default 60s fallback, login 429, refreshToken 429, server error message propagation, and non-axios error rethrow.
- Fixes applied based on QA review round 2.

### API Endpoints Consumed

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/v1/auth/send-code` | Send verification code to phone |
| POST | `/api/v1/auth/login` | Login with phone and code |
| POST | `/api/v1/auth/refresh` | Refresh access token |

### Key Features Implemented

| Feature | Description |
|---------|-------------|
| User Store | Pinia store with token persistence to localStorage |
| Token Refresh | Auto-refresh on 401, queue concurrent requests |
| Auth Endpoint Exclusion | /auth/* endpoints skip Authorization header |
| Login Page | Phone validation, 60s countdown, success redirect |
| Route Guard | Blocks unauthenticated access, preserves redirect URL |

### Business Rules Coverage

| ID | Rule | Implementation |
|----|------|----------------|
| BR-1.1 | All requests auto-add Authorization header | request.ts interceptor |
| BR-1.2 | 401 response auto-refresh Token | request.ts response interceptor |
| BR-2.1 | Phone real-time format validation | LoginView.vue onPhoneInput |
| BR-2.2 | Send code button disabled 60s | LoginView.vue startCountdown |
| BR-2.3 | Token stored to localStorage | user.ts setTokens |

### Self Review

| Gate | Score | Status |
|------|-------|--------|
| Implementation Gate | 100% | PASS |
| Test Coverage | 299 tests passing | PASS |
| Business Rules | 5/5 covered | PASS |
| Security | Tokens in localStorage, no secrets | PASS |
| QA Round 1 Issues | 3/3 fixed | PASS |
| QA Round 2 Issues | 2/2 fixed | PASS |
| CSS Build | Dev server starts without errors | PASS |
| Pinia Init | app.use(pinia) in main.ts | PASS |
| Blind Spot Coverage | BLIND-ERROR-002 behavioral tests added | PASS |

---

## QA Review

- **Round**: 3
- **Risk Level**: HIGH
- **Review Mode**: full_testing (incremental)
- **Gate**: PASS
- **Tests**: 299/299 automated (100%), 6/6 E2E (all pass â€” Pinia fix unblocked all scenarios)
- **Blind Spots**: 7/8 covered (87.5%)
- **Issues**: 0 critical / 0 high / 0 medium / 1 low
- **Gate File**: `docs/qa/gates/1.3-frontend-login.yml`
- **Evidence**: `docs/qa/evidence/1.3/`

### Round 1 Issues Resolution

| ID | Severity | Finding | R2 Status | R3 Status |
|----|----------|---------|-----------|-----------|
| ISSUE-001 | CRITICAL | TailwindCSS v4 configuration | RESOLVED | RESOLVED |
| ISSUE-002 | HIGH | Task checkboxes not updated | RESOLVED | RESOLVED |
| ISSUE-003 | MEDIUM | No 429 rate limit handling | RESOLVED | RESOLVED |

### Round 2 Issues Resolution

| ID | Severity | Finding | R3 Status |
|----|----------|---------|-----------|
| ISSUE-004 | CRITICAL | Pinia not initialized in main.ts | RESOLVED â€” `createPinia()` + `app.use(pinia)` added before router |
| ISSUE-005 | MEDIUM | BLIND-ERROR-002 test only verifies constants | RESOLVED â€” 6 behavioral `handleAuthError()` tests with mocked 429 responses |

### Round 3 Remaining (Non-Blocking)

| ID | Severity | Finding |
|----|----------|---------|
| BLIND-ERROR-001 | LOW | Auth endpoint timeout shows raw error message instead of user-friendly Chinese text (app doesn't crash, just cosmetic UX) |
