# Story 3.1: AI脚本生成服务

## Status
Draft

## Story

**As a** 系统,
**I want** 使用AI根据镜头分析和店铺信息生成口播脚本,
**so that** 用户无需自己撰写文案

## Acceptance Criteria

### AC1: 调用豆包API生成脚本

**Scenario**
```gherkin
GIVEN 镜头分析已完成
WHEN 系统生成脚本
THEN
  - 构建包含店铺信息和镜头摘要的Prompt
  - 调用豆包API生成脚本
  - 解析返回的脚本内容
  - 存储到任务记录
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 脚本分5-7个段落 |
| BR-1.2 | 每段标注对应镜头 |
| BR-1.3 | 总时长控制在60秒左右 |
| BR-1.4 | 脚本风格根据video_style调整 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| AI服务超时 | 504 | 生成超时，正在重试 | 自动重试2次 |
| 生成内容异常 | 422 | 生成内容异常，正在重新生成 | 更换Prompt参数重试 |

---

### AC2: 重新生成脚本

**Scenario**
```gherkin
GIVEN 用户对当前脚本不满意
WHEN 用户点击重新生成
THEN
  - 调整Prompt参数
  - 重新调用AI生成
  - 更新脚本内容
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 每个任务最多重新生成5次 |
| BR-2.2 | 保留上一版本脚本供对比 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 重新生成次数超限 | 429 | 重新生成次数已达上限，请手动编辑 | 禁用重新生成按钮 |

---

## Tasks / Subtasks

- [ ] **T1: 豆包API SDK集成** `[AC1]`
- [ ] **T2: 脚本生成Prompt设计** `[AC1]`
- [ ] **T3: 脚本存储和版本管理** `[AC2]`

## Dev Notes

### Provides APIs
- `GET /api/v1/tasks/{id}/script`
- `POST /api/v1/tasks/{id}/regenerate-script`

### Dependencies
- 依赖 Story 2.3 (AI镜头分析)

### Architecture Reference
[Source: docs/architecture.md - Section 4.4 Doubao Script Prompt]

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created → Draft | Story created from PRD Epic 3 |
