# Story 5.1: 集成阿里云TTS实现脚本配音

## Status
AwaitingTestDesign

## Story

**As a** 系统,
**I want** 将AI生成的口播脚本转换为语音音频,
**so that** 用户无需自己录制配音

## Description

实现media-service中的TTS功能：
- 调用阿里云语音合成API
- 支持多种标准音色
- 生成音频文件上传OSS

## Acceptance Criteria

### AC1: 文本转语音

**Scenario**
```gherkin
GIVEN 脚本文本
WHEN 调用阿里云TTS API
THEN
  - 生成对应的语音音频
  - 音频格式为MP3
  - 音频清晰、语速正常
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 音频格式: MP3, 16kHz |
| BR-1.2 | 默认语速: 1.0x |
| BR-1.3 | 单段最大文本: 300字 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 文本过长 | 400 | 文本超出限制 | 分段处理 |
| TTS服务异常 | 500 | 语音合成失败 | 重试 |

### AC2: 音色选择

**Scenario**
```gherkin
GIVEN 用户选择配音音色
WHEN 调用TTS服务
THEN
  - 使用指定音色合成
  - 默认提供3种标准音色
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | xiaoyun: 标准女声 |
| BR-2.2 | xiaogang: 标准男声 |
| BR-2.3 | xiaomeng: 甜美女声 |

### AC3: 分段合成

**Scenario**
```gherkin
GIVEN 多段脚本文本
WHEN 批量合成配音
THEN
  - 每段独立合成音频
  - 记录每段音频时长
  - 上传到OSS
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 每段脚本单独生成音频文件 |
| BR-3.2 | 记录音频时长(毫秒) |
| BR-3.3 | 并行合成提高效率 |

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 依赖和配置** `[ALL ACs]`
  - [ ] 添加阿里云NLS SDK依赖
  - [ ] 配置阿里云AccessKey
  - [ ] 配置OSS客户端

## Feature Implementation Tasks

### AC1: 文本转语音

- [ ] **T1: 实现TTS基础调用** `[AC1]`
  - [ ] 创建 TtsService
  - [ ] 实现阿里云NLS WebSocket连接
  - [ ] 实现文本转语音
  - [ ] 音频数据保存为MP3
  - [ ] 编写单元测试

### AC2: 音色选择

- [ ] **T2: 实现音色配置** `[AC2]`
  - [ ] 定义音色枚举
  - [ ] 支持音色参数传递
  - [ ] 配置默认音色
  - [ ] 编写单元测试

### AC3: 分段合成

- [ ] **T3: 实现批量分段合成** `[AC3]`
  - [ ] 创建 VoiceSegmentService
  - [ ] 实现并行合成
  - [ ] 记录音频时长
  - [ ] 上传到OSS
  - [ ] 更新 task_voice_segments 表
  - [ ] 编写单元测试

## Integration & Verification Tasks

- [ ] **T4: 集成测试** `[ALL ACs]`
  - [ ] 端到端: 脚本→TTS→音频文件
  - [ ] 不同音色效果测试
  - [ ] 长文本分段测试

## Dev Notes

### Technical Constraints

- 阿里云NLS SDK (WebSocket)
- 音频格式: MP3, 16kHz
- 分段合成再拼接

### API Configuration

```yaml
aliyun_tts:
  endpoint: "wss://nls-gateway.cn-shanghai.aliyuncs.com/ws/v1"
  app_key: ${ALIYUN_NLS_APP_KEY}
  voices:
    - xiaoyun  # 标准女声
    - xiaogang # 标准男声
    - xiaomeng # 甜美女声
```

### Database Schema

```sql
CREATE TABLE task_voice_segments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id BIGINT NOT NULL,
    segment_index INT NOT NULL,
    segment_title VARCHAR(100),
    script_text TEXT NOT NULL,
    audio_key VARCHAR(500),
    audio_url VARCHAR(1000),
    duration_ms INT,
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### File Locations

```
backend/media-service/
├── src/main/java/
│   ├── service/
│   │   ├── TtsService.java
│   │   └── VoiceSegmentService.java
│   ├── config/
│   │   └── TtsConfig.java
│   └── entity/
│       └── TaskVoiceSegment.java
```

## Source Proposals
- TCP-2026-001 Story Requirement T6
- PCP-2026-001 Story Requirement 1

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.8/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story技术方案与TCP-2026-001完全对齐。阿里云NLS WebSocket配置正确，音色选择与TCP一致，数据库Schema结构正确。由于涉及WebSocket长连接和并行处理，需要QA进行测试设计验证稳定性。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (3)
- **数据库索引缺失** (Dev Notes Schema): 补充 `INDEX idx_task_segment (task_id, segment_index)` 提升查询性能
- **外键约束缺失** (Dev Notes Schema): 补充 `FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE` 保证数据完整性
- **WebSocket连接管理** (T1 Tasks): 建议补充重连机制（指数退避）、心跳保活策略说明

### Recommendations
- 建议使用连接池管理WebSocket连接，避免频繁建连
- 并行合成建议使用 `CompletableFuture.allOf()` 等待所有段落完成
- 音频文件建议使用统一命名规则: `{task_id}/voice_{segment_index}.mp3`
- 考虑添加合成进度回调，实时更新任务进度

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 2 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP/PCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.8/10, 0 critical / 0 major issues |
