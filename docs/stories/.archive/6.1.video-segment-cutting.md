# Story 6.1: 根据脚本自动裁剪视频片段

## Status
AwaitingTestDesign

## Story

**As a** 系统,
**I want** 根据脚本段落和配音时长从原始视频中裁剪合适的片段,
**so that** 可以自动完成视频剪辑

## Description

实现media-service中的视频裁剪功能：
- 根据配音时长确定片段长度
- 从推荐镜头中提取视频片段
- 支持片段起始时间调整

## Acceptance Criteria

### AC1: 片段时长计算

**Scenario**
```gherkin
GIVEN 脚本段落和对应的配音音频
WHEN 计算视频片段时长
THEN
  - 片段时长 = 配音时长 + 0.5秒缓冲
  - 记录每段所需时长
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 片段时长 = 配音时长 + 500ms |
| BR-1.2 | 最小片段时长: 2秒 |
| BR-1.3 | 最大片段时长: 视频原始时长 |

### AC2: 视频片段裁剪

**Scenario**
```gherkin
GIVEN 推荐镜头和所需时长
WHEN 执行FFmpeg裁剪
THEN
  - 从视频指定位置裁剪
  - 输出独立的片段文件
  - 保持原始分辨率和帧率
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 默认从视频开头裁剪 |
| BR-2.2 | 片段时长不足时使用整个视频 |
| BR-2.3 | 输出格式与原始一致 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 视频文件损坏 | 400 | 视频文件无法处理 | 跳过该镜头 |
| FFmpeg执行失败 | 500 | 视频裁剪失败 | 重试 |

### AC3: 裁剪位置调整

**Scenario**
```gherkin
GIVEN 用户希望调整片段起始位置
WHEN 设置起始时间偏移
THEN
  - 从指定位置开始裁剪
  - 更新片段元数据
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 起始位置精度: 100ms |
| BR-3.2 | 不能超出视频时长范围 |

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 环境配置** `[ALL ACs]`
  - [ ] 确认FFmpeg 6.x已安装
  - [ ] 配置临时文件目录
  - [ ] 配置OSS上传

## Feature Implementation Tasks

### AC1: 片段时长计算

- [ ] **T1: 实现时长计算** `[AC1]`
  - [ ] 创建 SegmentPlanService
  - [ ] 读取配音时长
  - [ ] 计算各片段所需时长
  - [ ] 编写单元测试

### AC2: 视频片段裁剪

- [ ] **T2: 实现FFmpeg裁剪** `[AC2]`
  - [ ] 创建 VideoSegmentService
  - [ ] 实现FFmpeg命令构建
  - [ ] 执行裁剪并监控进度
  - [ ] 上传片段到OSS
  - [ ] 编写单元测试

### AC3: 裁剪位置调整

- [ ] **T3: 实现位置调整接口** `[AC3]`
  - [ ] 创建 /tasks/{id}/segments/{segmentId} PUT 接口
  - [ ] 支持 start_offset 参数
  - [ ] 触发重新裁剪
  - [ ] 编写单元测试

## Integration & Verification Tasks

- [ ] **T4: 集成测试** `[ALL ACs]`
  - [ ] 端到端: 配音完成→片段裁剪
  - [ ] 多种视频格式测试
  - [ ] 性能测试

## Dev Notes

### Technical Constraints

- FFmpeg 6.x
- ProcessBuilder执行命令
- 临时文件清理

### FFmpeg Commands

```bash
# 裁剪视频片段
ffmpeg -i {input} -ss {start} -t {duration} -c copy {output}

# 示例
ffmpeg -i source.mp4 -ss 00:00:05 -t 00:00:08 -c copy segment1.mp4
```

### Segment Plan Structure

```json
[
  {
    "index": 0,
    "source_video_id": 123,
    "source_video_url": "...",
    "start_offset_ms": 0,
    "duration_ms": 5500,
    "output_key": "segments/task_1/seg_0.mp4"
  }
]
```

### File Locations

```
backend/media-service/
├── src/main/java/
│   ├── service/
│   │   ├── VideoSegmentService.java
│   │   ├── SegmentPlanService.java
│   │   └── FfmpegCommandBuilder.java
│   └── dto/
│       └── SegmentPlan.java
```

## Source Proposals
- TCP-2026-001 Story Requirement T8
- PCP-2026-001 Story Requirement 2

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.4/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story技术方案与TCP-2026-001完全对齐。FFmpeg裁剪命令与TCP定义一致，media-service定位正确，ProcessBuilder执行方式符合架构要求。由于涉及外部进程执行和文件I/O操作，需要QA进行测试设计确保稳定性。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (4)
- **API端点扩展** (AC3 Tasks): `PUT /tasks/{id}/segments/{segmentId}` 未在TCP API规范中定义，为合理扩展但建议补充到TCP
- **task_videos字段更新** (AC2): TCP定义了 `used_segment_start`, `used_segment_end`, `sequence_order` 字段，建议在T2中明确更新这些字段的逻辑
- **片段存储关联** (Dev Notes): Segment Plan的 `output_key` 应与task_videos表的记录关联，建议明确存储关系而非独立JSON结构
- **临时文件清理策略** (T0 Tasks): 建议明确清理时机：任务成功后立即清理，任务失败保留用于调试（可配置保留时间）

### Recommendations
- FFmpeg执行建议设置超时（如5分钟），防止进程hang住
- 建议使用 `-y` 参数自动覆盖输出文件，避免交互式提示阻塞
- 片段文件命名建议统一规则: `{task_id}/segment_{index}.mp4`
- 考虑添加FFmpeg执行日志记录，便于问题排查

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 2 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP/PCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.4/10, 0 critical / 0 major issues |
