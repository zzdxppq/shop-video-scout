# Story 1.3: 实现用户认证和基础功能

## Status
Approved

## Story

**As a** 用户,
**I want** 通过手机验证码登录系统,
**so that** 可以安全地使用探店宝服务

## Description

实现user-service核心功能：
- 手机验证码发送 (阿里云短信)
- 验证码登录
- JWT Token生成和刷新
- 用户信息查询

## Acceptance Criteria

### AC1: 验证码发送

**Scenario**
```gherkin
GIVEN 用户输入手机号
WHEN 请求发送验证码
THEN
  - 调用阿里云短信API发送验证码
  - 验证码存储到Redis (5分钟过期)
  - 返回发送成功
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 手机号格式: 11位数字 |
| BR-1.2 | 验证码: 6位数字 |
| BR-1.3 | 有效期: 5分钟 |
| BR-1.4 | 发送频率限制: 60秒/次 |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| phone | string | Yes | 11位数字 | 手机号格式错误 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 手机号格式错误 | 400 | 手机号格式错误 | 返回错误 |
| 发送频率过快 | 429 | 请60秒后再试 | 返回错误 |
| 短信服务异常 | 500 | 发送失败，请重试 | 记录日志 |

### AC2: 验证码登录

**Scenario**
```gherkin
GIVEN 用户收到验证码
WHEN 提交手机号和验证码
THEN
  - 验证验证码正确
  - 自动注册或登录用户
  - 返回JWT Token
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 验证码正确则删除Redis中的验证码 |
| BR-2.2 | 新用户自动注册，赠送2次免费体验 |
| BR-2.3 | access_token有效期: 2小时 |
| BR-2.4 | refresh_token有效期: 7天 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 验证码错误 | 400 | 验证码错误 | 返回错误 |
| 验证码过期 | 400 | 验证码已过期 | 返回错误 |
| 验证码不存在 | 400 | 请先获取验证码 | 返回错误 |

### AC3: Token刷新

**Scenario**
```gherkin
GIVEN 用户持有有效的refresh_token
WHEN 请求刷新Token
THEN
  - 验证refresh_token有效
  - 返回新的access_token
  - refresh_token保持不变
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | refresh_token有效才能刷新 |
| BR-3.2 | 返回新的access_token |

### AC4: 用户信息查询

**Scenario**
```gherkin
GIVEN 用户已登录
WHEN 查询用户信息
THEN
  - 返回用户基本信息
  - 包含会员状态和剩余次数
```

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 数据库表和基础设施** `[ALL ACs]`
  - [ ] 创建 users 表
  - [ ] 配置 Redis 连接
  - [ ] 配置阿里云短信SDK

## Feature Implementation Tasks

### AC1: 验证码发送

- [ ] **T1: 实现验证码发送** `[AC1]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Valid phone | 13812345678 | 200 + SMS sent | integration |
  | Invalid phone | 1381234567 (10 digits) | 400 手机号格式错误 | unit |
  | Rate limited | Same phone within 60s | 429 请60秒后再试 | integration |
  | SMS failure | Valid phone, SMS API down | 500 发送失败 | integration |

  - [ ] 创建 SmsService (阿里云短信)
  - [ ] 实现验证码生成和Redis存储
  - [ ] 实现发送频率限制
  - [ ] 创建 /auth/send-code 接口
  - [ ] 编写单元测试

### AC2: 验证码登录

- [ ] **T2: 实现验证码登录** `[AC2]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Existing user login | Correct code | 200 + tokens | integration |
  | New user auto-register | Correct code, new phone | 200 + tokens + quota=2 | integration |
  | Wrong code | Incorrect code | 400 验证码错误 | integration |
  | Expired code | Code after 5min | 400 验证码已过期 | integration |
  | No code sent | Login without send-code | 400 请先获取验证码 | integration |
  | Code consumed | Login after successful login | 400 请先获取验证码 | integration |

  - [ ] 创建 AuthService
  - [ ] 实现验证码校验
  - [ ] 实现用户自动注册
  - [ ] 实现JWT Token生成
  - [ ] 创建 /auth/login 接口
  - [ ] 编写单元测试

### AC3: Token刷新

- [ ] **T3: 实现Token刷新** `[AC3]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Valid refresh | Valid refresh_token | 200 + new access_token | integration |
  | Expired refresh | Expired refresh_token | 401 Unauthorized | integration |
  | Invalid refresh | Tampered refresh_token | 401 Unauthorized | integration |

  - [ ] 创建 /auth/refresh 接口
  - [ ] 实现refresh_token验证
  - [ ] 编写单元测试

### AC4: 用户信息查询

- [ ] **T4: 实现用户信息查询** `[AC4]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Authenticated user | Valid access_token | 200 + profile data | integration |
  | Profile completeness | Valid request | membership_type, remaining_quota included | integration |
  | Unauthenticated | No token | 401 Unauthorized | integration |

  - [ ] 创建 UserService
  - [ ] 创建 /user/profile 接口
  - [ ] 编写单元测试

## Integration & Verification Tasks

- [ ] **T5: 集成测试** `[ALL ACs]`
  - [ ] 端到端: 发送验证码→登录→获取用户信息
  - [ ] Token刷新流程测试
  - [ ] 错误场景测试

## Dev Notes

### Technical Constraints

- 阿里云短信SDK
- Redis存储验证码 (5分钟过期)
- Token有效期: access 2h, refresh 7d

### Database Schema

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    phone VARCHAR(20) UNIQUE NOT NULL,
    nickname VARCHAR(50),
    avatar_url VARCHAR(500),
    membership_type ENUM('free', 'basic', 'pro') DEFAULT 'free',
    membership_expire_at DATETIME,
    remaining_quota INT DEFAULT 2,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | /api/v1/auth/send-code | 发送验证码 |
| POST | /api/v1/auth/login | 验证码登录 |
| POST | /api/v1/auth/refresh | 刷新Token |
| GET | /api/v1/user/profile | 获取用户信息 |

### File Locations

```
backend/user-service/
├── src/main/java/
│   ├── controller/
│   │   ├── AuthController.java
│   │   └── UserController.java
│   ├── service/
│   │   ├── AuthService.java
│   │   ├── SmsService.java
│   │   └── UserService.java
│   ├── entity/
│   │   └── User.java
│   └── mapper/
│       └── UserMapper.java
```

## Source Proposals
- TCP-2026-001 Story Requirement T3

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.7/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story技术方案与TCP-2026-001完全对齐。用户认证流程完整，数据库Schema基本正确，API设计规范。由于涉及用户认证和敏感数据处理，需要QA进行测试设计。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (3)
- **数据库索引缺失** (Dev Notes Schema): 建议补充 `INDEX idx_phone (phone)`, `INDEX idx_membership (membership_type, membership_expire_at)`
- **Token黑名单** (AC3): TCP提及Token黑名单机制，建议补充登出接口 `/auth/logout` 使Token失效
- **验证码错误限制** (AC2): 建议添加连续错误次数限制（如5次错误后锁定15分钟）

### Recommendations
- 建议使用 `@Validated` + 自定义手机号校验注解
- Redis key建议使用统一前缀如 `sms:code:{phone}`
- 考虑添加验证码发送记录表用于审计和防刷统计

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 3 |
| security_sensitive | true |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |
| test_design_status | Complete |
| test_design_document | docs/qa/assessments/E1.3-test-design-20260115.md |
| scenarios_total | 34 |
| scenarios_p0 | 17 |
| scenarios_p1 | 14 |
| scenarios_p2 | 3 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.7/10, 0 critical / 0 major issues, security_sensitive=true |
| 2026-01-15 | QA | AwaitingTestDesign → Approved | Test Design Complete: 34 scenarios (P0:17, P1:14, P2:3), Doc: docs/qa/assessments/E1.3-test-design-20260115.md |
