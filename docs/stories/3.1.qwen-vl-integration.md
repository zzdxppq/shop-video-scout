# Story 3.1: 集成通义千问VL实现镜头分析

## Status
Approved

## Story

**As a** 系统,
**I want** 调用通义千问VL分析视频关键帧,
**so that** 可以自动识别镜头内容、分类和质量评分

## Description

实现ai-service中的视觉分析功能：
- 调用通义千问VL API
- 分析视频关键帧
- 返回分类、标签、评分

## Acceptance Criteria

### AC1: 关键帧提取

**Scenario**
```gherkin
GIVEN 用户上传的原始视频
WHEN 系统开始分析
THEN
  - 提取视频关键帧 (每2秒1帧)
  - 关键帧保存到临时存储
  - 记录帧时间戳
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 采样频率: 0.5 fps (每2秒1帧) |
| BR-1.2 | 图片格式: JPEG |
| BR-1.3 | 最大分辨率: 1280x720 |

### AC2: 视觉AI分析

**Scenario**
```gherkin
GIVEN 提取的关键帧
WHEN 调用通义千问VL API
THEN
  - 返回镜头分类 (food/person/environment/other)
  - 返回内容标签 (菜品名称、场景描述等)
  - 返回镜头描述
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 分类: food(美食), person(人物), environment(环境), other(其他) |
| BR-2.2 | 标签数量: 3-8个 |
| BR-2.3 | 调用超时: 60秒 |
| BR-2.4 | 失败重试: 最多3次 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| API调用超时 | 504 | AI服务响应超时 | 重试 |
| API返回错误 | 500 | AI分析失败 | 记录日志，重试 |
| 图片格式错误 | 400 | 图片格式不支持 | 跳过该帧 |

### AC3: 质量评分

**Scenario**
```gherkin
GIVEN 关键帧分析结果
WHEN 计算质量分数
THEN
  - 评估清晰度 (0-100)
  - 评估构图 (0-100)
  - 评估光线 (0-100)
  - 计算综合评分
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 综合评分 = 清晰度*0.4 + 构图*0.3 + 光线*0.3 |
| BR-3.2 | 评分≥70为推荐镜头 |

### AC4: 结果存储

**Scenario**
```gherkin
GIVEN AI分析完成
WHEN 存储分析结果
THEN
  - 更新 task_videos 表的分析字段
  - 标记推荐镜头
  - 更新任务进度
```

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 依赖和配置** `[ALL ACs]`
  - [ ] 添加 DashScope SDK 依赖
  - [ ] 配置通义千问VL API密钥
  - [ ] 配置 FFmpeg (用于帧提取)

## Feature Implementation Tasks

### AC1: 关键帧提取

- [ ] **T1: 实现关键帧提取** `[AC1]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Valid 10s video | 10s MP4 | 5 frames extracted | integration |
  | Short video | <2s video | At least 1 frame | integration |
  | Frame storage | Extracted frames | JPEG saved to OSS | integration |
  | Invalid format | Non-video file | Error returned | integration |

  - [ ] 创建 FrameExtractorService
  - [ ] 实现 FFmpeg 帧提取命令
  - [ ] 上传帧图片到OSS临时目录
  - [ ] 编写单元测试

### AC2: 视觉AI分析

- [ ] **T2: 实现通义千问VL调用** `[AC2]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Valid frame analysis | JPEG frame | category + 3-8 tags + description | integration |
  | API timeout | Slow response >60s | Retry triggered | integration |
  | API error | 500 response | Retry up to 3 times | integration |
  | Retries exhausted | 3 failures | 500 AI分析失败 | integration |
  | Invalid image | Unsupported format | Skip frame with log | integration |

  - [ ] 创建 QwenVlService
  - [ ] 实现图片Base64编码
  - [ ] 设计分析Prompt
  - [ ] 解析API响应为结构化数据
  - [ ] 实现重试机制
  - [ ] 编写单元测试

### AC3: 质量评分

- [ ] **T3: 实现质量评分** `[AC3]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Score formula | clarity=80, composition=85, lighting=90 | 84.5 | unit |
  | High quality | scores ≥70 | marked recommended | unit |
  | Boundary inclusion | score exactly 70 | marked recommended | integration |
  | Boundary exclusion | score 69 | not recommended | integration |

  - [ ] 创建质量评分Prompt
  - [ ] 实现评分计算逻辑
  - [ ] 标记推荐镜头
  - [ ] 编写单元测试

### AC4: 结果存储

- [ ] **T4: 实现结果存储** `[AC4]`

  **Test Specs** (white-box scenarios from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Results persistence | Analysis complete | task_videos updated | integration |
  | Recommendation storage | Score ≥70 frames | Marked in database | integration |
  | Progress update | Analysis complete | Task progress updated | integration |
  | Cleanup | Analysis complete | Temp frames deleted | integration |

  - [ ] 更新 task_videos 表
  - [ ] 发送进度更新事件
  - [ ] 清理临时帧图片

## Integration & Verification Tasks

- [ ] **T5: 集成测试** `[ALL ACs]`
  - [ ] 端到端: 上传视频→帧提取→AI分析→结果存储
  - [ ] 批量视频分析测试
  - [ ] 性能测试 (分析时间)

## Dev Notes

### Technical Constraints

- 使用DashScope SDK调用通义千问VL
- 图片Base64编码传输
- 设置合理超时和重试

### API Configuration

```yaml
qwen_vl:
  endpoint: "https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation"
  model: "qwen-vl-plus"
  timeout: 60s
  retry: 3
```

### Analysis Prompt

```
分析这张探店视频截图，返回JSON格式：
{
  "category": "food|person|environment|other",
  "tags": ["标签1", "标签2", ...],
  "description": "镜头描述",
  "quality": {
    "clarity": 0-100,
    "composition": 0-100,
    "lighting": 0-100
  }
}
```

### File Locations

```
backend/ai-service/
├── src/main/java/
│   ├── service/
│   │   ├── QwenVlService.java
│   │   ├── FrameExtractorService.java
│   │   └── VideoAnalysisService.java
│   └── dto/
│       └── FrameAnalysisResult.java
```

## Source Proposals
- TCP-2026-001 Story Requirement T4

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.8/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story技术方案与TCP-2026-001完全对齐。通义千问VL API配置、FFmpeg帧提取、数据模型设计均符合架构要求。由于涉及外部AI API集成和视频处理，需要QA进行测试设计确保可靠性。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (3)
- **FFmpeg命令细节** (Dev Notes): 建议补充完整命令 `ffmpeg -i {input} -vf fps=0.5 -q:v 2 {output}_%04d.jpg`
- **并行分析策略** (AC2): 建议补充批量帧并行分析策略（如CompletableFuture）提升性能
- **analysis_status更新** (AC4): 建议明确补充 `task_videos.analysis_status = 'completed'` 更新逻辑

### Recommendations
- 建议使用 `@Async` + 线程池实现帧并行分析
- 考虑添加分析结果缓存，避免重复分析相同帧
- FFmpeg执行建议使用ProcessBuilder并设置超时
- 临时帧图片建议使用OSS生命周期策略自动清理

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 3 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |
| test_design_status | Complete |
| test_design_document | docs/qa/assessments/E3.1-test-design-20260115.md |
| scenarios_total | 38 |
| scenarios_p0 | 12 |
| scenarios_p1 | 18 |
| scenarios_p2 | 8 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.8/10, 0 critical / 0 major issues |
| 2026-01-15 | QA | AwaitingTestDesign → Approved | Test Design Complete: 38 scenarios (P0:12, P1:18, P2:8), Doc: docs/qa/assessments/E3.1-test-design-20260115.md |
