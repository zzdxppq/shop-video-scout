# Story 2.3: AI镜头分析服务

## Status
Approved

## Story

**As a** 系统,
**I want** 使用AI分析视频中的镜头内容,
**so that** 可以自动分类和推荐最佳镜头

## Acceptance Criteria

### AC1: 集成通义千问VL进行镜头分析

**Scenario**
```gherkin
GIVEN 视频关键帧已提取
WHEN 系统进行AI分析
THEN
  - 调用通义千问VL分析每个关键帧
  - 返回镜头分类（食物/人物/环境/其他）
  - 返回描述标签（最多5个）
  - 返回质量评分（0-100）
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 镜头分类：food, person, environment, other |
| BR-1.2 | 每个镜头最多5个标签 |
| BR-1.3 | 质量评分综合清晰度、构图、光线、稳定性 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| AI服务超时 | 504 | AI分析超时 | 自动重试3次 |
| 图片识别失败 | 422 | 无法识别图片内容 | 跳过该帧，继续其他 |

---

### AC2: 标记推荐镜头

**Scenario**
```gherkin
GIVEN 所有镜头分析完成
WHEN 系统进行推荐标记
THEN
  - 按分类分组
  - 每类按质量评分排序
  - 标记每类Top2为推荐镜头
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 每个分类最多推荐2个镜头 |
| BR-2.2 | 推荐镜头标记is_recommended=true |

---

## Tasks / Subtasks

- [ ] **T1: 通义千问VL SDK集成** `[AC1]`

  **Test Specs** (from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Valid API call | JPEG frame | JSON with category, tags, score | integration |
  | Timeout retry | 504 response | Retry 3x, then fail gracefully | integration |
  | Skip on 422 | Invalid frame | Skip frame, continue others | integration |
  | Malformed response | Bad JSON | Handle error, log, continue | unit |

  - [ ] Write tests (cover above scenarios)
  - [ ] Implement SDK integration
  - [ ] Verify & refactor

- [ ] **T2: 镜头分析Prompt设计** `[AC1]`

  **Test Specs** (from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Parse response | Valid JSON | Correct category, tags, score | unit |
  | Validate category | "food" | ENUM match | unit |
  | Tag count limit | 6 tags returned | Truncate to 5 | unit |
  | Score boundaries | 0, 100, 50 | Valid range 0-100 | unit |

  - [ ] Write tests (cover above scenarios)
  - [ ] Implement prompt and parser
  - [ ] Verify & refactor

- [ ] **T3: 推荐算法实现** `[AC2]`

  **Test Specs** (from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Group by category | Mixed frames | 4 groups | unit |
  | Sort by score | [80, 95, 70] | [95, 80, 70] | unit |
  | Top 2 selection | 5 food frames | 2 recommended | unit |
  | <2 in category | 1 food frame | 1 recommended | unit |
  | Tie-breaking | Same scores | Deterministic order | unit |

  - [ ] Write tests (cover above scenarios)
  - [ ] Implement recommendation algorithm
  - [ ] Verify & refactor

- [ ] **T4: 分析任务队列处理** `[ALL ACs]`

  **Test Specs** (from test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Queue message | analysis.queue msg | Process and ack | integration |
  | Batch processing | 10 frames | Parallel analysis | integration |
  | Progress tracking | Mid-analysis | Accurate % | e2e |
  | Empty frames | 0 frames | Handle gracefully | unit |

  - [ ] Write tests (cover above scenarios)
  - [ ] Implement queue consumer
  - [ ] Verify & refactor

## Dev Notes

### Provides APIs
- `POST /api/v1/tasks/{id}/analyze`
- `GET /api/v1/tasks/{id}/analysis-progress`

### Dependencies
- 依赖 Story 2.1 (视频上传服务)

### Architecture Reference
[Source: docs/architecture.md - Section 4.4 AI Analysis Pipeline]

---

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Comprehensive |
| test_design_status | Complete |
| complexity_indicators | 4 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-22 |
| test_design_doc | docs/qa/assessments/2.3-test-design-20260122.md |
| scenarios_total | 32 (Unit: 14, Integration: 12, E2E: 6) |
| blind_spot_scenarios | 12 |

---

## Architect Review Results

### Review Date: 2026-01-22
### Reviewed By: Aiden (Architect)
### Architecture Score: 10/10
### Review Round: 1

### Decision: APPROVED - Ready for QA Test Design

### Issues

#### Critical Issues (0)
None

#### High Issues (0)
None

#### Medium Issues (0)
None

#### Low Issues (0)
None

### Recommendations
- Story is well-structured and fully aligned with architecture
- Consider adding retry logic details for frame extraction failures
- Recommend documenting batch size for parallel Qwen-VL calls

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created → Draft | Story created from PRD Epic 2 |
| 2026-01-22 | Architect | Draft → AwaitingTestDesign | Score: 10/10, 0 critical / 0 major issues |
| 2026-01-22 | QA | AwaitingTestDesign → Approved | Test Design Complete: 32 scenarios (P0:8, P1:14, P2:8, P3:2), 12 blind spots |
