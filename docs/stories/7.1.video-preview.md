# Story 7.1: 实现成品视频在线预览

## Status
Approved

## Story

**As a** 用户,
**I want** 在导出前预览合成的视频效果,
**so that** 确认满意后再下载

## Description

实现前端视频预览功能：
- 视频播放器组件
- 支持播放控制
- 全屏预览

## Acceptance Criteria

### AC1: 视频播放器

**Scenario**
```gherkin
GIVEN 视频合成完成
WHEN 用户进入预览页面
THEN
  - 显示视频播放器
  - 支持播放/暂停
  - 显示进度条和时长
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 使用Video.js播放器 |
| BR-1.2 | 支持HLS/MP4格式 |
| BR-1.3 | 默认自动播放(静音) |

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| 点击播放区域 | 播放/暂停切换 |
| 拖动进度条 | 跳转到指定位置 |
| 点击音量按钮 | 静音/取消静音 |

### AC2: 全屏播放

**Scenario**
```gherkin
GIVEN 用户正在预览视频
WHEN 点击全屏按钮
THEN
  - 进入全屏模式
  - 保持播放控制可用
  - 按ESC退出全屏
```

### AC3: 加载状态

**Scenario**
```gherkin
GIVEN 视频正在加载
WHEN 等待视频就绪
THEN
  - 显示加载动画
  - 显示加载进度
  - 加载完成自动播放
```

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 视频加载失败 | - | 视频加载失败，请刷新重试 | 显示重试按钮 |
| 网络中断 | - | 网络连接中断 | 暂停并提示 |

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 依赖安装** `[ALL ACs]`
  - [ ] 安装 video.js
  - [ ] 配置播放器主题

## Feature Implementation Tasks

### AC1: 视频播放器

- [ ] **T1: 实现播放器组件** `[AC1]`
  - [ ] 创建 VideoPlayer.vue 组件
  - [ ] 集成 Video.js
  - [ ] 实现播放控制
  - [ ] 显示时长和进度
  - [ ] 编写组件测试

### AC2: 全屏播放

- [ ] **T2: 实现全屏功能** `[AC2]`
  - [ ] 添加全屏按钮
  - [ ] 实现全屏切换逻辑
  - [ ] 处理ESC退出
  - [ ] 编写测试

### AC3: 加载状态

- [ ] **T3: 实现加载状态** `[AC3]`
  - [ ] 创建加载动画组件
  - [ ] 监听视频加载事件
  - [ ] 实现错误处理和重试
  - [ ] 编写测试

## Integration & Verification Tasks

- [ ] **T4: 集成测试** `[ALL ACs]`
  - [ ] 不同视频格式测试
  - [ ] 移动端兼容测试
  - [ ] 弱网环境测试

## Dev Notes

### Technical Constraints

- Video.js播放器
- 支持HLS流媒体(可选)
- 移动端适配

### Video.js Configuration

```javascript
const player = videojs('my-video', {
  controls: true,
  autoplay: 'muted',
  preload: 'auto',
  fluid: true,
  playbackRates: [0.5, 1, 1.5, 2]
});
```

### File Locations

```
frontend/
├── src/components/
│   ├── VideoPlayer.vue
│   └── VideoLoading.vue
└── src/views/
    └── TaskResult.vue
```

## Source Proposals
- PCP-2026-001 Story Requirement 4

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.3/10
### Review Round: 1
### Test Design Level: Simple

### Decision: APPROVED

前端组件设计清晰，Video.js使用与TCP完全一致。作为纯前端视频播放器Story，技术复杂度低，无安全敏感内容，无需QA测试设计，可直接进入开发。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (3)
- **API数据源未明确** (AC1 Tasks): 建议在T1中明确：调用 `/tasks/{taskId}/output` API获取 `output_video_url` 作为播放源
- **CDN加速配置** (Dev Notes): TCP指定OSS + CDN，视频URL应配置CDN域名 `https://cdn.example.com/{output_video_key}` 以优化加载
- **移动端适配策略** (T4 Tasks): 建议补充：竖屏视频处理（9:16）、触摸手势支持、低带宽自动降质

### Recommendations
- Video.js支持HLS，建议对长视频启用HLS切片以优化首屏加载
- 建议添加播放速度控制（0.5x-2x），方便用户快速预览
- 考虑添加视频截图功能，方便用户分享预览画面
- 预览页建议显示视频基本信息（时长、分辨率、文件大小）

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from PCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → Approved | Score: 9.3/10, Simple test level, direct to Dev |
