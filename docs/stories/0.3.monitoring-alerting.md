# Story 0.3: 监控告警系统搭建

## Status
Draft

## Story

**As a** 运维团队,
**I want** 建立完善的监控告警系统,
**so that** 可以及时发现和响应系统问题，保障服务稳定性

## Acceptance Criteria

### AC1: 应用日志收集

**Scenario**
```gherkin
GIVEN 微服务应用已部署
WHEN 配置日志收集
THEN
  - 配置统一JSON日志格式
  - 集成阿里云SLS日志服务
  - 配置日志索引和查询
  - 设置日志保留策略（30天）
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 日志必须包含traceId用于链路追踪 |
| BR-1.2 | 敏感信息（手机号、Token）脱敏处理 |
| BR-1.3 | ERROR级别日志自动触发告警 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 日志服务不可用 | LOG_SERVICE_ERROR | 日志服务连接失败 | 本地文件备份，服务恢复后补传 |

---

### AC2: 应用指标采集

**Scenario**
```gherkin
GIVEN 微服务应用已部署
WHEN 配置指标采集
THEN
  - 集成Spring Boot Actuator
  - 暴露Prometheus格式指标端点
  - 配置Grafana仪表盘
  - 创建核心业务指标
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 指标采集间隔15秒 |
| BR-2.2 | 指标保留时间15天 |
| BR-2.3 | 核心指标: http_request_total, task_created_total, ai_api_calls_total, queue_depth |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 指标端点不可用 | METRICS_ERROR | 指标采集失败 | 记录采集失败，不影响主服务 |

---

### AC3: 告警规则配置

**Scenario**
```gherkin
GIVEN 指标采集已运行
WHEN 配置告警规则
THEN
  - 配置错误率告警（5xx > 1%持续5分钟）
  - 配置延迟告警（P99 > 5s持续5分钟）
  - 配置队列积压告警（depth > 100持续10分钟）
  - 配置AI服务失败告警（failures > 10次/5分钟）
  - 配置通知渠道（企业微信/钉钉）
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | Critical告警触发短信+即时通讯 |
| BR-3.2 | Warning告警触发即时通讯 |
| BR-3.3 | 告警去重窗口5分钟 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 通知发送失败 | NOTIFY_ERROR | 告警通知发送失败 | 重试3次，记录到备用日志 |

---

### AC4: 分布式链路追踪 (P1)

**Scenario**
```gherkin
GIVEN 微服务通信已建立
WHEN 配置链路追踪
THEN
  - 集成Spring Cloud Sleuth
  - 配置Zipkin或Jaeger收集器
  - 跨服务传播traceId
  - 设置采样率（生产10%，测试100%）
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-4.1 | 生产环境采样率10% |
| BR-4.2 | Trace数据保留7天 |
| BR-4.3 | 慢请求（>3s）100%采样 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 追踪服务不可用 | TRACE_ERROR | 链路追踪服务不可用 | 降级为本地日志记录traceId |

---

### AC5: 监控仪表盘 (P1)

**Scenario**
```gherkin
GIVEN 指标和日志已收集
WHEN 创建监控仪表盘
THEN
  - 创建服务概览仪表盘（QPS、延迟、错误率）
  - 创建任务处理仪表盘（任务数、成功率、处理时长）
  - 创建AI服务仪表盘（调用量、延迟、成本）
  - 创建基础设施仪表盘（CPU、内存、磁盘）
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-5.1 | 仪表盘刷新间隔1分钟 |
| BR-5.2 | 支持时间范围选择（1h/6h/24h/7d） |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 仪表盘加载失败 | DASHBOARD_ERROR | 仪表盘数据加载失败 | 显示错误提示，提供刷新按钮 |

---

## Tasks / Subtasks

### Infrastructure Tasks (Shared)

- [ ] **T0: 监控基础设施准备** `[ALL ACs]`
  - [ ] 配置阿里云SLS日志服务
  - [ ] 配置Prometheus/Grafana（或阿里云ARMS）

### Feature Implementation Tasks

#### AC1: 应用日志收集

- [ ] **T1: 配置日志格式** `[AC1]`
  - [ ] 添加Logback JSON依赖
  - [ ] 配置统一日志格式
  - [ ] 实现敏感信息脱敏

- [ ] **T2: 配置SLS采集** `[AC1]`
  - [ ] 配置SLS Logtail
  - [ ] 创建日志索引
  - [ ] 配置日志保留策略

#### AC2: 应用指标采集

- [ ] **T3: 配置Actuator** `[AC2]`
  - [ ] 添加Spring Boot Actuator依赖
  - [ ] 配置Prometheus端点
  - [ ] 添加自定义业务指标

#### AC3: 告警规则配置

- [ ] **T4: 配置告警规则** `[AC3]`
  - [ ] 创建错误率告警规则
  - [ ] 创建延迟告警规则
  - [ ] 创建队列积压告警规则
  - [ ] 配置通知渠道

#### AC4: 分布式链路追踪 (P1)

- [ ] **T5: 配置链路追踪** `[AC4]`
  - [ ] 添加Spring Cloud Sleuth依赖
  - [ ] 配置Zipkin/Jaeger
  - [ ] 配置采样率

#### AC5: 监控仪表盘 (P1)

- [ ] **T6: 创建Grafana仪表盘** `[AC5]`
  - [ ] 创建服务概览仪表盘
  - [ ] 创建任务处理仪表盘
  - [ ] 创建AI服务仪表盘
  - [ ] 创建基础设施仪表盘

---

## Dev Notes

### Technical Constraints

- 日志服务: 阿里云SLS
- 指标监控: Spring Boot Actuator + Prometheus + Grafana
- 链路追踪: Spring Cloud Sleuth + Zipkin/Jaeger
- 告警通知: 企业微信/钉钉Webhook
- AC1-AC3为P0核心监控，AC4-AC5为P1可与业务功能并行开发

### Dependencies

- 依赖 Story 1.1 (后端微服务架构)
- 依赖 Story 0.1 (CI/CD流水线)

### Provides APIs

- `GET /actuator/health` - 健康检查端点
- `GET /actuator/prometheus` - Prometheus指标端点

### File Locations

```
backend/
├── common-core/
│   └── src/main/resources/
│       └── logback-spring.xml      # 日志配置
└── */src/main/resources/
    └── application.yml             # Actuator配置

monitoring/
├── grafana/
│   └── dashboards/                 # Grafana仪表盘JSON
├── prometheus/
│   └── alerts/                     # 告警规则
└── sls/
    └── config/                     # SLS配置
```

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created → Draft | Story created from PRD Epic 0 |
