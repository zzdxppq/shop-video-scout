---
id: "5.5"
title: "å†å²ä»»åŠ¡ç®¡ç†"
epic: "5 - é¢„è§ˆå¯¼å‡ºä¸å‘å¸ƒè¾…åŠ©"
status: Done
mode: plan
repository: monolith
priority: P1
estimated_complexity: low
tier: simple
---

# Story 5.5: å†å²ä»»åŠ¡ç®¡ç†

## Story

**As a** ç”¨æˆ·,
**I want** æŸ¥çœ‹å’Œç®¡ç†æˆ‘çš„å†å²ä»»åŠ¡,
**so that** å¯ä»¥å›é¡¾ä¹‹å‰ç”Ÿæˆçš„è§†é¢‘å¹¶æ¸…ç†ä¸éœ€è¦çš„ä»»åŠ¡

### ğŸ”Œ APIs Provided by This Story

- `DELETE /api/v1/tasks/{id}` (task-service - åˆ é™¤ä»»åŠ¡åŠç›¸å…³OSSæ–‡ä»¶)

### ğŸ”Œ APIs Consumed by This Story

- `GET /api/v1/tasks` (from Story 1.4 - è·å–ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µ)
- `GET /api/v1/tasks/{id}` (from Story 1.4 - è·å–ä»»åŠ¡è¯¦æƒ…)

## Epic Context

**Epic**: 5 - é¢„è§ˆå¯¼å‡ºä¸å‘å¸ƒè¾…åŠ©

å®ç°æˆå“è§†é¢‘çš„åœ¨çº¿é¢„è§ˆæ’­æ”¾ã€ä¸‹è½½å¯¼å‡ºåŠŸèƒ½ï¼Œé›†æˆAIç”Ÿæˆçƒ­é—¨è¯é¢˜æ ‡ç­¾å’Œè§†é¢‘æ ‡é¢˜æ¨èï¼Œæå‡å‘å¸ƒæ•ˆç‡ã€‚

**Story Deliverables**:
- å†å²ä»»åŠ¡åˆ—è¡¨é¡µé¢ (TaskHistoryView)
- ä»»åŠ¡å¡ç‰‡ç»„ä»¶ (TaskHistoryCard)
- æ— é™æ»šåŠ¨åŠ è½½ (useInfiniteScroll composable)
- åˆ é™¤ç¡®è®¤å¼¹çª— (DeleteConfirmModal)
- åˆ é™¤ä»»åŠ¡API (TaskController.deleteTask)
- OSSæ–‡ä»¶æ¸…ç†æœåŠ¡ (OssCleanupService)

## Acceptance Criteria

### AC1: å†å²ä»»åŠ¡åˆ—è¡¨

**Scenario**
```gherkin
GIVEN ç”¨æˆ·è®¿é—®å†å²ä»»åŠ¡é¡µé¢
WHEN é¡µé¢åŠ è½½
THEN
  - æ˜¾ç¤ºç”¨æˆ·æ‰€æœ‰ä»»åŠ¡åˆ—è¡¨
  - æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
  - æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€ã€åº—é“ºåã€åˆ›å»ºæ—¶é—´
  - æ”¯æŒåˆ†é¡µåŠ è½½ï¼ˆæ— é™æ»šåŠ¨ï¼‰
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | æ¯é¡µæ˜¾ç¤º10æ¡ä»»åŠ¡ |
| BR-1.2 | æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€å›¾æ ‡ï¼ˆcompleted=ç»¿è‰²å‹¾, composing=è“è‰²è¿›åº¦, failed=çº¢è‰²å‰ï¼‰ |
| BR-1.3 | æ˜¾ç¤ºåº—é“ºç±»å‹æ ‡ç­¾ï¼ˆé¤é¥®/ç¾å®¹/å¨±ä¹/å…¶ä»–ï¼‰ |
| BR-1.4 | æ˜¾ç¤ºåˆ›å»ºæ—¶é—´ï¼Œä½¿ç”¨ç›¸å¯¹æ—¶é—´æ ¼å¼ï¼ˆå¦‚"2å°æ—¶å‰"ã€"3å¤©å‰"ï¼‰ |
| BR-1.5 | ä»»åŠ¡çŠ¶æ€ä¸º completed æ—¶æ˜¾ç¤ºå°é¢ç¼©ç•¥å›¾ |
| BR-1.6 | ç©ºåˆ—è¡¨æ˜¾ç¤ºå¼•å¯¼åˆ›å»ºä»»åŠ¡çš„æç¤º |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| page | number | N | >= 1, default 1 | - |
| size | number | N | 1-50, default 10 | - |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| åŠ è½½å¤±è´¥ | 500 | åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥ï¼Œè¯·é‡è¯• | æ˜¾ç¤ºé‡è¯•æŒ‰é’® |
| ç½‘ç»œé”™è¯¯ | - | ç½‘ç»œè¿æ¥å¤±è´¥ | æ˜¾ç¤ºé‡è¯•æŒ‰é’® |
| æ— ä»»åŠ¡ | - | - | æ˜¾ç¤ºç©ºçŠ¶æ€å¼•å¯¼ |

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| é¡µé¢åŠ è½½ | åŠ è½½ç¬¬ä¸€é¡µä»»åŠ¡ |
| æ»šåŠ¨åˆ°åº•éƒ¨ | è‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µï¼ˆæœ‰æ›´å¤šæ•°æ®æ—¶ï¼‰ |
| ç‚¹å‡»ä»»åŠ¡å¡ç‰‡ | æ ¹æ®çŠ¶æ€è·³è½¬ï¼šcompletedâ†’é¢„è§ˆé¡µï¼Œå…¶ä»–â†’å¯¹åº”çŠ¶æ€é¡µ |
| ä¸‹æ‹‰åˆ·æ–° | é‡æ–°åŠ è½½ç¬¬ä¸€é¡µ |

---

### AC2: åˆ é™¤ä»»åŠ¡

**Scenario**
```gherkin
GIVEN ç”¨æˆ·åœ¨å†å²ä»»åŠ¡åˆ—è¡¨
WHEN ç”¨æˆ·åˆ é™¤ä»»åŠ¡
THEN
  - æ˜¾ç¤ºç¡®è®¤å¼¹çª—ï¼ˆ"åˆ é™¤åæ— æ³•æ¢å¤ï¼Œæ˜¯å¦ç¡®è®¤ï¼Ÿ"ï¼‰
  - ç¡®è®¤ååˆ é™¤ä»»åŠ¡å’Œç›¸å…³OSSæ–‡ä»¶
  - ä»åˆ—è¡¨ä¸­ç§»é™¤è¯¥ä»»åŠ¡
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | åˆ é™¤åæ— æ³•æ¢å¤ï¼ˆç¡¬åˆ é™¤ï¼‰ |
| BR-2.2 | åŒæ—¶åˆ é™¤OSSä¸Šçš„æ‰€æœ‰ç›¸å…³æ–‡ä»¶ï¼ˆè§†é¢‘ã€å¸§ã€éŸ³é¢‘ã€è¾“å‡ºè§†é¢‘ã€ç´ æåŒ…ï¼‰ |
| BR-2.3 | æ•°æ®åº“CASCADEåˆ é™¤å…³è”è¡¨ï¼ˆvideos, scripts, publish_assistsï¼‰ |
| BR-2.4 | åªèƒ½åˆ é™¤è‡ªå·±çš„ä»»åŠ¡ï¼ˆuser_idæ ¡éªŒï¼‰ |
| BR-2.5 | æ­£åœ¨è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼ˆanalyzing/composingï¼‰ä¸èƒ½åˆ é™¤ |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| task_id | Long | Y | must exist | ä»»åŠ¡ä¸å­˜åœ¨ |
| task.user_id | Long | Y | must match current user | æ— æƒé™åˆ é™¤æ­¤ä»»åŠ¡ |
| task.status | string | Y | not in ['analyzing', 'composing'] | ä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­ï¼Œæ— æ³•åˆ é™¤ |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| ä»»åŠ¡ä¸å­˜åœ¨ | 404 | ä»»åŠ¡ä¸å­˜åœ¨ | å…³é—­å¼¹çª—ï¼Œä»åˆ—è¡¨ç§»é™¤ |
| æ— æƒé™ | 403 | æ— æƒé™åˆ é™¤æ­¤ä»»åŠ¡ | æ˜¾ç¤ºé”™è¯¯Toast |
| ä»»åŠ¡è¿›è¡Œä¸­ | 409 | ä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­ï¼Œæ— æ³•åˆ é™¤ | æ˜¾ç¤ºé”™è¯¯Toast |
| åˆ é™¤å¤±è´¥ | 500 | åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯• | æ˜¾ç¤ºé‡è¯•æŒ‰é’® |
| OSSåˆ é™¤éƒ¨åˆ†å¤±è´¥ | - | - | è®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä»»åŠ¡åˆ é™¤ |

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| ç‚¹å‡»åˆ é™¤æŒ‰é’® | æ˜¾ç¤ºç¡®è®¤å¼¹çª— |
| ç¡®è®¤åˆ é™¤ | æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œè°ƒç”¨åˆ é™¤API |
| åˆ é™¤æˆåŠŸ | å…³é—­å¼¹çª—ï¼Œä»åˆ—è¡¨ç§»é™¤ä»»åŠ¡ï¼Œæ˜¾ç¤ºæˆåŠŸToast |
| å–æ¶ˆåˆ é™¤ | å…³é—­å¼¹çª— |

---

## Tasks / Subtasks

### Infrastructure Tasks (T0)

- [x] **T0: åŸºç¡€æ¶æ„ä¸APIæ¨¡å—** `[ALL ACs]`
  - **File Locations**:
    - `frontend/src/api/task.ts` (modify - add pagination params and delete)
    - `frontend/src/types/task.ts` (modify - add pagination types)
    - `frontend/src/composables/useInfiniteScroll.ts` (create)
    - `frontend/src/composables/useTaskHistory.ts` (create)
  - **Subtasks**:
    - [x] T0.1: Extend task.ts API module:
      ```typescript
      export function getTasks(params: { page?: number; size?: number }): Promise<PagedResponse<TaskSummary>>
      export function deleteTask(taskId: number): Promise<void>
      ```
    - [x] T0.2: Create pagination types:
      ```typescript
      export interface PagedResponse<T> {
        items: T[];
        total: number;
        page: number;
        size: number;
        has_more: boolean;
      }

      export interface TaskSummary {
        id: number;
        shop_name: string;
        shop_type: 'food' | 'beauty' | 'entertainment' | 'other';
        status: TaskStatus;
        thumbnail_url?: string;
        created_at: string;
      }
      ```
    - [x] T0.3: Create useInfiniteScroll composable:
      - `loadMore()`: Load next page
      - State: `items`, `loading`, `hasMore`, `error`
      - IntersectionObserver for scroll detection
    - [x] T0.4: Create useTaskHistory composable:
      - Extends useInfiniteScroll with task-specific logic
      - `deleteTask(taskId)`: Delete with optimistic removal
      - `refresh()`: Reload from first page
  - **Complexity**: Low
  - **AC Traceability**: Foundation for AC1, AC2

---

### Feature Implementation Tasks

### AC1: å†å²ä»»åŠ¡åˆ—è¡¨

- [x] **T1: ä»»åŠ¡åˆ—è¡¨é¡µé¢å®ç°** `[AC1]`
  - **File Locations**:
    - `frontend/src/views/TaskHistoryView.vue` (create)
    - `frontend/src/components/task/TaskHistoryCard.vue` (create)
    - `frontend/src/components/common/EmptyState.vue` (create or reuse)
    - `frontend/src/router/index.ts` (modify - add route)
  - **Subtasks**:
    - [x] T1.1: Create TaskHistoryView.vue:
      - Uses useTaskHistory composable
      - Header with page title
      - Scrollable task list
      - Loading indicator at bottom
      - Empty state when no tasks
    - [x] T1.2: Create TaskHistoryCard.vue:
      - Props: `task: TaskSummary`
      - Emits: `click`, `delete`
      - Display: thumbnail (if available), shop_name, shop_type tag, status icon, relative time
      - Delete button (swipe or icon)
    - [x] T1.3: Add route to router/index.ts:
      ```typescript
      { path: '/history', name: 'task-history', component: TaskHistoryView, meta: { requiresAuth: true } }
      ```
    - [x] T1.4: Implement status icon mapping:
      - completed: CheckCircle (green)
      - composing/analyzing: Spinner (blue)
      - failed: XCircle (red)
      - Other: Clock (gray)
    - [x] T1.5: Implement relative time formatting:
      - Use dayjs or date-fns for relative time
      - Format: "åˆšåˆš", "5åˆ†é’Ÿå‰", "2å°æ—¶å‰", "3å¤©å‰", "2026-01-15"
    - [x] T1.6: Create EmptyState component:
      - Props: `icon`, `title`, `description`, `actionText`
      - Emits: `action`
      - Display: illustration, text, CTA button
    - [x] T1.7: Implement navigation based on task status:
      - completed â†’ /task/:id/preview
      - script_ready/script_edited â†’ /task/:id/script
      - composing â†’ /task/:id/compose-progress
      - Other â†’ /task/:id (detail page)
  - **Complexity**: Medium
  - **Error Handling**:
    | Scenario | Handler |
    |----------|---------|
    | Load error | Show error state with retry button |
    | No tasks | Show EmptyState with "åˆ›å»ºä»»åŠ¡" CTA |
    | Thumbnail load error | Show placeholder image |

  **Test Specs** (unit):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Render task list | 5 tasks | 5 TaskHistoryCard components | unit |
  | Show loading | loading=true | loading indicator visible | unit |
  | Show empty state | [] | EmptyState component visible | unit |
  | Status icon mapping | status='completed' | green check icon | unit |
  | Relative time | created_at 2h ago | "2å°æ—¶å‰" | unit |
  | Card click navigation | status='completed' | router.push('/task/:id/preview') | unit |
  | Infinite scroll | scroll to bottom | loadMore() called | unit |

---

### AC2: åˆ é™¤ä»»åŠ¡åŠŸèƒ½

- [x] **T2: åˆ é™¤ç¡®è®¤å¼¹çª—ç»„ä»¶** `[AC2]`
  - **File Locations**:
    - `frontend/src/components/common/DeleteConfirmModal.vue` (create)
    - `frontend/src/components/task/__tests__/TaskHistoryCard.test.ts` (create)
  - **Subtasks**:
    - [x] T2.1: Create DeleteConfirmModal.vue:
      - Props: `visible: boolean`, `title: string`, `message: string`, `loading: boolean`
      - Emits: `confirm`, `cancel`
      - Display: warning icon, message, confirm/cancel buttons
      - Confirm button: red background, shows spinner when loading
    - [x] T2.2: Implement delete button on TaskHistoryCard:
      - Trash icon button at card corner
      - Click opens DeleteConfirmModal
      - Prevent event bubbling (don't navigate)
    - [x] T2.3: Integrate with useTaskHistory:
      - Optimistic removal from list
      - Rollback on error
      - Show success/error Toast
  - **Complexity**: Low
  - **Error Handling**:
    | Scenario | Handler |
    |----------|---------|
    | Delete in progress | Disable button, show spinner |
    | Delete failed | Rollback card to list, show error toast |

  **Test Specs** (unit):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Modal shows | visible=true | modal visible | unit |
  | Confirm click | click confirm | emit('confirm') | unit |
  | Cancel click | click cancel | emit('cancel') | unit |
  | Loading state | loading=true | confirm button disabled, spinner | unit |
  | Delete button click | click trash | modal opens | unit |
  | Optimistic removal | delete called | task removed immediately | unit |
  | Rollback on error | delete fails | task restored to list | unit |

---

- [x] **T3: åç«¯åˆ é™¤APIå®ç°** `[AC2]`
  - **File Locations**:
    - `backend/task-service/src/main/java/com/shopvideoscout/task/controller/TaskController.java` (modify)
    - `backend/task-service/src/main/java/com/shopvideoscout/task/service/TaskService.java` (modify)
    - `backend/task-service/src/main/java/com/shopvideoscout/task/service/OssCleanupService.java` (create)
    - `backend/task-service/src/test/java/com/shopvideoscout/task/service/TaskServiceTest.java` (modify)
  - **Subtasks**:
    - [x] T3.1: Implement TaskController.deleteTask():
      ```java
      @DeleteMapping("/{id}")
      public R<Void> deleteTask(@PathVariable Long id) {
          taskService.deleteTask(id, getCurrentUserId());
          return R.ok();
      }
      ```
    - [x] T3.2: Implement TaskService.deleteTask():
      - Validate task exists
      - Validate user owns task
      - Validate task not in processing status
      - Call OssCleanupService (async)
      - Delete from database (CASCADE handles related tables)
    - [x] T3.3: Create OssCleanupService:
      ```java
      @Async
      public void cleanupTaskFiles(Long taskId, Long userId) {
          // Delete all OSS paths for this task
          ossClient.deleteObjects(Arrays.asList(
              "videos/" + userId + "/" + taskId + "/",
              "frames/" + taskId + "/",
              "audio/" + taskId + "/",
              "output/" + taskId + "/",
              "assets/" + taskId + "/"
          ));
      }
      ```
    - [x] T3.4: Add error handling:
      - TaskNotFoundException â†’ 404
      - AccessDeniedException â†’ 403
      - TaskInProgressException â†’ 409
    - [x] T3.5: Write unit tests for delete logic
  - **Complexity**: Medium
  - **Error Handling**:
    | Scenario | Handler |
    |----------|---------|
    | Task not found | throw TaskNotFoundException |
    | Not owner | throw AccessDeniedException |
    | Task processing | throw TaskInProgressException |
    | OSS delete fails | Log error, continue (best effort) |

  **Test Specs** (unit):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Delete success | valid taskId, owner | 200 OK | unit |
  | Task not found | invalid taskId | 404 | unit |
  | Not owner | other user's task | 403 | unit |
  | Task analyzing | status=analyzing | 409 | unit |
  | Task composing | status=composing | 409 | unit |
  | OSS cleanup called | delete success | cleanupTaskFiles invoked | unit |

---

### Integration Tasks

- [x] **T4: å¯¼èˆªé›†æˆ** `[ALL ACs]`
  - **File Locations**:
    - `frontend/src/components/common/BottomNav.vue` (modify or create)
    - `frontend/src/views/HomeView.vue` (modify if exists)
  - **Subtasks**:
    - [x] T4.1: Add "å†å²ä»»åŠ¡" entry to bottom navigation or sidebar
    - [x] T4.2: Add navigation from home page to history
    - [x] T4.3: Ensure back navigation works correctly
  - **Complexity**: Low

- [x] **T5: Final Verification** `[ALL ACs]`
  - **File Locations**:
    - All test files
  - **Subtasks**:
    - [x] T5.1: Run all unit tests
    - [x] T5.2: Verify no lint errors
    - [x] T5.3: Test complete flow in dev server
    - [x] T5.4: Update status â†’ Review
  - **Complexity**: Low

### AC Coverage Matrix

| Task | AC1 | AC2 |
|------|:---:|:---:|
| T0: åŸºç¡€æ¶æ„ä¸APIæ¨¡å— | âœ“ | âœ“ |
| T1: ä»»åŠ¡åˆ—è¡¨é¡µé¢ | âœ“ |   |
| T2: åˆ é™¤ç¡®è®¤å¼¹çª— |   | âœ“ |
| T3: åç«¯åˆ é™¤API |   | âœ“ |
| T4: å¯¼èˆªé›†æˆ | âœ“ | âœ“ |
| T5: Final Verification | âœ“ | âœ“ |

## Dev Notes

### Technical Constraints

- **Vue 3 Composition API**: All components use `<script setup lang="ts">`
- **IntersectionObserver**: Use for infinite scroll detection
- **dayjs**: Use for relative time formatting (already in project or install)
- **Async OSS Cleanup**: Run cleanup in background, don't block API response
- **CASCADE Delete**: Database handles related table cleanup via foreign keys

### Component Hierarchy

```
TaskHistoryView.vue
â”œâ”€â”€ Header ("å†å²ä»»åŠ¡")
â”œâ”€â”€ Loading Skeleton (on initial load)
â”œâ”€â”€ Task List
â”‚   â””â”€â”€ TaskHistoryCard.vue (multiple)
â”‚       â”œâ”€â”€ Thumbnail / Placeholder
â”‚       â”œâ”€â”€ Shop name
â”‚       â”œâ”€â”€ Shop type tag
â”‚       â”œâ”€â”€ Status icon
â”‚       â”œâ”€â”€ Relative time
â”‚       â””â”€â”€ Delete button â†’ DeleteConfirmModal
â”œâ”€â”€ Loading More indicator (infinite scroll)
â”œâ”€â”€ EmptyState (when no tasks)
â””â”€â”€ DeleteConfirmModal.vue (shared modal)
```

### Accumulated Context from Previous Stories

| Resource Type | Name | Source Story | Action | Key Info |
|--------------|------|--------------|--------|----------|
| API Endpoint | GET /api/v1/tasks | 1.4 | CONSUME | Returns paginated task list |
| API Endpoint | GET /api/v1/tasks/{id} | 1.4 | CONSUME | Returns task details |
| Table | tasks | 1.1 | READ/DELETE | User tasks with CASCADE |
| Table | videos | 2.1 | CASCADE DELETE | Task videos |
| Table | scripts | 3.1 | CASCADE DELETE | Task scripts |
| Table | publish_assists | 5.3 | CASCADE DELETE | Publish assist data |
| OSS Structure | videos/{user_id}/{task_id}/ | 2.1 | DELETE | Video files |
| OSS Structure | frames/{task_id}/ | 2.3 | DELETE | Extracted frames |
| OSS Structure | audio/{task_id}/ | 4.1 | DELETE | TTS audio files |
| OSS Structure | output/{task_id}/ | 4.3 | DELETE | Final video |
| OSS Structure | assets/{task_id}/ | 5.2 | DELETE | Assets pack |
| Router Pattern | /task/:id/* | 5.1 | FOLLOW | Task detail routes |
| Component | Toast | 5.4 | REUSE | Notification feedback |

### API Request/Response Specifications

**GET /api/v1/tasks** (from Story 1.4, extended with pagination)
```json
// Request
GET /api/v1/tasks?page=1&size=10

// Response 200
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 12345,
        "shop_name": "æµ·åº•æç«é”…(æœ›äº¬åº—)",
        "shop_type": "food",
        "status": "completed",
        "thumbnail_url": "https://oss.example.com/output/12345/thumb.jpg",
        "created_at": "2026-02-05T10:00:00Z"
      },
      {
        "id": 12344,
        "shop_name": "æ˜Ÿå·´å…‹è‡»é€‰(ä¸‰é‡Œå±¯åº—)",
        "shop_type": "food",
        "status": "composing",
        "thumbnail_url": null,
        "created_at": "2026-02-04T15:30:00Z"
      }
    ],
    "total": 25,
    "page": 1,
    "size": 10,
    "has_more": true
  }
}
```

**DELETE /api/v1/tasks/{id}** (new endpoint)
```json
// Request
DELETE /api/v1/tasks/12345

// Response 200
{
  "code": 0,
  "message": "success"
}

// Response 404 (not found)
{
  "code": 40401,
  "message": "ä»»åŠ¡ä¸å­˜åœ¨"
}

// Response 403 (forbidden)
{
  "code": 40301,
  "message": "æ— æƒé™åˆ é™¤æ­¤ä»»åŠ¡"
}

// Response 409 (conflict - task in progress)
{
  "code": 40901,
  "message": "ä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­ï¼Œæ— æ³•åˆ é™¤"
}
```

### Type Definitions

```typescript
// frontend/src/types/task.ts (extended)

export type TaskStatus =
  | 'created'
  | 'uploading'
  | 'analyzing'
  | 'script_ready'
  | 'script_edited'
  | 'voice_set'
  | 'composing'
  | 'completed'
  | 'failed';

export interface TaskSummary {
  id: number;
  shop_name: string;
  shop_type: 'food' | 'beauty' | 'entertainment' | 'other';
  status: TaskStatus;
  thumbnail_url?: string;
  created_at: string;
}

export interface PagedResponse<T> {
  items: T[];
  total: number;
  page: number;
  size: number;
  has_more: boolean;
}
```

### File Locations Summary

| File | Action | Purpose |
|------|--------|---------|
| `frontend/src/views/TaskHistoryView.vue` | CREATE | History list page |
| `frontend/src/components/task/TaskHistoryCard.vue` | CREATE | Task summary card |
| `frontend/src/components/common/DeleteConfirmModal.vue` | CREATE | Confirmation dialog |
| `frontend/src/components/common/EmptyState.vue` | CREATE | Empty list state |
| `frontend/src/composables/useInfiniteScroll.ts` | CREATE | Infinite scroll logic |
| `frontend/src/composables/useTaskHistory.ts` | CREATE | History page state |
| `frontend/src/api/task.ts` | MODIFY | Add pagination + delete |
| `frontend/src/types/task.ts` | MODIFY | Add new types |
| `frontend/src/router/index.ts` | MODIFY | Add history route |
| `backend/task-service/.../controller/TaskController.java` | MODIFY | Add deleteTask |
| `backend/task-service/.../service/TaskService.java` | MODIFY | Add delete logic |
| `backend/task-service/.../service/OssCleanupService.java` | CREATE | OSS file cleanup |

### Deliverable Bindings

> **SM**: Binding for each new code unit. Dev Gate will verify these.
> **Dev**: Ensure all bindings are implemented before self-review.

```yaml
deliverable_bindings:
  # Frontend composables
  - deliverable: "frontend/src/composables/useInfiniteScroll.ts"
    consumer: "frontend/src/composables/useTaskHistory.ts"
    binding_type: import
    verify: "useInfiniteScroll"

  - deliverable: "frontend/src/composables/useTaskHistory.ts"
    consumer: "frontend/src/views/TaskHistoryView.vue"
    binding_type: import
    verify: "useTaskHistory"

  # Frontend components
  - deliverable: "frontend/src/components/task/TaskHistoryCard.vue"
    consumer: "frontend/src/views/TaskHistoryView.vue"
    binding_type: vue_component
    verify: "<TaskHistoryCard"

  - deliverable: "frontend/src/components/common/DeleteConfirmModal.vue"
    consumer: "frontend/src/views/TaskHistoryView.vue"
    binding_type: vue_component
    verify: "<DeleteConfirmModal"

  - deliverable: "frontend/src/components/common/EmptyState.vue"
    consumer: "frontend/src/views/TaskHistoryView.vue"
    binding_type: vue_component
    verify: "<EmptyState"

  # Router
  - deliverable: "frontend/src/views/TaskHistoryView.vue"
    consumer: "frontend/src/router/index.ts"
    binding_type: route_mount
    verify: "path: '/history'"

  # Backend services
  - deliverable: "backend/task-service/.../service/OssCleanupService.java"
    consumer: "backend/task-service/.../service/TaskService.java"
    binding_type: di_inject
    verify: "OssCleanupService"

  - deliverable: "backend/task-service/.../service/TaskService.java"
    consumer: "backend/task-service/.../controller/TaskController.java"
    binding_type: di_inject
    verify: "deleteTask"
```

**Binding Status**: âœ… Verified by Dev

### Testing Requirements

- **å•å…ƒæµ‹è¯•é‡ç‚¹** (Frontend - Vitest):
  - TaskHistoryView: render list, empty state, error state
  - TaskHistoryCard: render, delete button, navigation
  - DeleteConfirmModal: show/hide, confirm/cancel events
  - useInfiniteScroll: loadMore, hasMore logic
  - useTaskHistory: fetch, delete, optimistic update

- **å•å…ƒæµ‹è¯•é‡ç‚¹** (Backend - JUnit):
  - TaskService.deleteTask: ownership check, status check
  - OssCleanupService: correct paths deleted
  - TaskController: request/response handling

- **é›†æˆæµ‹è¯•**:
  - Complete delete flow with database
  - Pagination with mock data

- **è¾¹ç•Œæµ‹è¯•**:
  - Delete non-existent task
  - Delete other user's task
  - Delete task in progress
  - OSS cleanup failure handling

---

## AC Traceability Matrix

> **Dev**: Fill this section BEFORE self-review. Every AC needs evidence.
> **QA**: Verify each entry during AC Coverage Verification.

### AC1: å†å²ä»»åŠ¡åˆ—è¡¨

```yaml
ac_id: AC1
code_locations:
  - "frontend/src/views/TaskHistoryView.vue"
  - "frontend/src/components/task/TaskHistoryCard.vue"
  - "frontend/src/composables/useTaskHistory.ts"
  - "frontend/src/composables/useInfiniteScroll.ts"
test_locations:
  - "frontend/src/views/__tests__/TaskHistoryView.test.ts"
  - "frontend/src/components/task/__tests__/TaskHistoryCard.test.ts"
verification_type: unit_test
aspects_covered:
  main_scenario: true
  business_rules: true
  data_validation: true
  error_handling: true
notes: "Paginated list, status icons, relative time, infinite scroll, empty state"
```

### AC2: åˆ é™¤ä»»åŠ¡

```yaml
ac_id: AC2
code_locations:
  - "frontend/src/components/common/DeleteConfirmModal.vue"
  - "backend/task-service/.../controller/TaskController.java"
  - "backend/task-service/.../service/TaskService.java"
  - "backend/task-service/.../service/OssCleanupService.java"
test_locations:
  - "frontend/src/components/common/__tests__/DeleteConfirmModal.test.ts"
  - "backend/task-service/src/test/.../TaskServiceTest.java"
verification_type: unit_test
aspects_covered:
  main_scenario: true
  business_rules: true
  data_validation: true
  error_handling: true
notes: "Confirm modal, ownership validation, status validation, OSS cleanup, CASCADE delete"
```

---

### Traceability Summary

| AC | Code Location | Test Location | Type | Status |
|----|---------------|---------------|------|--------|
| AC1 | TaskHistoryView.vue, TaskHistoryCard.vue, useTaskHistory.ts | TaskHistoryCard.test.ts, useTaskHistory.spec.ts | unit | âœ… |
| AC2 | DeleteConfirmModal.vue, TaskController.java, TaskService.java, OssCleanupService.java | DeleteConfirmModal.test.ts, TaskServiceDeleteTest.java | unit | âœ… |

**Legend**: âœ… Verified | â³ Pending | âŒ Missing

---

## Architect Review Results

### Review Date: 2026-02-06
### Reviewed By: Aiden (Architect Agent)
### Architecture Score: 10.0/10
### Review Round: 1

### Decision: Approved

### Summary

Story fully aligns with architecture:

| Validation | Reference | Status |
|------------|-----------|--------|
| CASCADE DELETE | Â§5.1 Foreign Keys | âœ… videos, scripts, publish_assists |
| OSS Storage | Â§5.3 OSS Structure | âœ… All paths correct |
| Frontend structure | Â§12.1 | âœ… views/, components/, composables/ |
| Backend structure | task-service | âœ… controller/, service/ |
| API design | Â§6 | âœ… RESTful, pagination |
| Security | ownership validation | âœ… user_id check |

### Issues

None - Story is well-structured and architecturally compliant.

### Recommendations

- Story ready for development (Simple tier - no QA test design required)
- Note: Ensure task status 'completed' aligns with existing code conventions

---

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Simple |
| complexity_indicators | 2 |
| security_sensitive | false |
| calculated_by | Architect (review) |
| calculation_date | 2026-02-06 |

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created â†’ Draft | Story created from PRD Epic 5 |
| 2026-02-06 | SM | Draft â†’ AwaitingArchReview | Full elaboration: TaskHistoryView, TaskHistoryCard, DeleteConfirmModal, useInfiniteScroll, useTaskHistory composables, DELETE API with OSS cleanup, pagination support, status-based navigation. |
| 2026-02-06 16:30 | Architect | AwaitingArchReview â†’ Approved | Score: 10.0/10, No issues. Simple tier - ready for Dev implementation |
| 2026-02-06 | Dev | Approved â†’ Review | Implementation complete: TaskHistoryView, TaskHistoryCard, DeleteConfirmModal, EmptyState, useInfiniteScroll, useTaskHistory; backend DELETE API with OssCleanupService; pagination support; 53 unit tests. See dev log 5.5-dev-log.md |
