---
id: "5.1"
title: "è§†é¢‘é¢„è§ˆæ’­æ”¾å™¨"
epic: "5 - é¢„è§ˆå¯¼å‡ºä¸å‘å¸ƒè¾…åŠ©"
status: Done
mode: plan
repository: monolith
priority: P0
estimated_complexity: medium
tier: standard
---

# Story 5.1: è§†é¢‘é¢„è§ˆæ’­æ”¾å™¨

## Story

**As a** ç”¨æˆ·,
**I want** åœ¨çº¿é¢„è§ˆåˆæˆå®Œæˆçš„è§†é¢‘,
**so that** å¯ä»¥æ£€æŸ¥è§†é¢‘æ•ˆæœå†å†³å®šæ˜¯å¦ä¸‹è½½æˆ–é‡æ–°ç”Ÿæˆ

### ğŸ”Œ APIs Consumed by This Story

- `GET /api/v1/tasks/{id}/output` (from Story 4.3)
- `GET /api/v1/tasks/{id}` (from Story 1.4 - to get task details and video list)

## Epic Context

**Epic**: 5 - é¢„è§ˆå¯¼å‡ºä¸å‘å¸ƒè¾…åŠ©

å®ç°æˆå“è§†é¢‘çš„åœ¨çº¿é¢„è§ˆæ’­æ”¾ã€ä¸‹è½½å¯¼å‡ºåŠŸèƒ½ï¼Œé›†æˆAIç”Ÿæˆçƒ­é—¨è¯é¢˜æ ‡ç­¾å’Œè§†é¢‘æ ‡é¢˜æ¨èï¼Œæå‡å‘å¸ƒæ•ˆç‡ã€‚

**Story Deliverables**:
- è§†é¢‘é¢„è§ˆé¡µé¢ (VideoPreviewView)
- è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶ (VideoPlayer)
- é•œå¤´åˆ—è¡¨å±•ç¤ºç»„ä»¶ (ShotList)
- æ’­æ”¾æ§åˆ¶é€»è¾‘ (useVideoPlayer composable)

## Acceptance Criteria

### AC1: è§†é¢‘é¢„è§ˆæ’­æ”¾

**Scenario**
```gherkin
GIVEN è§†é¢‘åˆæˆå®Œæˆ
WHEN ç”¨æˆ·è¿›å…¥ç»“æœé¡µé¢
THEN
  - æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨ç»„ä»¶
  - æ”¯æŒæ’­æ”¾/æš‚åœæ§åˆ¶
  - æ˜¾ç¤ºæ’­æ”¾è¿›åº¦æ¡
  - æ˜¾ç¤ºè§†é¢‘æ—¶é•¿
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | è§†é¢‘è‡ªåŠ¨åŠ è½½ä½†ä¸è‡ªåŠ¨æ’­æ”¾ï¼ˆautoplay=false, preload="metadata"ï¼‰ |
| BR-1.2 | æ”¯æŒå…¨å±æ’­æ”¾ï¼ˆFullscreen APIï¼‰ |
| BR-1.3 | æ˜¾ç¤ºåŠ è½½è¿›åº¦ï¼ˆbuffered progress barï¼‰ |
| BR-1.4 | æ˜¾ç¤ºå½“å‰æ—¶é—´ / æ€»æ—¶é•¿æ ¼å¼ï¼š00:00 / 00:00 |
| BR-1.5 | ç«–å±è§†é¢‘ï¼ˆ9:16ï¼‰å±…ä¸­æ˜¾ç¤ºï¼Œä¿æŒæ¯”ä¾‹ |
| BR-1.6 | æ’­æ”¾å™¨å®½åº¦è‡ªé€‚åº”å®¹å™¨ï¼Œæœ€å¤§å®½åº¦400pxï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰ |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| task.status | string | Y | must be 'done' | è§†é¢‘å°šæœªå®Œæˆåˆæˆ |
| task.output_oss_key | string | Y | not empty | è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| è§†é¢‘åŠ è½½å¤±è´¥ | LOAD_ERROR | è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯• | æ˜¾ç¤ºé‡æ–°åŠ è½½æŒ‰é’® |
| è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ | 404 | è§†é¢‘æ–‡ä»¶å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨ | æç¤ºé‡æ–°ç”Ÿæˆ |
| ä»»åŠ¡çŠ¶æ€édone | - | è§†é¢‘æ­£åœ¨ç”Ÿæˆä¸­ | è·³è½¬å›è¿›åº¦é¡µ |
| ç½‘ç»œä¸­æ–­ | NETWORK_ERROR | ç½‘ç»œè¿æ¥å¤±è´¥ | æ˜¾ç¤ºé‡è¯•æŒ‰é’® |

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| é¡µé¢åŠ è½½ | é¢„åŠ è½½è§†é¢‘å…ƒæ•°æ®ï¼Œæ˜¾ç¤ºç¬¬ä¸€å¸§ä½œä¸ºå°é¢ |
| ç‚¹å‡»æ’­æ”¾æŒ‰é’® | å¼€å§‹æ’­æ”¾ï¼ŒæŒ‰é’®å˜ä¸ºæš‚åœå›¾æ ‡ |
| ç‚¹å‡»æš‚åœæŒ‰é’® | æš‚åœæ’­æ”¾ï¼ŒæŒ‰é’®å˜ä¸ºæ’­æ”¾å›¾æ ‡ |
| ç‚¹å‡»è¿›åº¦æ¡ | è·³è½¬åˆ°å¯¹åº”æ—¶é—´ç‚¹ |
| æ‹–æ‹½è¿›åº¦æ¡ | å®æ—¶é¢„è§ˆï¼Œæ¾å¼€åè·³è½¬ |
| åŒå‡»è§†é¢‘åŒºåŸŸ | åˆ‡æ¢å…¨å±çŠ¶æ€ |
| ç‚¹å‡»å…¨å±æŒ‰é’® | è¿›å…¥/é€€å‡ºå…¨å±æ¨¡å¼ |
| è§†é¢‘æ’­æ”¾ç»“æŸ | æ˜¾ç¤ºé‡æ’­æŒ‰é’®ï¼Œè¿›åº¦æ¡å½’é›¶ |

---

### AC2: ä½¿ç”¨é•œå¤´å±•ç¤º

**Scenario**
```gherkin
GIVEN è§†é¢‘é¢„è§ˆé¡µé¢
WHEN ç”¨æˆ·æŸ¥çœ‹é•œå¤´è¯¦æƒ…
THEN
  - æ˜¾ç¤ºä½¿ç”¨çš„é•œå¤´ç¼©ç•¥å›¾åˆ—è¡¨
  - æ˜¾ç¤ºæ¯ä¸ªé•œå¤´çš„åˆ†ç±»å’Œæ—¶é•¿
  - æ”¯æŒå±•å¼€/æ”¶èµ·
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | é»˜è®¤æ”¶èµ·çŠ¶æ€ï¼ˆèŠ‚çœé¡µé¢ç©ºé—´ï¼‰ |
| BR-2.2 | æ˜¾ç¤ºé•œå¤´ä½¿ç”¨é¡ºåºï¼ˆ1, 2, 3...ï¼‰ |
| BR-2.3 | é•œå¤´ç¼©ç•¥å›¾æ˜¾ç¤ºï¼šåºå·ã€ç¼©ç•¥å›¾ã€åˆ†ç±»æ ‡ç­¾ã€æ—¶é•¿ |
| BR-2.4 | å±•å¼€æ—¶æ˜¾ç¤ºä¸ºæ¨ªå‘å¯æ»šåŠ¨åˆ—è¡¨ |
| BR-2.5 | æ¨èé•œå¤´æ˜¾ç¤ºæ˜Ÿæ ‡å›¾æ ‡ |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| videos | array | Y | length > 0 | æ— é•œå¤´æ•°æ® |
| video.thumbnail_url | string | Y | valid URL | ç¼©ç•¥å›¾åŠ è½½å¤±è´¥ |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| é•œå¤´æ•°æ®åŠ è½½å¤±è´¥ | 500 | é•œå¤´ä¿¡æ¯åŠ è½½å¤±è´¥ | æ˜¾ç¤ºé‡è¯•æŒ‰é’® |
| ç¼©ç•¥å›¾åŠ è½½å¤±è´¥ | - | - | æ˜¾ç¤ºå ä½å›¾ |

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| ç‚¹å‡»"æŸ¥çœ‹ä½¿ç”¨é•œå¤´"å±•å¼€æŒ‰é’® | å±•å¼€æ˜¾ç¤ºé•œå¤´ç½‘æ ¼ï¼Œå›¾æ ‡æ—‹è½¬ |
| å†æ¬¡ç‚¹å‡» | æ”¶èµ·é•œå¤´åˆ—è¡¨ |
| æ‚¬åœé•œå¤´å¡ç‰‡ | æ˜¾ç¤ºé•œå¤´è¯¦ç»†ä¿¡æ¯tooltipï¼ˆåˆ†ç±»ã€è¯„åˆ†ã€æ—¶é•¿ï¼‰ |
| ç‚¹å‡»é•œå¤´å¡ç‰‡ | å¯é€‰ï¼šè·³è½¬åˆ°è§†é¢‘å¯¹åº”æ—¶é—´ç‚¹ |

---

## Tasks / Subtasks

### Infrastructure Tasks (T0)

- [ ] **T0: é¡µé¢åŸºç¡€æ¶æ„æ­å»º** `[ALL ACs]`
  - **File Locations**:
    - `frontend/src/views/VideoPreviewView.vue` (create)
    - `frontend/src/stores/preview.ts` (create)
    - `frontend/src/router/index.ts` (modify - add route)
    - `frontend/src/api/output.ts` (create)
    - `frontend/src/types/output.ts` (create)
  - **Subtasks**:
    - [ ] T0.1: Create VideoPreviewView.vue skeleton with script setup + TypeScript
    - [ ] T0.2: Create preview store with Pinia (state: task, outputUrl, videos, loading, error)
    - [ ] T0.3: Add route to router/index.ts:
      ```typescript
      { path: '/task/:id/preview', name: 'task-preview', component: VideoPreviewView, meta: { requiresAuth: true } }
      ```
    - [ ] T0.4: Create output.ts API module with `getTaskOutput(taskId): Promise<TaskOutput>`
    - [ ] T0.5: Create output.ts type definitions (TaskOutput, VideoShot interfaces)
    - [ ] T0.6: Add navigation from ComposeProgressView â†’ VideoPreviewView (on compose done)
  - **Complexity**: Low
  - **AC Traceability**: Foundation for AC1, AC2

---

### Feature Implementation Tasks

### AC1: è§†é¢‘é¢„è§ˆæ’­æ”¾

- [ ] **T1: è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶å®ç°** `[AC1]`
  - **File Locations**:
    - `frontend/src/components/preview/VideoPlayer.vue` (create)
    - `frontend/src/components/preview/VideoControls.vue` (create)
    - `frontend/src/components/preview/ProgressBar.vue` (create)
    - `frontend/src/composables/useVideoPlayer.ts` (create)
  - **Subtasks**:
    - [ ] T1.1: Create useVideoPlayer composable:
      - State: `isPlaying`, `currentTime`, `duration`, `buffered`, `isFullscreen`, `isLoading`, `error`
      - Actions: `play()`, `pause()`, `seek(time)`, `toggleFullscreen()`, `setVolume(level)`
      - Events: handle video element events (play, pause, timeupdate, loadedmetadata, error, waiting, canplay)
    - [ ] T1.2: Create ProgressBar.vue component:
      - Props: `currentTime`, `duration`, `buffered`
      - Emits: `seek`
      - Display: played progress (blue), buffered progress (gray), track (light gray)
      - Drag to seek functionality
    - [ ] T1.3: Create VideoControls.vue component:
      - Props: `isPlaying`, `currentTime`, `duration`, `isFullscreen`
      - Emits: `play`, `pause`, `seek`, `fullscreen`
      - Display: play/pause button, time display, fullscreen button
    - [ ] T1.4: Create VideoPlayer.vue component:
      - Props: `src: string`, `poster?: string`
      - Compose: video element + VideoControls + ProgressBar
      - Handle loading state with spinner overlay
      - Handle error state with retry button
      - Double-click for fullscreen
    - [ ] T1.5: Style for 9:16 vertical video (max-width: 400px, aspect-ratio: 9/16)
    - [ ] T1.6: Implement loading and error states with user feedback
  - **Complexity**: Medium
  - **Error Handling**:
    | Scenario | Handler |
    |----------|---------|
    | Video load error | Show error overlay with retry button |
    | Network stall | Show buffering spinner |
    | Fullscreen not supported | Hide fullscreen button |

  **Test Specs** (unit):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | VideoPlayer renders video element | src prop | video element with src | unit |
  | Play button triggers play | click play | video.play() called, isPlaying=true | unit |
  | Pause button triggers pause | click pause | video.pause() called, isPlaying=false | unit |
  | Progress bar shows time | currentTime=30, duration=60 | shows 50% progress | unit |
  | Seek on progress click | click at 50% | seek(30) emitted | unit |
  | Time display format | currentTime=65 | displays "01:05" | unit |
  | useVideoPlayer handles error | video error event | error state set, isLoading=false | unit |
  | Fullscreen toggle | click fullscreen | requestFullscreen called | unit |
  | Double-click fullscreen | dblclick video | toggleFullscreen called | unit |

---

### AC2: ä½¿ç”¨é•œå¤´å±•ç¤º

- [ ] **T2: é•œå¤´åˆ—è¡¨ç»„ä»¶å®ç°** `[AC2]`
  - **File Locations**:
    - `frontend/src/components/preview/ShotList.vue` (create)
    - `frontend/src/components/preview/ShotCard.vue` (create)
    - `frontend/src/components/preview/CollapsibleSection.vue` (create)
  - **Subtasks**:
    - [ ] T2.1: Create ShotCard.vue component:
      - Props: `shot: VideoShot`, `index: number`
      - Display: sequence number badge, thumbnail, category tag, duration, recommended star
      - Hover: show tooltip with detailed info
      - Lazy load thumbnail images
    - [ ] T2.2: Create CollapsibleSection.vue component:
      - Props: `title: string`, `defaultOpen: boolean`
      - Emits: `toggle`
      - Slots: default (content)
      - Display: header with chevron icon, collapsible content area
      - Animation: smooth height transition
    - [ ] T2.3: Create ShotList.vue component:
      - Props: `shots: VideoShot[]`
      - Compose: CollapsibleSection + horizontal scroll container + ShotCards
      - Display: "æŸ¥çœ‹ä½¿ç”¨é•œå¤´ ({count})" header
      - Default collapsed state
    - [ ] T2.4: Implement horizontal scroll with snap points
    - [ ] T2.5: Handle thumbnail load errors with placeholder
  - **Complexity**: Medium
  - **Error Handling**:
    | Scenario | Handler |
    |----------|---------|
    | Empty shots array | Show "æš‚æ— é•œå¤´æ•°æ®" message |
    | Thumbnail 404 | Show placeholder image |

  **Test Specs** (unit):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | ShotCard renders thumbnail | shot object | img with thumbnail_url | unit |
  | ShotCard shows index | index=1 | displays "1" badge | unit |
  | ShotCard shows category | category="ç¾é£Ÿ" | displays category tag | unit |
  | ShotCard shows recommended | is_recommended=true | shows star icon | unit |
  | CollapsibleSection toggles | click header | content visibility toggles | unit |
  | CollapsibleSection default closed | defaultOpen=false | content hidden | unit |
  | ShotList renders all cards | 5 shots | renders 5 ShotCard components | unit |
  | ShotList shows count | 5 shots | header shows "(5)" | unit |

---

### Integration & Verification Tasks

- [ ] **T3: é¡µé¢é›†æˆä¸å¯¼èˆª** `[AC1, AC2]`
  - **File Locations**:
    - `frontend/src/views/VideoPreviewView.vue` (finalize)
    - `frontend/src/views/ComposeProgressView.vue` (modify - from Story 4.4)
  - **Subtasks**:
    - [ ] T3.1: Integrate VideoPlayer into VideoPreviewView
    - [ ] T3.2: Integrate ShotList below VideoPlayer
    - [ ] T3.3: Load task output data on mount (call getTaskOutput API)
    - [ ] T3.4: Handle task status check (redirect if not done)
    - [ ] T3.5: Add navigation buttons: "ä¸‹è½½è§†é¢‘"(â†’5.2), "é‡æ–°ç”Ÿæˆ"(â†’4.4)
    - [ ] T3.6: Update ComposeProgressView to navigate to preview on completion
  - **Complexity**: Low

- [ ] **T4: ç«¯åˆ°ç«¯æµ‹è¯•** `[AC1, AC2]`
  - **File Locations**:
    - `frontend/src/views/__tests__/VideoPreviewView.test.ts` (create)
    - `frontend/src/components/preview/__tests__/VideoPlayer.test.ts` (create)
  - **Subtasks**:
    - [ ] T4.1: Write VideoPlayer unit tests
    - [ ] T4.2: Write VideoPreviewView integration tests (MSW mocked APIs)
    - [ ] T4.3: Test navigation flow: compose complete â†’ preview page
  - **Complexity**: Medium

  **E2E Test Scenarios** (Playwright):
  | Scenario | Steps | Expected |
  |----------|-------|----------|
  | Happy path: preview video | Navigate to preview â†’ Click play â†’ Click pause | Video plays and pauses |
  | Fullscreen toggle | Double-click video | Enters fullscreen mode |
  | Shot list expand | Click "æŸ¥çœ‹ä½¿ç”¨é•œå¤´" | Shot cards appear |
  | Error recovery | Simulate video error â†’ Click retry | Video reloads |

---

## Dev Notes

### Technical Constraints

- **Vue 3 Composition API**: All components use `<script setup lang="ts">`
- **Video Element**: Use native HTML5 video element (no third-party player library)
- **Fullscreen API**: Use native Fullscreen API with vendor prefixes fallback
- **Aspect Ratio**: CSS aspect-ratio for 9:16 video container
- **Lazy Loading**: Use IntersectionObserver for thumbnail lazy loading

### Component Hierarchy

```
VideoPreviewView.vue
â”œâ”€â”€ VideoPlayer.vue
â”‚   â”œâ”€â”€ <video> element
â”‚   â”œâ”€â”€ Loading overlay (spinner)
â”‚   â”œâ”€â”€ Error overlay (retry button)
â”‚   â”œâ”€â”€ VideoControls.vue
â”‚   â”‚   â”œâ”€â”€ Play/Pause button
â”‚   â”‚   â”œâ”€â”€ Time display (current / duration)
â”‚   â”‚   â””â”€â”€ Fullscreen button
â”‚   â””â”€â”€ ProgressBar.vue
â”‚       â”œâ”€â”€ Buffered track
â”‚       â”œâ”€â”€ Played track
â”‚       â””â”€â”€ Seek handle
â”œâ”€â”€ ShotList.vue
â”‚   â””â”€â”€ CollapsibleSection.vue
â”‚       â””â”€â”€ Horizontal scroll container
â”‚           â””â”€â”€ ShotCard.vue (multiple)
â””â”€â”€ Action buttons (Download, Regenerate)
```

### Accumulated Context from Previous Stories

| Resource Type | Name | Source Story | Action | Key Info |
|--------------|------|--------------|--------|----------|
| API Endpoint | GET /api/v1/tasks/{id}/output | 4.3 | CONSUME | Returns { output_url, duration_seconds, file_size } |
| API Endpoint | GET /api/v1/tasks/{id} | 1.4 | CONSUME | Returns task with videos array |
| DB Field | tasks.output_oss_key | 4.3 | REUSE | VARCHAR(500), OSS path to final video |
| DB Field | tasks.output_duration_seconds | 4.3 | REUSE | INT, video duration |
| DB Field | tasks.output_file_size | 4.3 | REUSE | BIGINT, file size in bytes |
| DB Field | videos.thumbnail_url | 2.1 | REUSE | Video thumbnail OSS URL |
| DB Field | videos.is_recommended | 2.3 | REUSE | BOOLEAN, AI recommended shot |
| View | ComposeProgressView | 4.4 | EXTEND | Navigate to preview on done |
| Router Pattern | Dynamic routes | 1.3 | EXTEND | /task/:id/preview pattern |

### API Request/Response Specifications

**GET /api/v1/tasks/{id}/output**
```json
// Response 200
{
  "output_url": "https://oss.example.com/output/12345/final.mp4?signature=...",
  "duration_seconds": 62,
  "file_size_bytes": 47841280,
  "created_at": "2026-01-29T12:00:00Z"
}

// Response 404
{
  "error": "OUTPUT_NOT_READY",
  "message": "è§†é¢‘å°šæœªç”Ÿæˆå®Œæˆ"
}
```

**GET /api/v1/tasks/{id}** (relevant fields)
```json
{
  "id": 12345,
  "status": "done",
  "shop_name": "æµ·åº•ææœ›äº¬åº—",
  "output_oss_key": "output/12345/final.mp4",
  "output_duration_seconds": 62,
  "videos": [
    {
      "id": 101,
      "thumbnail_url": "https://oss.example.com/thumbnails/101.jpg",
      "category": "ç¯å¢ƒ",
      "duration_seconds": 15,
      "is_recommended": true,
      "sequence_in_output": 1
    },
    {
      "id": 102,
      "thumbnail_url": "https://oss.example.com/thumbnails/102.jpg",
      "category": "ç¾é£Ÿ",
      "duration_seconds": 12,
      "is_recommended": true,
      "sequence_in_output": 2
    }
  ]
}
```

### Type Definitions

```typescript
// frontend/src/types/output.ts
export interface TaskOutput {
  output_url: string;
  duration_seconds: number;
  file_size_bytes: number;
  created_at: string;
}

export interface VideoShot {
  id: number;
  thumbnail_url: string;
  category: string;
  duration_seconds: number;
  is_recommended: boolean;
  sequence_in_output: number;
}

export interface PreviewTask {
  id: number;
  status: string;
  shop_name: string;
  output_oss_key: string;
  output_duration_seconds: number;
  videos: VideoShot[];
}
```

### File Locations Summary

| File | Action | Purpose |
|------|--------|---------|
| `frontend/src/views/VideoPreviewView.vue` | CREATE | Main preview page |
| `frontend/src/stores/preview.ts` | CREATE | Preview page state |
| `frontend/src/components/preview/VideoPlayer.vue` | CREATE | Video player wrapper |
| `frontend/src/components/preview/VideoControls.vue` | CREATE | Play/pause/fullscreen controls |
| `frontend/src/components/preview/ProgressBar.vue` | CREATE | Seekable progress bar |
| `frontend/src/components/preview/ShotList.vue` | CREATE | Collapsible shot list |
| `frontend/src/components/preview/ShotCard.vue` | CREATE | Individual shot thumbnail |
| `frontend/src/components/preview/CollapsibleSection.vue` | CREATE | Reusable collapsible component |
| `frontend/src/composables/useVideoPlayer.ts` | CREATE | Video playback logic |
| `frontend/src/api/output.ts` | CREATE | Output API calls |
| `frontend/src/types/output.ts` | CREATE | Type definitions |
| `frontend/src/router/index.ts` | MODIFY | Add preview route |
| `frontend/src/views/ComposeProgressView.vue` | MODIFY | Add navigation to preview |

### Testing Requirements

**Unit Tests** (Vitest + Vue Test Utils):
- VideoPlayer: render, play/pause, error states
- VideoControls: button interactions, time formatting
- ProgressBar: seek functionality, progress display
- ShotCard: render, hover tooltip
- CollapsibleSection: toggle animation
- useVideoPlayer: state management, event handling

**Integration Tests** (Vitest + MSW):
- VideoPreviewView: complete page load flow
- Task status check and redirect logic
- API error handling

**E2E Tests** (Playwright - P1):
- Full video playback flow
- Navigation from compose progress

---

## Agent Records

### SM Quality Assessment

```yaml
quality_assessment:
  structure_score: 100%
  technical_extraction_score: 85%
  implementation_readiness_score: 90%
  overall_score: 8.5/10
```

### Architect Review

```yaml
review_required: false
review_round: 1
review_status: APPROVED
score: 9.0
issues_critical: 0
issues_major: 0
issues_minor: 3
minor_issues:
  - m1: Poster source not specified - API doesn't return poster URL
  - m2: Volume UI not designed - composable has setVolume but no UI control
  - m3: Click-to-seek implicit - only in tests, not in subtask description
```

### QA Test Design

```yaml
test_design_level: Standard
test_design_status: Complete
assigned_date: 2026-02-03
completed_date: 2026-02-03
test_scenarios: 99
test_document: docs/qa/assessments/5.1-test-design-20260203.md
```

---

## Architect Review Results

**Review Date**: 2026-02-03
**Reviewer**: Aiden (Solution Architect Agent)
**Score**: 9.0/10
**Decision**: Approved
**Test Design Level**: Standard

### Validation Summary

- âœ… YAML metadata block complete
- âœ… T0 Infrastructure Tasks with file locations
- âœ… Detailed T1-T4 tasks with subtasks and test specs
- âœ… Component hierarchy documented (VideoPlayer â†’ Controls + ProgressBar + ShotList)
- âœ… Native HTML5 video approach (no third-party player)
- âœ… useVideoPlayer composable for playback state management
- âœ… Accumulated context references Stories 4.3, 1.4, 4.4, 2.1, 2.3
- âœ… API request/response specifications complete
- âœ… Type definitions provided (TaskOutput, VideoShot, PreviewTask)

### Minor Issues (Non-blocking)

| ID | Issue | Recommendation |
|----|-------|----------------|
| m1 | Poster source not specified | Use first shot thumbnail or generate poster from video first frame |
| m2 | Volume UI not designed | Mobile-first approach may not need volume control - verify UX decision |
| m3 | Click-to-seek implicit | Add explicit click-to-seek handling in T1.2 subtask description |

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created â†’ Draft | Story created from PRD Epic 5 (stub) |
| 2026-02-03 | SM | Draft â†’ AwaitingArchReview | Story fully elaborated: Added YAML frontmatter, T0-T4 tasks with file locations, component hierarchy, API specs, test specs, accumulated context. Gate passed (8.5/10). |
| 2026-02-03 | Architect | AwaitingArchReview â†’ AwaitingTestDesign | Score 9.0/10, 0 critical, 0 major, 3 minor. Approved for test design. |
| 2026-02-03 | QA | AwaitingTestDesign â†’ Approved | Test design complete: 99 scenarios (56 unit, 10 integration, 4 E2E, 29 blind spot). Doc: 5.1-test-design-20260203.md. Ready for Dev. |
| 2026-02-03 | Dev | Approved â†’ Review | Implementation complete: VideoPlayer, ProgressBar, VideoControls, ShotCard, CollapsibleSection, ShotList. 101 new tests (510 total passing). HANDOFF TO qa |
| 2026-02-03 | QA | Review â†’ Done | Gate PASS: 100% AC coverage (2/2 verified), 100% test pass rate (510/510), 0 critical issues. Gate file: 5.1-video-preview.yml |
