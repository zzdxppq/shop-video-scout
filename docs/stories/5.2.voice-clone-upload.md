# Story 5.2: 支持用户上传声音样本进行克隆

## Status
AwaitingTestDesign

## Story

**As a** 用户,
**I want** 上传自己的声音样本让AI克隆我的声音,
**so that** 视频配音更有个人特色

## Description

实现声音克隆功能：
- 上传声音样本到OSS
- 调用阿里云声音复刻API
- 管理用户克隆音色

## Acceptance Criteria

### AC1: 声音样本上传

**Scenario**
```gherkin
GIVEN 用户录制了声音样本
WHEN 上传声音文件
THEN
  - 验证文件格式 (MP3/WAV)
  - 验证时长 (30秒-2分钟)
  - 上传到OSS
  - 返回上传成功
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 支持格式: MP3, WAV |
| BR-1.2 | 时长范围: 30秒-2分钟 |
| BR-1.3 | 文件大小: ≤20MB |
| BR-1.4 | 每用户最多保存3个声音样本 |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| file | audio | Yes | MP3/WAV, 30s-2min | 格式或时长不符合要求 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 格式不支持 | 400 | 仅支持MP3/WAV格式 | 返回错误 |
| 时长过短 | 400 | 声音样本至少30秒 | 返回错误 |
| 时长过长 | 400 | 声音样本最长2分钟 | 返回错误 |
| 数量超限 | 400 | 最多保存3个声音样本 | 返回错误 |

### AC2: 声音克隆任务

**Scenario**
```gherkin
GIVEN 声音样本上传成功
WHEN 提交克隆任务
THEN
  - 调用阿里云声音复刻API
  - 返回克隆任务状态
  - 克隆完成后保存音色ID
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 克隆耗时约3-5分钟 |
| BR-2.2 | 克隆完成获得音色ID |
| BR-2.3 | 克隆失败提供重试 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 克隆服务异常 | 500 | 声音克隆失败 | 记录日志 |
| 样本质量差 | 400 | 声音样本质量不佳，请重录 | 返回错误 |

### AC3: 克隆状态查询

**Scenario**
```gherkin
GIVEN 用户提交了克隆任务
WHEN 查询克隆状态
THEN
  - 返回当前克隆状态
  - 完成后显示"可用"
  - 失败显示错误原因
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 状态: pending/processing/completed/failed |
| BR-3.2 | 支持轮询查询 |

### AC4: 声音样本试听

**Scenario**
```gherkin
GIVEN 声音克隆完成
WHEN 用户点击试听
THEN
  - 使用克隆声音合成示例文本
  - 返回试听音频
```

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 依赖和配置** `[ALL ACs]`
  - [ ] 配置阿里云声音复刻API
  - [ ] 创建 user_voice_samples 表

## Feature Implementation Tasks

### AC1: 声音样本上传

- [ ] **T1: 实现声音样本上传** `[AC1]`
  - [ ] 创建 /voice/upload-url 接口
  - [ ] 实现文件格式和时长校验
  - [ ] 实现OSS上传
  - [ ] 创建 /voice/samples POST 接口
  - [ ] 编写单元测试

### AC2: 声音克隆任务

- [ ] **T2: 实现声音克隆调用** `[AC2]`
  - [ ] 创建 VoiceCloneService
  - [ ] 调用阿里云声音复刻API
  - [ ] 实现异步任务处理
  - [ ] 回调处理克隆结果
  - [ ] 编写单元测试

### AC3: 克隆状态查询

- [ ] **T3: 实现状态查询** `[AC3]`
  - [ ] 创建 /voice/samples/{id} GET 接口
  - [ ] 返回克隆状态和音色信息
  - [ ] 编写单元测试

### AC4: 声音样本试听

- [ ] **T4: 实现试听功能** `[AC4]`
  - [ ] 创建 /voice/samples/{id}/preview GET 接口
  - [ ] 使用克隆声音合成示例
  - [ ] 返回音频URL
  - [ ] 编写单元测试

## Integration & Verification Tasks

- [ ] **T5: 集成测试** `[ALL ACs]`
  - [ ] 端到端: 上传→克隆→试听
  - [ ] 异常场景测试

## Dev Notes

### Technical Constraints

- 阿里云声音复刻服务
- 样本要求: 30s-2min, 清晰
- 克隆耗时约3-5分钟

### API Configuration

```yaml
aliyun_voice_clone:
  endpoint: "https://nls-portal.cn-shanghai.aliyuncs.com"
  # 声音复刻API配置
```

### Recording Guidelines (for UI)

```
录音指南：
1. 选择安静环境，避免背景噪音
2. 使用普通话清晰朗读
3. 保持音量稳定，不要忽大忽小
4. 建议录制时长：1-2分钟
5. 可以朗读任意文字内容
```

### Database Schema

```sql
CREATE TABLE user_voice_samples (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    sample_name VARCHAR(100) DEFAULT '我的声音',
    oss_key VARCHAR(500) NOT NULL,
    oss_url VARCHAR(1000),
    duration_seconds INT,
    file_size_bytes BIGINT,
    clone_status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    clone_voice_id VARCHAR(200),  -- 阿里云返回的克隆音色ID
    error_message TEXT,
    is_default BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | /api/v1/voice/upload-url | 获取上传URL |
| POST | /api/v1/voice/samples | 创建克隆任务 |
| GET | /api/v1/voice/samples | 获取样本列表 |
| GET | /api/v1/voice/samples/{id} | 获取样本详情 |
| GET | /api/v1/voice/samples/{id}/preview | 试听 |
| DELETE | /api/v1/voice/samples/{id} | 删除样本 |

### File Locations

```
backend/user-service/
├── src/main/java/
│   ├── controller/
│   │   └── VoiceController.java
│   ├── service/
│   │   └── VoiceCloneService.java
│   └── entity/
│       └── UserVoiceSample.java
```

## Source Proposals
- TCP-2026-001 Story Requirement T7
- PCP-2026-001 Story Requirement 8

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.8/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story技术方案与TCP-2026-001完全对齐。声音样本上传、克隆API调用、状态管理设计合理，数据库Schema完整。由于涉及用户敏感声音数据和异步处理，需要QA进行测试设计。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (3)
- **数据库索引缺失** (Dev Notes Schema): 补充 `INDEX idx_user_id (user_id)`, `INDEX idx_clone_status (clone_status)` 提升查询性能
- **外键约束缺失** (Dev Notes Schema): 补充 `FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE`
- **克隆回调机制** (AC2): 建议明确阿里云克隆完成通知方式（Webhook回调 vs 轮询查询）

### Recommendations
- 声音样本建议存储在独立OSS Bucket，便于生命周期管理
- 考虑添加声音样本质量预检（静音检测、背景噪音检测）
- 克隆任务建议使用XXL-Job定时轮询状态或配置Webhook回调
- 用户删除声音样本时应同步通知阿里云删除克隆音色

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 3 |
| security_sensitive | true |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP/PCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.8/10, 0 critical / 0 major issues |
