# Story 8.1: AI生成抖音热门话题标签推荐

## Status
AwaitingTestDesign

## Story

**As a** 用户,
**I want** 在视频生成完成后获取相关的抖音热门话题标签推荐,
**so that** 发布时可以直接复制使用，提升视频曝光

## Description

实现publish-service功能：
- 调用豆包API生成话题标签
- 基于店铺类型和脚本内容
- 格式化输出符合抖音规范

## Acceptance Criteria

### AC1: 话题生成

**Scenario**
```gherkin
GIVEN 视频合成完成
WHEN 用户查看发布辅助页面
THEN
  - 显示5-10个推荐话题标签
  - 标签按热度排序
  - 格式符合抖音规范 (#话题名#)
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 生成5-10个话题 |
| BR-1.2 | 格式: #话题名# |
| BR-1.3 | 包含:店铺相关、行业相关、地域相关 |

### AC2: 一键复制

**Scenario**
```gherkin
GIVEN 用户看到推荐话题
WHEN 点击复制按钮
THEN
  - 单个标签: 复制该标签
  - 全部复制: 复制所有标签(空格分隔)
  - 显示复制成功提示
```

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| 点击标签 | 复制该标签 |
| 点击"复制全部" | 复制所有标签 |
| 复制后 | 显示"已复制"提示 |

### AC3: 标签存储

**Scenario**
```gherkin
GIVEN 话题标签已生成
WHEN 用户下次访问
THEN
  - 显示之前生成的标签
  - 无需重新生成
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 标签存储在 task_publish_assists 表 |
| BR-3.2 | 支持用户选择标记 |

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 服务和表准备** `[ALL ACs]`
  - [ ] 创建 publish-service 模块
  - [ ] 创建 task_publish_assists 表

## Feature Implementation Tasks

### AC1: 话题生成

- [ ] **T1: 实现话题生成** `[AC1]`
  - [ ] 创建 TopicService
  - [ ] 设计话题生成Prompt
  - [ ] 调用豆包API
  - [ ] 解析并存储结果
  - [ ] 编写单元测试

### AC2: 一键复制

- [ ] **T2: 实现复制功能** `[AC2]`
  - [ ] 创建 TopicTags.vue 组件
  - [ ] 实现单个复制
  - [ ] 实现全部复制
  - [ ] 显示复制提示
  - [ ] 编写测试

### AC3: 标签存储

- [ ] **T3: 实现标签存储** `[AC3]`
  - [ ] 创建 /tasks/{id}/publish-assist GET 接口
  - [ ] 返回已生成的标签
  - [ ] 支持用户选择更新
  - [ ] 编写测试

## Integration & Verification Tasks

- [ ] **T4: 集成测试** `[ALL ACs]`
  - [ ] 端到端: 视频完成→话题生成→复制
  - [ ] 不同店铺类型测试

## Dev Notes

### Technical Constraints

- 复用ai-service的豆包调用
- 或通过Feign调用ai-service

### Topic Generation Prompt

```
基于以下探店视频内容，生成10个适合抖音发布的热门话题标签：

店铺类型: {shop_type}
店铺名称: {shop_name}
视频脚本摘要: {script_summary}

要求：
1. 格式：#话题名#
2. 包含店铺相关、美食/行业相关、地域相关话题
3. 优先选择热度高的话题

返回JSON数组:
["#话题1#", "#话题2#", ...]
```

### Database Schema

```sql
CREATE TABLE task_publish_assists (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id BIGINT NOT NULL UNIQUE,
    hot_topics JSON,           -- ["#美食探店#", "#重庆美食#", ...]
    title_suggestions JSON,    -- ["标题1", "标题2", ...]
    selected_topics JSON,      -- 用户选中的标签
    selected_title VARCHAR(500),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### API Response

```json
{
  "hot_topics": [
    "#美食探店#",
    "#重庆火锅#",
    "#必吃榜#",
    "#探店vlog#",
    "#美食推荐#"
  ]
}
```

### File Locations

```
backend/publish-service/
├── src/main/java/
│   ├── controller/
│   │   └── PublishAssistController.java
│   ├── service/
│   │   └── TopicService.java
│   └── entity/
│       └── TaskPublishAssist.java

frontend/
├── src/components/
│   └── TopicTags.vue
```

## Source Proposals
- TCP-2026-001 Story Requirement T9
- PCP-2026-001 Story Requirement 6

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.6/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story与TCP-2026-001高度对齐。Prompt模板与TCP完全一致，数据库Schema匹配（task_publish_assists），API设计符合规范（`/tasks/{taskId}/publish-assist`）。publish-service服务定位正确。由于涉及AI生成内容质量验证，需要QA进行测试设计。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (3)
- **FK约束缺失** (Database Schema): TCP定义有 `FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE`，建议补充到Schema中
- **服务调用明确化** (Dev Notes): 建议明确：通过Feign调用 `ai-service` 的DoubaoService，避免在publish-service重复实现Doubao API逻辑
- **热度说明优化** (BR-1.2): AI生成的是"推荐话题"而非基于实时数据的"热度排行"，建议UI文案调整为"推荐话题标签"

### Recommendations
- 话题生成建议在视频合成完成后自动触发，减少用户等待
- 考虑添加"刷新话题"功能，让用户可以重新生成不满意的结果
- 建议缓存近期热门话题模板，提升生成质量
- 前端TopicTags组件建议支持标签拖拽排序，方便用户调整复制顺序

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 2 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP/PCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.6/10, 0 critical / 0 major issues |
