# Story 7.2: 实现成品视频下载导出

## Status
Approved

## Story

**As a** 用户,
**I want** 下载合成好的成品视频到本地,
**so that** 可以发布到抖音/小红书等平台

## Description

实现视频下载导出功能：
- 下载按钮
- 下载进度显示
- 文件命名

## Acceptance Criteria

### AC1: 下载按钮

**Scenario**
```gherkin
GIVEN 视频合成完成
WHEN 用户点击下载按钮
THEN
  - 开始下载视频文件
  - 文件名包含店铺名称和日期
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 文件名格式: {店铺名}_{日期}.mp4 |
| BR-1.2 | 特殊字符替换为下划线 |
| BR-1.3 | 通过OSS CDN加速下载 |

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| 点击下载按钮 | 开始下载文件 |
| 下载进行中 | 按钮显示进度 |
| 下载完成 | 显示完成提示 |

### AC2: 下载进度

**Scenario**
```gherkin
GIVEN 用户开始下载视频
WHEN 下载进行中
THEN
  - 显示下载进度百分比
  - 显示已下载大小/总大小
  - 支持取消下载
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 进度更新频率: 每秒 |
| BR-2.2 | 显示预计剩余时间 |

### AC3: 下载历史

**Scenario**
```gherkin
GIVEN 用户有多个已完成任务
WHEN 查看任务列表
THEN
  - 显示下载按钮
  - 可重复下载
```

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 下载中断 | - | 下载中断，请重试 | 提供重试按钮 |
| 文件不存在 | 404 | 视频文件已过期 | 提示重新生成 |

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: OSS配置** `[ALL ACs]`
  - [ ] 配置CDN加速域名
  - [ ] 配置下载链接签名

## Feature Implementation Tasks

### AC1: 下载按钮

- [ ] **T1: 实现下载功能** `[AC1]`
  - [ ] 创建 DownloadButton.vue 组件
  - [ ] 实现文件名生成逻辑
  - [ ] 调用下载接口
  - [ ] 编写测试

### AC2: 下载进度

- [ ] **T2: 实现进度显示** `[AC2]`
  - [ ] 使用 fetch + ReadableStream 追踪进度
  - [ ] 显示进度条
  - [ ] 实现取消功能
  - [ ] 编写测试

### AC3: 下载历史

- [ ] **T3: 实现任务列表下载** `[AC3]`
  - [ ] 在任务列表添加下载入口
  - [ ] 检查视频是否可用
  - [ ] 编写测试

## Integration & Verification Tasks

- [ ] **T4: 集成测试** `[ALL ACs]`
  - [ ] 大文件下载测试
  - [ ] 断点续传测试(可选)
  - [ ] 移动端下载测试

## Dev Notes

### Technical Constraints

- OSS CDN加速
- 签名URL (有效期1小时)
- 支持大文件下载

### Download API

```javascript
// 获取下载URL
GET /api/v1/tasks/{taskId}/output

Response:
{
  "download_url": "https://cdn.example.com/videos/xxx.mp4?sign=xxx",
  "filename": "美食探店_20260114.mp4",
  "file_size": 52428800,
  "expires_at": "2026-01-14T15:00:00Z"
}
```

### Download with Progress

```javascript
async function downloadWithProgress(url, filename, onProgress) {
  const response = await fetch(url);
  const reader = response.body.getReader();
  const contentLength = +response.headers.get('Content-Length');

  let receivedLength = 0;
  let chunks = [];

  while(true) {
    const {done, value} = await reader.read();
    if (done) break;
    chunks.push(value);
    receivedLength += value.length;
    onProgress(receivedLength / contentLength);
  }

  // Create blob and download
  const blob = new Blob(chunks);
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}
```

### File Locations

```
frontend/
├── src/components/
│   └── DownloadButton.vue
├── src/utils/
│   └── download.ts
└── src/api/
    └── task.ts
```

## Source Proposals
- PCP-2026-001 Story Requirement 5

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.1/10
### Review Round: 1
### Test Design Level: Simple

### Decision: APPROVED

前端下载功能设计合理，正确使用 `/tasks/{taskId}/output` API获取视频信息，OSS CDN加速符合TCP要求。作为纯前端下载组件，技术复杂度低，无安全敏感内容，无需QA测试设计，可直接进入开发。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (3)
- **API响应字段扩展** (Download API): Response添加 `filename`, `expires_at` 字段，TCP未定义。建议后端实现时同步更新TCP API spec
- **签名URL生成** (T0 Tasks): 建议明确：后端 `/tasks/{taskId}/output` 应生成带签名的OSS下载URL（有效期1小时），格式如 `{cdn_domain}/{output_video_key}?sign=xxx&expires=xxx`
- **大文件下载策略** (Dev Notes): 建议分两种模式：小文件(<50MB)使用fetch+blob显示进度，大文件(≥50MB)使用直接链接下载 `<a href download>` 避免内存问题

### Recommendations
- 建议添加下载统计，记录用户下载次数用于数据分析
- 移动端建议检测存储空间，不足时提前提示
- 考虑添加"分享到..."功能，支持直接分享到社交平台
- 文件名特殊字符处理建议使用encodeURIComponent确保兼容性

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from PCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → Approved | Score: 9.1/10, Simple test level, direct to Dev |
