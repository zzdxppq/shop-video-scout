# Story 0.1: CI/CD流水线搭建

## Status
Draft

## Story

**As a** 开发团队,
**I want** 建立自动化的CI/CD流水线,
**so that** 代码可以自动构建、测试和部署，提高开发效率和交付质量

## Acceptance Criteria

### AC1: 代码构建流水线

**Scenario**
```gherkin
GIVEN 开发者提交代码到Git仓库
WHEN 代码推送到develop或main分支
THEN
  - 自动触发构建流水线
  - 前端: 执行npm install && npm run build
  - 后端: 执行mvn clean package -DskipTests
  - 构建产物存档（Docker镜像或JAR包）
  - 构建失败时通知开发者
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | develop分支触发CI，main分支触发CI+CD |
| BR-1.2 | 构建超时时间30分钟 |
| BR-1.3 | Docker镜像标签格式: {service}:{branch}-{commit_sha} |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 构建失败 | BUILD_FAILED | 构建失败，请检查代码 | 发送企业微信/钉钉通知，附带错误日志链接 |

---

### AC2: 自动化测试阶段

**Scenario**
```gherkin
GIVEN 代码构建成功
WHEN 进入测试阶段
THEN
  - 执行前端单元测试 (Vitest)
  - 执行后端单元测试 (JUnit)
  - 生成测试覆盖率报告
  - 覆盖率低于阈值时标记警告
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 后端核心服务单元测试覆盖率 >= 60% |
| BR-2.2 | 前端组件测试覆盖率 >= 50% |
| BR-2.3 | 测试失败阻止后续部署 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 测试失败 | TEST_FAILED | 单元测试失败 | 阻止部署，通知开发者修复 |

---

### AC3: 自动部署到Staging环境

**Scenario**
```gherkin
GIVEN develop分支构建和测试通过
WHEN 触发Staging部署
THEN
  - 推送Docker镜像到私有仓库
  - 更新Staging环境Kubernetes部署
  - 等待健康检查通过
  - 部署成功后通知团队
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | Staging部署采用滚动更新策略 |
| BR-3.2 | 健康检查超时5分钟 |
| BR-3.3 | 部署失败自动回滚到上一版本 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 部署失败 | DEPLOY_FAILED | Staging部署失败 | 自动回滚，通知运维团队 |

---

### AC4: 生产环境部署流程

**Scenario**
```gherkin
GIVEN Staging验证通过
WHEN 触发Production部署（手动审批）
THEN
  - 需要至少1名审批者确认
  - 执行蓝绿部署或金丝雀发布
  - 保留最近3个版本用于回滚
  - 部署完成后执行冒烟测试
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-4.1 | 生产部署必须经过手动审批 |
| BR-4.2 | 保留最近3个可回滚版本 |
| BR-4.3 | 一键回滚响应时间 < 5分钟 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 冒烟测试失败 | SMOKE_TEST_FAILED | 生产冒烟测试失败 | 自动回滚，触发告警 |

---

## Tasks / Subtasks

### Infrastructure Tasks (Shared)

- [ ] **T0: 环境准备** `[ALL ACs]`
  - [ ] 配置GitHub Actions / GitLab CI运行环境
  - [ ] 准备Docker Registry凭证
  - [ ] 配置Kubernetes集群访问凭证

### Feature Implementation Tasks

#### AC1: 代码构建流水线

- [ ] **T1: 前端构建配置** `[AC1]`
  - [ ] 创建前端构建workflow文件
  - [ ] 配置Node.js环境和依赖缓存
  - [ ] 配置构建产物存档

- [ ] **T2: 后端构建配置** `[AC1]`
  - [ ] 创建后端构建workflow文件
  - [ ] 配置Java 21和Maven环境
  - [ ] 配置Docker镜像构建和推送

#### AC2: 自动化测试阶段

- [ ] **T3: 测试流水线配置** `[AC2]`
  - [ ] 配置前端Vitest测试步骤
  - [ ] 配置后端JUnit测试步骤
  - [ ] 配置覆盖率报告生成和上传

#### AC3: Staging部署

- [ ] **T4: Staging部署配置** `[AC3]`
  - [ ] 创建Kubernetes deployment配置
  - [ ] 配置滚动更新策略
  - [ ] 配置健康检查探针

#### AC4: 生产环境部署

- [ ] **T5: 生产部署配置** `[AC4]`
  - [ ] 配置手动审批流程
  - [ ] 配置蓝绿部署策略
  - [ ] 配置回滚机制

### Integration Tasks

- [ ] **T6: 通知集成** `[ALL ACs]`
  - [ ] 配置企业微信/钉钉Webhook
  - [ ] 实现构建/部署状态通知

---

## Dev Notes

### Technical Constraints

- 使用GitHub Actions或GitLab CI作为CI/CD平台
- Docker镜像推送到阿里云ACR或私有Registry
- Kubernetes部署到阿里云ACK

### File Locations

```
.github/workflows/
├── ci-frontend.yml       # 前端CI流水线
├── ci-backend.yml        # 后端CI流水线
├── cd-staging.yml        # Staging部署
└── cd-production.yml     # 生产部署

deploy/
├── kubernetes/
│   ├── staging/          # Staging环境K8s配置
│   └── production/       # 生产环境K8s配置
└── docker/
    └── Dockerfile.*      # 各服务Dockerfile
```

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created → Draft | Story created from PRD Epic 0 |
