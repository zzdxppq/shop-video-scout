# Story 7.3: 实现前端核心页面和流程

## Status
AwaitingTestDesign

## Story

**As a** 用户,
**I want** 通过直观的Web界面完成探店视频制作流程,
**so that** 可以轻松创建专业的探店视频

## Description

实现Vue 3前端核心功能：
- 创建任务页 (表单+上传)
- 任务进度页 (实时进度)
- 结果预览页 (播放器+下载)

## Acceptance Criteria

### AC1: 创建任务页

**Scenario**
```gherkin
GIVEN 用户登录后进入首页
WHEN 点击"新建任务"
THEN
  - 显示店铺信息表单
  - 支持批量视频上传
  - 填写完成后提交任务
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 必填: 店铺名称、类型、视频风格 |
| BR-1.2 | 可选: 优惠信息、配音音色 |
| BR-1.3 | 视频数量: 3-20个 |
| BR-1.4 | 单个视频: ≤100MB |

**Data Validation**
| Field | Type | Required | Rules | Error Message |
|-------|------|----------|-------|---------------|
| shop_name | string | Yes | 2-50字 | 请输入店铺名称 |
| shop_type | enum | Yes | 选择一个 | 请选择店铺类型 |
| video_style | enum | Yes | 选择一个 | 请选择视频风格 |
| videos | file[] | Yes | 3-20个 | 请上传3-20个视频 |

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| 拖拽文件到上传区 | 添加到上传列表 |
| 点击上传区 | 打开文件选择器 |
| 点击删除按钮 | 移除对应视频 |
| 点击提交 | 验证并提交任务 |

### AC2: 视频上传

**Scenario**
```gherkin
GIVEN 用户选择了视频文件
WHEN 开始上传
THEN
  - 显示每个文件的上传进度
  - 支持并行上传
  - 上传失败支持重试
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 并行上传数: 3 |
| BR-2.2 | 上传失败自动重试: 2次 |
| BR-2.3 | 使用OSS直传 |

### AC3: 任务进度页

**Scenario**
```gherkin
GIVEN 任务已提交
WHEN 进入任务详情页
THEN
  - 显示当前处理步骤
  - 显示进度百分比
  - 实时更新状态
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 步骤: 上传中→分析中→脚本生成中→配音中→合成中→完成 |
| BR-3.2 | 使用SSE实时更新 |
| BR-3.3 | 每5秒回退轮询 (SSE失败时) |

**UI Interaction**
| Trigger | Behavior |
|---------|----------|
| 步骤完成 | 图标变绿色勾选 |
| 当前步骤 | 显示加载动画 |
| 任务失败 | 显示错误信息和重试按钮 |

### AC4: 任务列表

**Scenario**
```gherkin
GIVEN 用户有历史任务
WHEN 进入任务列表页
THEN
  - 分页显示任务列表
  - 显示任务状态
  - 可点击进入详情
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-4.1 | 每页20条 |
| BR-4.2 | 按创建时间倒序 |
| BR-4.3 | 显示缩略图 |

## Tasks / Subtasks

## Infrastructure Tasks (Shared)

- [ ] **T0: 前端路由和状态** `[ALL ACs]`
  - [ ] 配置Vue Router路由
  - [ ] 配置Pinia状态管理
  - [ ] 封装API请求

## Feature Implementation Tasks

### AC1: 创建任务页

- [ ] **T1: 实现创建任务表单** `[AC1]`
  - [ ] 创建 CreateTask.vue 页面
  - [ ] 实现表单验证
  - [ ] 实现店铺类型和视频风格选择器
  - [ ] 编写测试

### AC2: 视频上传

- [ ] **T2: 实现视频上传组件** `[AC2]`
  - [ ] 创建 VideoUploader.vue 组件
  - [ ] 实现拖拽上传
  - [ ] 实现并行上传和进度显示
  - [ ] 实现OSS直传
  - [ ] 编写测试

### AC3: 任务进度页

- [ ] **T3: 实现任务进度页** `[AC3]`
  - [ ] 创建 TaskProgress.vue 页面
  - [ ] 实现步骤进度组件
  - [ ] 实现SSE实时更新
  - [ ] 实现错误处理
  - [ ] 编写测试

### AC4: 任务列表

- [ ] **T4: 实现任务列表** `[AC4]`
  - [ ] 创建 TaskList.vue 页面
  - [ ] 实现分页组件
  - [ ] 实现任务卡片组件
  - [ ] 编写测试

## Integration & Verification Tasks

- [ ] **T5: 集成测试** `[ALL ACs]`
  - [ ] 端到端流程测试
  - [ ] 移动端适配测试
  - [ ] 性能测试

## Dev Notes

### Technical Constraints

- Vue 3.4 + TypeScript
- Element Plus UI组件库
- SSE实时进度更新

### Page Routes

```javascript
const routes = [
  { path: '/', name: 'Home', component: Home },
  { path: '/login', name: 'Login', component: Login },
  { path: '/tasks', name: 'TaskList', component: TaskList },
  { path: '/tasks/create', name: 'CreateTask', component: CreateTask },
  { path: '/tasks/:id', name: 'TaskDetail', component: TaskDetail },
  { path: '/tasks/:id/result', name: 'TaskResult', component: TaskResult },
  { path: '/voice', name: 'VoiceManage', component: VoiceManage }
];
```

### SSE Progress Update

```javascript
const eventSource = new EventSource(`/api/v1/tasks/${taskId}/progress`);

eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  // { step: 'analyzing', progress: 45, message: 'AI分析中...' }
  updateProgress(data);
};

eventSource.onerror = () => {
  // Fallback to polling
  startPolling();
};
```

### File Locations

```
frontend/
├── src/
│   ├── views/
│   │   ├── Home.vue
│   │   ├── Login.vue
│   │   ├── TaskList.vue
│   │   ├── CreateTask.vue
│   │   ├── TaskDetail.vue
│   │   └── TaskResult.vue
│   ├── components/
│   │   ├── VideoUploader.vue
│   │   ├── StepProgress.vue
│   │   ├── TaskCard.vue
│   │   └── VoiceSelector.vue
│   ├── stores/
│   │   ├── user.ts
│   │   └── task.ts
│   ├── api/
│   │   ├── auth.ts
│   │   ├── task.ts
│   │   └── voice.ts
│   └── router/
│       └── index.ts
```

## Source Proposals
- TCP-2026-001 Story Requirement T10

## Architect Review Results

### Review Date: 2026-01-14
### Reviewed By: Aiden (Architect)
### Architecture Score: 9.4/10
### Review Round: 1
### Test Design Level: Standard

### Decision: APPROVED (Pending Test Design)

Story完整实现TCP T10前端核心页面需求。技术栈完全对齐（Vue 3 + TypeScript + Element Plus），SSE实时更新与轮询回退机制设计合理，状态机映射正确。由于涉及4个主要页面、视频上传组件、实时进度更新等复杂功能，需要QA进行测试设计确保用户体验。

### Issues

#### Critical Issues (0)
无

#### High Issues (0)
无

#### Medium Issues (0)
无

#### Low Issues (3)
- **任务创建与上传流程** (AC1/AC2): 建议在T1/T2中明确两步流程：1) `POST /tasks` 创建任务获取taskId，2) 调用 `/tasks/{taskId}/videos/upload-url` 获取OSS签名上传地址，3) 前端直传OSS。避免将videos理解为表单提交字段
- **配音音色选择时机** (BR-1.2): TCP设计voice_type在compose时设置。建议支持两种场景：创建时可预设voice_type存入task记录，合成前可修改
- **VoiceManage路由** (Page Routes): `/voice` 路由服务于E5.2/E5.3声音克隆管理，为合理扩展。建议添加路由守卫，仅登录用户可访问

### Recommendations
- 建议使用Vue 3 Composition API + `<script setup>` 语法以提高开发效率
- VideoUploader组件建议支持视频预览缩略图，方便用户确认上传文件
- SSE连接建议添加心跳检测，超时自动重连
- 任务列表建议添加下拉刷新和加载更多（无限滚动），提升移动端体验
- 考虑添加任务草稿功能，防止用户意外关闭页面丢失填写内容

## QA Test Design Metadata

| Field | Value |
|-------|-------|
| test_design_level | Standard |
| complexity_indicators | 4 |
| security_sensitive | false |
| calculated_by | Architect (post-review) |
| calculation_date | 2026-01-14 |

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-14 | SM | Created → AwaitingArchReview | Story created from TCP-2026-001 |
| 2026-01-14 | Architect | AwaitingArchReview → AwaitingTestDesign | Score: 9.4/10, 0 critical / 0 major issues |
