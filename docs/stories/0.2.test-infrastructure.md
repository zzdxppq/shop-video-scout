# Story 0.2: 测试基础设施搭建

## Status
Draft

## Story

**As a** 开发团队,
**I want** 建立完善的测试基础设施,
**so that** 可以对代码进行单元测试、集成测试和端到端测试，确保代码质量

## Acceptance Criteria

### AC1: 后端单元测试框架

**Scenario**
```gherkin
GIVEN 后端微服务项目已创建
WHEN 配置测试框架
THEN
  - 集成JUnit 5测试框架
  - 集成Mockito用于Mock依赖
  - 集成Testcontainers用于数据库测试
  - 创建测试基类和通用工具类
  - 配置测试数据库连接（H2内存数据库）
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 每个Service类必须有对应的Test类 |
| BR-1.2 | 测试方法命名: should_预期行为_when_条件 |
| BR-1.3 | 测试数据使用@BeforeEach准备，@AfterEach清理 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 测试数据库连接失败 | TEST_DB_ERROR | 测试数据库初始化失败 | 检查H2配置，确保测试隔离 |

---

### AC2: 后端集成测试框架

**Scenario**
```gherkin
GIVEN 单元测试框架已配置
WHEN 配置集成测试
THEN
  - 使用@SpringBootTest加载完整上下文
  - 使用Testcontainers启动MySQL和Redis容器
  - 配置MockMvc进行API端点测试
  - 创建集成测试基类
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 集成测试使用独立的test profile |
| BR-2.2 | 每个API端点至少有Happy Path测试 |
| BR-2.3 | 集成测试不依赖外部AI服务（使用Mock） |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 容器启动失败 | CONTAINER_ERROR | Testcontainers启动失败 | 检查Docker环境，确保Docker daemon运行 |

---

### AC3: 前端单元测试框架

**Scenario**
```gherkin
GIVEN Vue3前端项目已创建
WHEN 配置前端测试框架
THEN
  - 集成Vitest作为测试运行器
  - 集成Vue Test Utils进行组件测试
  - 集成MSW (Mock Service Worker)模拟API
  - 配置测试覆盖率报告 (c8/istanbul)
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-3.1 | 核心组件必须有单元测试 |
| BR-3.2 | Composables必须有单元测试 |
| BR-3.3 | 测试文件与源文件同目录: Component.vue → Component.test.ts |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 组件渲染失败 | RENDER_ERROR | 组件测试渲染失败 | 检查组件依赖是否正确Mock |

---

### AC4: E2E测试框架 (P1)

**Scenario**
```gherkin
GIVEN 前后端集成完成
WHEN 配置E2E测试
THEN
  - 集成Playwright
  - 创建关键用户流程测试
  - 配置无头浏览器运行
  - 生成测试报告和截图
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-4.1 | E2E测试仅覆盖核心Happy Path |
| BR-4.2 | E2E测试不在每次CI运行，仅在发布前 |
| BR-4.3 | 测试失败自动截图保存 |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 浏览器启动失败 | BROWSER_ERROR | E2E测试浏览器启动失败 | 检查Playwright依赖是否正确安装 |

---

## Tasks / Subtasks

### Infrastructure Tasks (Shared)

- [ ] **T0: 测试环境准备** `[ALL ACs]`
  - [ ] 确认Docker环境可用（Testcontainers需要）
  - [ ] 准备测试配置文件

### Feature Implementation Tasks

#### AC1: 后端单元测试框架

- [ ] **T1: 配置JUnit 5** `[AC1]`
  - [ ] 添加JUnit 5依赖到pom.xml
  - [ ] 添加Mockito依赖
  - [ ] 创建测试基类BaseUnitTest

- [ ] **T2: 配置H2测试数据库** `[AC1]`
  - [ ] 添加H2依赖
  - [ ] 创建application-test.yml配置
  - [ ] 创建测试数据初始化脚本

#### AC2: 后端集成测试框架

- [ ] **T3: 配置Testcontainers** `[AC2]`
  - [ ] 添加Testcontainers依赖
  - [ ] 创建MySQL和Redis容器配置
  - [ ] 创建集成测试基类BaseIntegrationTest

- [ ] **T4: 配置MockMvc** `[AC2]`
  - [ ] 创建API测试基类
  - [ ] 配置认证Mock

#### AC3: 前端单元测试框架

- [ ] **T5: 配置Vitest** `[AC3]`
  - [ ] 安装Vitest和Vue Test Utils
  - [ ] 配置vitest.config.ts
  - [ ] 创建测试setup文件

- [ ] **T6: 配置MSW** `[AC3]`
  - [ ] 安装MSW
  - [ ] 创建API mock handlers
  - [ ] 配置测试环境

#### AC4: E2E测试框架 (P1)

- [ ] **T7: 配置Playwright** `[AC4]`
  - [ ] 安装Playwright
  - [ ] 配置playwright.config.ts
  - [ ] 创建核心流程测试用例

---

## Dev Notes

### Technical Constraints

- 后端测试框架: JUnit 5 + Mockito + Testcontainers
- 前端测试框架: Vitest + Vue Test Utils + MSW
- E2E测试框架: Playwright
- AC1-AC3为P0优先级，AC4 E2E测试为P1可延后

### Dependencies

- 依赖 Story 1.1 (后端项目结构)
- 依赖 Story 1.3 (前端项目结构)

### File Locations

```
backend/
├── common-test/                    # 测试公共模块
│   └── src/test/java/
│       └── com/shopvideoscout/test/
│           ├── BaseUnitTest.java
│           └── BaseIntegrationTest.java
└── */src/test/                     # 各服务测试目录

frontend/
├── vitest.config.ts
├── src/
│   └── **/*.test.ts               # 组件测试文件
└── tests/
    ├── setup.ts                   # 测试setup
    └── mocks/                     # MSW handlers

e2e/
├── playwright.config.ts
└── tests/                         # E2E测试用例
```

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created → Draft | Story created from PRD Epic 0 |
