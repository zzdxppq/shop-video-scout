# Story 3.1: AI脚本生成服务

## Status
Done

## QA Test Design Metadata

- **Level:** Standard
- **Test Design Status:** Complete
- **Document:** docs/qa/assessments/3.1-test-design-20260125.md
- **Scenarios:** 32 (P0: 8, P1: 14, P2: 10)
- **Blind Spots:** 12 scenarios covering BOUNDARY, ERROR, DATA, CONCURRENCY, FLOW, RESOURCE

## Story

**As a** 系统,
**I want** 使用AI根据镜头分析和店铺信息生成口播脚本,
**so that** 用户无需自己撰写文案

## Acceptance Criteria

### AC1: 调用豆包API生成脚本

**Scenario**
```gherkin
GIVEN 镜头分析已完成 (task.status = 'analyzing' 且所有视频分析完成)
WHEN 系统生成脚本
THEN
  - 构建包含店铺信息和镜头摘要的Prompt
  - 调用豆包API生成脚本
  - 解析返回的脚本内容（JSON格式）
  - 存储到scripts表
  - 更新task.status为'script_ready'
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-1.1 | 脚本分5-7个段落 |
| BR-1.2 | 每段标注对应镜头shot_id |
| BR-1.3 | 总时长控制在60秒左右 |
| BR-1.4 | 脚本风格根据task.video_style调整（recommend/review/vlog） |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| AI服务超时 | 504/50300 | 生成超时，正在重试 | 自动重试2次，间隔5秒 |
| 生成内容不符合要求 | 422/50301 | 生成内容异常，正在重新生成 | 更换Prompt参数重试（调整temperature） |
| 豆包API返回错误 | 50302 | AI服务暂时不可用 | 记录错误日志，设置task.status='failed' |

**Examples**
- **Input**: 店铺信息(shop_name, shop_type, promotion_text) + 镜头摘要(shot_summaries from videos表)
- **Expected**:
```json
{
  "paragraphs": [
    {
      "id": "para_1",
      "section": "开场",
      "shot_id": 101,
      "text": "家人们！今天给你们探一家望京超火的海底捞...",
      "estimated_duration": 8
    }
  ],
  "total_duration": 60
}
```

---

### AC2: 重新生成脚本

**Scenario**
```gherkin
GIVEN 用户对当前脚本不满意
WHEN 用户请求重新生成 (POST /api/v1/tasks/{id}/regenerate-script)
THEN
  - 检查script_regenerate_count < 5
  - 调整Prompt参数（增加temperature变化）
  - 重新调用AI生成
  - 更新scripts表content和version
  - 增加task.script_regenerate_count
```

**Business Rules**
| ID | Rule |
|----|------|
| BR-2.1 | 每个任务最多重新生成5次（检查task.script_regenerate_count） |
| BR-2.2 | 保留上一版本脚本供对比（通过scripts.version递增） |

**Error Handling**
| Scenario | Code | Message | Action |
|----------|------|---------|--------|
| 重新生成次数超限 | 429/42900 | 重新生成次数已达上限，请手动编辑 | 返回regenerate_remaining=0，前端禁用重新生成按钮 |

---

## Tasks / Subtasks

### Infrastructure Tasks (Shared)

- [x] **T0: 豆包API SDK集成与配置** `[ALL ACs]`
  - [x] 添加豆包API SDK依赖到ai-service
  - [x] 创建豆包API配置类（API Key, endpoint, timeout设置）
  - [x] 实现DoubaoClient wrapper with retry logic
  - [x] 验证SDK连接成功

### Feature Implementation Tasks

- [x] **T1: 实现脚本生成服务** `[AC1]`

  **Test Specs** (from QA test-design - 32 scenarios total):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | Prompt包含店铺信息 | shop_name, shop_type, promotion_text | Prompt字符串包含所有字段 | unit |
  | Prompt包含镜头摘要 | analyzed videos | Prompt包含shot_summaries | unit |
  | Prompt按风格变化 | video_style=recommend/review/vlog | Prompt模板匹配风格 | unit |
  | JSON解析成功 | valid Doubao response | paragraphs数组正确 | unit |
  | 段落数量校验 | paragraphs array | 5-7个段落 (BR-1.1) | unit |
  | shot_id映射校验 | paragraphs | 每段有shot_id (BR-1.2) | unit |
  | 时长校验 | total_duration | ~60s ±10s (BR-1.3) | unit |
  | 生成脚本成功 | task with analyzed videos | scripts表插入, status='script_ready' | integration |
  | API超时重试 | timeout | 重试2次 (5s, 10s backoff) | integration |
  | API错误处理 | Doubao returns error | status='failed', log error | integration |
  | 无效JSON重试 | malformed JSON | 调整temperature重试 | integration |
  | [BLIND] 空店铺名 | empty shop_name | 合理错误处理 | unit |
  | [BLIND] 空镜头列表 | no analyzed videos | 合理错误处理 | unit |
  | [BLIND] 事务回滚 | DB save fails | task.status NOT updated | integration |

  - [x] Write unit tests for ScriptGenerationService
  - [x] Implement ScriptPromptBuilder（构建Doubao prompt）
  - [x] Implement ScriptGenerationService.generateScript()
  - [x] Implement ScriptResponseParser（解析JSON响应）
  - [x] Add retry logic with exponential backoff
  - [x] Update TaskService to trigger script generation after analysis
  - [x] Verify all tests pass

- [x] **T2: 实现脚本重新生成** `[AC2]`

  **Test Specs** (from QA test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | 次数检查通过 | count < 5 | 允许重新生成 (BR-2.1) | unit |
  | 次数检查拒绝 | count >= 5 | 返回false (BR-2.1) | unit |
  | temperature递增 | regenerate request | 0.7→0.8→0.9 | unit |
  | 重新生成成功 | valid task | scripts.version++, count++ | integration |
  | 版本递增 | regenerate | version 1→2→3... (BR-2.2) | integration |
  | 历史版本保留 | regenerate | 前版本可查询 | integration |
  | 次数超限429 | count=5 | 返回429, regenerate_remaining=0 | integration |
  | [BLIND] 边界次数 | count=4→5 | 第5次成功，第6次拒绝 | integration |
  | [BLIND] 并发请求 | 同时2个regenerate | 只1个成功或正确计数 | integration |

  - [x] Write unit tests for regeneration logic
  - [x] Implement ScriptService.regenerateScript()
  - [x] Add regeneration count check
  - [x] Implement prompt parameter variation
  - [x] Update scripts table version on regeneration
  - [x] Verify all tests pass

- [x] **T3: 实现API端点** `[AC1, AC2]`

  **Test Specs** (from QA test-design):
  | Scenario | Input | Expected | Level |
  |----------|-------|----------|-------|
  | GET script成功 | valid task_id | 返回script内容 + regenerate_remaining | integration |
  | GET script 404 | invalid task_id | 返回404 | integration |
  | GET script未生成 | task未生成脚本 | 返回404 | integration |
  | POST regenerate成功 | valid task_id | 触发重新生成，返回200 | integration |
  | POST regenerate 404 | invalid task_id | 返回404 | integration |
  | POST regenerate 429 | count >= 5 | 返回429, regenerate_remaining=0 | integration |
  | [BLIND] 未分析任务 | task.status != script_ready | 合理错误处理 | integration |

  - [x] Implement GET /api/v1/tasks/{id}/script endpoint
  - [x] Implement POST /api/v1/tasks/{id}/regenerate-script endpoint
  - [x] Add request validation
  - [x] Verify all tests pass

### Integration & Verification Tasks

- [x] **T4: Integration Testing** `[ALL ACs]`
  - [x] End-to-end flow: task created → analysis → script generation
  - [x] Regeneration flow with version tracking
  - [x] Error handling flow (API timeout, invalid response)

- [x] **T5: Final Verification** `[ALL ACs]`
  - [x] All tests passing (unit + integration)
  - [x] No lint errors
  - [x] Dev Log complete with implementation summary
  - [x] Status → Review

## AC Coverage Matrix

| Task | AC1 | AC2 |
|------|:---:|:---:|
| T0: SDK Setup | ✓ | ✓ |
| T1: Script Generation | ✓ |   |
| T2: Regeneration |   | ✓ |
| T3: API Endpoints | ✓ | ✓ |
| T4: Integration | ✓ | ✓ |
| T5: Final | ✓ | ✓ |

---

## Dev Notes

### Technical Constraints

- 豆包API调用timeout设置为60秒（脚本生成较慢）
- 重试间隔使用exponential backoff: 5s, 10s
- temperature参数范围: 0.7（首次）→ 0.8/0.9（重试）
- [→ docs/architecture/4-service-architecture-details.md#4.4 AI Service]

### Accumulated Context (From Previous Stories)

| Resource Type | Name | Source Story | Action | Key Info |
|--------------|------|--------------|--------|----------|
| Table | tasks | 1.1 | REUSE | status, video_style, shop_name, shop_type, promotion_text, script_regenerate_count |
| Table | videos | 1.1 | REUSE | category, tags, quality_score, is_recommended (for shot summaries) |
| Table | scripts | 1.1 | REUSE | task_id (UNIQUE), content (JSON), version, is_user_edited |
| Endpoint | POST /api/v1/tasks/{id}/analyze | 2.3 | TRIGGER | 分析完成后触发脚本生成 |
| Endpoint | GET /api/v1/tasks/{id}/progress | 2.3 | CALL | 检查分析状态 |

### Database Design

**scripts表** (已存在于架构设计):
```sql
CREATE TABLE scripts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id BIGINT NOT NULL UNIQUE,
    content JSON NOT NULL,  -- {paragraphs: [{id, section, shot_id, text, estimated_duration}], total_duration}
    version INT DEFAULT 1,
    is_user_edited BOOLEAN DEFAULT FALSE,
    total_duration_seconds INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

**tasks表字段** (已存在):
- `script_regenerate_count INT DEFAULT 0` - 追踪重新生成次数

### Data Models

**ScriptContent Interface**:
```typescript
interface ScriptContent {
  paragraphs: ScriptParagraph[];
  total_duration: number;
}

interface ScriptParagraph {
  id: string;           // "para_1", "para_2", ...
  section: string;      // "开场", "环境展示", "重点内容", "优惠信息", "结尾互动"
  shot_id: number;      // Reference to videos.id
  text: string;         // 口播文案
  estimated_duration: number;  // 预计秒数
}

interface ScriptResponse {
  id: number;
  task_id: number;
  version: number;
  is_user_edited: boolean;
  paragraphs: ScriptParagraph[];
  total_duration: number;
  regenerate_remaining: number;  // 5 - task.script_regenerate_count
}
```

**Doubao Prompt Template** (from architecture):
```
你是一位专业的探店视频文案撰写专家。请根据以下信息生成探店口播脚本：

店铺信息：
- 名称：{{shop_name}}
- 类型：{{shop_type}}
- 特色/优惠：{{promotion_text}}

视频风格：{{video_style}}（recommend=种草安利型/review=真实测评型/vlog=探店vlog型）

可用镜头：
{{shot_summaries}}

要求：
1. 生成5-7个段落
2. 每段标注对应使用的镜头shot_id
3. 包含：开场hook、环境介绍、重点内容、优惠信息、结尾互动
4. 总时长控制在60秒左右
5. 语言风格符合{{video_style}}调性

输出JSON格式：
{
  "paragraphs": [
    {
      "id": "para_1",
      "section": "开场",
      "shot_id": xxx,
      "text": "...",
      "estimated_duration": 8
    },
    ...
  ],
  "total_duration": 60
}
```

### File Locations

| File | Purpose | Action |
|------|---------|--------|
| `backend/ai-service/src/main/java/com/svs/ai/service/ScriptGenerationService.java` | 脚本生成服务 | CREATE |
| `backend/ai-service/src/main/java/com/svs/ai/service/ScriptPromptBuilder.java` | Prompt构建器 | CREATE |
| `backend/ai-service/src/main/java/com/svs/ai/client/DoubaoClient.java` | 豆包API客户端 | CREATE |
| `backend/ai-service/src/main/java/com/svs/ai/dto/ScriptResponse.java` | 脚本响应DTO | CREATE |
| `backend/ai-service/src/main/java/com/svs/ai/controller/ScriptController.java` | API控制器 | CREATE |
| `backend/ai-service/src/main/resources/application.yml` | 豆包API配置 | MODIFY |
| `backend/task-service/src/main/java/com/svs/task/service/TaskService.java` | 任务服务 | MODIFY (trigger script gen) |

### Deliverable Bindings

```yaml
deliverable_bindings:
  - deliverable: "backend/ai-service/src/main/java/com/svs/ai/service/ScriptGenerationService.java"
    consumer: "backend/ai-service/src/main/java/com/svs/ai/controller/ScriptController.java"
    binding_type: di_inject
    verify: "@Autowired.*ScriptGenerationService|private.*ScriptGenerationService"

  - deliverable: "backend/ai-service/src/main/java/com/svs/ai/client/DoubaoClient.java"
    consumer: "backend/ai-service/src/main/java/com/svs/ai/service/ScriptGenerationService.java"
    binding_type: di_inject
    verify: "@Autowired.*DoubaoClient|private.*DoubaoClient"

  - deliverable: "GET /api/v1/tasks/{id}/script"
    consumer: "backend/ai-service/src/main/java/com/svs/ai/controller/ScriptController.java"
    binding_type: route_mount
    verify: "@GetMapping.*script|@RequestMapping.*script"

  - deliverable: "POST /api/v1/tasks/{id}/regenerate-script"
    consumer: "backend/ai-service/src/main/java/com/svs/ai/controller/ScriptController.java"
    binding_type: route_mount
    verify: "@PostMapping.*regenerate-script"
```

**Binding Status**: ✅ Verified - All bindings implemented with correct patterns

### Testing Requirements

- **Unit Tests**: ScriptPromptBuilder, ScriptResponseParser, regeneration count logic
- **Integration Tests**: DoubaoClient with mock server, full script generation flow
- **Focus Areas**:
  - Doubao API timeout handling and retry logic
  - JSON parsing robustness (malformed responses)
  - Regeneration count boundary (4→5→reject)
  - Prompt template correctness for different video_style values
- [→ docs/architecture/12-development-guidelines.md#12.4 Testing Strategy]

---

## AC Traceability Matrix

> **Dev**: Fill this section BEFORE self-review. Every AC needs evidence.
> **QA**: Verify each entry during AC Coverage Verification.

### AC1: 调用豆包API生成脚本

```yaml
ac_id: AC1
code_locations:
  - "ai-service/.../service/ScriptGenerationService.java:generateScript()"
  - "ai-service/.../service/ScriptPromptBuilder.java:buildPrompt()"
  - "ai-service/.../service/ScriptResponseParser.java:parse()"
  - "ai-service/.../client/DoubaoClient.java:generateScript()"
  - "ai-service/.../controller/ScriptController.java:getScript()"
test_locations:
  - "ScriptGenerationServiceTest.java:generateScript_success_shouldInsertScript"
  - "ScriptPromptBuilderTest.java:8 tests (prompt building, BR-1.4)"
  - "ScriptResponseParserTest.java:9 tests (JSON parsing)"
  - "DoubaoClientTest.java:8 tests (API integration, retry)"
  - "ScriptControllerTest.java:getScript_success_shouldReturnScript"
verification_type: unit_test + integration_test
aspects_covered:
  main_scenario: true
  business_rules: true  # BR-1.1 (5-7 paragraphs), BR-1.2 (shot_id), BR-1.3 (~60s), BR-1.4 (video_style)
  data_validation: true
  error_handling: true  # timeout retry, invalid response handling
notes: "Used existing package com.shopvideoscout.ai instead of com.svs.ai"
```

### AC2: 重新生成脚本

```yaml
ac_id: AC2
code_locations:
  - "ai-service/.../service/ScriptGenerationService.java:regenerateScript()"
  - "ai-service/.../service/ScriptGenerationService.java:canRegenerate()"
  - "ai-service/.../client/DoubaoClient.java:calculateTemperature()"
  - "ai-service/.../controller/ScriptController.java:regenerateScript()"
test_locations:
  - "ScriptGenerationServiceTest.java:canRegenerate_countLessThan5_shouldReturnTrue"
  - "ScriptGenerationServiceTest.java:canRegenerate_countGreaterOrEqual5_shouldReturnFalse"
  - "ScriptGenerationServiceTest.java:regenerateScript_existingScript_shouldUpdateVersion"
  - "ScriptGenerationServiceTest.java:regenerateScript_limitReached_shouldThrow429"
  - "DoubaoClientTest.java:calculateTemperature_shouldIncreaseWithCount"
  - "ScriptControllerTest.java:regenerateScript_limitReached_shouldReturn429"
verification_type: unit_test + integration_test
aspects_covered:
  main_scenario: true
  business_rules: true  # BR-2.1 (max 5), BR-2.2 (version++)
  data_validation: true
  error_handling: true  # count exceeded -> 429
notes: "MAX_REGENERATE_COUNT=5, Temperature: 0.7→0.8→0.9"
```

---

### Traceability Summary

| AC | Code Location | Test Location | Type | Status |
|----|---------------|---------------|------|--------|
| AC1 | ScriptGenerationService, DoubaoClient, ScriptPromptBuilder, ScriptResponseParser | 35 tests across 5 test classes | unit+integration | ✅ |
| AC2 | ScriptGenerationService.regenerateScript(), canRegenerate() | 6 tests (boundary, version, 429) | unit+integration | ✅ |

**Legend**: ✅ Verified | ⏳ Pending | ❌ Missing

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Implementation Summary
Implemented AI script generation service using Doubao API with:
- Script generation from shop info + shot summaries (AC1)
- Script regeneration with max 5 attempts, temperature variation 0.7→0.8→0.9 (AC2)
- REST endpoints: GET /api/v1/tasks/{id}/script, POST /api/v1/tasks/{id}/regenerate-script
- 41 unit/integration tests covering all business rules and error handling

### Database Changes (Structured)
```yaml
# No new tables - uses existing scripts table from architecture
# Used Script entity with JacksonTypeHandler for JSON content column
```

### API Endpoints Created (Structured)
```yaml
- path: "GET /api/v1/tasks/{id}/script"
  controller: ScriptController.java
  service: ScriptGenerationService.getByTaskId()
  response: ScriptResponse (with regenerate_remaining)

- path: "POST /api/v1/tasks/{id}/regenerate-script"
  controller: ScriptController.java
  service: ScriptGenerationService.regenerateScript()
  response: ScriptResponse (with new version)
  error_codes: [404, 429]
```

### Shared Models Created (Structured)
```yaml
DTOs:
  - ScriptContent: JSON structure with paragraphs array
  - ScriptResponse: API response with regenerate_remaining
  - ShotSummary: Shot summary for prompt building
  - DoubaoRequest/DoubaoResponse: API DTOs

Entities:
  - Script: MyBatis-Plus entity with JacksonTypeHandler

Clients:
  - DoubaoClient: WebClient with retry logic
  - TaskServiceClient: Feign client for task-service
```

### File List
| File | Action | Lines |
|------|--------|-------|
| ai-service/.../config/DoubaoConfig.java | CREATE | ~35 |
| ai-service/.../dto/DoubaoRequest.java | CREATE | ~25 |
| ai-service/.../dto/DoubaoResponse.java | CREATE | ~40 |
| ai-service/.../dto/ScriptContent.java | CREATE | ~45 |
| ai-service/.../dto/ScriptResponse.java | CREATE | ~30 |
| ai-service/.../dto/ShotSummary.java | CREATE | ~25 |
| ai-service/.../entity/Script.java | CREATE | ~50 |
| ai-service/.../mapper/ScriptMapper.java | CREATE | ~15 |
| ai-service/.../client/DoubaoClient.java | CREATE | ~90 |
| ai-service/.../client/TaskServiceClient.java | CREATE | ~35 |
| ai-service/.../service/ScriptPromptBuilder.java | CREATE | ~80 |
| ai-service/.../service/ScriptResponseParser.java | CREATE | ~75 |
| ai-service/.../service/ScriptGenerationService.java | CREATE | ~120 |
| ai-service/.../controller/ScriptController.java | CREATE | ~80 |
| ai-service/.../mapper/VideoFrameMapper.java | MODIFY | +5 |
| ai-service/.../AiServiceApplication.java | MODIFY | +1 |
| ai-service/src/main/resources/application.yml | MODIFY | +12 |
| ai-service/pom.xml | MODIFY | +5 |
| ai-service/.../test/ScriptPromptBuilderTest.java | CREATE | ~100 |
| ai-service/.../test/ScriptResponseParserTest.java | CREATE | ~120 |
| ai-service/.../test/ScriptGenerationServiceTest.java | CREATE | ~150 |
| ai-service/.../test/DoubaoClientTest.java | CREATE | ~110 |
| ai-service/.../test/ScriptControllerTest.java | CREATE | ~100 |

### Dev Log Reference
`docs/dev/logs/3.1-dev-log.md`

### Open Issues
None

### Deviations from Design
1. **Package name**: Used `com.shopvideoscout.ai` (existing pattern) instead of `com.svs.ai` (story spec)
2. **Feign Client**: Added TaskServiceClient as Feign interface for service-to-service communication

---

## QA Review

- **Round**: 1
- **Risk Level**: MEDIUM
- **Review Mode**: automated_plus_spot_check
- **Gate**: PASS
- **Tests**: 41/41 automated (100%)
- **Blind Spots**: 8/12 covered (67%)
- **Issues**: 0 critical / 0 high / 2 medium
- **Gate File**: `docs/qa/gates/3.1-ai-script-generation.yml`

### QA Results

| Dimension | Status | Details |
|-----------|--------|---------|
| AC Coverage | ✅ PASS | AC1: VERIFIED, AC2: VERIFIED |
| Test Evidence | ✅ PASS | 41 tests across 5 test classes |
| Task Checkboxes | ✅ PASS | 28/28 checked, all consistent |
| Blind Spots | ✅ PASS | 8/12 covered, only P2 missing |
| Blocking Issues | ✅ PASS | 0 critical, 0 high |

**Gate Decision**: PASS - All core functionality verified, only P2 edge cases missing. SHIP IT.

---

## Change Log

| Date | Agent | Status Transition | Details/Link |
|------|-------|-------------------|--------------|
| 2026-01-22 | SM | Created → Draft | Story created from PRD Epic 3 |
| 2026-01-25 | SM | Draft → Draft | Story enhanced with full template, architecture refs, deliverable bindings |
| 2026-01-25 | SM | Draft → Ready | GATE 1 PASS (Structure 100%, Quality 88%). QA Test Design recommended before Dev |
| 2026-01-25 | QA | Ready → Approved | Test Design Complete. 32 scenarios (P0:8, P1:14, P2:10). 12 blind spot scenarios. Ready for Dev |
| 2026-01-25 | Dev | Approved → Review | Implementation complete. 18 files created, 4 modified. 41 tests. docs/dev/logs/3.1-dev-log.md |
| 2026-01-25 | QA | Review → Done | Round 1, Gate: PASS, Tests: 100%, Blind Spots: 67%. docs/qa/gates/3.1-ai-script-generation.yml |
